<!DOCTYPE html> 250hot 
<!-- Payment Assistant AI - Deployed via GitHub Pages -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Payment Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --color-purple-500: #533AFD;
            --color-purple-600: #4A2FE8;
            --color-gray-50: #F9FAFB;
            --color-gray-100: #F3F4F6;
            --color-gray-150: #EBEDF0;
            --color-gray-200: #E4E7EC;
            --color-gray-300: #D2D6DC;
            --color-gray-400: #9AA2B1;
            --color-gray-500: #6C7689;
            --color-gray-600: #4F566B;
            --color-gray-700: #3D4456;
            --color-gray-800: #2B3040;
            --color-gray-900: #1A1F2E;
            --sidebar-width: 280px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #ffffff;
            color: var(--color-gray-900);
        }
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid var(--color-gray-200);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px 12px 20px;
        }
        .sidebar-logo {
            width: 28px;
            height: 28px;
            background: var(--color-gray-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-gray-500);
            font-size: 14px;
        }
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            line-height: 20px;
            letter-spacing: -0.15px;
        }
        .sidebar-dropdown {
            margin-left: auto;
            color: var(--color-gray-400);
            font-size: 16px;
        }
        .nav-section {
            margin-top: 32px;
        }
        .nav-section:first-of-type {
            margin-top: 16px;
        }
        .nav-section-title {
            font-size: 12px;
            font-weight: 400;
            color: var(--color-gray-500);
            text-transform: none;
            letter-spacing: 0;
            padding: 0 20px 4px 20px;
            margin-bottom: 4px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            line-height: 16px;
            display: flex;
            align-items: center;
        }
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0 12px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 14px 5px 14px;
            border-radius: 8px;
            color: var(--color-gray-600);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 14px;
            line-height: 20px;
            letter-spacing: -0.15px;
            text-decoration: none;
            transition: color 0.15s;
            cursor: pointer;
            background: none;
        }
        .nav-item.active {
            color: #533AFD;
            font-weight: 600;
            background: none;
        }
        .nav-item:hover:not(.active) {
            color: var(--color-gray-900);
            background: var(--color-gray-100);
        }
        .nav-item-icon {
            width: 14px;
            height: 14px;
            color: inherit;
            flex-shrink: 0;
        }
        .nav-expand {
            margin-left: auto;
            color: var(--color-gray-400);
            width: 14px;
            height: 14px;
        }
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 0;
            border-top: 1px solid var(--color-gray-200);
            background: #fff;
            margin-top: 32px;
        }
        .footer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 400;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.15s, color 0.15s;
        }
        .footer-item:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-900);
        }
        .footer-icon {
            width: 14px;
            height: 14px;
            color: inherit;
        }
        .nav-sub-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-left: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .nav-sub-item {
            color: var(--color-gray-600);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 14px;
            line-height: 20px;
            letter-spacing: -0.15px;
            padding: 5px 14px 5px 40px;
            border-radius: 8px;
            text-decoration: none;
            transition: color 0.15s;
            cursor: pointer;
            background: none;
            display: flex;
            align-items: center;
            margin-left: 0;
        }
        .nav-sub-item:hover {
            color: var(--color-gray-900);
            background: var(--color-gray-100);
        }
        
        .nav-sub-item.active {
            color: #533AFD;
            font-weight: 600;
            background: none;
        }
        
        /* Top Bar Styles */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: #fff;
            height: 64px;
            width: calc(100vw - var(--sidebar-width));
            position: fixed;
            top: 0;
            z-index: 999;
            box-sizing: border-box;
            left: var(--sidebar-width);
            display: flex;
            justify-content: center;
        }
        
        .top-bar-inner {
            width: 100%;
            max-width: 1280px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-container {
            position: relative;
            width: 300px;
            margin-left: 0;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--color-gray-400);
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-gray-100);
            transition: background 0.15s;
            color: var(--color-gray-600);
        }
        
        .search-input::placeholder {
            color: var(--color-gray-500);
        }
        
        .search-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 1px var(--color-purple-500);
        }
        
        .top-right-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-right: 0;
        }
        
        .icon-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: var(--color-gray-50);
        }
        
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            border-radius: 4px;
            color: var(--color-gray-600);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .icon-btn:hover {
            background: var(--color-gray-100);
        }
        
        .standalone-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .standalone-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 6px;
            color: var(--color-gray-600);
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        
        .standalone-icon-btn:hover {
            background: var(--color-gray-100);
        }
        
        .notification-btn {
            position: relative;
        }
        
        .notification-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: #3B82F6;
            border-radius: 50%;
        }
        
        .new-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-purple-500);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .new-btn:hover {
            background: var(--color-purple-600);
        }
        
        .icon {
            width: 16px;
            height: 16px;
        }
        
        .new-icon {
            width: 16px;
            height: 16px;
        }
        
        /* Main Content Styles */
        .main-content {
            padding: 24px;
            width: calc(100vw - var(--sidebar-width));
            max-width: none;
            margin-left: var(--sidebar-width);
            margin-top: 64px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        .main-content-inner {
            width: 100%;
            max-width: 1280px;
        }
        
        .page-title {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 700;
            font-size: 28px;
            line-height: 36px;
            display: flex;
            align-items: center;
            letter-spacing: 0.38px;
            font-feature-settings: 'pnum' on, 'lnum' on;
            color: #353A44;
            margin: 0;
        }
        
        /* Page Header Styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .share-feedback-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .share-feedback-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }
        
        /* Navigation Tabs Styles */
        .nav-tabs {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--color-gray-200);
            padding-bottom: 0;
        }
        
        .nav-tab {
            padding: 12px 0;
            border: none;
            background: none;
            color: var(--color-gray-600);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.15s;
            pointer-events: auto;
            z-index: 10;
        }
        
        .nav-tab:hover {
            color: var(--color-gray-900);
        }
        
        .nav-tab.active {
            color: var(--color-purple-500);
            font-weight: 600;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-purple-500);
            border-radius: 1px;
        }
        
        /* Filter Styles */
        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .filter-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }
        
        .filter-btn.active {
            background: white;
            color: #533AFD;
            border-color: var(--color-gray-200);
        }
        
        .filter-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }
        
        .filter-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px dashed var(--color-gray-300);
            border-radius: 20px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .filter-chip:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-400);
        }
        
        .chip-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        /* Date Range Dropdown Styles */
        .date-range-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-trigger:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 140px;
            display: none;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--color-gray-600);
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--color-gray-50);
        }

        .dropdown-item.active {
            background: var(--color-purple-50);
            color: var(--color-purple-500);
            font-weight: 500;
        }
        
        /* Separator */
        .separator {
            height: 1px;
            background: var(--color-gray-200);
            margin: 24px 0;
        }

        /* Two Column Layout Styles */
        .two-column-layout {
            display: grid;
            grid-template-columns: 70% 30%;
            gap: 24px;
            margin-top: 24px;
            width: 100%;
            align-items: start;
            height: 100%;
        }

        .left-column, .right-column {
            padding: 0;
            overflow: visible;
            overflow-x: auto;
            min-width: 0;
            height: 100%;
            display: block;
            box-sizing: border-box;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .metrics-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .metrics-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .compared-to {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .comparison-dropdown {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 4px;
            background: white;
            color: var(--color-gray-900);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .comparison-dropdown:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .dropdown-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-500);
        }

        .date-range {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 4px;
            background: white;
            color: var(--color-gray-600);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .download-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .download-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-600);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 16px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: all 0.15s;
            cursor: pointer;
        }

        .metric-card:hover {
            background: white;
            border-color: var(--color-gray-300);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .metric-card.selected {
            background: white;
            border-color: var(--color-purple-500);
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.1);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
        }

        .info-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.2;
        }

        .metric-change {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive {
            color: #22C55E; /* Green */
        }

        .negative {
            color: #EF4444; /* Red */
        }



        .chart-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .chart-filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: white;
            color: var(--color-gray-600);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .chart-filter-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .chart-filter-btn.active {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .chart-container {
            height: 400px;
            background: white;
            margin-top: 0;
            padding: 0;
            width: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .chart-legend {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .snapshot-chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            justify-content: center;
            padding: 8px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid var(--color-gray-200);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--color-gray-600);
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-color.current {
            background: var(--color-purple-500);
        }

        .legend-color.previous {
            background: var(--color-gray-300);
        }

        .legend-color.optimized {
            background: #22C55E;
        }

        .chart-content {
            position: relative;
            height: 300px;
            margin-bottom: 16px;
            width: 100%;
            padding: 0;
        }

        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 8px;
        }

        .chart-area {
            position: absolute;
            top: 0;
            left: 40px;
            right: 40px;
            bottom: 40px;
            background: white;
            padding: 0;
        }

        .chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px);
            background-size: 100% 25%;
            opacity: 0.3;
        }

        .chart-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        .chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -40px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 40px;
            padding-right: 40px;
        }

        .chart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .assistant-section {
            margin-bottom: 32px;
            padding: 0;
            background: transparent;
            width: 100%;
        }

        .assistant-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .sparkles-icon {
            width: 16px;
            height: 16px;
            color: var(--color-purple-500);
        }

        .assistant-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .suggested-prompts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .prompt-btn {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 12px;
            padding: 16px;
            border: 2.5px solid rgba(83, 58, 253, 0.3);
            border-radius: 24px;
            background: white;
            color: var(--color-gray-900);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            line-height: 1.4;
            width: 100%;
        }

        .prompt-btn:hover {
            background: var(--color-gray-50);
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.1);
        }

        .resources-section {
            padding: 0;
            background: transparent;
            width: 100%;
        }

        .resources-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 20px;
        }

        .resource-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: var(--color-gray-50);
            margin-bottom: 16px;
            transition: all 0.15s;
            cursor: pointer;
            width: 100%;
        }

        .resource-item:hover {
            background: var(--color-gray-100);
        }

        .resource-icon {
            width: 24px;
            height: 24px;
            color: var(--color-purple-500);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .resource-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .resource-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .resource-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .resource-subsection {
            margin-top: 20px;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-900);
            margin-bottom: 16px;
        }

        .resource-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 400;
            text-decoration: none;
            transition: color 0.15s;
            padding: 8px 0;
            cursor: pointer;
        }

        .resource-link:hover {
            color: var(--color-gray-900);
        }

        .arrow-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        /* Card Payments Breakdown Styles */
        .breakdown-section {
            margin-top: 32px;
            background: white;
            border-radius: 0;
            border: none;
            width: 100%;
        }

        .breakdown-header {
            padding: 24px 0 16px 0;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .breakdown-title-section {
            margin-bottom: 12px;
        }

        .breakdown-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .breakdown-subtitle {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0;
            line-height: 20px;
        }

        .breakdown-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breakdown-filters {
            display: flex;
            gap: 8px;
        }

        .breakdown-filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .breakdown-filter-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .breakdown-filter-btn.active {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
            border-width: 1px;
        }

        .breakdown-dropdowns {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-900);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .breakdown-total {
            padding: 12px 0;
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .total-label {
            font-size: 14px;
            color: var(--color-gray-600);
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .total-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-gray-900);
            display: block;
            margin-top: 4px;
        }

        .bar-chart-container {
            padding: 0;
        }

        .bar-chart-content {
            position: relative;
            height: 300px;
            margin-bottom: 12px;
            width: 100%;
            padding: 0;
        }

        .bar-chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 8px;
        }

        .bar-chart-area {
            position: absolute;
            top: 0;
            left: 40px;
            right: 40px;
            bottom: 40px;
            background: white;
            border: none;
            outline: none;
            padding: 0;
        }

        .bar-chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px);
            background-size: 100% 25%;
            opacity: 0.3;
        }

        .bar-chart-bars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .bar-chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        .bar-chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -40px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 40px;
            padding-right: 40px;
        }

        .bar-chart-footer {
            display: flex;
            justify-content: flex-end;
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .data-table-container {
            padding: 0 0 20px 0;
            margin-top: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            text-align: left;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-gray-200);
            font-weight: 600;
            color: var(--color-gray-700);
            background: white;
            font-size: 13px;
            letter-spacing: -0.15px;
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-gray-150);
            color: var(--color-gray-900);
            font-size: 14px;
            line-height: 20px;
            background: white;
        }

        .data-table tbody tr:hover {
            background: white;
        }

        .data-table tbody tr {
            background: white;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .checkbox-header {
            width: 40px;
        }

        .data-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-purple-500);
        }

        .total-row {
            background: white;
            border-top: 2px solid var(--color-gray-200);
        }

        .data-table th {
            background: white;
        }

        .total-row td {
            font-weight: 600;
            color: var(--color-gray-900);
            font-size: 14px;
        }

        .data-table .reason-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .data-table .reason-icon {
            width: 16px;
            height: 16px;
            color: var(--color-purple-500);
            flex-shrink: 0;
        }



        /* Business Type Tabs (Horizontal Navigation) */
        .business-type-tabs {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        .business-type-tab {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            background: none;
            white-space: nowrap;
        }
        .business-type-tab:hover {
            background: var(--color-gray-50);
        }
        .business-type-tab.active {
            color: var(--color-purple-500);
            background: var(--color-purple-50);
            border-bottom: 2px solid var(--color-purple-500);
        }
        .business-type-tab:not(:last-child) {
            border-right: 1px solid var(--color-gray-200);
        }

        /* Lo-fi Mode Toggle Styles */
        .lofi-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px 16px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-200);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--color-gray-300);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--color-purple-500);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        .toggle-label {
            white-space: nowrap;
        }

        /* Skeleton Styles for Lo-fi Mode */
        .skeleton-block {
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .skeleton-block::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            transform: translateX(-100%);
        }

        .skeleton-title {
            height: 28px;
            width: 240px;
            margin-bottom: 16px;
            background: #e8e8e8;
        }

        .skeleton-subtitle {
            height: 18px;
            width: 320px;
            margin-bottom: 24px;
            background: #f0f0f0;
        }

        .skeleton-card {
            height: 140px;
            width: 100%;
            margin-bottom: 16px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .skeleton-card-header {
            height: 20px;
            width: 60%;
            background: #e8e8e8;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-card-content {
            height: 16px;
            width: 80%;
            background: #f0f0f0;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-card-metric {
            height: 32px;
            width: 40%;
            background: #e8e8e8;
            border-radius: 6px;
        }

        .skeleton-table {
            height: 240px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-table-header {
            height: 20px;
            width: 100%;
            background: #e8e8e8;
            margin-bottom: 16px;
            border-radius: 4px;
        }

        .skeleton-table-row {
            height: 16px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-timeline {
            height: 320px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-timeline-item {
            height: 60px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 16px;
        }

        .skeleton-timeline-dot {
            width: 12px;
            height: 12px;
            background: #e8e8e8;
            border-radius: 50%;
            margin-right: 16px;
        }

        .skeleton-timeline-content {
            flex: 1;
        }

        .skeleton-timeline-title {
            height: 16px;
            width: 70%;
            background: #e8e8e8;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-timeline-subtitle {
            height: 14px;
            width: 50%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-insights {
            height: 180px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-insight-item {
            height: 40px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .skeleton-insight-icon {
            width: 16px;
            height: 16px;
            background: #e8e8e8;
            border-radius: 50%;
            margin-right: 12px;
        }

        .skeleton-insight-text {
            flex: 1;
            height: 14px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-actions {
            height: 120px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-action-button {
            height: 40px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        /* High-fidelity skeleton styles */
        .skeleton-waterfall {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            height: 200px;
            padding: 20px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
        }

        .skeleton-waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .skeleton-waterfall-bar {
            width: 60px;
            height: 80px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-waterfall-label {
            height: 16px;
            width: 80%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-waterfall-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .skeleton-detail-value {
            height: 14px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-detail-rate {
            height: 12px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .skeleton-metric-card {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .skeleton-metric-title {
            height: 18px;
            width: 120px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-metric-value {
            height: 24px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-metric-chart {
            display: flex;
            gap: 12px;
        }

        .skeleton-chart-y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px;
        }

        .skeleton-axis-label {
            height: 12px;
            width: 30px;
            background: #f0f0f0;
            border-radius: 2px;
        }

        .skeleton-chart-area {
            flex: 1;
            position: relative;
            height: 120px;
            background: #fafafa;
            border-radius: 4px;
        }

        .skeleton-chart-line {
            position: absolute;
            height: 2px;
            background: #e8e8e8;
            border-radius: 1px;
        }

        .skeleton-chart-line:nth-child(1) {
            top: 20%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-line:nth-child(2) {
            top: 50%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-line:nth-child(3) {
            top: 80%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-legend {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .skeleton-legend-item {
            height: 12px;
            width: 60px;
            background: #f0f0f0;
            border-radius: 2px;
        }

        .skeleton-table {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-table-header {
            display: flex;
            background: #f0f0f0;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .skeleton-table-th {
            flex: 1;
            height: 16px;
            background: #e8e8e8;
            border-radius: 4px;
            margin-right: 16px;
        }

        .skeleton-table-th:last-child {
            margin-right: 0;
        }

        .skeleton-table-row {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .skeleton-table-row:last-child {
            border-bottom: none;
        }

        .skeleton-table-td {
            flex: 1;
            margin-right: 16px;
        }

        .skeleton-table-td:last-child {
            margin-right: 0;
        }

        .skeleton-opportunity-title {
            height: 16px;
            width: 80%;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-opportunity-desc {
            height: 12px;
            width: 60%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-impact-value {
            height: 16px;
            width: 50px;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .skeleton-impact-label {
            height: 12px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-revenue {
            height: 16px;
            width: 100px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-effort-badge {
            height: 20px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 12px;
            margin-bottom: 4px;
        }

        .skeleton-action-btn {
            height: 32px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        /* Additional skeleton elements for experiments */
        .skeleton-test-title {
            height: 16px;
            width: 80%;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-test-desc {
            height: 12px;
            width: 60%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-status-badge {
            height: 20px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 12px;
        }

        .skeleton-progress-bar {
            height: 8px;
            width: 100px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .skeleton-rate-value {
            height: 16px;
            width: 50px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-improvement {
            height: 16px;
            width: 40px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        /* Performance stats skeleton styles */
        .skeleton-stat-card {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .skeleton-stat-value {
            height: 28px;
            width: 80px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-stat-label {
            height: 16px;
            width: 120px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* AI Assistant Panel Styles */
        .ai-assistant-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: white;
            border-left: 1px solid var(--color-gray-200);
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.08);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .ai-assistant-panel.open {
            transform: translateX(0);
        }

        /* Main content adjustment when AI panel is open */
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }

        .main-content.ai-panel-open {
            margin-right: 480px;
        }

        /* Top bar adjustment when AI panel is open */
        .top-bar {
            transition: margin-right 0.3s ease-in-out;
        }

        .top-bar.ai-panel-open {
            margin-right: 480px;
        }

        /* Business type tabs adjustment when AI panel is open */
        .business-type-tabs {
            transition: left 0.3s ease-in-out;
        }

        .business-type-tabs.ai-panel-open {
            left: calc(var(--sidebar-width) + 20px - 480px);
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--color-gray-150);
            background: white;
        }

        .ai-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-panel-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ai-panel-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-panel-control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 6px;
            color: var(--color-gray-500);
            cursor: pointer;
            transition: all 0.15s;
        }

        .ai-panel-control-btn:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
        }

        .ai-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
        }

        .ai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 32px;
            overflow-y: auto;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.02) 2px,
                    rgba(0, 0, 0, 0.02) 4px
                );
        }

        .ai-message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.4s ease-out forwards;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .ai-message-avatar.assistant {
            background: var(--color-purple-500);
            color: white;
        }

        .ai-message-avatar.user {
            background: var(--color-gray-100);
            color: var(--color-gray-600);
        }

        .ai-message-content {
            flex: 1;
            max-width: calc(100% - 52px);
        }

        .ai-message-bubble {
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ai-message-bubble.assistant {
            background: white;
            color: var(--color-gray-900);
            border: 1px solid var(--color-gray-150);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .ai-message-bubble.assistant p {
            margin: 0 0 10px 0;
            line-height: 1.5;
            font-size: 13px;
        }

        .ai-message-bubble.assistant strong {
            color: var(--color-gray-900);
            font-weight: 600;
            font-size: 13px;
        }

        .ai-message-bubble.assistant h4 {
            margin: 12px 0 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            line-height: 1.4;
        }

        .ai-message-bubble.assistant ul {
            margin: 8px 0;
            padding-left: 16px;
            list-style-type: none;
        }

        .ai-message-bubble.assistant li {
            margin: 4px 0;
            line-height: 1.4;
            font-size: 13px;
            position: relative;
            padding-left: 8px;
        }

        .ai-message-bubble.assistant li:before {
            content: "";
            color: var(--color-purple-500);
            font-weight: bold;
            position: absolute;
            left: -8px;
        }

        .ai-message-bubble.user {
            background: var(--color-purple-500);
            color: white;
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.2);
        }

        .ai-input-container {
            padding: 24px 32px 32px 32px;
            background: white;
            border-top: 1px solid var(--color-gray-150);
        }

        .ai-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            position: relative;
        }

        .ai-input {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            min-height: 52px;
            max-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: white;
            transition: all 0.15s;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--color-purple-500);
            box-shadow: 0 0 0 3px rgba(83, 58, 253, 0.1);
        }

        .ai-input::placeholder {
            color: var(--color-gray-500);
        }

        .ai-send-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            border: none;
            background: var(--color-gray-200);
            color: var(--color-gray-600);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .ai-send-btn:hover {
            background: var(--color-purple-500);
            color: white;
            transform: scale(1.05);
        }

        .ai-send-btn:disabled {
            background: var(--color-gray-200);
            color: var(--color-gray-400);
            cursor: not-allowed;
            transform: none;
        }

        /* Backdrop for panel */
        .ai-panel-backdrop {
            display: none;
        }

        .ai-panel-backdrop.visible {
            display: none;
        }

        /* Layout adjustments when AI panel is open */
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }

        .main-content.ai-panel-open {
            margin-right: 480px;
        }

        /* Top bar adjustment when AI panel is open */
        .top-bar {
            transition: margin-right 0.3s ease-in-out;
        }

        .top-bar.ai-panel-open {
            margin-right: 480px;
        }

        /* Business type tabs adjustment when AI panel is open */
        .business-type-tabs {
            transition: left 0.3s ease-in-out;
        }

        .business-type-tabs.ai-panel-open {
            left: calc(var(--sidebar-width) + 20px - 480px);
        }

        /* AI Prompt Pills Styles */
        .ai-prompt-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .ai-prompt-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            max-width: 200px;
        }

        .ai-prompt-pill:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-prompt-pill.primary {
            background: var(--color-purple-500);
            border-color: var(--color-purple-500);
            color: white;
        }

        .ai-prompt-pill.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
            color: white;
        }

        .ai-prompt-pill.secondary {
            background: var(--color-gray-100);
            border-color: var(--color-gray-200);
            color: var(--color-gray-700);
        }

        .ai-prompt-pill.secondary:hover {
            background: var(--color-gray-200);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        .ai-prompt-pill-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .ai-prompt-pill-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chart Tooltip Styles */
        .chart-tooltip {
            position: fixed;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            font-size: 13px;
            line-height: 1.4;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 336px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            top: 0;
            left: 0;
        }

        .chart-tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .tooltip-header {
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .tooltip-data {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tooltip-data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-label {
            color: var(--color-gray-600);
            font-size: 12px;
        }

        .tooltip-value {
            color: var(--color-gray-900);
            font-weight: 500;
            font-size: 12px;
        }

        .tooltip-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .tooltip-ask-btn {
            background: white;
            color: var(--color-gray-600);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            z-index: 10000;
            position: relative;
        }

        .tooltip-ask-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        .tooltip-ask-btn i {
            width: 10px;
            height: 10px;
        }

        /* Chart hover states */
        .chart-lines path,
        .bar-chart-bars rect {
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .chart-lines path:hover,
        .bar-chart-bars rect:hover {
            opacity: 0.8;
        }

        /* Data point indicators */
        .data-point {
            cursor: pointer;
            transition: all 0.15s;
        }

        .data-point:hover {
            opacity: 0.8;
        }

        /* Hover areas for better interaction */
        .hover-area {
            cursor: pointer;
            transition: all 0.15s;
        }

        .hover-area:hover {
            opacity: 0.8;
        }

        .tooltip-color-swatch {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .tooltip-label {
            color: var(--color-gray-600);
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        /* AI Message Animations */
        .ai-message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.4s ease-out forwards;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Graph Load Animations */
        .chart-svg {
            opacity: 0.5;
            transform: scale(0.99);
            animation: graphLoadIn 0.4s ease-out 0.1s forwards;
        }

        @keyframes graphLoadIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .bar-chart-svg {
            opacity: 0.5;
            transform: scale(0.99);
            animation: graphLoadIn 0.4s ease-out 0.1s forwards;
        }

        /* AI optimized line (third path) should be dotted */
        .chart-lines path:nth-child(3) {
            stroke-dasharray: 5, 5;
        }

        /* Bar chart bars animation */
        .bar-chart-bars rect {
            transform: scaleY(0.5);
            transform-origin: bottom;
            animation: growBar 0.6s ease-out 0.3s forwards;
        }

        @keyframes growBar {
            to {
                transform: scaleY(1);
            }
        }

        /* AI Insight Indicator Styles */
        .ai-insight-indicator {
            cursor: pointer;
            transition: all 0.3s ease;
            /* Remove any animations to keep it fixed */
            animation: none !important;
        }

        .ai-insight-sparkle {
            pointer-events: none;
        }

        /* Ensure AI insight indicator is completely static */
        .ai-insight-indicator,
        .ai-insight-indicator * {
            animation: none !important;
            transform: none !important;
        }

        .ai-insight-indicator {
            transform-origin: center center;
        }

        .ai-insight-indicator:hover {
            /* No transform to prevent movement */
            filter: drop-shadow(0 4px 8px rgba(83, 58, 253, 0.4));
        }



        @keyframes aiInsightGlow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* Data points animation */
        .data-point, .hover-area {
            opacity: 0.5;
            animation: fadeInDataPoints 0.3s ease-out 0.6s forwards;
        }

        @keyframes fadeInDataPoints {
            to {
                opacity: 1;
            }
        }

        /* Payment Lifecycle Optimization Styles */
        .lifecycle-header {
            margin-bottom: 32px;
        }

        .lifecycle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .lifecycle-subtitle {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: -10px 0 0 0;
        }

        /* Waterfall Chart Styles */
        .waterfall-chart {
            background: white;
            padding: 0;
            margin-bottom: 72px;
            width: 100%;
        }

        .waterfall-header {
            margin-bottom: 24px;
        }

        .waterfall-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .waterfall-header p {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0;
        }

        .waterfall-container {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex: 1;
            gap: 8px;
        }

        .waterfall-bar {
            width: 100%;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 4px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            min-height: 40px;
        }

        .waterfall-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .bar-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: center;
            line-height: 1.2;
        }

        .bar-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-gray-700);
            text-align: center;
        }

        .waterfall-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: center;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .waterfall-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .detail-value {
            font-size: 20px !important;
            color: var(--color-gray-600);
            text-align: center;
        }

        .detail-rate {
            font-size: 12px;
            color: var(--color-gray-500);
            text-align: center;
        }

        .waterfall-item.starting .waterfall-bar {
            background: #3B82F6;
        }

        .waterfall-item.positive .waterfall-bar {
            background: #10B981;
        }

        .waterfall-item.negative .waterfall-bar {
            background: #EF4444;
        }

        .waterfall-item.total .waterfall-bar {
            background: #533AFD;
        }

        .waterfall-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-gray-200);
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--color-gray-50);
            border-radius: 8px;
        }

        .summary-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .summary-icon.positive {
            background: #10B981;
        }

        .summary-icon.negative {
            background: #EF4444;
        }

        .summary-icon.neutral {
            background: #533AFD;
        }

        .summary-content {
            flex: 1;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gray-900);
            line-height: 1.2;
        }

        .summary-label {
            font-size: 12px;
            color: var(--color-gray-600);
            margin-top: 2px;
        }

        .lifecycle-flow {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .lifecycle-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .stage-icon {
            width: 48px;
            height: 48px;
            background: var(--color-gray-100);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stage-content {
            flex: 1;
        }

        .stage-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .stage-description {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .stage-health {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stage-health.good .health-indicator {
            background: #22C55E;
        }

        .stage-health.warning .health-indicator {
            background: #F59E0B;
        }

        .stage-health.poor .health-indicator {
            background: #EF4444;
        }

        .health-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .stage-connector {
            display: flex;
            align-items: center;
            color: var(--color-gray-400);
        }

        /* Performance Snapshot Styles */
        .performance-snapshot {
            background: white;
            padding: 0;
            margin-bottom: 72px;
        }

        .snapshot-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 20px 0;
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .snapshot-card {
            background: white;
            border: 1px solid var(--color-gray-100);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.15s;
        }

        .snapshot-card:hover {
            box-shadow: 2px 5px 7px 0px rgba(214,17,17,0.06),-1px 0px 10px 0px rgba(187,175,255,0.34);
        }

        .performance-stat-card:hover {
            box-shadow: 2px 5px 7px 0px rgba(214,17,17,0.06),-1px 0px 10px 0px rgba(187,175,255,0.34);
        }

        .snapshot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .snapshot-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .snapshot-card-value {
            font-size: 16px !important;
            font-weight: 600;
            color: var(--color-purple-500);
        }

        .snapshot-chart-container {
            padding: 0;
        }

        .snapshot-chart-content {
            position: relative;
            height: 200px;
            margin-bottom: 24px;
            width: 100%;
            padding: 0;
        }

        .snapshot-chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 8px;
        }

        .snapshot-chart-area {
            position: absolute;
            top: 0;
            left: 30px;
            right: 0;
            bottom: 30px;
            background: white;
            border: none;
            outline: none;
            padding: 0;
        }

        .snapshot-chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px);
            background-size: 100% 25%;
            opacity: 0.3;
        }

        .snapshot-chart-bars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .snapshot-chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        .snapshot-chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -30px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 40px;
            padding-right: 40px;
        }

        /* Impact Quantification Styles */
        .impact-quantification {
            margin-bottom: 32px;
        }

        .impact-card {
            background: white;
            padding: 24px;
        }

        .impact-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .impact-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .impact-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .impact-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .impact-label {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .impact-value {
            font-size: 24px;
            font-weight: 700;
        }

        .impact-metric.positive .impact-value {
            color: #22C55E;
        }

        .impact-metric.negative .impact-value {
            color: #EF4444;
        }

        .impact-period {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .impact-calculator-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--color-purple-500);
            border-radius: 8px;
            background: var(--color-purple-500);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .impact-calculator-btn:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Optimization Opportunities Styles */
        .optimization-opportunities {
            margin-bottom: 72px;
        }

        .opportunities-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .opportunities-title-section {
            flex: 1;
        }

        .opportunities-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .opportunities-subtitle {
            font-size: 12px;
            color: var(--color-gray-600);
            margin: -10px 0 0 0;
        }

        .view-all-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            color: var(--color-purple-500);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .view-all-link:hover {
            background: var(--color-purple-50);
            color: var(--color-purple-600);
        }

        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .opportunity-card {
            background: white;
            padding: 24px;
            transition: all 0.15s;
        }

        .opportunity-card:hover {
            background: var(--color-gray-50);
        }

        .opportunity-card.high-priority {
            border-left: 4px solid #22C55E;
        }

        .opportunity-card.medium-priority {
            border-left: 4px solid #F59E0B;
        }

        .opportunity-card.complex {
            border-left: 4px solid #EF4444;
        }

        .opportunity-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .opportunity-icon {
            width: 48px;
            height: 48px;
            background: var(--color-gray-100);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .opportunity-meta {
            flex: 1;
        }

        .opportunity-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .opportunity-impact {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .impact-value {
            font-size: 16px;
            font-weight: 700;
            color: #22C55E;
        }

        .impact-label {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .opportunity-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .detail-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .effort-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .effort-badge.easy {
            background: #DCFCE7;
            color: #166534;
        }

        .effort-badge.medium {
            background: #FEF3C7;
            color: #92400E;
        }

        .effort-badge.complex {
            background: #FEE2E2;
            color: #991B1B;
        }

        .opportunity-actions {
            display: flex;
            gap: 12px;
        }

        .implement-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: white;
            color: var(--color-gray-700);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .implement-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .implement-btn.primary {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .implement-btn.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Experiments Styles */
        .ab-testing-section {
            margin-bottom: 72px;
        }

        .ab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .ab-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .new-test-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 1px solid var(--color-purple-500);
            border-radius: 6px;
            background: var(--color-purple-500);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-test-btn:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        .ab-tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .ab-test-card {
            background: white;
            padding: 24px;
            transition: all 0.15s;
        }

        .ab-test-card:hover {
            background: var(--color-gray-50);
        }

        .ab-test-card.active {
            border-left: 4px solid #22C55E;
        }

        .ab-test-card.completed {
            border-left: 4px solid #3B82F6;
        }

        .test-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .test-status.active .status-dot {
            background: #22C55E;
        }

        .test-status.completed .status-dot {
            background: #3B82F6;
        }

        .status-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .test-meta {
            flex: 1;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .test-description {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0;
        }

        .test-progress {
            margin-bottom: 20px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 14px;
            color: var(--color-gray-600);
        }

        .progress-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .progress-bar {
            height: 6px;
            background: var(--color-gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-purple-500);
            border-radius: 3px;
        }

        .test-results {
            margin-bottom: 20px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-row.winner {
            background: #F0FDF4;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 0 -12px;
        }

        .variant-label {
            font-size: 14px;
            color: var(--color-gray-700);
        }

        .variant-rate {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .improvement {
            font-size: 12px;
            font-weight: 500;
            color: #22C55E;
        }

        .test-actions {
            display: flex;
            gap: 12px;
        }

        .test-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .test-action-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        /* Progress Timeline Styles */
        .progress-timeline {
            margin-bottom: 48px;
        }

        .timeline-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .timeline-subtitle {
            font-size: 12px;
            color: var(--color-gray-600);
            margin: -10px 0 16px 0;
        }

        .timeline-container {
            position: relative;
            padding-left: 24px;
        }



        .timeline-event {
            position: relative;
            margin-bottom: 16px;
        }

        .timeline-event:last-child {
            margin-bottom: 0;
        }

        .event-marker {
            position: absolute;
            left: -24px;
            top: 20px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .event-marker.completed {
            background: #22C55E;
        }

        .event-marker.active {
            background: var(--color-purple-500);
        }

        .event-marker.future {
            background: var(--color-gray-300);
        }

        .event-content {
            background: white;
            padding: 16px;
            margin-left: 12px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .event-date {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .event-description {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .event-impact {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .impact-label {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .impact-value {
            font-size: 10px;
            font-weight: 500;
            color: var(--color-gray-900);
        }
        
        .timeline-event .event-impact .impact-value {
            font-size: 20px !important;
            font-weight: 700 !important;
            color: var(--color-gray-900) !important;
        }

        /* Right Column Additional Styles */
        .performance-insights {
            margin-bottom: 24px;
        }

        .insights-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 16px 0;
        }

        .insight-card {
            background: transparent;
            padding: 12px 0;
            margin-bottom: 8px;
            margin-left: 0;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .insight-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-600);
        }

        .insight-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 4px;
        }

        .insight-description {
            font-size: 12px;
            color: var(--color-gray-600);
        }

        .insight-description-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .learn-more-link {
            font-size: 11px;
            color: var(--color-purple-500);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.15s;
        }

        .learn-more-link:hover {
            color: var(--color-purple-600);
            text-decoration: underline;
        }

        .quick-actions {
            margin-bottom: 24px;
        }

        .actions-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 16px 0;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 0;
            background: transparent;
            color: var(--color-gray-700);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 6px;
            margin-left: 0;
        }

                .quick-action-btn:last-child {
            margin-bottom: 0;
        }

        .action-btn.secondary {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
        }

        .action-btn.secondary:hover {
            background: var(--color-gray-200);
        }

        .ai-insights-section {
            margin-bottom: 48px;
        }

        .ai-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .ai-insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-insight-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .ai-insight-text {
            font-size: 14px;
            color: var(--color-gray-700);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .ai-insight-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--color-purple-500);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .ai-insight-btn:hover {
            background: var(--color-purple-600);
        }

        /* Funnel Chart Styles */
        .funnel-chart {
            margin-bottom: 32px;
            background: white;
            padding: 24px;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 8px;
            background: var(--color-gray-50);
            transition: all 0.15s;
        }

        .funnel-stage:hover {
            background: var(--color-gray-100);
            transform: translateX(4px);
        }

        .funnel-stage:last-child {
            margin-bottom: 0;
        }

        .funnel-visual {
            flex: 0 0 120px;
            position: relative;
        }

        .funnel-bar {
            height: 40px;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .funnel-bar:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .funnel-label {
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .funnel-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .funnel-icon {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .funnel-details {
            flex: 1;
        }

        .funnel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .funnel-description {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .funnel-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .funnel-metrics .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gray-900);
        }

        .funnel-metrics .metric-label {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .funnel-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .funnel-status.good {
            background: #DCFCE7;
            color: #166534;
        }

        .funnel-status.warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .funnel-status.critical {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .funnel-connector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0 8px 140px;
            padding: 8px 16px;
            background: var(--color-gray-100);
            border-radius: 6px;
            border-left: 3px solid var(--color-gray-300);
        }

        .connector-line {
            flex: 1;
            height: 2px;
            background: var(--color-gray-300);
            position: relative;
        }

        .connector-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -2px;
            width: 0;
            height: 0;
            border-left: 6px solid var(--color-gray-300);
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
        }

        .connector-loss {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 60px;
        }

        .loss-amount {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-700);
        }

        .loss-label {
            font-size: 10px;
            color: var(--color-gray-500);
        }

        .funnel-summary {
            margin-bottom: 72px;
        }

        .summary-card {
            background: white;
            padding: 0;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            width: 100%;
            min-width: 0;
        }

        .summary-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--color-gray-50);
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .summary-stat .stat-value {
            display: block;
            font-size: 20px !important;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 2px;
        }

        .summary-stat .stat-label {
            font-size: 11px;
            color: var(--color-gray-600);
        }

        /* Table Styles */
        .opportunities-table-container,
        .ab-tests-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .opportunities-table,
        .ab-tests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .opportunities-table thead,
        .ab-tests-table thead {
            background: white;
        }

        .opportunities-table th,
        .ab-tests-table th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--color-gray-700);
            border-bottom: 1px solid var(--color-gray-200);
            font-size: 13px;
        }

        .opportunities-table td,
        .ab-tests-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--color-gray-100);
            vertical-align: top;
        }

        .opportunities-table tbody tr:hover,
        .ab-tests-table tbody tr:hover {
            background: white;
        }

        .opportunities-table tbody tr:last-child td,
        .ab-tests-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Opportunity Table Specific Styles */
        .opportunity-cell {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .opportunity-icon {
            width: 32px;
            height: 32px;
            background: var(--color-gray-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .opportunity-info {
            flex: 1;
        }

        .opportunity-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 4px;
        }

        .opportunity-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .impact-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .impact-value {
            font-size: 16px;
            font-weight: 700;
            color: #22C55E;
        }

        .impact-label {
            font-size: 11px;
            color: var(--color-gray-500);
        }

        .revenue-impact {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .effort-detail {
            font-size: 11px;
            color: var(--color-gray-500);
            margin-top: 2px;
        }

        .implementation-time {
            font-size: 14px;
            color: var(--color-gray-700);
        }

        /* Experiments Table Specific Styles */
        .test-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .test-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .test-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .status-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-cell.active .status-dot {
            background: #22C55E;
        }

        .status-cell.completed .status-dot {
            background: #3B82F6;
        }

        .status-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .progress-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-bar {
            height: 4px;
            background: var(--color-gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-purple-500);
            border-radius: 2px;
        }

        .progress-text {
            font-size: 11px;
            color: var(--color-gray-500);
        }

        .rate-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .rate-value.winner {
            color: var(--color-gray-900);
        }

        .improvement {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .table-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-300);
        }

        .table-btn.primary {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .table-btn.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Priority Indicators */
        .opportunities-table tr.high-priority {
            border-left: none;
        }

        .opportunities-table tr.medium-priority {
            border-left: none;
        }

        .ab-tests-table tr.active {
            border-left: none;
        }

        .ab-tests-table tr.completed {
            border-left: none;
        }

        /* Tab Content Styles */
        .tab-content {
            display: none;
        }

        /* Color variables for optimization page */
        :root {
            --color-green-500: #22C55E;
            --color-blue-500: #3B82F6;
            --color-orange-500: #F59E0B;
        }

        /* Optimization tab specific styles */
        .optimization-tab-content {
            width: 100%;
            background: white;
            min-height: 100vh;
            display: block;
        }

        .optimization-tab-content .two-column-layout {
            display: grid !important;
            grid-template-columns: 70% 30% !important;
            gap: 24px !important;
            margin-top: 48px;
            width: 100%;
            align-items: start;
            height: 100%;
        }

        .optimization-tab-content .left-column,
        .optimization-tab-content .right-column {
            padding: 0;
            overflow: visible;
            overflow-x: auto;
            min-width: 0;
            height: 100%;
            display: block;
            box-sizing: border-box;
            float: none !important;
            clear: none !important;
        }

        .optimization-tab-content .left-column {
            grid-column: 1;
        }

        .optimization-tab-content .right-column {
            grid-column: 2;
        }
    </style>
</head>
<body>
<div class="flex">
    <aside class="sidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="sidebar-logo">S</div>
            <span class="sidebar-title">Stripe Shop</span>
            <i data-lucide="chevron-down" class="sidebar-dropdown"></i>
        </div>
        <!-- Main Navigation -->
        <nav class="nav-section">
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="home" class="nav-item-icon"></i>
                    Home
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="list" class="nav-item-icon"></i>
                    Balances
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="repeat" class="nav-item-icon"></i>
                    Transactions
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="user" class="nav-item-icon"></i>
                    Customers
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="box" class="nav-item-icon"></i>
                    Product catalog
                </a>
            </div>
        </nav>
        <!-- Shortcuts -->
        <div class="nav-section">
            <div class="nav-section-title">Shortcuts</div>
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="wand-2" class="nav-item-icon"></i>
                    Radar
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Orchestration
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Sigma
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Custom metrics
                </a>
            </div>
        </div>
        <!-- Products -->
        <div class="nav-section">
            <div class="nav-section-title">Products</div>
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="layers" class="nav-item-icon"></i>
                    Connect
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="wallet" class="nav-item-icon"></i>
                    Payments
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <div class="nav-sub-list">
                    <a class="nav-sub-item active" href="#">Analytics</a>
                    <a class="nav-sub-item" href="#">Orchestration</a>
                    <a class="nav-sub-item" href="#">Disputes</a>
                    <a class="nav-sub-item" href="#">Radar</a>
                    <a class="nav-sub-item" href="#">Payment Links</a>
                    <a class="nav-sub-item" href="#">Terminal</a>
                </div>
                <a class="nav-item" href="#">
                    <i data-lucide="file-text" class="nav-item-icon"></i>
                    Billing
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="bar-chart-2" class="nav-item-icon"></i>
                    Reporting
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="more-horizontal" class="nav-item-icon"></i>
                    More
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
            </div>
        </div>
        <!-- Footer -->
        <div class="sidebar-footer">
            <a class="footer-item" href="#">
                <i data-lucide="code-2" class="footer-icon"></i>
                Developers
            </a>
        </div>
    </aside>
    <!-- Main content placeholder -->
    <main class="flex-1 bg-white flex flex-col">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-inner">
                <div class="search-container">
                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" placeholder="Search" class="search-input">
                </div>
                <div class="top-right-controls">
                    <div class="icon-group">
                        <button class="icon-btn">
                            <i data-lucide="square" class="icon"></i>
                        </button>
                        <button class="icon-btn">
                            <i data-lucide="star" class="icon"></i>
                        </button>
                        <button class="icon-btn">
                            <i data-lucide="grid-3x3" class="icon"></i>
                        </button>
                    </div>
                    <div class="standalone-icons">
                        <button class="standalone-icon-btn">
                            <i data-lucide="help-circle" class="icon"></i>
                        </button>
                        <button class="standalone-icon-btn notification-btn">
                            <i data-lucide="bell" class="icon"></i>
                            <div class="notification-dot"></div>
                        </button>
                        <button class="standalone-icon-btn">
                            <i data-lucide="settings" class="icon"></i>
                        </button>
                    </div>
                    <button class="new-btn">
                        <i data-lucide="plus" class="new-icon"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-content-inner">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Payments analytics</h1>
                <button class="share-feedback-btn">
                    Share feedback
                </button>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTabView('acceptance')">Acceptance</button>
                <button class="nav-tab" onclick="switchTabView('authentication')">Authentication</button>
                <button class="nav-tab" onclick="switchTabView('disputes')">Disputes</button>
                <button class="nav-tab" onclick="switchTabView('payment methods')">Payment methods</button>
                <button class="nav-tab" onclick="switchTabView('optimization')">Optimization</button>
            </div>
            
            <!-- Filter Section Row 1 -->
            <div class="filter-row">
                <div class="date-range-dropdown">
                    <button class="filter-btn dropdown-trigger" id="dateRangeDropdown">
                        Last 90 days
                        <i data-lucide="chevron-down" class="filter-icon"></i>
                    </button>
                    <div class="dropdown-menu" id="dateRangeMenu">
                        <div class="dropdown-item" data-range="7">Last 7 days</div>
                        <div class="dropdown-item" data-range="30">Last 30 days</div>
                        <div class="dropdown-item" data-range="60">Last 60 days</div>
                        <div class="dropdown-item active" data-range="90">Last 90 days</div>
                        <div class="dropdown-item" data-range="180">Last 6 months</div>
                    </div>
                </div>
                <button class="filter-btn">
                    Deduplicated
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
                <button class="filter-btn">
                    Payment success rate
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
                <button class="filter-btn">
                    Include connected accounts
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
            </div>
            
            <!-- Filter Section Row 2 -->
            <div class="filter-row">
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Processor
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card type
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card country
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card brand
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Interaction type
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    More filters
                </button>
            </div>
            
            <!-- Separator Line -->
            <div class="separator"></div>
            
            <!-- Two Column Layout -->
            <div class="two-column-layout">
                <!-- Left Column: Payment Analytics -->
                <div class="left-column">
                    <!-- Key Metrics Header -->
                    <div class="metrics-header">
                        <h2 class="metrics-title">Key metrics for cards</h2>
                        <div class="metrics-controls">
                            <div class="comparison-controls">
                                <span class="compared-to">Compared to</span>
                                <button class="comparison-dropdown">
                                    Previous month
                                    <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                </button>
                            </div>
                            <span class="date-range">Mar 23 - Jun 17</span>
                            <button class="download-btn">
                                <i data-lucide="download" class="download-icon"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <!-- Key Metrics Cards -->
                    <div class="metrics-grid">
                        <div class="metric-card selected">
                            <div class="metric-header">
                                <span class="metric-label">Payment success rate</span>
                            </div>
                            <div class="metric-value">63.27%</div>
                            <div class="metric-change positive">+3.27%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Accepted volume</span>
                            </div>
                            <div class="metric-value">$33.03</div>
                            <div class="metric-change positive">+48.12%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Accepted payments</span>
                            </div>
                            <div class="metric-value">31</div>
                            <div class="metric-change positive">+72.22%</div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>100%</span>
                                <span>75%</span>
                                <span>50%</span>
                                <span>25%</span>
                                <span>0%</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="M80,150 L200,120 L320,130 L440,110 L560,120 L680,100 L720,110" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="M80,120 L200,100 L320,110 L440,90 L560,100 L680,80 L720,90" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- AI-optimized performance line (green) -->
                                        <path d="M80,80 L200,60 L320,70 L440,50 L560,60 L680,40 L720,50" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    <span>Apr 20</span>
                                    <span>May 4</span>
                                    <span>May 18</span>
                                    <span>Jun 1</span>
                                    <span>Jun 15</span>
                                    <span>Jun 29</span>
                                    <span>Jul 13</span>
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                    <span id="legend-current-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                    <span id="legend-baseline-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color optimized"></div>
                                    <span>AI-optimized potential</span>
                                    <span id="legend-optimized-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Payments Breakdown Section -->
                    <div class="breakdown-section">
                        <div class="breakdown-header">
                            <div class="breakdown-title-section">
                                <h3 class="breakdown-title">Card payments breakdown</h3>
                                <p class="breakdown-subtitle">Review card acceptance by different attributes. Includes blocked and failed payments, and payments that didn't complete 3D Secure authentication.</p>
                            </div>
                            <div class="breakdown-controls">
                                <div class="breakdown-filters">
                                    <button class="breakdown-filter-btn active" data-metric="volume">Payment volume</button>
                                    <button class="breakdown-filter-btn" data-metric="payments">Payments</button>
                                    <button class="breakdown-filter-btn" data-metric="share">Share of payments</button>
                                    <button class="breakdown-filter-btn" data-metric="success">Success rate</button>
                                </div>
                                <div class="breakdown-dropdowns">
                                    <button class="dropdown-btn">
                                        Card type
                                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                    </button>
                                    <button class="download-btn">
                                        <i data-lucide="download" class="download-icon"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown-total">
                            <div class="total-label">
                                <span id="metric-label">Payment volume</span>
                                <i data-lucide="info" class="info-icon" style="width: 14px; height: 14px; color: var(--color-gray-400);"></i>
                            </div>
                            <span class="total-value" id="metric-value">$642.57</span>
                        </div>
                        
                        <!-- Bar Chart Container -->
                        <div class="bar-chart-container">
                            <div class="bar-chart-content">
                                <div class="bar-chart-y-axis">
                                    <span>$240</span>
                                    <span>$180</span>
                                    <span>$120</span>
                                    <span>$60</span>
                                    <span>$0</span>
                                </div>
                                <div class="bar-chart-area">
                                    <div class="bar-chart-grid"></div>
                                    <div class="bar-chart-bars">
                                        <svg class="bar-chart-svg" viewBox="0 0 800 200">
                                            <!-- Default bar groups - will be updated by JavaScript -->
                                            <g class="bar-group" transform="translate(80, 0)">
                                                <rect x="0" y="80" width="20" height="100" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="120" width="20" height="60" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(200, 0)">
                                                <rect x="0" y="60" width="20" height="120" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="100" width="20" height="80" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(320, 0)">
                                                <rect x="0" y="100" width="20" height="80" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="140" width="20" height="40" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(440, 0)">
                                                <rect x="0" y="120" width="20" height="60" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="160" width="20" height="20" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(560, 0)">
                                                <rect x="0" y="90" width="20" height="90" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="130" width="20" height="50" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(680, 0)">
                                                <rect x="0" y="70" width="20" height="110" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="110" width="20" height="70" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(720, 0)">
                                                <rect x="0" y="50" width="20" height="130" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="90" width="20" height="90" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="bar-chart-x-axis">
                                        <span>Apr 20</span>
                                        <span>May 4</span>
                                        <span>May 18</span>
                                        <span>Jun 1</span>
                                        <span>Jun 15</span>
                                        <span>Jun 29</span>
                                        <span>Jul 13</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bar-chart-footer">
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-header">
                                            <input type="checkbox" checked>
                                        </th>
                                        <th>Card type</th>
                                        <th>Payment volume</th>
                                        <th>Payments</th>
                                        <th>Share of payments</th>
                                        <th>Success rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Credit card</td>
                                        <td>$239.13</td>
                                        <td>43</td>
                                        <td>87.76%</td>
                                        <td>65.12%</td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Debit card</td>
                                        <td>$402.94</td>
                                        <td>5</td>
                                        <td>10.20%</td>
                                        <td>40.00%</td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Prepaid card</td>
                                        <td>$0.50</td>
                                        <td>1</td>
                                        <td>2.04%</td>
                                        <td>100.00%</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td></td>
                                        <td style="font-weight: 700;">Total</td>
                                        <td style="font-weight: 700;">$642.57</td>
                                        <td style="font-weight: 700;">49</td>
                                        <td style="font-weight: 700;">100.00%</td>
                                        <td style="font-weight: 700;">63.27%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Failed Card Payments Section -->
                    <div class="breakdown-section">
                        <div class="breakdown-header">
                            <div class="breakdown-title-section">
                                <h3 class="breakdown-title">Failed card payments</h3>
                                <p class="breakdown-subtitle">Find out why card payments failed. <a href="#" style="color: var(--color-purple-500); text-decoration: none;">Learn more about decline codes</a>.</p>
                            </div>
                            <div class="breakdown-controls">
                                <div class="breakdown-filters">
                                    <button class="breakdown-filter-btn active" data-metric="failed-volume">Failed volume</button>
                                    <button class="breakdown-filter-btn" data-metric="failed-count">Failed</button>
                                    <button class="breakdown-filter-btn" data-metric="share-failures">Share of failures</button>
                                    <button class="breakdown-filter-btn" data-metric="failure-rate">Failure rate</button>
                                </div>
                                <div class="breakdown-dropdowns">
                                    <button class="dropdown-btn">
                                        Blocked and 6 more
                                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                    </button>
                                    <button class="download-btn">
                                        <i data-lucide="download" class="download-icon"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown-total">
                            <div class="total-label">
                                <span id="failed-metric-label">Failed payment volume</span>
                                <i data-lucide="info" class="info-icon" style="width: 14px; height: 14px; color: var(--color-gray-400);"></i>
                            </div>
                            <span class="total-value" id="failed-metric-value">$609.54</span>
                        </div>
                        
                        <!-- Bar Chart Container -->
                        <div class="bar-chart-container">
                            <div class="bar-chart-content">
                                <div class="bar-chart-y-axis">
                                    <span>$200</span>
                                    <span>$150</span>
                                    <span>$100</span>
                                    <span>$50</span>
                                    <span>$0</span>
                                </div>
                                <div class="bar-chart-area">
                                    <div class="bar-chart-grid"></div>
                                    <div class="bar-chart-bars">
                                        <svg class="bar-chart-svg" viewBox="0 0 800 200">
                                            <!-- Default failed payment bars - will be updated by JavaScript -->
                                            <g class="bar-group" transform="translate(80, 0)">
                                                <rect x="0" y="180" width="25" height="20" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(200, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(320, 0)">
                                                <rect x="0" y="10" width="25" height="190" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(440, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(560, 0)">
                                                <rect x="0" y="155" width="25" height="45" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(680, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(720, 0)">
                                                <rect x="0" y="10" width="25" height="190" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="bar-chart-x-axis">
                                        <span>Apr 20</span>
                                        <span>May 4</span>
                                        <span>May 18</span>
                                        <span>Jun 1</span>
                                        <span>Jun 15</span>
                                        <span>Jun 29</span>
                                        <span>Jul 13</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-footer">
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reason</th>
                                        <th>Failed volume</th>
                                        <th>Failed count</th>
                                        <th>Share of failures</th>
                                        <th>Failure rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check" class="reason-icon"></i>
                                                Stripe
                                            </div>
                                        </td>
                                        <td>$609.54</td>
                                        <td>18</td>
                                        <td>100.00%</td>
                                        <td>36.73%</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check" class="reason-icon"></i>
                                                Bank
                                            </div>
                                        </td>
                                        <td>$0.00</td>
                                        <td>0</td>
                                        <td>0.00%</td>
                                        <td>0.00%</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td>Total</td>
                                        <td>$609.54</td>
                                        <td>18</td>
                                        <td>100.00%</td>
                                        <td>36.73%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Assistant and Resources -->
                <div class="right-column">
                    <!-- Ask Assistant Section -->
                    <div class="assistant-section">
                        <div class="assistant-header">
                            <i data-lucide="sparkles" class="sparkles-icon"></i>
                            <h3 class="assistant-title">Ask Assistant</h3>
                        </div>
                        <div class="suggested-prompts">
                            <button class="prompt-btn" id="prompt-1">
                                Why is my payment success rate lower than last month?
                            </button>
                            <button class="prompt-btn" id="prompt-2">
                                Which card types have the highest failure rates?
                            </button>
                            <button class="prompt-btn" id="prompt-3">
                                How can I improve my authorization rate?
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resources Section -->
                    <div class="resources-section">
                        <h3 class="resources-title">Resources</h3>
                        <div class="resource-item">
                            <i data-lucide="file-text" class="resource-icon"></i>
                            <div class="resource-content">
                                <span class="resource-name">Acceptance analytics</span>
                                <span class="resource-description">Learn more about analyzing your card payments acceptance.</span>
                            </div>
                        </div>
                        <div class="resource-subsection">
                            <span class="subsection-title">View other payment reports</span>
                            <div class="resource-link">
                                <i data-lucide="arrow-right" class="arrow-icon"></i>
                                <span>Network costs</span>
                            </div>
                            <div class="resource-link">
                                <i data-lucide="arrow-right" class="arrow-icon"></i>
                                <span>Radar analytics</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
    </main>
</div>

<!-- Chart Tooltip -->
<div class="chart-tooltip" id="chartTooltip">
    <div class="tooltip-header" id="tooltipHeader">Data Point</div>
    <div class="tooltip-data" id="tooltipData">
        <!-- Data will be populated dynamically -->
    </div>
    <div class="tooltip-actions">
        <button class="tooltip-ask-btn" id="tooltipAskBtn">
            <i data-lucide="sparkles" style="width: 10px; height: 10;"></i>
            Ask Assistant
        </button>
    </div>
</div>

<script>
    lucide.createIcons();
    
    // Test function to verify JavaScript is working
    console.log('JavaScript loaded successfully');
    
    // Chart Tooltip Functionality
    let currentTooltipData = null;
    let tooltipTimeout = null;
    let lastHoverIndex = null;
    let isHovering = false;
    let lastHoverTime = 0;
    let tooltipPosition = { x: 0, y: 0 }; // Store last tooltip position
    
    function initializeChartTooltips() {
        const tooltip = document.getElementById('chartTooltip');
        const tooltipAskBtn = document.getElementById('tooltipAskBtn');
        
        if (!tooltip || !tooltipAskBtn) {
            console.error('Tooltip elements not found');
            return;
        }
        
        console.log('Tooltip elements found:', { tooltip, tooltipAskBtn });
        
        // Add click handler for the "Ask Assistant" button
        tooltipAskBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Ask Assistant button clicked');
            console.log('currentTooltipData:', currentTooltipData);
            console.log('Tooltip visible:', tooltip.classList.contains('visible'));
            
            // Add visual feedback
            this.style.backgroundColor = '#533AFD';
            this.style.color = 'white';
            setTimeout(() => {
                this.style.backgroundColor = '';
                this.style.color = '';
            }, 200);
            
            // Check if tooltip is visible and has data
            if (!tooltip.classList.contains('visible')) {
                console.log('Tooltip not visible, but continuing with available data');
            }
            
            if (currentTooltipData) {
                console.log('Processing tooltip data:', currentTooltipData);
                
                // Ensure all required properties are present
                const tooltipData = {
                    ...currentTooltipData,
                    dateRange: currentTooltipData.dateRange || document.getElementById('dateRangeDropdown').textContent.trim(),
                    payments: currentTooltipData.payments || 0,
                    metric: currentTooltipData.metric || 'Performance',
                    value: currentTooltipData.value || currentTooltipData.current
                };
                
                console.log('Enhanced tooltip data:', tooltipData);
                
                // Determine if this is the sparkle icon (AI insight)
                const chartArea = document.querySelector('.chart-area');
                const barChartArea = document.querySelector('.bar-chart-area');
                const failedChartArea = document.querySelector('.breakdown-section:last-child .bar-chart-area');
                let chartType = 'main chart';
                let topic = 'data-analysis';
                let question = '';
                
                // Check for AI insight (sparkle) context
                let isAIInsight = false;
                let aiRecommendation = '';
                if (typeof tooltipData.dataIndex !== 'undefined') {
                    // Recompute insightIndex for the current chart
                    let chartData = null;
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        chartData = new RealisticDataGenerator(currentBusinessType, tooltipData.dateRange).generateMainChartData();
                    } else if (barChartArea && !failedChartArea) {
                        chartData = new RealisticDataGenerator(currentBusinessType, tooltipData.dateRange).generateBreakdownData();
                    }
                    if (chartData) {
                        const insightIndex = findHighestChangePoint(chartData);
                        isAIInsight = tooltipData.dataIndex === insightIndex;
                    }
                }
                // If this is the sparkle icon, use the stored insight and recommendation
                if (isAIInsight && chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                    // Use the stored insight and recommendation from the tooltip
                    const storedData = window.currentHoverData;
                    if (storedData && storedData.insight && storedData.recommendation) {
                        question = `I'm looking at the AI insight for ${tooltipData.date} (${tooltipData.dateRange}) and want to learn more`;
                    } else {
                        // Fallback to computed recommendation
                        const currentPercent = parseFloat(tooltipData.current);
                        const baselinePercent = parseFloat(tooltipData.baseline);
                        const optimizedPercent = parseFloat(tooltipData.optimized);
                        const optimizationGap = optimizedPercent - currentPercent;
                        if (optimizationGap > 8) {
                            aiRecommendation = 'Enable Link authentication and optimize your 3D Secure settings to capture this significant improvement.';
                        } else if (optimizationGap > 5) {
                            aiRecommendation = 'Review your fraud detection rules and consider adding Apple Pay/Google Pay to reduce authentication friction.';
                        } else if (optimizationGap > 2) {
                            aiRecommendation = 'Optimize your payment form and enable saved payment methods to reduce checkout friction.';
                        } else if (optimizationGap > 0) {
                            aiRecommendation = 'Review Radar rules and expand fraud detection coverage to capture this improvement.';
                        } else {
                            aiRecommendation = 'Excellent work! Consider expanding to new payment methods to capture additional revenue.';
                        }
                        question = `What specific steps should I take to achieve the AI-optimized potential for ${tooltipData.date} (${tooltipData.dateRange})? The AI recommendation is: ${aiRecommendation}`;
                    }
                    topic = 'ai-insight';
                } else if (isAIInsight && barChartArea && !failedChartArea) {
                    // Bar chart AI insight - use stored insight and recommendation
                    const storedData = window.currentHoverData;
                    if (storedData && storedData.insight && storedData.recommendation) {
                        question = `I'm looking at the AI insight for ${tooltipData.date} (${tooltipData.dateRange}) and want to learn more`;
                    } else {
                        // Fallback
                        aiRecommendation = 'Review your payment method mix to optimize for lower fees.';
                        question = `How can I act on the AI insight for ${tooltipData.date} (${tooltipData.dateRange})? The AI recommendation is: ${aiRecommendation}`;
                    }
                    topic = 'bar-chart-insight';
                } else {
                    // Default/fallback logic
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        chartType = 'authorization rate chart';
                        topic = 'success-rate';
                        question = `I'm looking to learn about the authorization rate performance for ${tooltipData.date} (${tooltipData.dateRange}). The current rate is ${tooltipData.current}, baseline is ${tooltipData.baseline}, and AI-optimized potential is ${tooltipData.optimized}. Can you help me understand what's driving these numbers and how to improve them?`;
                    } else if (barChartArea && !failedChartArea) {
                        chartType = 'payment volume breakdown chart';
                        topic = 'optimization';
                        question = `I'm looking to learn about payment volume performance for ${tooltipData.date} (${tooltipData.dateRange}). Credit card volume is ${tooltipData.creditVolume} with ${tooltipData.creditPayments} payments, and debit card volume is ${tooltipData.debitVolume} with ${tooltipData.debitPayments} payments. Can you help me understand the payment mix and optimization opportunities?`;
                    } else if (failedChartArea) {
                        chartType = 'failed payments chart';
                        topic = 'failure-analysis';
                        question = `I'm looking to learn about failed payment performance for ${tooltipData.date} (${tooltipData.dateRange}). Failed volume is ${tooltipData.failedVolume} with ${tooltipData.failedPayments} failed payments and a ${tooltipData.failureRate} failure rate. Can you help me understand what's causing these failures and how to reduce them?`;
                    } else {
                        question = `I'm looking to learn about this data point from the ${chartType}: ${tooltipData.date} - ${tooltipData.metric} ${tooltipData.value} (${tooltipData.dateRange}). Can you help me understand what this data means and how to improve performance?`;
                    }
                }
                
                console.log('Generated question:', question);
                console.log('Topic:', topic);
                
                try {
                    openAIPanel(question, currentBusinessType, topic, tooltipData.value, tooltipData.dateRange, tooltipData.payments);
                    hideTooltip();
                    // Clear the tooltip data after successfully opening the AI panel
                    currentTooltipData = null;
                } catch (error) {
                    console.error('Error opening AI panel:', error);
                    alert('Error opening AI assistant. Please try again.');
                }
            } else {
                console.error('No tooltip data available');
                
                // Try to extract data from the visible tooltip as a fallback
                const tooltipHeader = document.getElementById('tooltipHeader');
                const tooltipDataDiv = document.getElementById('tooltipData');
                
                if (tooltipHeader && tooltipDataDiv && tooltip.classList.contains('visible')) {
                    console.log('Attempting to extract data from visible tooltip');
                    const date = tooltipHeader.textContent;
                    const dataText = tooltipDataDiv.textContent;
                    const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    
                    // Create a contextual question based on the visible data and current chart
                    let question = '';
                    let topic = 'data-analysis';
                    let metric = 85.2; // Default metric
                    
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        // Authorization rate chart
                        topic = 'success-rate';
                        question = `I'm looking at the authorization rate data for ${date} (${dateRange.toLowerCase()}). Can you help me understand what's driving these performance numbers and how to improve them?`;
                    } else if (barChartArea && !failedChartArea) {
                        // Payment volume chart
                        topic = 'optimization';
                        question = `I'm looking at the payment volume breakdown for ${date} (${dateRange.toLowerCase()}). Can you help me understand the payment mix and identify optimization opportunities?`;
                    } else if (failedChartArea) {
                        // Failed payments chart
                        topic = 'failure-analysis';
                        question = `I'm looking at the failed payment data for ${date} (${dateRange.toLowerCase()}). Can you help me understand what's causing these failures and how to reduce them?`;
                    } else {
                        // Fallback
                        question = `I'm looking at the data for ${date} (${dateRange.toLowerCase()}). Can you help me understand this data and provide recommendations for improvement?`;
                    }
                    
                    try {
                        openAIPanel(question, currentBusinessType, topic, metric, dateRange, 0);
                        hideTooltip();
                        currentTooltipData = null;
                    } catch (error) {
                        console.error('Error opening AI panel with fallback data:', error);
                        alert('Error opening AI assistant. Please try hovering over a data point again.');
                    }
                } else {
                    console.log('No tooltip data available, but AI panel should still work');
                    // Try to open AI panel with contextual data based on current chart
                    try {
                        const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                        const generator = new RealisticDataGenerator(currentBusinessType, dateRange);
                        const metrics = generator.getBusinessMetrics();
                        const successRate = 85.2; // Default success rate
                        
                        // Create contextual question based on business type and current chart
                        let question = '';
                        let topic = 'data-analysis';
                        
                        if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                            // Authorization rate chart
                            topic = 'success-rate';
                            question = `How can I improve my ${successRate.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()}?`;
                        } else if (barChartArea && !failedChartArea) {
                            // Payment volume chart
                            topic = 'optimization';
                            const volume = metrics.dailyTransactions * generator.getTimeframeMultipliers().days * 50; // Approximate volume
                            question = `Are my current payment methods limiting my $${volume.toFixed(0)} volume for the ${dateRange.toLowerCase()}?`;
                        } else if (failedChartArea) {
                            // Failed payments chart
                            topic = 'failure-analysis';
                            const failedVolume = metrics.dailyTransactions * generator.getTimeframeMultipliers().days * 2; // Approximate failed volume
                            question = `What's causing my $${Math.round(failedVolume)} in failed payments for the ${dateRange.toLowerCase()} and how can I reduce this?`;
                        } else {
                            // Fallback
                            question = `How can I improve my payment performance for the ${dateRange.toLowerCase()}?`;
                        }
                        
                        openAIPanel(question, currentBusinessType, topic, successRate, dateRange, metrics.dailyTransactions * generator.getTimeframeMultipliers().days);
                        hideTooltip();
                        currentTooltipData = null;
                    } catch (error) {
                        console.error('Error opening AI panel with contextual data:', error);
                    }
                }
            }
        });
        
        // Add hover listeners to chart areas
        addChartHoverListeners();
        
        // Add tooltip hover listeners to keep tooltip open when mouse enters it
        addTooltipHoverListeners();
    }
    
    function addChartHoverListeners() {
        // Use mouseenter/mouseleave for more stable hover detection
        document.addEventListener('mouseenter', function(e) {
            if (e.target && e.target.classList && (e.target.classList.contains('data-point') || e.target.classList.contains('hover-area') || e.target.classList.contains('ai-insight-indicator'))) {
                const index = parseInt(e.target.dataset.index);
                if (!isNaN(index) && index !== lastHoverIndex) {
                    const now = Date.now();
                    
                    // Prevent rapid hover changes (minimum 100ms between hovers)
                    if (now - lastHoverTime < 100) {
                        return;
                    }
                    
                    lastHoverIndex = index;
                    lastHoverTime = now;
                    isHovering = true;
                    
                    if (tooltipTimeout) {
                        clearTimeout(tooltipTimeout);
                    }
                    
                    // Show tooltip immediately for better responsiveness
                    handleDataPointHover(e, index);
                }
            }
        }, true);
        
        document.addEventListener('mouseleave', function(e) {
            if (e.target && e.target.classList && (e.target.classList.contains('data-point') || e.target.classList.contains('hover-area') || e.target.classList.contains('ai-insight-indicator'))) {
                // Check if mouse is moving to the tooltip
                const tooltip = document.getElementById('chartTooltip');
                if (tooltip && tooltip.classList.contains('visible')) {
                    // Don't hide immediately, let the tooltip hover listeners handle it
                    return;
                }
                
                isHovering = false;
                lastHoverIndex = null;
                
                // Add a small delay to prevent flickering when moving between hover areas
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                }
                tooltipTimeout = setTimeout(() => {
                    if (!isHovering) {
                        hideTooltip();
                    }
                }, 500); // Much longer delay for easier interaction
            }
        }, true);
        
        // Also handle mouseover for better compatibility
        document.addEventListener('mouseover', function(e) {
            if (e.target && e.target.classList && (e.target.classList.contains('data-point') || e.target.classList.contains('hover-area') || e.target.classList.contains('ai-insight-indicator'))) {
                const index = parseInt(e.target.dataset.index);
                if (!isNaN(index) && index !== lastHoverIndex) {
                    const now = Date.now();
                    if (now - lastHoverTime < 100) {
                        return;
                    }
                    
                    lastHoverIndex = index;
                    lastHoverTime = now;
                    isHovering = true;
                    
                    if (tooltipTimeout) {
                        clearTimeout(tooltipTimeout);
                    }
                    
                    handleDataPointHover(e, index);
                }
            }
        });
        
        document.addEventListener('mouseout', function(e) {
            if (e.target && e.target.classList && (e.target.classList.contains('data-point') || e.target.classList.contains('hover-area') || e.target.classList.contains('ai-insight-indicator'))) {
                // Check if mouse is moving to the tooltip
                const tooltip = document.getElementById('chartTooltip');
                if (tooltip && tooltip.classList.contains('visible')) {
                    // Don't hide immediately, let the tooltip hover listeners handle it
                    return;
                }
                
                isHovering = false;
                lastHoverIndex = null;
                
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                }
                tooltipTimeout = setTimeout(() => {
                    if (!isHovering) {
                        hideTooltip();
                    }
                }, 500); // Much longer delay for easier interaction
            }
        });
    }
    
    function addTooltipHoverListeners() {
        const tooltip = document.getElementById('chartTooltip');
        if (!tooltip) return;
        
        // Keep tooltip open when mouse enters the tooltip itself
        tooltip.addEventListener('mouseenter', function(e) {
            console.log('Mouse entered tooltip, keeping it open');
            isHovering = true;
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
            }
        });
        
        // Hide tooltip when mouse leaves the tooltip
        tooltip.addEventListener('mouseleave', function(e) {
            console.log('Mouse left tooltip, starting hide timer');
            isHovering = false;
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
            }
            tooltipTimeout = setTimeout(() => {
                if (!isHovering) {
                    hideTooltip();
                }
            }, 500); // Longer delay for easier interaction
        });
        
        // Also prevent tooltip from hiding when clicking inside it
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Tooltip clicked, preventing hide');
            isHovering = true;
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
            }
        });
    }
    
    function handleChartHover(event) {
        // Only show tooltip if hovering over a data point, hover area, or AI insight indicator
        if (!event.target || !event.target.classList || (!event.target.classList.contains('data-point') && !event.target.classList.contains('hover-area') && !event.target.classList.contains('ai-insight-indicator'))) {
            return;
        }
        
        const dataIndex = parseInt(event.target.dataset.index);
        if (isNaN(dataIndex)) return;
        
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const chartData = generator.generateMainChartData();
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        const tooltipData = {
            date: dateLabels[dataIndex],
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            current: yToPercent(chartData.current[dataIndex]),
            baseline: yToPercent(chartData.baseline[dataIndex]),
            optimized: yToPercent(chartData.optimized[dataIndex]),
            metric: 'Authorization Rate',
            value: yToPercent(chartData.current[dataIndex]),
            payments: generator.getBusinessMetrics().dailyTransactions * generator.getTimeframeMultipliers().days,
            dataIndex: dataIndex
        };
        
        console.log('Tooltip data for index', dataIndex, ':', {
            date: tooltipData.date,
            current: tooltipData.current,
            baseline: tooltipData.baseline,
            optimized: tooltipData.optimized,
            rawData: {
                current: chartData.current[dataIndex],
                baseline: chartData.baseline[dataIndex],
                optimized: chartData.optimized[dataIndex]
            }
        });
        
        showTooltip(event, tooltipData);
    }
    
    function handleBarChartHover(event) {
        // Only show tooltip if hovering over a data point, hover area, or AI insight indicator
        if (!event.target || !event.target.classList || (!event.target.classList.contains('data-point') && !event.target.classList.contains('hover-area') && !event.target.classList.contains('ai-insight-indicator'))) {
            return;
        }
        
        const dataIndex = parseInt(event.target.dataset.index);
        if (isNaN(dataIndex)) return;
        
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const breakdownData = generator.generateBreakdownData();
        
        const tooltipData = {
            date: dateLabels[dataIndex],
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            creditVolume: `$${breakdownData.bars[dataIndex].credit.toFixed(2)}`,
            debitVolume: `$${breakdownData.bars[dataIndex].debit.toFixed(2)}`,
            creditPayments: breakdownData.bars[dataIndex].payments.credit,
            debitPayments: breakdownData.bars[dataIndex].payments.debit,
            metric: 'Payment Volume',
            value: `$${(breakdownData.bars[dataIndex].credit + breakdownData.bars[dataIndex].debit).toFixed(2)}`,
            payments: breakdownData.bars[dataIndex].payments.credit + breakdownData.bars[dataIndex].payments.debit,
            dataIndex: dataIndex
        };
        
        showTooltip(event, tooltipData);
    }
    
    function findClosestDataPoint(mouseX, xPoints) {
        let closestIndex = -1;
        let closestDistance = Infinity;
        
        for (let i = 0; i < xPoints.length; i++) {
            const distance = Math.abs(mouseX - xPoints[i]);
            if (distance < closestDistance && distance < 50) { // Within 50px threshold
                closestDistance = distance;
                closestIndex = i;
            }
        }
        
        return closestIndex;
    }
    
    function showTooltip(event, data) {
        console.log('showTooltip called with:', { event, data });
        
        // Don't show tooltip if AI panel is open
        const aiPanel = document.getElementById('aiAssistantPanel');
        if (aiPanel && aiPanel.classList.contains('open')) {
            console.log('AI panel is open, not showing tooltip');
            return;
        }
        
        const tooltip = document.getElementById('chartTooltip');
        const tooltipHeader = document.getElementById('tooltipHeader');
        const tooltipData = document.getElementById('tooltipData');
        
        if (!tooltip || !tooltipHeader || !tooltipData) {
            console.error('Tooltip elements not found');
            return;
        }
        
        console.log('Tooltip elements found:', { tooltip, tooltipHeader, tooltipData });
        
        // Check if we're already showing the same data to prevent unnecessary re-rendering
        if (currentTooltipData && 
            currentTooltipData.dataIndex === data.dataIndex && 
            currentTooltipData.date === data.date &&
            tooltip.classList.contains('visible')) {
            console.log('Same tooltip data, not re-rendering');
            return;
        }
        
        // Ensure currentTooltipData has all required properties for the assistant
        currentTooltipData = {
            ...data,
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            payments: data.payments || 0,
            metric: data.metric || 'Performance',
            value: data.value || data.current
        };
        
        console.log('Set currentTooltipData:', currentTooltipData);
        
        // Position tooltip relative to the data point being hovered
        const tooltipWidth = 336;
        const tooltipHeight = 200; // Approximate tooltip height
        
        // Get the chart area to calculate data point positioning
        const chartArea = event.target.closest('.chart-area') || event.target.closest('.bar-chart-area');
        if (!chartArea) {
            console.error('Chart area not found');
            return;
        }
        
        const chartRect = chartArea.getBoundingClientRect();
        const dataIndex = currentTooltipData.dataIndex || 0;
        
        // Use the exact x-coordinates that match the SVG data points
        const xPoints = [80, 200, 320, 440, 560, 680, 720];
        const svgWidth = 800; // SVG viewBox width
        const chartWidth = chartRect.width;
        
        // Calculate the actual data point position by scaling the SVG coordinates to the chart width
        const dataPointX = (xPoints[dataIndex] / svgWidth) * chartWidth;
        
        // Get the current chart data to find the actual y-coordinate of the data point
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const chartData = generator.generateMainChartData();
        const dataPointY = chartData.current[dataIndex]; // This is the actual y-coordinate in SVG space
        
        // Scale the SVG y-coordinate to the chart height
        const svgHeight = 200; // SVG viewBox height
        const scaledDataPointY = (dataPointY / svgHeight) * chartRect.height;
        
        // Calculate tooltip position relative to the actual data point
        // Position tooltip closer to cursor for better interaction
        let tooltipX = chartRect.left + dataPointX + 10;
        let tooltipY;
        
        // Position tooltip to the right and slightly below the data point for easier interaction
        tooltipY = chartRect.top + scaledDataPointY + 20; // 20px below the data point
        
        // For data points near the right edge, position to the left instead
        if (dataIndex >= 5) {
            tooltipX = chartRect.left + dataPointX - tooltipWidth - 10;
        }
        
        // Ensure tooltip doesn't go off-screen
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Adjust horizontal position if tooltip goes off-screen
        if (tooltipX + tooltipWidth > viewportWidth - 10) {
            tooltipX = chartRect.left + dataPointX - tooltipWidth - 15; // Position to the left of data point
        }
        
        // Adjust vertical position if tooltip goes off-screen
        if (tooltipY < 10) {
            tooltipY = chartRect.top + scaledDataPointY + 15; // Position below the data point
        }
        
        // Ensure minimum distance from edges
        tooltipX = Math.max(10, Math.min(tooltipX, viewportWidth - tooltipWidth - 10));
        tooltipY = Math.max(10, Math.min(tooltipY, viewportHeight - tooltipHeight - 10));
        
        // Check if the new position is significantly different from the last position
        const positionChanged = Math.abs(tooltipX - tooltipPosition.x) > 5 || Math.abs(tooltipY - tooltipPosition.y) > 5;
        
        // Only update position if it has changed significantly to prevent micro-adjustments
        if (positionChanged || !tooltip.classList.contains('visible')) {
            tooltipPosition = { x: tooltipX, y: tooltipY };
            tooltip.style.left = tooltipX + 'px';
            tooltip.style.top = tooltipY + 'px';
        }
        
        // Update tooltip content
        tooltipHeader.textContent = data.date;
        
        // Check if this is the AI insight indicator (sparkle icon)
        const insightIndex = findHighestChangePoint(chartData);
        const isAIInsight = dataIndex === insightIndex;
        
        let dataHTML = '';
        if (data.current && data.baseline && data.optimized) {
            // Line chart data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Performance:
                    </span>
                    <span class="tooltip-value">${data.current}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #E4E7EC;"></div>
                        Baseline Performance:
                    </span>
                    <span class="tooltip-value">${data.baseline}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #22C55E;"></div>
                        AI-Optimized Potential:
                    </span>
                    <span class="tooltip-value">${data.optimized}</span>
                </div>
            `;
            
            // Add AI insight for the sparkle icon
            if (isAIInsight) {
                const currentPercent = parseFloat(data.current);
                const baselinePercent = parseFloat(data.baseline);
                const optimizedPercent = parseFloat(data.optimized);
                const optimizationGap = optimizedPercent - currentPercent;
                // Refined insight copy
                const insight = `Your payment approval rate of ${currentPercent.toFixed(1)}% could increase by ${optimizationGap.toFixed(1)}% if you implement our AI-recommended optimizations to reach ${optimizedPercent.toFixed(0)}%.`;
                const recommendation = ' Enable Link authentication and adjust your 3D Secure settings to unlock this revenue opportunity.';
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                            ${recommendation}
                        </div>
                    </div>
                `;
                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'performance',
                    insight: insight,
                    recommendation: recommendation
                };
            }
        } else if (data.creditVolume && data.debitVolume) {
            // Bar chart data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #3B82F6;"></div>
                        Credit Card Volume:
                    </span>
                    <span class="tooltip-value">${data.creditVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #3B82F6;"></div>
                        Credit Card Payments:
                    </span>
                    <span class="tooltip-value">${data.creditPayments}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Debit Card Volume:
                    </span>
                    <span class="tooltip-value">${data.debitVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Debit Card Payments:
                    </span>
                    <span class="tooltip-value">${data.debitPayments}</span>
                </div>
            `;
            
            // Add AI insight for bar chart sparkle icon
            if (isAIInsight) {
                const creditVolume = parseFloat(data.creditVolume.replace('$', ''));
                const debitVolume = parseFloat(data.debitVolume.replace('$', ''));
                const totalVolume = creditVolume + debitVolume;
                const creditShare = (creditVolume / totalVolume * 100).toFixed(1);
                const debitShare = (debitVolume / totalVolume * 100).toFixed(1);
                
                let insight = '';
                let recommendation = '';
                
                if (creditShare > 70) {
                    insight = `Credit cards dominate ${creditShare}% of your payment volume on ${data.date}.`;
                    recommendation = 'Consider optimizing debit card acceptance to reduce processing fees.';
                } else if (debitShare > 40) {
                    insight = `Strong debit card usage at ${debitShare}% shows good payment method diversity.`;
                    recommendation = 'Explore adding digital wallets to capture more mobile transactions.';
                } else if (totalVolume > 100) {
                    insight = `High payment volume of $${totalVolume.toFixed(0)} indicates strong customer engagement.`;
                    recommendation = 'Review your payment method mix to optimize for lower fees.';
                } else {
                    insight = `Payment volume of $${totalVolume.toFixed(0)} shows room for growth.`;
                    recommendation = 'Consider enabling more payment methods to increase conversion.';
                }
                
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                             ${recommendation}
                        </div>
                    </div>
                `;

                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'payment-volume',
                    insight: insight,
                    recommendation: recommendation
                };
            }
        } else if (data.failedVolume && data.failedPayments) {
            // Failed payments data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failed Volume:
                    </span>
                    <span class="tooltip-value">${data.failedVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failed Payments:
                    </span>
                    <span class="tooltip-value">${data.failedPayments}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failure Rate:
                    </span>
                    <span class="tooltip-value">${data.failureRate}</span>
                </div>
            `;
            
            // Add AI insight for failed payments sparkle icon
            if (isAIInsight) {
                const failedVolume = parseFloat(data.failedVolume.replace('$', ''));
                const failedPayments = parseInt(data.failedPayments);
                const failureRate = parseFloat(data.failureRate.replace('%', ''));
                
                let insight = '';
                let recommendation = '';
                
                if (failureRate > 30) {
                    insight = `High failure rate of ${failureRate}% on ${data.date} indicates authentication issues.`;
                    recommendation = 'Review your 3D Secure settings and consider enabling Link for better authentication.';
                } else if (failedVolume > 50) {
                    insight = `Failed volume of $${failedVolume.toFixed(0)} suggests potential fraud or card issues.`;
                    recommendation = 'Check your Radar rules and consider adding additional fraud detection.';
                } else if (failedPayments > 10) {
                    insight = `${failedPayments} failed payments may indicate customer experience issues.`;
                    recommendation = 'Review your payment form and consider adding saved payment methods.';
                } else {
                    insight = `Low failure rate of ${failureRate}% shows good payment processing health.`;
                    recommendation = 'Consider enabling more payment methods to reduce dependency on cards.';
                }
                
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                             ${recommendation}
                        </div>
                    </div>
                `;

                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'failure-analysis'
                };
            }
        }
        
        tooltipData.innerHTML = dataHTML;
        tooltip.classList.add('visible');
        
        console.log('Tooltip made visible, classes:', tooltip.classList.toString());
        console.log('Tooltip position:', { left: tooltip.style.left, top: tooltip.style.top });
        console.log('Tooltip computed style:', window.getComputedStyle(tooltip));
        
        // Check if the button is properly rendered
        const button = tooltip.querySelector('#tooltipAskBtn');
        console.log('Button found in tooltip:', button);
        if (button) {
            console.log('Button computed style:', window.getComputedStyle(button));
            console.log('Button position:', button.getBoundingClientRect());
        }
        
        // Reinitialize lucide icons for the tooltip
        lucide.createIcons();
    }
    
    function hideTooltip() {
        const tooltip = document.getElementById('chartTooltip');
        if (tooltip) {
            tooltip.classList.remove('visible');
            // Don't clear currentTooltipData immediately - let the AI panel handle it
        }
    }
    
    // Test function to verify JavaScript is working
    console.log('JavaScript loaded successfully');
    
    // Function to update main chart with new data
    function updateMainChart(dateRange, businessType = 'medium') {
        console.log('updateMainChart called with:', dateRange, 'business type:', businessType);
        const chartContainer = document.querySelector('.chart-container');
        if (!chartContainer) {
            console.log('Chart container not found!');
            return;
        }
        console.log('Chart container found');

        // Use the realistic data generator
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const mainChartData = generator.generateMainChartData();
        
        // Ensure we have exactly 7 data points to match the x-coordinates
        if (mainChartData.current.length !== 7 || mainChartData.baseline.length !== 7 || mainChartData.optimized.length !== 7) {
            console.error('Data length mismatch. Expected 7, got:', mainChartData.current.length, mainChartData.baseline.length, mainChartData.optimized.length);
            return;
        }

        // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
        // These coordinates correspond to the visual positions of the x-axis labels
        // IMPORTANT: These must match the static SVG coordinates exactly
        const xPoints = [80, 200, 320, 440, 560, 680, 720];

        console.log('Generated main chart data:', {
            currentPeriod: mainChartData.current,
            baselinePeriod: mainChartData.baseline,
            optimizedPeriod: mainChartData.optimized,
            xPoints: xPoints
        });
        console.log('X-coordinates being used:', xPoints);
        console.log('Current period Y-coordinates:', mainChartData.current);
        console.log('Baseline period Y-coordinates:', mainChartData.baseline);
        console.log('Optimized period Y-coordinates:', mainChartData.optimized);

        // Build SVG paths with perfect alignment
        let currentLine = '';
        let baselineLine = '';
        let optimizedLine = '';
        for (let i = 0; i < xPoints.length; i++) {
            if (i === 0) {
                currentLine = `M${xPoints[i]},${mainChartData.current[i]}`;
                baselineLine = `M${xPoints[i]},${mainChartData.baseline[i]}`;
                optimizedLine = `M${xPoints[i]},${mainChartData.optimized[i]}`;
            } else {
                currentLine += ` L${xPoints[i]},${mainChartData.current[i]}`;
                baselineLine += ` L${xPoints[i]},${mainChartData.baseline[i]}`;
                optimizedLine += ` L${xPoints[i]},${mainChartData.optimized[i]}`;
            }
        }
        
        // Update the SVG paths with proper stroke widths
        const svg = chartContainer.querySelector('.chart-svg');
        if (svg) {
            svg.setAttribute('viewBox', '0 0 800 200');
            const paths = svg.querySelectorAll('path');
            if (paths.length >= 3) {
                paths[0].setAttribute('d', baselineLine);
                paths[0].setAttribute('stroke-width', '2');
                paths[1].setAttribute('d', currentLine);
                paths[1].setAttribute('stroke-width', '3');
                paths[2].setAttribute('d', optimizedLine);
                paths[2].setAttribute('stroke-width', '3');
                paths[2].setAttribute('stroke-dasharray', '5,5');
            }
        }
        
        // Add invisible data points for hover detection
        setTimeout(() => {
            const svg = chartContainer.querySelector('.chart-svg');
            if (svg) {
                addDataPoints(svg, xPoints, mainChartData);
            }
        }, 100);

        // Update legend values
        const legendCurrent = document.getElementById('legend-current-value');
        const legendBaseline = document.getElementById('legend-baseline-value');
        const legendOptimized = document.getElementById('legend-optimized-value');
        if (legendCurrent && legendBaseline && legendOptimized) {
            // Convert Y back to percent for display
            const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
            
            const lastIndex = mainChartData.current.length - 1;
            const currentValue = yToPercent(mainChartData.current[lastIndex]);
            const baselineValue = yToPercent(mainChartData.baseline[lastIndex]);
            const optimizedValue = yToPercent(mainChartData.optimized[lastIndex]);
            
            console.log('Legend values being set:', {
                current: currentValue,
                baseline: baselineValue,
                optimized: optimizedValue,
                lastIndex: lastIndex,
                rawData: {
                    current: mainChartData.current[lastIndex],
                    baseline: mainChartData.baseline[lastIndex],
                    optimized: mainChartData.optimized[lastIndex]
                }
            });
            
            legendCurrent.textContent = currentValue;
            legendBaseline.textContent = baselineValue;
            legendOptimized.textContent = optimizedValue;
        }
    }
    
    // Function to add invisible data points for hover detection
    function addDataPoints(svg, xPoints, chartData) {
        // Remove existing data points and AI indicators
        const existingPoints = svg.querySelectorAll('.data-point, .ai-insight-indicator');
        existingPoints.forEach(point => point.remove());
        
        // Calculate dynamic hover area positions based on chart width
        const svgWidth = 800; // SVG viewBox width
        const numDataPoints = xPoints.length;
        const dataPointSpacing = svgWidth / (numDataPoints - 1);
        
        // Find the data point with the highest rate of change
        const insightIndex = findHighestChangePoint(chartData);
        
        // Add large invisible hover areas at each calculated position covering the full chart height
        for (let i = 0; i < numDataPoints; i++) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            const dataPointX = xPoints[i]; // Use exact x-coordinate from the array
            const hoverWidth = 200; // Much larger hover area for easier interaction
            
            rect.setAttribute('x', dataPointX - (hoverWidth / 2));
            rect.setAttribute('y', '0');
            rect.setAttribute('width', hoverWidth.toString());
            rect.setAttribute('height', '200'); // Full chart height
            rect.setAttribute('fill', 'transparent');
            rect.setAttribute('stroke', 'none');
            rect.classList.add('data-point');
            rect.dataset.index = i;
            svg.appendChild(rect);
            
            // Add AI insight indicator for the point with highest change
            if (i === insightIndex) {
                addAIInsightIndicator(svg, dataPointX, chartData, i);
            }
        }
    }
    
    // Function to find the data point with the highest rate of change
    function findHighestChangePoint(chartData) {
        // Target June 15th data point (index 4) where there's a larger optimization opportunity
        // This shows users what happened and how they could improve
        return 4; // June 15th data point
    }
    
    // Function to add AI insight indicator
    function addAIInsightIndicator(svg, x, chartData, index) {
        // Get the actual y-coordinate for this data point
        const y = chartData.current[index];
        // Create the floating circle background
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y); // Use actual y
        circle.setAttribute('r', '16');
        circle.setAttribute('fill', '#533AFD');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('filter', 'drop-shadow(0 2px 4px rgba(83, 58, 253, 0.3))');
        circle.classList.add('ai-insight-indicator');
        circle.dataset.index = index;
        svg.appendChild(circle);
        // Create the sparkle icon (simplified SVG path)
        const sparkle = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        sparkle.setAttribute('d', 'M8 0L9.5 5.5L15 7L9.5 8.5L8 14L6.5 8.5L1 7L6.5 5.5L8 0Z');
        sparkle.setAttribute('fill', '#ffffff');
        sparkle.setAttribute('transform', `translate(${x-8}, ${y-8})`); // Perfectly center the sparkle
        sparkle.classList.add('ai-insight-sparkle');
        svg.appendChild(sparkle);
        // No animation - keep the circle fixed in position
    }
    
    // Metric card interaction functionality
    document.addEventListener('DOMContentLoaded', function() {
        const metricCards = document.querySelectorAll('.metric-card');
        const chartContainer = document.querySelector('.chart-container');
        const metricsTitle = document.querySelector('.metrics-title');
        
        // Store original chart content
        const originalChartContent = chartContainer.innerHTML;
        const originalTitle = metricsTitle.textContent;
        
        metricCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected state from all cards
                metricCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected state to clicked card
                this.classList.add('selected');
                
                // Get the metric label
                const metricLabel = this.querySelector('.metric-label').textContent;
                
                // Update the title
                metricsTitle.textContent = `Key metrics for ${metricLabel.toLowerCase()}`;
                
                // Create different chart content based on the metric
                if (metricLabel === 'Accepted volume') {
                    // Use the same date range as the main filter
                    const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    const dateLabels = getDateLabels(currentDateRange);
                    console.log('Creating Accepted volume chart with dates:', dateLabels);
                    
                    // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
                    const xPoints = [80, 200, 320, 440, 560, 680, 720];
                    
                    // Generate realistic volume data
                    const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
                    const volumeData = generator.generateTimeSeriesData(50, 0.2, 0.05);
                    const previousVolumeData = volumeData.map(v => v * 0.8);
                    const optimizedVolumeData = volumeData.map(v => v * 1.25); // AI-optimized potential
                    
                    // Convert to Y coordinates
                    const currentY = volumeData.map(v => 200 - (v * 2));
                    const previousY = previousVolumeData.map(v => 200 - (v * 2));
                    const optimizedY = optimizedVolumeData.map(v => 200 - (v * 2));
                    
                    // Build SVG paths
                    let currentLine = '';
                    let previousLine = '';
                    let optimizedLine = '';
                    for (let i = 0; i < xPoints.length; i++) {
                        if (i === 0) {
                            currentLine = `M${xPoints[i]},${currentY[i]}`;
                            previousLine = `M${xPoints[i]},${previousY[i]}`;
                            optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
                        } else {
                            currentLine += ` L${xPoints[i]},${currentY[i]}`;
                            previousLine += ` L${xPoints[i]},${previousY[i]}`;
                            optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
                        }
                    }
                    
                    chartContainer.innerHTML = `
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>$60</span>
                                <span>$50</span>
                                <span>$40</span>
                                <span>$30</span>
                                <span>$20</span>
                                <span>$10</span>
                                <span>$0</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- AI-optimized performance line (green) -->
                                        <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    ${dateLabels.map(label => `<span>${label}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color optimized"></div>
                                    <span>AI-optimized potential</span>
                                </div>
                            </div>
                            <span class="update-status">Updated yesterday</span>
                        </div>
                    `;
                } else if (metricLabel === 'Accepted payments') {
                    // Use the same date range as the main filter
                    const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    const dateLabels = getDateLabels(currentDateRange);
                    console.log('Creating Accepted payments chart with dates:', dateLabels);
                    
                    // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
                    const xPoints = [80, 200, 320, 440, 560, 680, 720];
                    
                    // Generate realistic payment count data
                    const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
                    const paymentsData = generator.generateTimeSeriesData(25, 0.25, 0.02);
                    const previousPaymentsData = paymentsData.map(v => v * 0.85);
                    const optimizedPaymentsData = paymentsData.map(v => v * 1.3); // AI-optimized potential
                    
                    // Convert to Y coordinates
                    const currentY = paymentsData.map(v => 200 - (v * 4));
                    const previousY = previousPaymentsData.map(v => 200 - (v * 4));
                    const optimizedY = optimizedPaymentsData.map(v => 200 - (v * 4));
                    
                    // Build SVG paths
                    let currentLine = '';
                    let previousLine = '';
                    let optimizedLine = '';
                    for (let i = 0; i < xPoints.length; i++) {
                        if (i === 0) {
                            currentLine = `M${xPoints[i]},${currentY[i]}`;
                            previousLine = `M${xPoints[i]},${previousY[i]}`;
                            optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
                        } else {
                            currentLine += ` L${xPoints[i]},${currentY[i]}`;
                            previousLine += ` L${xPoints[i]},${previousY[i]}`;
                            optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
                        }
                    }
                    
                    chartContainer.innerHTML = `
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>60</span>
                                <span>50</span>
                                <span>40</span>
                                <span>30</span>
                                <span>20</span>
                                <span>10</span>
                                <span>0</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- AI-optimized performance line (green) -->
                                        <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    ${dateLabels.map(label => `<span>${label}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color optimized"></div>
                                    <span>AI-optimized potential</span>
                                </div>
                            </div>
                            <span class="update-status">Updated yesterday</span>
                        </div>
                    `;
                } else {
                    // Default chart (Payment success rate)
                    chartContainer.innerHTML = originalChartContent;
                    metricsTitle.textContent = originalTitle;
                    
                    // Update the chart with the current date range
                    setTimeout(() => {
                        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                        updateMainChart(currentDateRange);
                    }, 10);
                }
            });
        });
    });

    // Chart data for different metrics
    const chartData = {
        volume: {
            label: "Payment volume",
            total: "$642.57",
            yAxis: ["$240", "$180", "$120", "$60", "$0"],
            bars: [
                { credit: 120, debit: 100 },
                { credit: 140, debit: 120 },
                { credit: 100, debit: 80 },
                { credit: 60, debit: 40 },
                { credit: 80, debit: 60 },
                { credit: 120, debit: 100 },
                { credit: 140, debit: 120 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        payments: {
            label: "Payments",
            total: "49",
            yAxis: ["40", "30", "20", "10", "0"],
            bars: [
                { credit: 25, debit: 20 },
                { credit: 30, debit: 25 },
                { credit: 20, debit: 15 },
                { credit: 10, debit: 8 },
                { credit: 15, debit: 12 },
                { credit: 25, debit: 20 },
                { credit: 30, debit: 25 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        share: {
            label: "Share of payments",
            total: "100.00%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [
                { credit: 60, debit: 50 },
                { credit: 70, debit: 60 },
                { credit: 50, debit: 40 },
                { credit: 30, debit: 20 },
                { credit: 40, debit: 30 },
                { credit: 60, debit: 50 },
                { credit: 70, debit: 60 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        success: {
            label: "Success rate",
            total: "63.27%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [
                { credit: 65, debit: 40 },
                { credit: 75, debit: 60 },
                { credit: 55, debit: 45 },
                { credit: 35, debit: 25 },
                { credit: 45, debit: 35 },
                { credit: 65, debit: 40 },
                { credit: 75, debit: 60 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        }
    };

    // Function to update chart
    function updateChart(metric) {
        const data = chartData[metric];
        
        // Check if data exists
        if (!data) {
            console.error('No data found for metric:', metric);
            return;
        }
        
        // Update labels and total
        const metricLabel = document.getElementById('metric-label');
        const metricValue = document.getElementById('metric-value');
        
        if (metricLabel) metricLabel.textContent = data.label;
        if (metricValue) metricValue.textContent = data.total;
        
        // Update Y-axis labels
        const yAxisLabels = document.querySelectorAll('.bar-chart-y-axis span');
        data.yAxis.forEach((label, index) => {
            if (yAxisLabels[index]) {
                yAxisLabels[index].textContent = label;
            }
        });
        
        // Update bar chart SVG
        const svg = document.querySelector('.bar-chart-svg');
        if (svg) {
            let bars = '';
            const barWidth = 20; // Wider bars for better visibility
            // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
            const xPoints = [80, 200, 320, 440, 560, 680, 720];
            const totalBars = data.bars.length;
            
            data.bars.forEach((barData, i) => {
                // Use exact x-coordinates for perfect alignment
                const x = xPoints[i];
                const creditY = 200 - barData.credit;
                const debitY = 200 - barData.debit;
                bars += `
                    <g class="bar-group" transform="translate(${x}, 0)">
                        <rect x="0" y="${creditY}" width="${barWidth}" height="${barData.credit}" fill="#3B82F6" opacity="0.8"/>
                        <rect x="${barWidth + 5}" y="${debitY}" width="${barWidth}" height="${barData.debit}" fill="#533AFD" opacity="0.8"/>
                    </g>
                `;
            });
            svg.innerHTML = bars;
            
            console.log('Bar chart updated with', totalBars, 'bars');
            
            // Add invisible hover areas for each bar
            addBarHoverAreas(svg, xPoints, data.bars);
            
            // Reset animations for the updated chart
            setTimeout(() => resetGraphAnimations(), 100);
        }
        
        // Update data table
        const tableBody = document.querySelector('.data-table tbody');
        if (tableBody && data.table && Array.isArray(data.table)) {
            let tableHTML = '';
            data.table.forEach(row => {
                tableHTML += `
                    <tr>
                        <td><input type="checkbox" checked></td>
                        <td>${row.type}</td>
                        <td>${row.volume}</td>
                        <td>${row.payments}</td>
                        <td>${row.share}</td>
                        <td>${row.success}</td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalVolume = data.table.reduce((sum, row) => sum + parseFloat(row.volume.replace('$', '') || 0), 0);
            const totalPayments = data.table.reduce((sum, row) => sum + parseInt(row.payments) || 0, 0);
            
            tableHTML += `
                <tr class="total-row">
                    <td></td>
                    <td style="font-weight: 700;">Total</td>
                    <td style="font-weight: 700;">$${totalVolume.toFixed(2)}</td>
                    <td style="font-weight: 700;">${totalPayments}</td>
                    <td style="font-weight: 700;">100.00%</td>
                    <td style="font-weight: 700;">${data.total}</td>
                </tr>
            `;
            
            tableBody.innerHTML = tableHTML;
        }
    }

    // Realistic data generation system
    class RealisticDataGenerator {
        constructor(businessType, dateRange) {
            this.businessType = businessType;
            this.dateRange = dateRange;
            this.dataPoints = this.getDataPointsForRange(dateRange);
            this.seed = this.getSeed(businessType, dateRange);
            this.rng = this.seededRandom(this.seed);
        }

        // Get consistent seed for reproducible data
        getSeed(businessType, dateRange) {
            const businessSeeds = { 'small': 1000, 'medium': 2000, 'large': 3000 };
            const rangeSeeds = { 
                'Last 7 days': 1, 'Last 30 days': 2, 'Last 60 days': 3, 
                'Last 90 days': 4, 'Last 6 months': 5 
            };
            return businessSeeds[businessType] + rangeSeeds[dateRange];
        }

        // Seeded random number generator for consistent data
        seededRandom(seed) {
            let state = seed;
            return function() {
                state = (state * 9301 + 49297) % 233280;
                return state / 233280;
            };
        }

        // Get number of data points for each timeframe
        getDataPointsForRange(dateRange) {
            const points = { 
                'Last 7 days': 7, 'Last 30 days': 8, 'Last 60 days': 8, 
                'Last 90 days': 7, 'Last 6 months': 8 
            };
            return points[dateRange] || 7;
        }

        // Generate business-specific base metrics
        getBusinessMetrics() {
            const metrics = {
                'small': {
                    successRate: 78.5,
                    avgTransactionValue: 8.0,
                    dailyTransactions: 2.2,
                    failureRate: 21.5,
                    disputeRate: 0.8
                },
                'medium': {
                    successRate: 85.2,
                    avgTransactionValue: 10.3,
                    dailyTransactions: 13.8,
                    failureRate: 14.8,
                    disputeRate: 0.4
                },
                'large': {
                    successRate: 91.7,
                    avgTransactionValue: 10.0,
                    dailyTransactions: 99.4,
                    failureRate: 8.3,
                    disputeRate: 0.2
                }
            };
            return metrics[this.businessType];
        }

        // Generate timeframe multipliers
        getTimeframeMultipliers() {
            const multipliers = {
                'Last 7 days': { volume: 0.1, payments: 0.1, days: 7 },
                'Last 30 days': { volume: 0.33, payments: 0.33, days: 30 },
                'Last 60 days': { volume: 0.67, payments: 0.67, days: 60 },
                'Last 90 days': { volume: 1.0, payments: 1.0, days: 90 },
                'Last 6 months': { volume: 2.0, payments: 2.0, days: 180 }
            };
            return multipliers[this.dateRange];
        }

        // Generate realistic time series data with trends and seasonality
        generateTimeSeriesData(baseValue, volatility = 0.15, trend = 0) {
            const data = [];
            let currentValue = baseValue;
            
            for (let i = 0; i < this.dataPoints; i++) {
                // Add trend
                currentValue += trend;
                
                // Add weekly seasonality (weekend effect)
                const dayOfWeek = (i % 7);
                const weekendEffect = (dayOfWeek === 0 || dayOfWeek === 6) ? 0.8 : 1.0;
                
                // Add random variation
                const randomFactor = 1 + (this.rng() - 0.5) * volatility * 2;
                
                const finalValue = Math.max(0, currentValue * weekendEffect * randomFactor);
                data.push(Math.round(finalValue * 100) / 100);
            }
            
            return data;
        }

        // Generate card type distribution
        generateCardDistribution() {
            const distributions = {
                'small': { credit: 0.65, debit: 0.30, prepaid: 0.05 },
                'medium': { credit: 0.70, debit: 0.25, prepaid: 0.05 },
                'large': { credit: 0.75, debit: 0.20, prepaid: 0.05 }
            };
            return distributions[this.businessType];
        }

        // Generate main chart data with three lines
        generateMainChartData() {
            const businessMetrics = this.getBusinessMetrics();
            const timeframeMultipliers = this.getTimeframeMultipliers();
            
            // Generate current success rate data with realistic fluctuations
            const baseSuccessRate = businessMetrics.successRate;
            const currentData = this.generateTimeSeriesData(baseSuccessRate, 0.08, 0.1);
            
            // Generate baseline data (past performance - slightly lower)
            const baselineSuccessRate = baseSuccessRate * 0.92;
            const baselineData = this.generateTimeSeriesData(baselineSuccessRate, 0.08, 0.05);
            
            // Generate AI-optimized data (potential future performance - varies by business size)
            let optimizedSuccessRate;
            if (this.businessType === 'small') {
                // Small businesses have the most room for improvement
                optimizedSuccessRate = Math.min(baseSuccessRate * 1.25, 92); // Up to 25% improvement
            } else if (this.businessType === 'medium') {
                // Medium businesses have moderate room for improvement
                optimizedSuccessRate = Math.min(baseSuccessRate * 1.15, 94); // Up to 15% improvement
            } else {
                // Large businesses are already well-optimized, smaller gains
                optimizedSuccessRate = Math.min(baseSuccessRate * 1.08, 96); // Up to 8% improvement
            }
            const optimizedData = this.generateTimeSeriesData(optimizedSuccessRate, 0.06, 0.15);
            
            return {
                current: currentData.map(rate => 200 - (rate * 2)), // Convert to Y coordinates
                baseline: baselineData.map(rate => 200 - (rate * 2)),
                optimized: optimizedData.map(rate => 200 - (rate * 2))
            };
        }

        // Generate breakdown chart data
        generateBreakdownData() {
            const businessMetrics = this.getBusinessMetrics();
            const timeframeMultipliers = this.getTimeframeMultipliers();
            const cardDistribution = this.generateCardDistribution();
            
            // Calculate base values
            const totalDays = timeframeMultipliers.days;
            const avgDailyVolume = businessMetrics.avgTransactionValue * businessMetrics.dailyTransactions;
            const totalVolume = avgDailyVolume * totalDays * timeframeMultipliers.volume;
            const totalPayments = businessMetrics.dailyTransactions * totalDays * timeframeMultipliers.payments;
            
            // Generate time series for each metric
            const volumeData = this.generateTimeSeriesData(avgDailyVolume, 0.2, 0.05);
            const paymentsData = this.generateTimeSeriesData(businessMetrics.dailyTransactions, 0.25, 0.02);
            
            // Create bar data
            const bars = [];
            for (let i = 0; i < this.dataPoints; i++) {
                const dailyVolume = volumeData[i];
                const dailyPayments = paymentsData[i];
                
                bars.push({
                    credit: Math.round(dailyVolume * cardDistribution.credit),
                    debit: Math.round(dailyVolume * cardDistribution.debit),
                    prepaid: Math.round(dailyVolume * cardDistribution.prepaid),
                    payments: {
                        credit: Math.round(dailyPayments * cardDistribution.credit),
                        debit: Math.round(dailyPayments * cardDistribution.debit),
                        prepaid: Math.round(dailyPayments * cardDistribution.prepaid)
                    }
                });
            }
            
            // Calculate totals
            const totalCreditVolume = bars.reduce((sum, bar) => sum + bar.credit, 0);
            const totalDebitVolume = bars.reduce((sum, bar) => sum + bar.debit, 0);
            const totalPrepaidVolume = bars.reduce((sum, bar) => sum + bar.prepaid, 0);
            
            const totalCreditPayments = bars.reduce((sum, bar) => sum + bar.payments.credit, 0);
            const totalDebitPayments = bars.reduce((sum, bar) => sum + bar.payments.debit, 0);
            const totalPrepaidPayments = bars.reduce((sum, bar) => sum + bar.payments.prepaid, 0);
            
            const totalBreakdownVolume = totalCreditVolume + totalDebitVolume + totalPrepaidVolume;
            const totalBreakdownPayments = totalCreditPayments + totalDebitPayments + totalPrepaidPayments;
            
            // Generate table data
            const tableData = [
                {
                    type: 'Credit card',
                    volume: totalCreditVolume,
                    payments: totalCreditPayments,
                    share: totalPayments > 0 ? (totalCreditPayments / totalPayments * 100) : 0,
                    success: businessMetrics.successRate + (this.rng() - 0.5) * 5
                },
                {
                    type: 'Debit card',
                    volume: totalDebitVolume,
                    payments: totalDebitPayments,
                    share: totalPayments > 0 ? (totalDebitPayments / totalPayments * 100) : 0,
                    success: businessMetrics.successRate * 0.85 + (this.rng() - 0.5) * 5
                },
                {
                    type: 'Prepaid card',
                    volume: totalPrepaidVolume,
                    payments: totalPrepaidPayments,
                    share: totalPayments > 0 ? (totalPrepaidPayments / totalPayments * 100) : 0,
                    success: businessMetrics.successRate * 1.1 + (this.rng() - 0.5) * 5
                }
            ];
            
            return {
                bars,
                table: tableData,
                totals: {
                    volume: totalBreakdownVolume,
                    payments: totalBreakdownPayments
                }
            };
        }

        // Generate failed payments data
        generateFailedData() {
            const businessMetrics = this.getBusinessMetrics();
            const timeframeMultipliers = this.getTimeframeMultipliers();
            
            // Calculate base failed values
            const totalDays = timeframeMultipliers.days;
            const avgDailyVolume = businessMetrics.avgTransactionValue * businessMetrics.dailyTransactions;
            const failedBaseVolume = avgDailyVolume * totalDays * timeframeMultipliers.volume;
            const failedBasePayments = businessMetrics.dailyTransactions * totalDays * timeframeMultipliers.payments;
            
            const failedVolume = failedBaseVolume * (businessMetrics.failureRate / 100);
            const failedPayments = failedBasePayments * (businessMetrics.failureRate / 100);
            
            // Generate time series for failed data
            const failedVolumeData = this.generateTimeSeriesData(failedVolume / this.dataPoints, 0.3, 0);
            const failedPaymentsData = this.generateTimeSeriesData(failedPayments / this.dataPoints, 0.3, 0);
            
            return {
                volume: failedVolumeData,
                payments: failedPaymentsData,
                totalVolume: failedVolume,
                totalPayments: failedPayments,
                failureRate: businessMetrics.failureRate
            };
        }

        // Generate all data for a business type and timeframe
        generateAllData() {
            const mainChartData = this.generateMainChartData();
            const breakdownData = this.generateBreakdownData();
            const failedData = this.generateFailedData();
            const businessMetrics = this.getBusinessMetrics();
            
            return {
                mainChart: mainChartData,
                breakdown: breakdownData,
                failed: failedData,
                metrics: {
                    successRate: businessMetrics.successRate,
                    volume: breakdownData.totals.volume,
                    payments: breakdownData.totals.payments,
                    failedVolume: failedData.totalVolume,
                    failedPayments: failedData.totalPayments
                }
            };
        }
    }

    // Function to generate data based on date range and business type
    function generateDataForTimeframe(dateRange, businessType = 'medium') {
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const allData = generator.generateAllData();
        
        const data = {
            volume: {
                label: "Payment volume",
                total: `$${allData.breakdown.totals.volume.toFixed(2)}`,
                yAxis: generateYAxisLabels(allData.breakdown.totals.volume, '$'),
                bars: allData.breakdown.bars.map(bar => ({ credit: bar.credit, debit: bar.debit })),
                table: allData.breakdown.table.map(row => ({
                    type: row.type,
                    volume: `$${row.volume.toFixed(2)}`,
                    payments: row.payments,
                    share: `${row.share.toFixed(2)}%`,
                    success: `${row.success.toFixed(2)}%`
                }))
            },
            payments: {
                label: "Payments",
                total: allData.breakdown.totals.payments.toString(),
                yAxis: generateYAxisLabels(allData.breakdown.totals.payments, ''),
                bars: allData.breakdown.bars.map(bar => ({ 
                    credit: bar.payments.credit, 
                    debit: bar.payments.debit 
                })),
                table: allData.breakdown.table.map(row => ({
                    type: row.type,
                    volume: `$${row.volume.toFixed(2)}`,
                    payments: row.payments,
                    share: `${row.share.toFixed(2)}%`,
                    success: `${row.success.toFixed(2)}%`
                }))
            },
            share: {
                label: "Share of payments",
                total: "100.00%",
                yAxis: ["100%", "75%", "50%", "25%", "0%"],
                bars: allData.breakdown.bars.map(bar => {
                    const total = bar.payments.credit + bar.payments.debit + bar.payments.prepaid;
                    return {
                        credit: total > 0 ? (bar.payments.credit / total * 100) : 0,
                        debit: total > 0 ? (bar.payments.debit / total * 100) : 0
                    };
                }),
                table: allData.breakdown.table.map(row => ({
                    type: row.type,
                    volume: `$${row.volume.toFixed(2)}`,
                    payments: row.payments,
                    share: `${row.share.toFixed(2)}%`,
                    success: `${row.success.toFixed(2)}%`
                }))
            },
            success: {
                label: "Success rate",
                total: `${allData.metrics.successRate.toFixed(2)}%`,
                yAxis: ["100%", "75%", "50%", "25%", "0%"],
                bars: allData.breakdown.bars.map(bar => {
                    const total = bar.payments.credit + bar.payments.debit + bar.payments.prepaid;
                    const successCredit = bar.payments.credit * (allData.metrics.successRate / 100);
                    const successDebit = bar.payments.debit * (allData.metrics.successRate * 0.85 / 100);
                    return {
                        credit: total > 0 ? (successCredit / total * 100) : 0,
                        debit: total > 0 ? (successDebit / total * 100) : 0
                    };
                }),
                table: allData.breakdown.table.map(row => ({
                    type: row.type,
                    volume: `$${row.volume.toFixed(2)}`,
                    payments: row.payments,
                    share: `${row.share.toFixed(2)}%`,
                    success: `${row.success.toFixed(2)}%`
                }))
            }
        };

        return data;
    }

    // Helper function to generate Y-axis labels
    function generateYAxisLabels(maxValue, prefix = '') {
        const max = Math.ceil(maxValue * 1.2);
        const step = max / 4;
        return [
            `${prefix}${max.toLocaleString()}`,
            `${prefix}${Math.round(max * 0.75).toLocaleString()}`,
            `${prefix}${Math.round(max * 0.5).toLocaleString()}`,
            `${prefix}${Math.round(max * 0.25).toLocaleString()}`,
            `${prefix}0`
        ];
    }

    // Function to update all chart x-axes based on selected date range
    function updateChartDateRanges(dateRange, businessType = 'medium') {
        console.log('updateChartDateRanges called with:', dateRange, 'business type:', businessType);
        
        const dateLabels = getDateLabels(dateRange);
        console.log('Generated date labels:', dateLabels);
        
        // Generate new data for the selected timeframe and business type
        const newChartData = generateDataForTimeframe(dateRange, businessType);
        console.log('Generated new chart data:', newChartData);
        
        // Update the global chartData with new data
        Object.assign(chartData, newChartData);
        
        // Update main chart x-axis
        const mainChartXAxis = document.querySelector('.chart-x-axis');
        if (mainChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            mainChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                mainChartXAxis.appendChild(span);
            });
        }
        
        // Update bar chart x-axis
        const barChartXAxis = document.querySelector('.bar-chart-x-axis');
        if (barChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            barChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                barChartXAxis.appendChild(span);
            });
        }
        
        // Update failed chart x-axis
        const failedChartXAxis = document.querySelector('.breakdown-section:last-child .bar-chart-x-axis');
        if (failedChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            failedChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                failedChartXAxis.appendChild(span);
            });
        }
        
        // Generate new failed payments data for the selected timeframe
        const newFailedData = generateFailedDataForTimeframe(dateRange, businessType);
        
        // Update the global failedChartData with new data
        Object.assign(failedChartData, newFailedData);
        
        // Update main metrics cards based on timeframe and business type
        updateMainMetrics(dateRange, businessType);
        
        // Update main chart with new data
        console.log('About to call updateMainChart with:', dateRange, businessType);
        updateMainChart(dateRange, businessType);
        console.log('updateMainChart call completed');
        
        // Update the currently active metric chart
        const activeMetric = document.querySelector('.breakdown-filter-btn.active');
        if (activeMetric) {
            const metric = activeMetric.getAttribute('data-metric');
            updateChart(metric);
        }
        
        // Update metric card charts if they are currently displayed
        const selectedMetricCard = document.querySelector('.metric-card.selected');
        if (selectedMetricCard) {
            const metricLabel = selectedMetricCard.querySelector('.metric-label').textContent;
            console.log('Updating metric card chart for:', metricLabel);
            if (metricLabel === 'Accepted volume' || metricLabel === 'Accepted payments') {
                // Force update the chart with new date range
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    // Recreate the chart content with new date labels
                    const dateLabels = getDateLabels(dateRange);
                    const xAxisSpans = chartContainer.querySelectorAll('.chart-x-axis span');
                    dateLabels.forEach((label, index) => {
                        if (xAxisSpans[index]) {
                            xAxisSpans[index].textContent = label;
                        }
                    });
                }
            }
        }
        
        // Update failed payments data too
        const activeFailedMetric = document.querySelector('.breakdown-section:last-child .breakdown-filter-btn.active');
        if (activeFailedMetric) {
            const failedMetric = activeFailedMetric.getAttribute('data-metric');
            updateFailedChart(failedMetric);
        }
    }

    // Function to update main metrics cards
    function updateMainMetrics(dateRange, businessType = 'medium') {
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const allData = generator.generateAllData();
        
        // Update metric cards with realistic data
        const successRateCard = document.querySelector('.metric-card .metric-value');
        const volumeCard = document.querySelectorAll('.metric-card .metric-value')[1];
        const paymentsCard = document.querySelectorAll('.metric-card .metric-value')[2];

        if (successRateCard) successRateCard.textContent = allData.metrics.successRate.toFixed(2) + '%';
        if (volumeCard) volumeCard.textContent = '$' + allData.metrics.volume.toFixed(2);
        if (paymentsCard) paymentsCard.textContent = Math.round(allData.metrics.payments).toString();

        // Generate realistic change percentages based on business type and timeframe
        const changes = document.querySelectorAll('.metric-change');
        if (changes.length >= 3) {
            // Generate consistent changes based on business type and timeframe
            const businessMetrics = generator.getBusinessMetrics();
            const timeframeMultipliers = generator.getTimeframeMultipliers();
            
            // Success rate changes (smaller for larger businesses)
            const successChange = (businessType === 'small' ? 2.5 : businessType === 'medium' ? 1.8 : 1.2) + (Math.random() - 0.5) * 2;
            
            // Volume changes (larger for smaller businesses due to growth potential)
            const volumeChange = (businessType === 'small' ? 25 : businessType === 'medium' ? 18 : 12) + (Math.random() - 0.5) * 10;
            
            // Payment count changes
            const paymentsChange = (businessType === 'small' ? 15 : businessType === 'medium' ? 12 : 8) + (Math.random() - 0.5) * 6;

            changes[0].textContent = (successChange > 0 ? '+' : '') + successChange.toFixed(2) + '%';
            changes[1].textContent = (volumeChange > 0 ? '+' : '') + volumeChange.toFixed(2) + '%';
            changes[2].textContent = (paymentsChange > 0 ? '+' : '') + paymentsChange.toFixed(2) + '%';
        }


    }



    // Function to generate date labels based on selected range
    function getDateLabels(dateRange) {
        const today = new Date();
        const labels = [];
        
        switch (dateRange) {
            case 'Last 7 days':
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 30 days':
                for (let i = 29; i >= 0; i -= 4) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 60 days':
                for (let i = 59; i >= 0; i -= 8) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 90 days':
                // Ensure we get exactly 7 data points for the default view
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (89 - i * 15));
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                console.log('Generated 90-day labels:', labels);
                break;
            case 'Last 6 months':
                for (let i = 179; i >= 0; i -= 25) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Aug 14 - Aug 20':
                labels.push('Aug 14', 'Aug 15', 'Aug 16', 'Aug 17', 'Aug 18', 'Aug 19', 'Aug 20');
                break;
            default:
                // Default to last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
        }
        
        return labels;
    }

    // Add click handlers to breakdown filter buttons
    document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('.breakdown-filter-btn');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons in the same section
                const section = this.closest('.breakdown-section');
                const sectionButtons = section.querySelectorAll('.breakdown-filter-btn');
                sectionButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update chart based on selected metric
                const metric = this.getAttribute('data-metric');
                if (metric.startsWith('failed-')) {
                    updateFailedChart(metric);
                } else {
                    updateChart(metric);
                }
            });
        });

        // Date Range Dropdown Functionality
        const dateRangeDropdown = document.getElementById('dateRangeDropdown');
        const dateRangeMenu = document.getElementById('dateRangeMenu');
        const dropdownItems = document.querySelectorAll('.dropdown-item');

        // Toggle dropdown
        dateRangeDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            dateRangeMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            dateRangeMenu.classList.remove('show');
        });

        // Handle dropdown item selection
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                console.log('Dropdown item clicked:', this.textContent);
                
                // Remove active class from all items
                dropdownItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                
                // Add active class to selected item
                this.classList.add('active');
                
                // Update dropdown trigger text
                dateRangeDropdown.textContent = this.textContent;
                dateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                dateRangeDropdown.querySelector('i').classList.add('filter-icon');
                
                console.log('About to call updateChartDateRanges with:', this.textContent);
                
                // Update charts with current business type
                updateChartDateRanges(this.textContent, currentBusinessType);
                
                // Update AI assistant prompts with new date range
                updateAssistantPrompts(currentBusinessType, this.textContent);
                
                // Preserve the correct page title
                preservePageTitle();
                
                // Close dropdown
                dateRangeMenu.classList.remove('show');
                
                // Reinitialize lucide icons
                lucide.createIcons();
            });
        });

        // Initialize with default date range and business type
        updateChartDateRanges('Last 90 days', 'medium');
        
        // Initialize AI assistant prompts
        console.log('Initializing AI assistant prompts...');
        updateAssistantPrompts('medium', 'Last 90 days');
        
        // Force update the main chart on page load
        setTimeout(() => {
            console.log('About to call updateMainChart');
            updateMainChart('Last 90 days', 'medium');
            console.log('updateMainChart call completed');
        }, 500);
        
        // Fallback: Update prompts after a delay to ensure everything is loaded
        setTimeout(() => {
            console.log('Fallback: Updating AI assistant prompts...');
            updateAssistantPrompts('medium', 'Last 90 days');
        }, 1000);
        
        // Initialize chart tooltips
        initializeChartTooltips();
        
        // Optimization Date Range Dropdown Functionality
        const optimizationDateRangeDropdown = document.getElementById('optimizationDateRangeDropdown');
        const optimizationDateRangeMenu = document.getElementById('optimizationDateRangeMenu');
        const optimizationDropdownItems = document.querySelectorAll('#optimizationDateRangeMenu .dropdown-item');

        // Toggle dropdown
        if (optimizationDateRangeDropdown) {
            optimizationDateRangeDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                optimizationDateRangeMenu.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            if (optimizationDateRangeMenu) {
                optimizationDateRangeMenu.classList.remove('show');
            }
        });

        // Handle dropdown item selection
        optimizationDropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                console.log('Optimization dropdown item clicked:', this.textContent);
                
                // Remove active class from all items
                optimizationDropdownItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                
                // Add active class to selected item
                this.classList.add('active');
                
                // Update dropdown trigger text
                optimizationDateRangeDropdown.textContent = this.textContent;
                optimizationDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                optimizationDateRangeDropdown.querySelector('i').classList.add('filter-icon');
                
                // Update optimization page with new date range
                if (currentBusinessType) {
                    updateOptimizationPage(currentBusinessType, this.textContent);
                }
                
                // Preserve the correct page title
                preservePageTitle();
                
                // Close dropdown
                optimizationDateRangeMenu.classList.remove('show');
                
                // Reinitialize lucide icons
                lucide.createIcons();
            });
        });
    });

    // Failed card payments chart data (now includes bars and table)
    let failedChartData = {
        'failed-volume': {
            label: "Failed payment volume",
            total: "$609.54",
            yAxis: ["$200", "$150", "$100", "$50", "$0"],
            bars: [10, 30, 190, 10, 10, 150, 120],
            table: [
                { reason: 'Stripe', value: '$609.54', count: 18, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'failed-count': {
            label: "Failed",
            total: "18",
            yAxis: ["20", "15", "10", "5", "0"],
            bars: [2, 2, 12, 2, 2, 10, 8],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 18, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'share-failures': {
            label: "Share of failures",
            total: "100.00%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [100, 100, 100, 100, 100, 100, 100],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'failure-rate': {
            label: "Failure rate",
            total: "36.73%",
            yAxis: ["50%", "40%", "30%", "20%", "0%"],
            bars: [20, 25, 40, 10, 5, 35, 30],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 0, share: '0.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        }
    };

    // Function to generate failed payments data based on date range and business type
    function generateFailedDataForTimeframe(dateRange, businessType = 'medium') {
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const failedData = generator.generateFailedData();
        
        const newFailedData = {
            'failed-volume': {
                label: "Failed payment volume",
                total: `$${failedData.totalVolume.toFixed(2)}`,
                yAxis: generateYAxisLabels(failedData.totalVolume, '$'),
                bars: failedData.volume,
                table: [
                    { reason: 'Stripe', value: `$${failedData.totalVolume.toFixed(2)}`, count: Math.round(failedData.totalPayments), share: '100.00%', rate: `${failedData.failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'failed-count': {
                label: "Failed",
                total: Math.round(failedData.totalPayments).toString(),
                yAxis: generateYAxisLabels(failedData.totalPayments, ''),
                bars: failedData.payments,
                table: [
                    { reason: 'Stripe', value: '$0.00', count: Math.round(failedData.totalPayments), share: '100.00%', rate: `${failedData.failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'share-failures': {
                label: "Share of failures",
                total: "100.00%",
                yAxis: ["100%", "75%", "50%", "25%", "0%"],
                bars: failedData.volume.map(() => 100), // All failures are Stripe
                table: [
                    { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: `${failedData.failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'failure-rate': {
                label: "Failure rate",
                total: `${failedData.failureRate.toFixed(2)}%`,
                yAxis: ["50%", "40%", "30%", "20%", "0%"],
                bars: failedData.volume.map(() => failedData.failureRate), // Consistent failure rate
                table: [
                    { reason: 'Stripe', value: '$0.00', count: 0, share: '0.00%', rate: `${failedData.failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            }
        };

        return newFailedData;
    }

    // Function to update failed chart (now updates bars and table)
    function updateFailedChart(metric) {
        const data = failedChartData[metric];
        // Update labels and total
        document.getElementById('failed-metric-label').textContent = data.label;
        document.getElementById('failed-metric-value').textContent = data.total;
        // Update Y-axis labels
        const yAxisLabels = document.querySelectorAll('.breakdown-section:last-child .bar-chart-y-axis span');
        data.yAxis.forEach((label, index) => {
            if (yAxisLabels[index]) {
                yAxisLabels[index].textContent = label;
            }
        });
        // Update bar chart SVG
        const svg = document.querySelector('.breakdown-section:last-child .bar-chart-svg');
        if (svg && data.bars && Array.isArray(data.bars)) {
            let bars = '';
            const barWidth = 25;
            // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
            const xPoints = [80, 200, 320, 440, 560, 680, 720];
            const totalBars = data.bars.length;
            for (let i = 0; i < totalBars; i++) {
                const x = xPoints[i];
                const y = 200 - data.bars[i];
                bars += `<g class="bar-group" transform="translate(${x}, 0)"><rect x="0" y="${y}" width="${barWidth}" height="${data.bars[i]}" fill="#EF4444" opacity="0.8"/></g>`;
            }
            svg.innerHTML = bars;
            
            // Add invisible hover areas for failed chart
            addBarHoverAreas(svg, xPoints, data.bars);
            
            // Reset animations for the updated chart
            setTimeout(() => resetGraphAnimations(), 100);
        }
        // Update table
        const tableBody = document.querySelector('.breakdown-section:last-child .data-table tbody');
        if (tableBody && data.table && Array.isArray(data.table)) {
            tableBody.innerHTML = data.table.map(row => `
                <tr>
                    <td><div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="check" style="width: 16px; height: 16px; color: var(--color-purple-500);"></i>${row.reason}</div></td>
                    <td>${row.value}</td>
                    <td>${row.count}</td>
                    <td>${row.share}</td>
                    <td>${row.rate}</td>
                </tr>
            `).join('') + `
                <tr class="total-row">
                    <td style="font-weight: 700;">Total</td>
                    <td style="font-weight: 700;">${data.total}</td>
                    <td style="font-weight: 700;">${data.total === '18' ? '18' : ''}</td>
                    <td style="font-weight: 700;">100.00%</td>
                    <td style="font-weight: 700;">36.73%</td>
                </tr>
            `;
            // Reinitialize lucide icons for the new check icons
            lucide.createIcons();
        }
    }

    // Data simulation functionality
    const businessData = {
        'small': {
            metrics: {
                'Payment success rate': { value: '78.45%', change: '+2.15%' },
                'Accepted volume': { value: '$1,247.83', change: '+12.34%' },
                'Accepted payments': { value: '156', change: '+8.67%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$1,247.83",
                    yAxis: ["$600", "$450", "$300", "$150", "$0"],
                    bars: [
                        { credit: 180, debit: 140 },
                        { credit: 220, debit: 180 },
                        { credit: 160, debit: 120 },
                        { credit: 100, debit: 80 },
                        { credit: 140, debit: 100 },
                        { credit: 200, debit: 160 },
                        { credit: 240, debit: 200 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "156",
                    yAxis: ["80", "60", "40", "20", "0"],
                    bars: [
                        { credit: 45, debit: 35 },
                        { credit: 55, debit: 45 },
                        { credit: 40, debit: 30 },
                        { credit: 25, debit: 20 },
                        { credit: 35, debit: 25 },
                        { credit: 50, debit: 40 },
                        { credit: 60, debit: 50 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "78.45%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 80, debit: 60 },
                        { credit: 85, debit: 70 },
                        { credit: 75, debit: 65 },
                        { credit: 70, debit: 50 },
                        { credit: 78, debit: 65 },
                        { credit: 82, debit: 68 },
                        { credit: 88, debit: 75 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$341.17",
                    yAxis: ["$100", "$75", "$50", "$25", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "43",
                    yAxis: ["50", "40", "30", "20", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "21.55%",
                    yAxis: ["30%", "25%", "20%", "15%", "0%"]
                }
            }
        },
        'medium': {
            metrics: {
                'Payment success rate': { value: '85.23%', change: '+3.45%' },
                'Accepted volume': { value: '$12,847.56', change: '+18.67%' },
                'Accepted payments': { value: '1,247', change: '+15.23%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$12,847.56",
                    yAxis: ["$6,000", "$4,500", "$3,000", "$1,500", "$0"],
                    bars: [
                        { credit: 1800, debit: 1400 },
                        { credit: 2200, debit: 1800 },
                        { credit: 1600, debit: 1200 },
                        { credit: 1000, debit: 800 },
                        { credit: 1400, debit: 1000 },
                        { credit: 2000, debit: 1600 },
                        { credit: 2400, debit: 2000 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "1,247",
                    yAxis: ["800", "600", "400", "200", "0"],
                    bars: [
                        { credit: 450, debit: 350 },
                        { credit: 550, debit: 450 },
                        { credit: 400, debit: 300 },
                        { credit: 250, debit: 200 },
                        { credit: 350, debit: 250 },
                        { credit: 500, debit: 400 },
                        { credit: 600, debit: 500 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "85.23%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 85, debit: 70 },
                        { credit: 88, debit: 75 },
                        { credit: 82, debit: 68 },
                        { credit: 80, debit: 65 },
                        { credit: 84, debit: 70 },
                        { credit: 87, debit: 72 },
                        { credit: 90, debit: 78 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$2,152.44",
                    yAxis: ["$1,000", "$750", "$500", "$250", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "216",
                    yAxis: ["250", "200", "150", "100", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "14.77%",
                    yAxis: ["20%", "15%", "10%", "5%", "0%"]
                }
            }
        },
        'large': {
            metrics: {
                'Payment success rate': { value: '91.67%', change: '+2.89%' },
                'Accepted volume': { value: '$89,432.15', change: '+24.56%' },
                'Accepted payments': { value: '8,943', change: '+22.34%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$89,432.15",
                    yAxis: ["$40,000", "$30,000", "$20,000", "$10,000", "$0"],
                    bars: [
                        { credit: 12000, debit: 10000 },
                        { credit: 15000, debit: 13000 },
                        { credit: 11000, debit: 9000 },
                        { credit: 8000, debit: 6000 },
                        { credit: 13000, debit: 11000 },
                        { credit: 18000, debit: 15000 },
                        { credit: 22000, debit: 18000 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "8,943",
                    yAxis: ["5,000", "4,000", "3,000", "2,000", "0"],
                    bars: [
                        { credit: 2800, debit: 2200 },
                        { credit: 3500, debit: 2900 },
                        { credit: 2500, debit: 2000 },
                        { credit: 1800, debit: 1400 },
                        { credit: 3200, debit: 2600 },
                        { credit: 3500, debit: 2900 },
                        { credit: 4200, debit: 3500 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "91.67%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 90, debit: 75 },
                        { credit: 92, debit: 80 },
                        { credit: 88, debit: 72 },
                        { credit: 85, debit: 70 },
                        { credit: 89, debit: 74 },
                        { credit: 93, debit: 78 },
                        { credit: 95, debit: 82 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$8,067.85",
                    yAxis: ["$4,000", "$3,000", "$2,000", "$1,000", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "813",
                    yAxis: ["1,000", "800", "600", "400", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "8.33%",
                    yAxis: ["12%", "10%", "8%", "4%", "0%"]
                }
            }
        }
    };

    let currentBusinessType = 'medium';
    
    // Function to preserve the correct page title - always "Payments analytics"
    function preservePageTitle() {
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
            pageTitle.textContent = 'Payments analytics';
        }
    }

    // Simple function to switch business type
    function switchBusinessType(businessType) {
        console.log('switchBusinessType called with:', businessType);
        
        // Remove active class from all tabs
        document.querySelectorAll('.business-type-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked tab
        const activeTab = document.querySelector(`[data-type="${businessType}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        } else {
            console.error('Could not find tab with data-type:', businessType);
        }
        
        // Update business data
        updateBusinessData(businessType);
        
        // Force immediate prompt update
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateAssistantPrompts(businessType, currentDateRange);
        
        console.log('Business type switched to:', businessType);
    }

    function updateBusinessData(businessType) {
        console.log('updateBusinessData called with:', businessType);
        currentBusinessType = businessType;
        
        // Get current date range
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        console.log('Current date range:', currentDateRange);
        
        // Update all data using the realistic data generator
        updateChartDateRanges(currentDateRange, businessType);
        
        // Update AI assistant prompts with new business context
        updateAssistantPrompts(businessType, currentDateRange);
        
        // Update optimization page if it exists
        updateOptimizationPage(businessType, currentDateRange);
        
        // Preserve the correct page title based on current active tab
        preservePageTitle();
        
        console.log('Business data updated for:', businessType);
    }



    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Remove duplicate initialization - this is already handled in the main initialization below
        // updateBusinessData('medium');
        
        // Ensure business type tabs are properly initialized
        console.log('DOM loaded, initializing business type tabs...');
        const businessTypeTabs = document.querySelectorAll('.business-type-tab');
        console.log('Found business type tabs:', businessTypeTabs.length);
        
        // Set initial business type
        currentBusinessType = 'medium';
        console.log('Initial business type set to:', currentBusinessType);
    });

    // Function to update AI assistant prompts based on business type and data
    function updateOptimizationPage(businessType, dateRange) {
        console.log('updateOptimizationPage called with:', businessType, dateRange);
        const optimizationView = document.getElementById('optimization-view');
        if (!optimizationView) {
            console.log('Optimization view not found!');
            return;
        }
        console.log('Found optimization view, updating content...');
        console.log('Optimization view display style:', optimizationView.style.display);
        
        // Generate dynamic data based on business type and date range
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const businessMetrics = generator.getBusinessMetrics();
        const timeframeMultipliers = generator.getTimeframeMultipliers();
        
        // Calculate base values for the selected timeframe
        const totalDays = timeframeMultipliers.days;
        const avgDailyVolume = businessMetrics.avgTransactionValue * businessMetrics.dailyTransactions;
        const totalVolume = avgDailyVolume * totalDays * timeframeMultipliers.volume;
        const totalTransactions = businessMetrics.dailyTransactions * totalDays * timeframeMultipliers.payments;
        
        // Generate realistic data with some variation
        const successRate = businessMetrics.successRate + (generator.rng() - 0.5) * 3; // 1.5% variation
        const authRate = Math.min(100, successRate + 5 + (generator.rng() - 0.5) * 4); // Slightly higher than success rate
        const disputeRate = businessMetrics.disputeRate + (generator.rng() - 0.5) * 0.2; // Small variation
        const retentionRate = 45 + (businessType === 'small' ? 0 : businessType === 'medium' ? 20 : 35) + (generator.rng() - 0.5) * 10;
        
        // Calculate derived metrics
        const finalRevenue = totalVolume * (successRate / 100);
        const revenueLost = totalVolume - finalRevenue;
        const declinedTransactions = Math.round(totalTransactions * (1 - authRate / 100));
        const disputeTransactions = Math.round(totalTransactions * disputeRate / 100);
        const fraudLosses = Math.round(totalVolume * 0.008); // 0.8% fraud rate
        
        const data = {
            totalVolume: Math.round(totalVolume),
            totalTransactions: Math.round(totalTransactions),
            successRate: Math.round(successRate * 10) / 10,
            authRate: Math.round(authRate * 10) / 10,
            disputeRate: Math.round(disputeRate * 10) / 10,
            retentionRate: Math.round(retentionRate * 10) / 10,
            finalRevenue: Math.round(finalRevenue),
            revenueLost: Math.round(revenueLost),
            declinedTransactions: declinedTransactions,
            disputeTransactions: disputeTransactions,
            fraudLosses: fraudLosses,
            recoveredTransactions: 134 // Demo value for recovered payments count
        };
        
        // Update performance stats (the four cards at the top)
        updatePerformanceStats(optimizationView, data);
        
        // Update summary stats (only if they exist)
        const summaryStats = optimizationView.querySelectorAll('.summary-stats .stat-value');
        if (summaryStats.length >= 4) {
            summaryStats[0].textContent = formatCurrency(data.totalVolume);
            summaryStats[1].textContent = formatCurrency(Math.abs(data.revenueLost));
            summaryStats[2].textContent = formatCurrency(data.finalRevenue);
            summaryStats[3].textContent = `${data.successRate}%`;
            console.log('Updated summary stats for', businessType, ':', {
                totalRevenue: formatCurrency(data.totalVolume),
                revenueRecovered: formatCurrency(Math.abs(data.revenueLost)),
                finalRevenue: formatCurrency(data.finalRevenue),
                successRate: `${data.successRate}%`
            });
        } else {
            console.log('No summary stats found, skipping summary stats update');
        }
        
        // Update waterfall chart
        updateWaterfallChart(optimizationView, data);
        
        // Update performance snapshot
        updatePerformanceSnapshot(optimizationView, data);
        
        // Update optimization opportunities
        updateOptimizationOpportunities(optimizationView, businessType, data, dateRange);
        
        // Update Experiments table
        updateABTestingTable(optimizationView, businessType, data, dateRange);
        
        // Update timeline
        updateTimeline(optimizationView, businessType, data);
        
        // Update performance insights
        updatePerformanceInsights(optimizationView, businessType, data);
        
        // Update quick actions
        updateQuickActions(optimizationView, businessType, data, dateRange);
        
        // Update resources section
        updateResourcesSection(optimizationView, businessType);
        
        // Update assistant prompts
        updateOptimizationAssistantPrompts(optimizationView, businessType, data, dateRange);
        
        // Add a visible indicator in the optimization view
        const lifecycleTitle = optimizationView.querySelector('.lifecycle-title');
        if (lifecycleTitle) {
            lifecycleTitle.textContent = `Payment lifecycle`;
        }
    }
    
    // Function to update performance stats cards
    function updatePerformanceStats(container, data) {
        console.log('updatePerformanceStats called with data:', data);
        console.log('Recovered transactions value:', data.recoveredTransactions);
        const performanceCards = container.querySelectorAll('.performance-stat-card');
        console.log('Found performance cards:', performanceCards.length);
        if (performanceCards.length >= 4) {
            // Total revenue
            const totalRevenueCard = performanceCards[0];
            const totalRevenueValue = totalRevenueCard.querySelector('.stat-value');
            if (totalRevenueValue) {
                totalRevenueValue.textContent = formatCurrency(data.totalVolume);
            }
            
            // Total revenue recovered
            const revenueLostCard = performanceCards[1];
            const revenueLostValue = revenueLostCard.querySelector('.stat-value');
            if (revenueLostValue) {
                // Display as positive value since it's "recovered" revenue
                revenueLostValue.textContent = formatCurrency(Math.abs(data.revenueLost));
            }
            
            // Recovered payments (count of recovered transactions)
            const recoveredVolumeCard = performanceCards[2];
            const recoveredVolumeValue = recoveredVolumeCard.querySelector('.stat-value');
            if (recoveredVolumeValue) {
                // Ensure we display as a count, not currency
                const count = data.recoveredTransactions || 0;
                recoveredVolumeValue.textContent = count.toString();
                console.log('Updated recovered payments card:', {
                    cardIndex: 2,
                    dataValue: data.recoveredTransactions,
                    displayValue: count.toString(),
                    elementFound: !!recoveredVolumeValue,
                    currentTextContent: recoveredVolumeValue.textContent,
                    element: recoveredVolumeValue
                });
            } else {
                console.error('Could not find recovered payments value element');
            }
            
            // Success rate
            const successRateCard = performanceCards[3];
            const successRateValue = successRateCard.querySelector('.stat-value');
            if (successRateValue) {
                successRateValue.textContent = `${data.successRate}%`;
            }
            
            console.log('Updated performance stats:', {
                totalRevenue: formatCurrency(data.totalVolume),
                revenueRecovered: formatCurrency(Math.abs(data.revenueLost)),
                recoveredPayments: data.recoveredTransactions || 0,
                successRate: `${data.successRate}%`
            });
        } else {
            console.error('Could not find performance stat cards:', performanceCards.length);
        }
    }
    
    function formatCurrency(amount) {
        // Handle undefined, null, or NaN values
        if (amount === undefined || amount === null || isNaN(amount)) {
            return '$0';
        }
        
        // Ensure amount is a number
        const numAmount = Number(amount);
        if (isNaN(numAmount)) {
            return '$0';
        }
        
        // Handle negative values
        const isNegative = numAmount < 0;
        const absAmount = Math.abs(numAmount);
        
        let formattedValue;
        if (absAmount >= 1000000) {
            formattedValue = `${(absAmount / 1000000).toFixed(1)}M`;
        } else if (absAmount >= 1000) {
            formattedValue = `${(absAmount / 1000).toFixed(1)}k`;
        } else {
            formattedValue = `${Math.round(absAmount)}`;
        }
        
        return isNegative ? `-$${formattedValue}` : `$${formattedValue}`;
    }
    
    function updateWaterfallChart(container, data) {
        const waterfallItems = container.querySelectorAll('.waterfall-item');
        if (waterfallItems.length >= 5) {
            // Calculate bar heights based on data (max height 200px)
            const maxValue = Math.max(data.totalVolume, data.finalRevenue);
            const scaleFactor = 200 / maxValue;
            
            // Authentication
            const authItem = waterfallItems[0];
            const authHeight = Math.round(data.totalVolume * scaleFactor);
            authItem.querySelector('.waterfall-bar').style.height = `${authHeight}px`;
            authItem.querySelector('.detail-value').textContent = formatCurrency(data.totalVolume);
            authItem.querySelector('.detail-rate').textContent = `${data.totalTransactions.toLocaleString()} transactions`;
            
            // Declines
            const declineItem = waterfallItems[1];
            const declineAmount = data.totalVolume * (1 - data.authRate / 100);
            const declineHeight = Math.round(declineAmount * scaleFactor);
            declineItem.querySelector('.waterfall-bar').style.height = `${declineHeight}px`;
            declineItem.querySelector('.detail-value').textContent = formatCurrency(-declineAmount);
            declineItem.querySelector('.detail-rate').textContent = `${data.declinedTransactions.toLocaleString()} declined`;
            
            // Disputes
            const disputeItem = waterfallItems[2];
            const disputeAmount = data.totalVolume * data.disputeRate / 100;
            const disputeHeight = Math.round(disputeAmount * scaleFactor);
            disputeItem.querySelector('.waterfall-bar').style.height = `${disputeHeight}px`;
            disputeItem.querySelector('.detail-value').textContent = formatCurrency(-disputeAmount);
            disputeItem.querySelector('.detail-rate').textContent = `${data.disputeTransactions} disputes`;
            
            // Fraud
            const fraudItem = waterfallItems[3];
            const fraudHeight = Math.round(data.fraudLosses * scaleFactor);
            fraudItem.querySelector('.waterfall-bar').style.height = `${fraudHeight}px`;
            fraudItem.querySelector('.detail-value').textContent = formatCurrency(-data.fraudLosses);
            fraudItem.querySelector('.detail-rate').textContent = `${formatCurrency(-data.fraudLosses)} fraud losses`;
            
            // Final Revenue
            const finalItem = waterfallItems[4];
            const finalHeight = Math.round(data.finalRevenue * scaleFactor);
            finalItem.querySelector('.waterfall-bar').style.height = `${finalHeight}px`;
            finalItem.querySelector('.detail-value').textContent = formatCurrency(data.finalRevenue);
            finalItem.querySelector('.detail-rate').textContent = `${data.successRate}% success rate`;
        }
    }
    
    function updatePerformanceSnapshot(container, data) {
        const snapshotCards = container.querySelectorAll('.snapshot-card');
        if (snapshotCards.length >= 4) {
            // Checkout conversion
            snapshotCards[0].querySelector('.snapshot-card-value').textContent = `${data.successRate}%`;
            updateSnapshotChart(snapshotCards[0], data.successRate, 100);
            
            // Authorization rate
            snapshotCards[1].querySelector('.snapshot-card-value').textContent = `${data.authRate}%`;
            updateSnapshotChart(snapshotCards[1], data.authRate, 100);
            
            // Dispute rate
            snapshotCards[2].querySelector('.snapshot-card-value').textContent = `${data.disputeRate}%`;
            updateSnapshotChart(snapshotCards[2], data.disputeRate, 1.0);
            
            // Customer retention
            snapshotCards[3].querySelector('.snapshot-card-value').textContent = `${data.retentionRate}%`;
            updateSnapshotChart(snapshotCards[3], data.retentionRate, 100);
        }
    }
    
    function updateSnapshotChart(card, currentValue, maxValue) {
        const svg = card.querySelector('.snapshot-chart-svg');
        if (!svg) return;

        // Generate time series data for the line chart
        const generator = new RealisticDataGenerator(currentBusinessType, 'Last 90 days');

        // Generate data points for the three lines
        const baselineData = generator.generateTimeSeriesData(currentValue * 0.85, 0.1, 0.05);
        const currentData = generator.generateTimeSeriesData(currentValue, 0.08, 0.02);
        const optimizedData = generator.generateTimeSeriesData(Math.min(currentValue * 1.08, maxValue), 0.06, 0.03);

        // Define x-coordinates for the line chart (3 points for baseline, current, potential)
        // Use coordinates that span the full width of the SVG (0 to 200)
        const xPoints = [0, 100, 200]; // Span the full width from 0 to 200 (200 units wide)

        // Convert to Y coordinates (invert for SVG coordinate system)
        const baselineY = baselineData.slice(0, 3).map(v => 200 - (v / maxValue * 200));
        const currentY = currentData.slice(0, 3).map(v => 200 - (v / maxValue * 200));
        const optimizedY = optimizedData.slice(0, 3).map(v => 200 - (v / maxValue * 200));

        // Build SVG paths
        let baselineLine = '';
        let currentLine = '';
        let optimizedLine = '';

        for (let i = 0; i < xPoints.length; i++) {
            if (i === 0) {
                baselineLine = `M${xPoints[i]},${baselineY[i]}`;
                currentLine = `M${xPoints[i]},${currentY[i]}`;
                optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
            } else {
                baselineLine += ` L${xPoints[i]},${baselineY[i]}`;
                currentLine += ` L${xPoints[i]},${currentY[i]}`;
                optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
            }
        }

        // Update SVG content with line paths
        svg.innerHTML = `
            <!-- Baseline performance line (gray) -->
            <path d="${baselineLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
            <!-- Current performance line (purple) -->
            <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
            <!-- AI-optimized performance line (green) -->
            <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
        `;
    }
    
    function updateOptimizationOpportunities(container, businessType, data, dateRange) {
        console.log('updateOptimizationOpportunities called with:', businessType, data);
        const opportunities = {
            small: [
                {
                    title: "Elements integration",
                    description: "Upgrade to Elements for better UX and security",
                    impact: "+1.8%",
                    impactLabel: "conversion rate",
                    revenue: "+$3,200/year",
                    effort: "Easy",
                    effortDetail: "2-3 hours",
                    timeline: "Same day"
                },
                {
                    title: "Radar fraud detection",
                    description: "Enable Radar to prevent fraudulent transactions",
                    impact: "+1.5%",
                    impactLabel: "approval rate",
                    revenue: "+$2,100/year",
                    effort: "Easy",
                    effortDetail: "15 minute setup",
                    timeline: "Same day"
                },
                {
                    title: "Checkout optimization",
                    description: "Use Checkout for optimized payment flows",
                    impact: "+1.2%",
                    impactLabel: "conversion rate",
                    revenue: "+$1,800/year",
                    effort: "Easy",
                    effortDetail: "1 hour setup",
                    timeline: "Same day"
                }
            ],
            medium: [
                {
                    title: "Payment Intents",
                    description: "Implement Payment Intents for better authorization rates",
                    impact: "+2.5%",
                    impactLabel: "approval rate",
                    revenue: "+$45,000/year",
                    effort: "Medium",
                    effortDetail: "1-2 dev days",
                    timeline: "1 week"
                },
                {
                    title: "Smart Retries",
                    description: "Enable intelligent retry logic for declined payments",
                    impact: "+2.1%",
                    impactLabel: "recovery rate",
                    revenue: "+$38,000/year",
                    effort: "Easy",
                    effortDetail: "30 minute setup",
                    timeline: "Same day"
                },
                {
                    title: "Connect marketplace",
                    description: "Set up Connect for multi-party payment flows",
                    impact: "+1.8%",
                    impactLabel: "revenue growth",
                    revenue: "+$32,000/year",
                    effort: "Medium",
                    effortDetail: "3-5 dev days",
                    timeline: "1-2 weeks"
                }
            ],
            large: [
                {
                    title: "Radar Advanced",
                    description: "Implement custom fraud rules and machine learning",
                    impact: "+3.5%",
                    impactLabel: "approval rate",
                    revenue: "+$320,000/year",
                    effort: "Hard",
                    effortDetail: "1-2 weeks",
                    timeline: "2-3 weeks"
                },
                {
                    title: "Treasury integration",
                    description: "Add banking-as-a-service capabilities",
                    impact: "+2.9%",
                    impactLabel: "revenue growth",
                    revenue: "+$210,000/year",
                    effort: "Medium",
                    effortDetail: "2-3 weeks",
                    timeline: "1 month"
                },
                {
                    title: "Issuing cards",
                    description: "Create virtual and physical cards for your business",
                    impact: "+2.3%",
                    impactLabel: "operational efficiency",
                    revenue: "+$180,000/year",
                    effort: "Medium",
                    effortDetail: "1 week",
                    timeline: "1-2 weeks"
                }
            ]
        };
        
        const businessOpportunities = opportunities[businessType] || opportunities.medium;
        const tableBody = container.querySelector('.opportunities-table tbody');
        
        console.log('Found opportunities table body:', !!tableBody);
        console.log('Business opportunities for', businessType, ':', businessOpportunities.length, 'items');
        
        if (tableBody) {
            tableBody.innerHTML = businessOpportunities.map((opp, index) => `
                <tr class="${index === 0 ? 'high-priority' : index === 1 ? 'high-priority' : 'medium-priority'}">
                    <td>
                        <div class="opportunity-cell">
                            <div class="opportunity-info">
                                <div class="opportunity-title">${opp.title}</div>
                                <div class="opportunity-description">${opp.description}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="impact-cell">
                            <span class="impact-value">${opp.impact}</span>
                            <span class="impact-label">${opp.impactLabel}</span>
                        </div>
                    </td>
                    <td>
                        <span class="revenue-impact">${opp.revenue}</span>
                    </td>
                    <td>
                        <span class="effort-badge ${opp.effort.toLowerCase()}">${opp.effort}</span>
                        <div class="effort-detail">${opp.effortDetail}</div>
                    </td>
                    <td>
                        <div class="table-actions">
                                                            <button class="table-btn secondary" onclick="openAIPanel('How do I implement ${opp.title.toLowerCase()}?', '${businessType}', '${opp.title.toLowerCase().replace(/\s+/g, '-')}', ${data.successRate}, '${dateRange}', ${data.totalTransactions})">
                                Get started
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }
    
    function updateTimeline(container, businessType, data) {
        const timelines = {
            small: [
                {
                    title: "Digital Wallets Added",
                    description: "Integrated Apple Pay and Google Pay for mobile users",
                    impact: "+1.5% conversion rate",
                    date: "June 15, 2024"
                },
                {
                    title: "Basic Retry Logic",
                    description: "Configured simple retry rules for declined transactions",
                    impact: "+1.2% recovery rate",
                    date: "May 28, 2024"
                },
                {
                    title: "Payment Method Expansion",
                    description: "Added local payment options for your region",
                    impact: "+0.8% conversion rate",
                    date: "Current"
                },
                {
                    title: "Advanced Fraud Detection",
                    description: "Implement basic fraud prevention measures",
                    impact: "+1.1% approval rate",
                    date: "Planned"
                }
            ],
            medium: [
                {
                    title: "Smart Retries Implemented",
                    description: "Configured intelligent retry logic for declined transactions",
                    impact: "+2.2% authorization rate",
                    date: "June 15, 2024"
                },
                {
                    title: "Digital Wallets Added",
                    description: "Integrated Apple Pay and Google Pay for mobile users",
                    impact: "+1.5% conversion rate",
                    date: "May 28, 2024"
                },
                {
                    title: "3D Secure Optimization",
                    description: "Experiments automatic vs. challenge-based authentication",
                    impact: "+2.6% authorization rate",
                    date: "Current"
                },
                {
                    title: "Card Network Tokens",
                    description: "Implement card network tokenization for improved security",
                    impact: "+2.3% authorization rate",
                    date: "Planned"
                }
            ],
            large: [
                {
                    title: "Machine Learning Fraud Detection",
                    description: "Deployed AI-powered fraud prevention systems",
                    impact: "+3.2% authorization rate",
                    date: "June 15, 2024"
                },
                {
                    title: "Regional Payment Methods",
                    description: "Added local payment options for international markets",
                    impact: "+2.8% conversion rate",
                    date: "May 28, 2024"
                },
                {
                    title: "Advanced 3D Secure",
                    description: "Implementing intelligent authentication routing",
                    impact: "+2.1% authorization rate",
                    date: "Current"
                },
                {
                    title: "Enterprise Link Deployment",
                    description: "Deploy Link authentication across all customer touchpoints",
                    impact: "+1.8% conversion rate",
                    date: "Planned"
                }
            ]
        };
        
        const businessTimeline = timelines[businessType] || timelines.medium;
        const timelineContainer = container.querySelector('.timeline-container');
        
        if (timelineContainer) {
            timelineContainer.innerHTML = businessTimeline.map((event, index) => {
                const status = index === 0 || index === 1 ? 'completed' : index === 2 ? 'active' : 'future';
                const icon = status === 'completed' ? 'check' : status === 'active' ? 'play' : 'target';
                const iconColor = status === 'completed' ? 'white' : status === 'active' ? 'white' : 'var(--color-gray-400)';
                
                return `
                    <div class="timeline-event ${status}">
                        <div class="event-marker ${status}">
                            <i data-lucide="${icon}" style="width: 16px; height: 16px; color: ${iconColor};"></i>
                        </div>
                        <div class="event-content">
                            <div class="event-header">
                                <h3 class="event-title">${event.title}</h3>
                                <span class="event-date">${event.date}</span>
                            </div>
                            <p class="event-description">${event.description}</p>
                            <div class="event-impact">
                                <span class="impact-label">${status === 'future' ? 'Expected:' : 'Impact:'}</span>
                                <span class="impact-value">${event.impact}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }
    
    function updateOptimizationAssistantPrompts(container, businessType, data, dateRange) {
        const prompts = {
            small: [
                "What are my highest-impact optimization opportunities?",
                "How do I calculate optimization ROI?",
                "What experiments should I run?"
            ],
            medium: [
                "What are my highest-impact optimization opportunities?",
                "How do I calculate optimization ROI?",
                "What experiments should I run?"
            ],
            large: [
                "What enterprise optimization strategies should I implement?",
                "How do I scale Radar fraud detection for my volume?",
                "What international payment methods should I add?"
            ]
        };
        
        const businessPrompts = prompts[businessType] || prompts.medium;
        const promptButtons = container.querySelectorAll('.prompt-btn');
        
        promptButtons.forEach((button, index) => {
            if (businessPrompts[index]) {
                button.textContent = businessPrompts[index];
                button.onclick = () => {
                    openAIPanel(businessPrompts[index], businessType, 'optimization', data.successRate, dateRange, data.totalTransactions);
                };
            }
        });
    }

    function updateABTestingTable(container, businessType, data, dateRange) {
        console.log('updateABTestingTable called with:', businessType);
        const abTests = {
            small: [
                {
                    title: "Elements integration",
                    description: "Testing Elements vs. custom payment forms",
                    status: "active",
                    progress: 45,
                    control: "78.2%",
                    variant: "79.7%",
                    improvement: "+1.5%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Checkout optimization",
                    description: "Testing Checkout vs. embedded forms",
                    status: "completed",
                    progress: 100,
                    control: "75.1%",
                    variant: "76.3%",
                    improvement: "+1.2%",
                    actions: ["Deploy", "Report"]
                }
            ],
            medium: [
                {
                    title: "3D Secure optimization",
                    description: "Testing automatic vs. challenge-based 3D Secure authentication",
                    status: "active",
                    progress: 67,
                    control: "89.2%",
                    variant: "91.8%",
                    improvement: "+2.6%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Smart Retries configuration",
                    description: "Testing different retry strategies for declined payments",
                    status: "completed",
                    progress: 100,
                    control: "85.1%",
                    variant: "87.3%",
                    improvement: "+2.2%",
                    actions: ["Deploy", "Report"]
                }
            ],
            large: [
                {
                    title: "Radar Advanced",
                    description: "Testing custom fraud rules and machine learning",
                    status: "active",
                    progress: 78,
                    control: "91.2%",
                    variant: "94.4%",
                    improvement: "+3.2%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Connect marketplace",
                    description: "Testing multi-party payment flows",
                    status: "completed",
                    progress: 100,
                    control: "89.8%",
                    variant: "92.6%",
                    improvement: "+2.8%",
                    actions: ["Deploy", "Report"]
                }
            ]
        };
        
        const businessTests = abTests[businessType] || abTests.medium;
        const tableBody = container.querySelector('.ab-tests-table tbody');
        
        if (tableBody) {
            tableBody.innerHTML = businessTests.map((test, index) => {
                const isWinner = test.status === 'completed' && test.variant.includes('winner');
                const variantClass = isWinner ? 'winner' : '';
                
                return `
                    <tr class="${test.status}">
                        <td>
                            <div class="test-cell">
                                <div class="test-title">${test.title}</div>
                                <div class="test-description">${test.description}</div>
                            </div>
                        </td>
                        <td>
                            <div class="status-cell ${test.status}">
                                <span class="status-dot"></span>
                                <span class="status-text">${test.status.charAt(0).toUpperCase() + test.status.slice(1)}</span>
                            </div>
                        </td>
                        <td>
                            <div class="progress-cell">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${test.progress}%"></div>
                                </div>
                                <span class="progress-text">${test.progress}% Complete</span>
                            </div>
                        </td>
                        <td>
                            <span class="rate-value">${test.control}</span>
                        </td>
                        <td>
                            <span class="rate-value ${variantClass}">${test.variant}</span>
                        </td>
                        <td>
                            <span class="improvement">${test.improvement}</span>
                        </td>
                        <td>
                            <div class="table-actions">
                                ${test.actions.map(action => {
                                    const icon = action === 'Details' ? 'bar-chart' : 
                                                action === 'Pause' ? 'pause' : 
                                                action === 'Deploy' ? 'check' : 'file-text';
                                    return `
                                        <button class="table-btn secondary" onclick="openAIPanel('How do I ${action.toLowerCase()} this experiment?', '${businessType}', 'ab-test-${action.toLowerCase()}', ${data.successRate}, '${dateRange}', ${data.totalTransactions})">
                                            <i data-lucide="${icon}" style="width: 14px; height: 14px;"></i>
                                            ${action}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    function updatePerformanceInsights(container, businessType, data) {
        console.log('updatePerformanceInsights called with:', businessType);
        const insights = {
            small: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Elements",
                    description: `${data.authRate}% success rate - excellent Elements integration`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Smart Retries",
                    description: `${data.disputeRate}% dispute rate - consider enabling Smart Retries`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ],
            medium: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Payment Intents",
                    description: `${data.authRate}% success rate - excellent Payment Intents implementation`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Radar",
                    description: `${data.disputeRate}% dispute rate - consider enabling Radar fraud detection`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ],
            large: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Radar Advanced",
                    description: `${data.authRate}% success rate - excellent Radar fraud detection`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Connect",
                    description: `${data.disputeRate}% dispute rate - consider implementing Connect for marketplace payments`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ]
        };
        
        const businessInsights = insights[businessType] || insights.medium;
        const insightsContainer = container.querySelector('.performance-insights');
        
        if (insightsContainer) {
            const insightCards = insightsContainer.querySelectorAll('.insight-card');
            businessInsights.forEach((insight, index) => {
                if (insightCards[index]) {
                    const icon = insightCards[index].querySelector('i');
                    const label = insightCards[index].querySelector('.insight-label');
                    const value = insightCards[index].querySelector('.insight-value');
                    const description = insightCards[index].querySelector('.insight-description');
                    const learnMoreLink = insightCards[index].querySelector('.learn-more-link');
                    
                    if (icon) {
                        icon.setAttribute('data-lucide', insight.icon);
                        icon.style.color = insight.color;
                    }
                    if (label) label.textContent = insight.label;
                    if (value) value.textContent = insight.value;
                    if (description) description.textContent = insight.description;
                    if (learnMoreLink) {
                        learnMoreLink.onclick = (e) => {
                            e.preventDefault();
                            openAIPanel(`Tell me more about ${insight.value} optimization`, businessType, 'performance-insights', data.successRate, 'Last 30 days', data.totalTransactions);
                        };
                    }
                }
            });
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateQuickActions(container, businessType, data, dateRange) {
        console.log('updateQuickActions called with:', businessType);
        const actions = {
            small: [
                {
                    text: "Create experiment",
                    icon: "plus",
                    action: "setup-ab-test"
                },
                {
                    text: "Add Elements",
                    icon: "smartphone",
                    action: "add-elements"
                },
                {
                    text: "Configure Smart Retries",
                    icon: "refresh-cw",
                    action: "configure-retries"
                }
            ],
            medium: [
                {
                    text: "Create experiment",
                    icon: "plus",
                    action: "setup-ab-test"
                },
                {
                    text: "Implement Payment Intents",
                    icon: "shield-check",
                    action: "implement-payment-intents"
                },
                {
                    text: "Configure Smart Retries",
                    icon: "refresh-cw",
                    action: "configure-retries"
                }
            ],
            large: [
                {
                    text: "Setup Radar Advanced",
                    icon: "brain",
                    action: "setup-radar"
                },
                {
                    text: "Add Connect",
                    icon: "globe",
                    action: "add-connect"
                },
                {
                    text: "Optimize 3D Secure",
                    icon: "shield",
                    action: "optimize-3d-secure"
                }
            ]
        };
        
        const businessActions = actions[businessType] || actions.medium;
        const actionsContainer = container.querySelector('.quick-actions');
        
        if (actionsContainer) {
            const actionButtons = actionsContainer.querySelectorAll('.quick-action-btn');
            businessActions.forEach((action, index) => {
                if (actionButtons[index]) {
                    const icon = actionButtons[index].querySelector('i');
                    const text = actionButtons[index].querySelector('span') || actionButtons[index];
                    
                    if (icon) icon.setAttribute('data-lucide', action.icon);
                    if (text && text !== actionButtons[index]) {
                        text.textContent = action.text;
                    } else if (text === actionButtons[index]) {
                        actionButtons[index].innerHTML = `
                            <i data-lucide="${action.icon}" style="width: 16px; height: 16px;"></i>
                            ${action.text}
                        `;
                    }
                    
                    actionButtons[index].onclick = () => {
                        openAIPanel(`How do I ${action.text.toLowerCase()}?`, businessType, action.action, data.successRate, dateRange, data.totalTransactions);
                    };
                }
            });
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateResourcesSection(container, businessType) {
        console.log('updateResourcesSection called with:', businessType);
        const resources = {
            small: [
                {
                    name: "Payment optimization guide",
                    description: "Learn how to optimize your payment performance and increase revenue.",
                    icon: "file-text"
                },
                {
                    name: "Experiments best practices",
                    description: "Learn how to design and run effective payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Radar fraud prevention",
                        "Checkout optimization"
                    ]
                }
            ],
            medium: [
                {
                    name: "Advanced payment optimization",
                    description: "Learn enterprise-level payment optimization strategies and best practices.",
                    icon: "file-text"
                },
                {
                    name: "Experiments best practices",
                    description: "Learn how to design and run effective payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Radar fraud prevention",
                        "Checkout optimization"
                    ]
                }
            ],
            large: [
                {
                    name: "Enterprise optimization guide",
                    description: "Learn enterprise-level payment optimization strategies and best practices.",
                    icon: "file-text"
                },
                {
                    name: "Enterprise Experiments",
                    description: "Learn how to design and run enterprise-scale payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Radar Advanced fraud prevention",
                        "Connect marketplace payments"
                    ]
                }
            ]
        };
        
        const businessResources = resources[businessType] || resources.medium;
        const resourcesContainer = container.querySelector('.resources-section');
        
        if (resourcesContainer) {
            const resourceItems = resourcesContainer.querySelectorAll('.resource-item');
            const resourceSubsection = resourcesContainer.querySelector('.resource-subsection');
            
            // Update main resource items
            businessResources.forEach((resource, index) => {
                if (resource.name && resourceItems[index]) {
                    const icon = resourceItems[index].querySelector('.resource-icon');
                    const name = resourceItems[index].querySelector('.resource-name');
                    const description = resourceItems[index].querySelector('.resource-description');
                    
                    if (icon) icon.setAttribute('data-lucide', resource.icon);
                    if (name) name.textContent = resource.name;
                    if (description) description.textContent = resource.description;
                }
            });
            
            // Update subsection
            if (resourceSubsection) {
                const subsectionTitle = resourceSubsection.querySelector('.subsection-title');
                const resourceLinks = resourceSubsection.querySelectorAll('.resource-link span');
                
                const subsectionResource = businessResources.find(r => r.subsection);
                if (subsectionResource && subsectionTitle) {
                    subsectionTitle.textContent = subsectionResource.subsection;
                }
                
                if (subsectionResource && subsectionResource.links) {
                    subsectionResource.links.forEach((link, index) => {
                        if (resourceLinks[index]) {
                            resourceLinks[index].textContent = link;
                        }
                    });
                }
            }
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateAssistantPrompts(businessType, dateRange) {
        console.log('updateAssistantPrompts called with:', businessType, dateRange);
        
        const prompt1 = document.getElementById('prompt-1');
        const prompt2 = document.getElementById('prompt-2');
        const prompt3 = document.getElementById('prompt-3');
        
        console.log('Prompt elements found:', {
            prompt1: !!prompt1,
            prompt2: !!prompt2,
            prompt3: !!prompt3
        });
        
        if (!prompt1 || !prompt2 || !prompt3) {
            console.error('Prompt elements not found!');
            return;
        }
        
        // Get current metrics for context - using hardcoded values for now
        let successRate, volume, payments, failedVolume;
        
        try {
            const generator = new RealisticDataGenerator(businessType, dateRange);
            const allData = generator.generateAllData();
            successRate = allData.metrics.successRate;
            volume = allData.metrics.volume;
            payments = allData.metrics.payments;
            failedVolume = allData.metrics.failedVolume;
    
        } catch (error) {
            console.error('Error generating data:', error);
            // Fallback to hardcoded values
            const fallbackData = {
                small: { successRate: 78.5, volume: 1248, payments: 156, failedVolume: 341 },
                medium: { successRate: 85.2, volume: 12848, payments: 1247, failedVolume: 2152 },
                large: { successRate: 91.7, volume: 89432, payments: 8943, failedVolume: 8068 }
            };
            const data = fallbackData[businessType] || fallbackData.medium;
            successRate = data.successRate;
            volume = data.volume;
            payments = data.payments;
            failedVolume = data.failedVolume;

        }
        
        // Business-specific prompt templates with professional tone
        const promptTemplates = {
            small: {
                prompt1: `How can I improve my ${successRate.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()}?`,
                prompt2: `What's causing my $${Math.round(failedVolume)} in failed payments for the ${dateRange.toLowerCase()} and how can I reduce this?`,
                prompt3: `Are my current payment methods limiting my $${volume.toFixed(0)} volume for the ${dateRange.toLowerCase()}?`
            },
            medium: {
                prompt1: `My authorization rate is ${successRate.toFixed(1)}% for the ${dateRange.toLowerCase()}. What should I investigate?`,
                prompt2: `How can I recover the $${failedVolume.toFixed(0)} lost to failed payments this ${dateRange.toLowerCase().replace('last ', '')}?`,
                prompt3: `What fraud prevention measures should I implement for ${payments} transactions in the ${dateRange.toLowerCase()}?`
            },
            large: {
                prompt1: `How can I optimize my ${successRate.toFixed(1)}% authorization rate for $${(volume/1000).toFixed(1)}k volume in the ${dateRange.toLowerCase()}?`,
                prompt2: `Which payment methods are contributing to my $${failedVolume.toFixed(0)} in failed payments for the ${dateRange.toLowerCase()}?`,
                prompt3: `What enterprise solutions can maximize conversion for ${payments.toLocaleString()} payments in the ${dateRange.toLowerCase()}?`
            }
        };
        
        const templates = promptTemplates[businessType] || promptTemplates.medium;
        
        // Update prompt text
        prompt1.textContent = templates.prompt1;
        prompt2.textContent = templates.prompt2;
        prompt3.textContent = templates.prompt3;
        
        console.log('Prompt text updated:', {
            prompt1: prompt1.textContent,
            prompt2: prompt2.textContent,
            prompt3: prompt3.textContent
        });
        
        // Add click handlers for AI panel
        prompt1.onclick = () => {
            openAIPanel(templates.prompt1, businessType, 'success-rate', successRate, dateRange, payments);
        };
        prompt2.onclick = () => {
            openAIPanel(templates.prompt2, businessType, 'failure-analysis', failedVolume, dateRange, payments);
        };
        prompt3.onclick = () => {
            openAIPanel(templates.prompt3, businessType, 'optimization', successRate, dateRange, payments);
        };
        
        console.log('Click handlers attached to prompts');
        
        // Enhanced debugging - log to console and add visual indicators
        console.log('=== PROMPT UPDATE COMPLETE ===');
        console.log('Business Type:', businessType);
        console.log('Date Range:', dateRange);
        console.log('Final Prompt 1:', prompt1.textContent);
        console.log('Final Prompt 2:', prompt2.textContent);
        console.log('Final Prompt 3:', prompt3.textContent);
        console.log('Prompt elements found:', !!prompt1, !!prompt2, !!prompt3);
        console.log('================================');
        
        // Force a DOM update by triggering a reflow
        prompt1.offsetHeight;
        prompt2.offsetHeight;
        prompt3.offsetHeight;
        

    }
    


    // Function to show professional assistant responses with business-specific advice
    function showAssistantResponse(businessType, topic, metric, dateRange, payments = null) {
        const responses = {
            'success-rate': {
                small: `Your ${metric.toFixed(1)}% authorization rate is within the expected range for businesses of your scale. To optimize further, consider expanding your payment method offerings to include digital wallets and local payment options. Additionally, ensure your checkout flow clearly communicates all fees and total amounts to reduce cart abandonment.`,
                medium: `The decline in your authorization rate to ${metric.toFixed(1)}% warrants investigation. Review your Radar fraud detection settings and 3D Secure configuration. For transactions exceeding $100, consider implementing step-up authentication. Analyze your decline codes to identify whether issues stem from fraud prevention or insufficient funds.`,
                large: `With your current volume, a ${metric.toFixed(1)}% authorization rate indicates strong performance, though there's room for optimization. Consider implementing regional payment methods for your primary markets and upgrading to machine learning-based fraud detection systems, as manual rules may not scale effectively with ${payments ? payments.toLocaleString() : 'large volume'} monthly transactions.`
            },
            'failure-analysis': {
                small: `Your failed payment volume of $${metric.toFixed(0)} represents a significant impact on revenue. Primary causes typically include insufficient funds, expired payment methods, and unclear pricing. Implement automatic retry logic with exponential backoff and consider pre-authorization for transactions over $50. Additionally, enable our Card Updater service to automatically refresh expired payment methods.`,
                medium: `The $${metric.toFixed(0)} in failed payments requires immediate attention. Implement intelligent retry logic with 24-hour intervals and review your decline code patterns. If you're experiencing high "do_not_honor" rates, your acquiring bank may have overly conservative risk parameters. Consider implementing 3D Secure for high-risk transactions and review your fraud detection thresholds.`,
                large: `Your failed payment volume of $${metric.toFixed(0)} necessitates a data-driven approach to optimization. Leverage your analytics to identify patterns across card types, geographic regions, and transaction amounts. Implement regional payment methods for your top markets and consider experiments with different fraud rule configurations. At your scale, even marginal improvements can yield significant revenue gains.`
            },
            'optimization': {
                small: `To improve your ${metric.toFixed(1)}% authorization rate, focus on foundational optimizations: diversify your payment method portfolio, ensure transparent pricing throughout the checkout process, and maintain excellent customer service. Consider implementing basic address verification while prioritizing user experience over complex fraud prevention measures.`,
                medium: `Your business has reached the scale where advanced optimization tools become valuable. Implement 3D Secure for transactions over $100, enable address verification, and deploy intelligent retry logic. Monitor fraud patterns weekly and consider implementing Radar rules for suspicious transaction patterns. Your ${payments} monthly payments provide sufficient data for meaningful trend analysis.`,
                large: `With ${payments.toLocaleString()} monthly payments, enterprise-grade solutions are essential. Implement machine learning-based fraud detection systems, as manual rules cannot effectively scale to your volume. Add regional payment methods for your top five markets and consider establishing a dedicated fraud management team. Utilize experiments to optimize conversion rateseven incremental improvements can generate substantial revenue increases.`
            }
        };
        
        const response = responses[topic][businessType];
        
        // Create a more sophisticated response display
        const responseDiv = document.createElement('div');
        responseDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;
        
        responseDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="width: 32px; height: 32px; background: var(--color-purple-500); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="sparkles" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--color-gray-900);">Assistant Response</h3>
            </div>
            <p style="margin: 0; line-height: 1.6; color: var(--color-gray-700); font-size: 14px;">${response}</p>
            <button onclick="this.parentElement.remove()" style="
                margin-top: 16px;
                padding: 8px 16px;
                background: var(--color-purple-500);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            ">Got it</button>
        `;
        
        document.body.appendChild(responseDiv);
        lucide.createIcons();
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        `;
        backdrop.onclick = () => {
            backdrop.remove();
            responseDiv.remove();
        };
        document.body.appendChild(backdrop);
    }

    // AI Assistant Panel Functions
    function openAIPanel(question, businessType, topic, metric, dateRange, payments = null) {
        // Convert metric to number if it's a string (e.g., "80.3%" -> 80.3)
        let numericMetric = metric;
        if (typeof metric === 'string') {
            // Remove % and $ signs and convert to number
            numericMetric = parseFloat(metric.replace(/[%$]/g, ''));
            if (isNaN(numericMetric)) {
                numericMetric = 0; // Fallback if conversion fails
            }
        }
        const panel = document.getElementById('aiAssistantPanel');
        const mainContent = document.querySelector('.main-content');
        const topBar = document.querySelector('.top-bar');
        const businessTabs = document.querySelector('.business-type-tabs');
        
        if (!panel || !mainContent || !topBar || !businessTabs) {
            console.error('Required elements not found for AI panel');
            return;
        }
        
        // Hide any active tooltip
        hideTooltip();
        
        // Clear previous chat
        const chatContainer = document.getElementById('aiChatContainer');
        if (chatContainer) {
            chatContainer.innerHTML = '';
        }
        
        // Add user's question
        addAIMessage('user', question);
        
        // Generate contextual response based on business type and topic
        const responses = {
            'success-rate': {
                small: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with limited optimization tools.\n\n**Small Business Focus:** Prioritize user experience and foundational improvements over complex fraud prevention.\n\n**Recommended Actions:**\n Diversify payment method portfolio\n Ensure transparent pricing throughout checkout\n Implement basic address verification\n Maintain excellent customer service standards`,
                    pills: [
                        { text: "Add payment methods", icon: "credit-card", type: "primary", action: "add-payment-methods" },
                        { text: "Optimize checkout", icon: "settings", type: "secondary", action: "optimize-checkout" },
                        { text: "View best practices", icon: "file-text", type: "secondary", action: "view-docs" }
                    ]
                },
                medium: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with ${payments} monthly payments.\n\n**Growth Stage:** Your business has reached the scale where advanced optimization tools become valuable.\n\n**Recommended Actions:**\n Implement 3D Secure for transactions over $100\n Enable address verification and intelligent retry logic\n Monitor fraud patterns weekly with Radar rules\n Deploy performance tracking for trend analysis`,
                    pills: [
                        { text: "Advanced 3D Secure", icon: "shield", type: "primary", action: "advanced-3ds" },
                        { text: "Fraud monitoring", icon: "bar-chart", type: "secondary", action: "fraud-monitoring" },
                        { text: "Performance tracking", icon: "trending-up", type: "secondary", action: "performance-tracking" }
                    ]
                },
                large: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with ${payments ? payments.toLocaleString() : 'large volume'} monthly payments.\n\n**Enterprise Scale:** Manual rules can't effectively manage your transaction volume.\n\n**Enterprise Solutions:**\n Implement machine learning fraud detection\n Add regional payment methods for top 5 markets\n Establish dedicated fraud management team\n Deploy experiments for conversion optimization`,
                    pills: [
                        { text: "Enable ML fraud", icon: "brain", type: "primary", action: "enable-ml-fraud" },
                        { text: "Regional payments", icon: "globe", type: "secondary", action: "regional-payments" },
                        { text: "Enterprise support", icon: "message-circle", type: "secondary", action: "contact-support" }
                    ]
                }
            },
            'failure-analysis': {
                small: {
                    message: `**Current Situation:** $${numericMetric.toFixed(0)} in failed payments for the ${dateRange.toLowerCase()} represents a significant revenue impact.\n\n**Common Causes:** Insufficient funds, expired payment methods, and unclear pricing are primary failure drivers for small businesses.\n\n**Recommended Actions:**\n Implement automatic retry logic with exponential backoff\n Enable Card Updater service for expired methods\n Add pre-authorization for transactions over $50\n Optimize checkout flow for transparency`,
                    pills: [
                        { text: "Enable retry logic", icon: "refresh-cw", type: "primary", action: "enable-retry" },
                        { text: "Card updater", icon: "credit-card", type: "secondary", action: "card-updater" },
                        { text: "Optimize checkout", icon: "settings", type: "secondary", action: "optimize-checkout" }
                    ]
                },
                medium: {
                    message: `**Current Situation:** $${numericMetric.toFixed(0)} in failed payments for the ${dateRange.toLowerCase()} requires immediate attention.\n\n**Analysis:** High "do_not_honor" rates suggest overly conservative bank risk parameters or fraud detection thresholds.\n\n**Recommended Actions:**\n Implement intelligent retry logic with 24-hour intervals\n Review fraud detection thresholds and Radar settings\n Enable 3D Secure for high-risk transactions\n Analyze decline code patterns for optimization`,
                    pills: [
                        { text: "Smart retry setup", icon: "refresh-cw", type: "primary", action: "smart-retry" },
                        { text: "Review fraud settings", icon: "shield", type: "secondary", action: "review-fraud" },
                        { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" }
                    ]
                },
                large: {
                    message: `**Current Situation:** $${numericMetric.toFixed(0)} in failed payments for the ${dateRange.toLowerCase()} necessitates data-driven optimization.\n\n**Enterprise Analysis:** At your scale, pattern analysis across card types, regions, and amounts is essential.\n\n**Enterprise Solutions:**\n Leverage analytics to identify failure patterns\n Implement regional payment methods for top markets\n Experiment with different fraud rule configurations\n Establish dedicated payment optimization team`,
                    pills: [
                        { text: "Data analysis", icon: "bar-chart", type: "primary", action: "data-analysis" },
                        { text: "Regional methods", icon: "globe", type: "secondary", action: "regional-payments" },
                        { text: "Enterprise support", icon: "message-circle", type: "secondary", action: "contact-support" }
                    ]
                }
            },
            'optimization': {
                small: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with limited optimization tools.\n\n**Small Business Focus:** Prioritize user experience and foundational improvements over complex fraud prevention.\n\n**Recommended Actions:**\n Diversify payment method portfolio\n Ensure transparent pricing throughout checkout\n Implement basic address verification\n Maintain excellent customer service standards`,
                    pills: [
                        { text: "Add payment methods", icon: "credit-card", type: "primary", action: "add-payment-methods" },
                        { text: "Optimize checkout", icon: "settings", type: "secondary", action: "optimize-checkout" },
                        { text: "View best practices", icon: "file-text", type: "secondary", action: "view-docs" }
                    ]
                },
                medium: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with ${payments} monthly payments.\n\n**Growth Stage:** Your business has reached the scale where advanced optimization tools become valuable.\n\n**Recommended Actions:**\n Implement 3D Secure for transactions over $100\n Enable address verification and intelligent retry logic\n Monitor fraud patterns weekly with Radar rules\n Deploy performance tracking for trend analysis`,
                    pills: [
                        { text: "Advanced 3D Secure", icon: "shield", type: "primary", action: "advanced-3ds" },
                        { text: "Fraud monitoring", icon: "bar-chart", type: "secondary", action: "fraud-monitoring" },
                        { text: "Performance tracking", icon: "trending-up", type: "secondary", action: "performance-tracking" }
                    ]
                },
                large: {
                    message: `**Current Situation:** ${numericMetric.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()} with ${payments ? payments.toLocaleString() : 'large volume'} monthly payments.\n\n**Enterprise Scale:** Manual rules can't effectively manage your transaction volume.\n\n**Enterprise Solutions:**\n Implement machine learning fraud detection\n Add regional payment methods for top 5 markets\n Establish dedicated fraud management team\n Deploy experiments for conversion optimization`,
                    pills: [
                        { text: "ML fraud detection", icon: "brain", type: "primary", action: "ml-fraud" },
                        { text: "Enterprise Experiments", icon: "test-tube", type: "secondary", action: "enterprise-ab-test" },
                        { text: "Dedicated support", icon: "message-circle", type: "secondary", action: "contact-support" }
                    ]
                }
            },
            'ai-insight': {
                small: {
                    message: '**Current Situation:** {insight}\n\n**Small Business Focus:** {recommendation}\n\n**Recommended Actions:**\n Start with basic authentication improvements\n Focus on user experience optimization\n Implement gradual security enhancements\n Monitor performance improvements weekly',
                    pills: [
                        { text: "Enable Link auth", icon: "shield", type: "primary", action: "enable-link-auth" },
                        { text: "3D Secure setup", icon: "settings", type: "secondary", action: "3d-secure-setup" },
                        { text: "View implementation guide", icon: "file-text", type: "secondary", action: "view-implementation-guide" }
                    ]
                },
                medium: {
                    message: '**Current Situation:** {insight}\n\n**Growth Stage:** {recommendation}\n\n**Recommended Actions:**\n Configure Link authentication with custom branding\n Optimize 3D Secure rules for your transaction patterns\n Set up automated monitoring and alerting\n Implement experiments for conversion optimization',
                    pills: [
                        { text: "Advanced Link setup", icon: "shield", type: "primary", action: "advanced-link-setup" },
                        { text: "3D Secure optimization", icon: "settings", type: "secondary", action: "3d-secure-optimization" },
                        { text: "Performance monitoring", icon: "bar-chart", type: "secondary", action: "performance-monitoring" }
                    ]
                },
                large: {
                    message: '**Current Situation:** {insight}\n\n**Enterprise Scale:** {recommendation}\n\n**Enterprise Solutions:**\n Deploy Link authentication across all customer touchpoints\n Implement advanced 3D Secure rules with machine learning\n Set up comprehensive analytics and reporting\n Establish dedicated optimization team and processes',
                    pills: [
                        { text: "Enterprise Link deployment", icon: "shield", type: "primary", action: "enterprise-link-deployment" },
                        { text: "ML-powered 3D Secure", icon: "brain", type: "secondary", action: "ml-3d-secure" },
                        { text: "Dedicated support", icon: "message-circle", type: "secondary", action: "contact-support" }
                    ]
                }
            },
            'bar-chart-insight': {
                small: {
                    message: '**Current Situation:** {insight}\n\n**Small Business Focus:** {recommendation}\n\n**Recommended Actions:**\n Review your current payment method mix\n Analyze transaction patterns and fees\n Consider adding new payment options\n Monitor conversion rates after changes',
                    pills: [
                        { text: "Payment method mix", icon: "credit-card", type: "primary", action: "payment-method-mix" },
                        { text: "Fee optimization", icon: "dollar-sign", type: "secondary", action: "fee-optimization" },
                        { text: "Add payment methods", icon: "plus", type: "secondary", action: "add-payment-methods" }
                    ]
                },
                medium: {
                    message: '**Current Situation:** {insight}\n\n**Growth Stage:** {recommendation}\n\n**Recommended Actions:**\n Implement dynamic payment method selection\n Set up automated fee analysis and optimization\n Add digital wallet support (Apple Pay, Google Pay)\n Monitor and optimize conversion rates',
                    pills: [
                        { text: "Dynamic payment selection", icon: "settings", type: "primary", action: "dynamic-payment-selection" },
                        { text: "Digital wallets", icon: "smartphone", type: "secondary", action: "digital-wallets" },
                        { text: "Conversion optimization", icon: "trending-up", type: "secondary", action: "conversion-optimization" }
                    ]
                },
                large: {
                    message: '**Current Situation:** {insight}\n\n**Enterprise Scale:** {recommendation}\n\n**Enterprise Solutions:**\n Deploy AI-powered payment method optimization\n Implement regional payment methods for key markets\n Set up comprehensive analytics and reporting\n Establish dedicated payment optimization team',
                    pills: [
                        { text: "AI payment optimization", icon: "brain", type: "primary", action: "ai-payment-optimization" },
                        { text: "Regional payments", icon: "globe", type: "secondary", action: "regional-payments" },
                        { text: "Enterprise analytics", icon: "bar-chart", type: "secondary", action: "enterprise-analytics" }
                    ]
                }
            }
        };
        
        const responseData = responses[topic][businessType];
        
        // Add error handling and debugging
        if (!responseData) {
            console.error('Response data not found for:', { topic, businessType, responses });
            // Fallback response
            const fallbackResponse = {
                message: `I understand your question about ${topic}. Let me provide some insights based on your business type and current metrics.`,
                pills: [
                    { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                    { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" },
                    { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" }
                ]
            };
            addAIMessage('assistant', fallbackResponse.message, fallbackResponse.pills);
        } else {
            // Handle AI insight responses that need stored data
            let message = responseData.message;
            if (topic === 'ai-insight' || topic === 'bar-chart-insight') {
                const storedData = window.currentHoverData;
                if (storedData && storedData.insight && storedData.recommendation) {
                    message = message.replace('{insight}', storedData.insight).replace('{recommendation}', storedData.recommendation);
                } else {
                    // Fallback if no stored data
                    message = `I understand you're looking at an AI insight. Let me provide some recommendations for improving your payment performance.`;
                }
            }
            addAIMessage('assistant', message, responseData.pills);
        }
        
        // Store context for follow-up questions
        panel.dataset.businessType = businessType;
        panel.dataset.topic = topic;
        panel.dataset.metric = metric;
        panel.dataset.dateRange = dateRange;
        panel.dataset.payments = payments;
        
        // Open panel and adjust layout
        console.log('About to add "open" class to panel...');
        panel.classList.add('open');
        mainContent.classList.add('ai-panel-open');
        topBar.classList.add('ai-panel-open');
        
        console.log('Panel after opening:', panel.classList.toString());
        console.log('Panel computed style transform:', window.getComputedStyle(panel).transform);
        
        // Focus on input
        setTimeout(() => {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.focus();
                console.log('AI input focused');
            } else {
                console.error('AI input not found');
            }
        }, 300);
    }

    function closeAIPanel() {
        const panel = document.getElementById('aiAssistantPanel');
        const mainContent = document.querySelector('.main-content');
        const topBar = document.querySelector('.top-bar');
        
        // Close panel and restore layout
        panel.classList.remove('open');
        mainContent.classList.remove('ai-panel-open');
        topBar.classList.remove('ai-panel-open');
    }

    // Lo-fi Mode Toggle Function
    function toggleLofiMode() {
        const toggle = document.querySelector('.toggle-switch');
        const isActive = toggle.classList.contains('active');
        
        if (isActive) {
            // Disable lo-fi mode
            toggle.classList.remove('active');
            document.body.classList.remove('lofi-mode');
            restoreOriginalContent();
        } else {
            // Enable lo-fi mode
            toggle.classList.add('active');
            document.body.classList.add('lofi-mode');
            convertToSkeletonMode();
        }
    }

    function convertToSkeletonMode() {
        // Performance stats at the top
        const performanceStats = document.querySelector('.performance-stats');
        if (performanceStats) {
            const originalContent = performanceStats.innerHTML;
            performanceStats.dataset.originalContent = originalContent;
            performanceStats.innerHTML = `
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
            `;
        }

        // Payment lifecycle waterfall chart
        const waterfallChart = document.querySelector('.waterfall-chart');
        if (waterfallChart) {
            const originalContent = waterfallChart.innerHTML;
            waterfallChart.dataset.originalContent = originalContent;
            waterfallChart.innerHTML = `
                <div class="skeleton-block skeleton-waterfall">
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Key metrics - preserve header, skeleton only the content
        const metricsSection = document.querySelector('.performance-snapshot');
        if (metricsSection) {
            const originalContent = metricsSection.innerHTML;
            metricsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = metricsSection.querySelector('.snapshot-title');
            const headerHTML = header ? header.outerHTML : '';
            
            metricsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-metrics-grid">
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Recommendations - preserve header, skeleton only the content
        const recommendationsSection = document.querySelector('.optimization-opportunities');
        if (recommendationsSection) {
            const originalContent = recommendationsSection.innerHTML;
            recommendationsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = recommendationsSection.querySelector('.opportunities-header');
            const headerHTML = header ? header.outerHTML : '';
            
            recommendationsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-impact-value"></div>
                            <div class="skeleton-impact-label"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-impact-value"></div>
                            <div class="skeleton-impact-label"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-impact-value"></div>
                            <div class="skeleton-impact-label"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Experiments - preserve header, skeleton only the content
        const experimentsSection = document.querySelector('.ab-testing-section');
        if (experimentsSection) {
            const originalContent = experimentsSection.innerHTML;
            experimentsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = experimentsSection.querySelector('.ab-header');
            const headerHTML = header ? header.outerHTML : '';
            
            experimentsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-test-title"></div>
                            <div class="skeleton-test-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-status-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-progress-bar"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-improvement"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-test-title"></div>
                            <div class="skeleton-test-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-status-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-progress-bar"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-improvement"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Optimization journey - preserve header, skeleton only the content
        const timelineSection = document.querySelector('.progress-timeline');
        if (timelineSection) {
            const originalContent = timelineSection.innerHTML;
            timelineSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = timelineSection.querySelector('.timeline-header');
            const headerHTML = header ? header.outerHTML : '';
            
            timelineSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-timeline">
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Performance insights - preserve header, skeleton only the content
        const insightsSection = document.querySelector('.performance-insights');
        if (insightsSection) {
            const originalContent = insightsSection.innerHTML;
            insightsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = insightsSection.querySelector('.insights-header');
            const headerHTML = header ? header.outerHTML : '';
            
            insightsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-insights">
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                </div>
            `;
        }

        // Quick actions - preserve header, skeleton only the content
        const actionsSection = document.querySelector('.quick-actions');
        if (actionsSection) {
            const originalContent = actionsSection.innerHTML;
            actionsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = actionsSection.querySelector('.actions-header');
            const headerHTML = header ? header.outerHTML : '';
            
            actionsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-actions">
                    <div class="skeleton-action-button"></div>
                    <div class="skeleton-action-button"></div>
                    <div class="skeleton-action-button"></div>
                </div>
            `;
        }
    }

    function restoreOriginalContent() {
        // Restore all sections to their original content
        const sections = [
            '.performance-stats',
            '.waterfall-chart',
            '.performance-snapshot',
            '.optimization-opportunities',
            '.ab-testing-section',
            '.progress-timeline',
            '.performance-insights',
            '.quick-actions'
        ];

        sections.forEach(selector => {
            const section = document.querySelector(selector);
            if (section && section.dataset.originalContent) {
                section.innerHTML = section.dataset.originalContent;
                delete section.dataset.originalContent;
            }
        });
    }

    function parseMarkdown(text) {
        // Clean up extra whitespace and normalize line breaks
        text = text.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // Parse section headers (like "**Current Situation:**")
        text = text.replace(/\*\*(.*?):\*\*/g, '<h4 style="margin: 12px 0 8px 0; font-size: 13px; font-weight: 600; color: var(--color-gray-900);">$1:</h4>');
        
        // Parse bold text (**text**) - but not headers
        text = text.replace(/\*\*(?!.*:)(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Parse bullet points ( text) - handle multiple lines
        const lines = text.split('\n');
        let inList = false;
        let processedLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.startsWith('')) {
                if (!inList) {
                    processedLines.push('<ul style="margin: 8px 0; padding-left: 16px;">');
                    inList = true;
                }
                const listItem = line.replace(/^\s*/, '');
                processedLines.push(`<li style="margin: 4px 0; line-height: 1.4; font-size: 13px; position: relative; padding-left: 8px;">${listItem}</li>`);
            } else if (line === '') {
                if (inList) {
                    processedLines.push('</ul>');
                    inList = false;
                }
                // Don't add extra breaks for empty lines
            } else {
                if (inList) {
                    processedLines.push('</ul>');
                    inList = false;
                }
                if (line) {
                    processedLines.push(`<p style="margin: 0 0 10px 0; line-height: 1.5; font-size: 13px;">${line}</p>`);
                }
            }
        }
        
        // Close any open list
        if (inList) {
            processedLines.push('</ul>');
        }
        
        text = processedLines.join('');
        
        // Clean up empty paragraphs and extra spacing
        text = text.replace(/<p[^>]*>\s*<\/p>/g, '');
        text = text.replace(/(<\/p>)\s*(<p[^>]*>)/g, '$1$2');
        
        return text;
    }

    function addAIMessage(sender, content, followUpPills = []) {
        const chatContainer = document.getElementById('aiChatContainer');
        if (!chatContainer) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = `ai-message-avatar ${sender}`;
        avatar.innerHTML = sender === 'assistant' ? '<i data-lucide="sparkles"></i>' : '<i data-lucide="user"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'ai-message-content';
        
        const bubble = document.createElement('div');
        bubble.className = `ai-message-bubble ${sender}`;
        
        // Parse markdown for assistant messages
        if (sender === 'assistant') {
            bubble.innerHTML = parseMarkdown(content);
        } else {
            bubble.innerHTML = content;
        }
        
        contentDiv.appendChild(bubble);
        
        // Add follow-up pills if provided
        if (followUpPills && followUpPills.length > 0) {
            const pillsContainer = document.createElement('div');
            pillsContainer.className = 'ai-prompt-pills';
            
            followUpPills.forEach(pill => {
                const pillElement = document.createElement('button');
                pillElement.className = `ai-prompt-pill ${pill.type || 'secondary'}`;
                pillElement.innerHTML = `
                    ${pill.icon ? `<i data-lucide="${pill.icon}"></i>` : ''}
                    ${pill.text}
                `;
                pillElement.onclick = () => {
                    if (pill.action === 'ask-follow-up') {
                        addAIMessage('user', pill.text);
                        sendAIMessage(pill.text);
                    } else if (pill.action === 'contact-support') {
                        // Handle contact support action
                        console.log('Contact support clicked');
                    }
                };
                pillsContainer.appendChild(pillElement);
            });
            
            contentDiv.appendChild(pillsContainer);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);
        
        // Reset animation for the new message
        messageDiv.style.animation = 'none';
        messageDiv.offsetHeight; // Trigger reflow
        messageDiv.style.animation = 'messageSlideIn 0.4s ease-out forwards';
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Reinitialize lucide icons
        lucide.createIcons();
    }

    function handlePillAction(action, pillText) {
        const panel = document.getElementById('aiAssistantPanel');
        const businessType = panel.dataset.businessType;
        
        // Add user's pill selection as a message
        addAIMessage('user', `I'd like to ${pillText.toLowerCase()}`);
        
        // Generate contextual response based on action
        const actionResponses = {
            'enable-3ds': {
                message: "Great choice! 3D Secure adds an extra layer of security and can improve your authorization rates. Let me guide you through the setup process.",
                pills: [
                    { text: "View setup guide", icon: "file-text", type: "primary", action: "view-setup-guide" },
                    { text: "Enable now", icon: "play", type: "secondary", action: "enable-feature" },
                    { text: "Learn more", icon: "info", type: "secondary", action: "learn-more" }
                ]
            },
            'configure-radar': {
                message: "Radar is our machine learning fraud detection system. I'll help you configure it for optimal performance with your transaction volume.",
                pills: [
                    { text: "Configure rules", icon: "settings", type: "primary", action: "configure-rules" },
                    { text: "View dashboard", icon: "bar-chart", type: "secondary", action: "view-dashboard" },
                    { text: "Best practices", icon: "file-text", type: "secondary", action: "best-practices" }
                ]
            },
            'enable-ml-fraud': {
                message: "Perfect! At your scale, machine learning fraud detection will significantly improve your fraud prevention while reducing false positives.",
                pills: [
                    { text: "Start setup", icon: "play", type: "primary", action: "start-setup" },
                    { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" },
                    { text: "Enterprise pricing", icon: "dollar-sign", type: "secondary", action: "pricing" }
                ]
            },
            'enable-retry': {
                message: "Smart retry logic can recover up to 15% of failed payments. Let's configure it based on your decline patterns.",
                pills: [
                    { text: "Configure retry", icon: "settings", type: "primary", action: "configure-retry" },
                    { text: "View patterns", icon: "bar-chart", type: "secondary", action: "view-patterns" },
                    { text: "Test settings", icon: "test-tube", type: "secondary", action: "test-retry" }
                ]
            },
            'smart-retry': {
                message: "Intelligent retry logic uses machine learning to determine the optimal retry timing and frequency for each transaction.",
                pills: [
                    { text: "Enable smart retry", icon: "play", type: "primary", action: "enable-smart-retry" },
                    { text: "Configure rules", icon: "settings", type: "secondary", action: "configure-rules" },
                    { text: "Monitor results", icon: "bar-chart", type: "secondary", action: "monitor-results" }
                ]
            },
            'data-analysis': {
                message: "Let's analyze your failed payment patterns to identify optimization opportunities. I'll help you set up comprehensive reporting.",
                pills: [
                    { text: "Run analysis", icon: "bar-chart", type: "primary", action: "run-analysis" },
                    { text: "Export data", icon: "download", type: "secondary", action: "export-data" },
                    { text: "Schedule review", icon: "calendar", type: "secondary", action: "schedule-review" }
                ]
            },
            'add-payment-methods': {
                message: "Adding more payment methods can increase your conversion rates by 15-20%. Let's explore options for your business.",
                pills: [
                    { text: "Browse methods", icon: "credit-card", type: "primary", action: "browse-methods" },
                    { text: "Integration guide", icon: "file-text", type: "secondary", action: "integration-guide" },
                    { text: "Compare costs", icon: "dollar-sign", type: "secondary", action: "compare-costs" }
                ]
            },
            'advanced-3ds': {
                message: "Advanced 3D Secure configuration allows you to customize authentication flows based on transaction risk and amount.",
                pills: [
                    { text: "Configure flows", icon: "settings", type: "primary", action: "configure-flows" },
                    { text: "Risk assessment", icon: "shield", type: "secondary", action: "risk-assessment" },
                    { text: "Test scenarios", icon: "test-tube", type: "secondary", action: "test-scenarios" }
                ]
            },
            'ml-fraud': {
                message: "Machine learning fraud detection adapts to your business patterns and provides real-time protection with minimal false positives.",
                pills: [
                    { text: "Start trial", icon: "play", type: "primary", action: "start-trial" },
                    { text: "Technical demo", icon: "monitor", type: "secondary", action: "technical-demo" },
                    { text: "ROI calculator", icon: "calculator", type: "secondary", action: "roi-calculator" }
                ]
            },
            'contact-support': {
                message: "I'll connect you with our support team who can provide personalized assistance for your specific needs.",
                pills: [
                    { text: "Chat with support", icon: "message-circle", type: "primary", action: "chat-support" },
                    { text: "Schedule call", icon: "phone", type: "secondary", action: "schedule-call" },
                    { text: "Email support", icon: "mail", type: "secondary", action: "email-support" }
                ]
            },
            'view-docs': {
                message: "Here are the most relevant documentation resources for your current situation. I've curated them based on your business type and metrics.",
                pills: [
                    { text: "Best practices", icon: "file-text", type: "primary", action: "best-practices" },
                    { text: "API reference", icon: "code", type: "secondary", action: "api-reference" },
                    { text: "Case studies", icon: "book-open", type: "secondary", action: "case-studies" }
                ]
            },
            'ab-test': {
                message: "Experiments can help you optimize your payment flows. Let's set up an experiment to compare different configurations.",
                pills: [
                    { text: "Create test", icon: "test-tube", type: "primary", action: "create-test" },
                    { text: "View templates", icon: "file-text", type: "secondary", action: "view-templates" },
                    { text: "Analyze results", icon: "bar-chart", type: "secondary", action: "analyze-results" }
                ]
            }
        };
        
        const response = actionResponses[action] || {
            message: "I understand you're interested in this feature. Let me provide you with the next steps to get started.",
            pills: [
                { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" },
                { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" }
            ]
        };
        
        setTimeout(() => {
            addAIMessage('assistant', response.message, response.pills);
        }, 500);
    }

    function sendAIMessage() {
        const input = document.getElementById('aiInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        addAIMessage('user', message);
        
        // Clear input
        input.value = '';
        
        // Generate contextual AI response with follow-up pills
        setTimeout(() => {
            const panel = document.getElementById('aiAssistantPanel');
            const businessType = panel.dataset.businessType;
            const topic = panel.dataset.topic;
            
            let response = "I understand your question. Let me provide some additional insights based on your business context. ";
            
            if (businessType === 'small') {
                response += "For small businesses like yours, it's important to focus on the fundamentals first. ";
            } else if (businessType === 'medium') {
                response += "At your scale, you have enough data to make informed decisions. ";
            } else {
                response += "With your volume, enterprise solutions and data-driven approaches are key. ";
            }
            
            response += "Would you like me to dive deeper into any specific aspect of this topic?";
            
            const followUpPills = [
                { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                { text: "Enable features", icon: "settings", type: "secondary", action: "enable-features" },
                { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" }
            ];
            
            addAIMessage('assistant', response, followUpPills);
        }, 1000);
    }

    // Auto-resize textarea
    document.addEventListener('DOMContentLoaded', function() {
        const aiInput = document.getElementById('aiInput');
        if (aiInput) {
            aiInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Handle Enter key
            aiInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
        }

        // Close AI panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('aiAssistantPanel');
            // Guard: If click is on a prompt-btn or inside the panel, do not close
            if ((e.target.classList && e.target.classList.contains('prompt-btn')) || (panel && panel.contains(e.target))) {
                console.log('Click inside panel or on prompt-btn, not closing panel.');
                return;
            }
            if (panel && panel.classList.contains('open')) {
                // Check if click is outside the panel
                closeAIPanel();
            }
        });


    });

    // Function to add invisible hover areas for bar charts
    function addBarHoverAreas(svg, xPoints, barsData) {
        // Remove existing hover areas and AI indicators
        const existingAreas = svg.querySelectorAll('.hover-area, .ai-insight-indicator, .ai-insight-sparkle');
        existingAreas.forEach(area => area.remove());
        
        // Calculate dynamic hover area positions based on chart width
        const svgWidth = 800; // SVG viewBox width
        const numDataPoints = xPoints.length;
        const dataPointSpacing = svgWidth / (numDataPoints - 1);
        
        // Find the data point with the highest rate of change for AI insights
        const insightIndex = findHighestChangePointForBars(barsData);
        
        // Add large invisible hover areas for each bar group covering the full chart height
        for (let i = 0; i < numDataPoints; i++) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            const dataPointX = (i * dataPointSpacing) + (dataPointSpacing / 2);
            const hoverWidth = 200; // Much larger hover area for easier interaction
            
            rect.setAttribute('x', dataPointX - (hoverWidth / 2));
            rect.setAttribute('y', '0');
            rect.setAttribute('width', hoverWidth.toString());
            rect.setAttribute('height', '200'); // Full chart height
            rect.setAttribute('fill', 'transparent');
            rect.setAttribute('stroke', 'none');
            rect.classList.add('hover-area');
            rect.dataset.index = i;
            svg.appendChild(rect);
            
            // Add AI insight indicator for the point with highest change
            if (i === insightIndex) {
                addAIInsightIndicatorForBars(svg, dataPointX, barsData, i);
            }
        }
    }

    // Function to find the data point with the highest rate of change for bar charts
    function findHighestChangePointForBars(barsData) {
        let maxChange = 0;
        let maxChangeIndex = 1; // Start from index 1 to avoid first point
        
        for (let i = 1; i < barsData.length; i++) {
            let currentValue, previousValue;
            
            // Handle different data structures
            if (typeof barsData[i] === 'number') {
                // Simple array of numbers (failed charts)
                currentValue = barsData[i];
                previousValue = barsData[i-1];
            } else if (barsData[i] && typeof barsData[i] === 'object') {
                // Array of objects with credit/debit properties (breakdown charts)
                currentValue = barsData[i].credit + barsData[i].debit;
                previousValue = barsData[i-1].credit + barsData[i-1].debit;
            } else {
                continue; // Skip invalid data
            }
            
            const change = Math.abs(currentValue - previousValue);
            
            if (change > maxChange) {
                maxChange = change;
                maxChangeIndex = i;
            }
        }
        
        return maxChangeIndex;
    }
    
    // Function to add AI insight indicator for bar charts
    function addAIInsightIndicatorForBars(svg, x, barsData, index) {
        // Get the actual y-coordinate for this data point (bar height)
        let barHeight;
        
        // Handle different data structures
        if (typeof barsData[index] === 'number') {
            // Simple array of numbers (failed charts)
            barHeight = barsData[index];
        } else if (barsData[index] && typeof barsData[index] === 'object') {
            // Array of objects with credit/debit properties (breakdown charts)
            barHeight = barsData[index].credit + barsData[index].debit;
        } else {
            barHeight = 0; // Fallback
        }
        
        const y = 200 - barHeight; // Position above the bar
        
        // Create the floating circle background
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y - 20); // Position 20px above the bar
        circle.setAttribute('r', '16');
        circle.setAttribute('fill', '#533AFD');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('filter', 'drop-shadow(0 2px 4px rgba(83, 58, 253, 0.3))');
        circle.classList.add('ai-insight-indicator');
        circle.dataset.index = index;
        svg.appendChild(circle);
        
        // Create the sparkle icon (simplified SVG path)
        const sparkle = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        sparkle.setAttribute('d', 'M8 0L9.5 5.5L15 7L9.5 8.5L8 14L6.5 8.5L1 7L6.5 5.5L8 0Z');
        sparkle.setAttribute('fill', '#ffffff');
        sparkle.setAttribute('transform', `translate(${x-8}, ${y-28})`); // Position above the circle
        sparkle.classList.add('ai-insight-sparkle');
        svg.appendChild(sparkle);
    }

    function handleDataPointHover(event, dataIndex) {
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        
        // Check if this is the AI insight indicator
        const isAIInsight = event.target.classList.contains('ai-insight-indicator');
        
        // Determine which chart we're hovering over
        const isMainChart = event.target.closest('.chart-area');
        const isBarChart = event.target.closest('.bar-chart-area');
        const isFailedChart = event.target.closest('.breakdown-section:last-child .bar-chart-area');
        
        if (isMainChart) {
            const chartData = generator.generateMainChartData();
            const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
            
            // Calculate rate of change for AI insights
            let rateOfChange = '';
            let insight = '';
            let recommendedAction = '';
            
            if (isAIInsight && dataIndex > 0) {
                const currentChange = chartData.current[dataIndex] - chartData.current[dataIndex - 1];
                const baselineChange = chartData.baseline[dataIndex] - chartData.baseline[dataIndex - 1];
                const changePercent = ((currentChange / chartData.current[dataIndex - 1]) * 100).toFixed(1);
                
                rateOfChange = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
                
                if (currentChange > 0 && currentChange > baselineChange) {
                    insight = 'Strong positive performance trend detected';
                    recommendedAction = 'Consider scaling successful strategies';
                } else if (currentChange < 0) {
                    insight = 'Performance decline identified';
                    recommendedAction = 'Review recent changes and optimize';
                } else {
                    insight = 'Stable performance with room for improvement';
                    recommendedAction = 'Explore optimization opportunities';
                }
            }
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                current: yToPercent(chartData.current[dataIndex]),
                baseline: yToPercent(chartData.baseline[dataIndex]),
                optimized: yToPercent(chartData.optimized[dataIndex]),
                metric: 'Authorization Rate',
                value: yToPercent(chartData.current[dataIndex]),
                payments: generator.getBusinessMetrics().dailyTransactions * generator.getTimeframeMultipliers().days,
                dataIndex: dataIndex,
                isAIInsight: isAIInsight,
                rateOfChange: rateOfChange,
                insight: insight,
                recommendedAction: recommendedAction
            };
            
            showTooltip(event, tooltipData);
        } else if (isBarChart) {
            const breakdownData = generator.generateBreakdownData();
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                creditVolume: `$${breakdownData.bars[dataIndex].credit.toFixed(2)}`,
                debitVolume: `$${breakdownData.bars[dataIndex].debit.toFixed(2)}`,
                creditPayments: breakdownData.bars[dataIndex].payments.credit,
                debitPayments: breakdownData.bars[dataIndex].payments.debit,
                metric: 'Payment Volume',
                value: `$${(breakdownData.bars[dataIndex].credit + breakdownData.bars[dataIndex].debit).toFixed(2)}`,
                payments: breakdownData.bars[dataIndex].payments.credit + breakdownData.bars[dataIndex].payments.debit,
                dataIndex: dataIndex
            };
            
            showTooltip(event, tooltipData);
        } else if (isFailedChart) {
            const failedData = generator.generateFailedData();
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                failedVolume: `$${failedData.volume[dataIndex].toFixed(2)}`,
                failedPayments: Math.round(failedData.payments[dataIndex]),
                failureRate: `${failedData.failureRate.toFixed(1)}%`,
                metric: 'Failed Payments',
                value: `$${failedData.volume[dataIndex].toFixed(2)}`,
                payments: Math.round(failedData.payments[dataIndex]),
                dataIndex: dataIndex
            };
            
            showTooltip(event, tooltipData);
        }
    }

    // Initialize chart tooltips
    document.addEventListener('DOMContentLoaded', function() {
        initializeChartTooltips();
        
        // Initialize business type switching
        initializeBusinessTypeSwitching();
        
        // Initialize date range switching
        initializeDateRangeSwitching();
        
        // Initialize metric card interactions
        initializeMetricCardInteractions();
        
        // Initialize breakdown filter interactions
        initializeBreakdownFilterInteractions();
        
        // Initialize failed payments filter interactions
        initializeFailedPaymentsFilterInteractions();
        
        // Initialize assistant prompts
        updateAssistantPrompts();
        
        // Initialize chart tooltips
        initializeChartTooltips();
        
        // Initialize navigation tabs
        initializeNavigationTabs();
        
        // Trigger initial graph animations after a short delay
        setTimeout(() => resetGraphAnimations(), 200);
    });

    // Function to reset graph animations when charts are updated
    function resetGraphAnimations() {
        const chartSvgs = document.querySelectorAll('.chart-svg, .bar-chart-svg');
        const chartPaths = document.querySelectorAll('.chart-lines path');
        const chartBars = document.querySelectorAll('.bar-chart-bars rect');
        const dataPoints = document.querySelectorAll('.data-point, .hover-area');
        
        // Reset SVG animations
        chartSvgs.forEach(svg => {
            svg.style.animation = 'none';
            svg.offsetHeight; // Trigger reflow
            svg.style.animation = 'graphLoadIn 0.4s ease-out 0.1s forwards';
        });
        
        // Reset path animations
        chartPaths.forEach(path => {
            path.style.animation = 'none';
            path.offsetHeight; // Trigger reflow
        });
        
        // Reset bar animations
        chartBars.forEach(bar => {
            bar.style.animation = 'none';
            bar.offsetHeight; // Trigger reflow
            bar.style.animation = 'growBar 0.6s ease-out 0.3s forwards';
        });
        
        // Reset data point animations
        dataPoints.forEach(point => {
            point.style.animation = 'none';
            point.offsetHeight; // Trigger reflow
            point.style.animation = 'fadeInDataPoints 0.3s ease-out 0.6s forwards';
        });
    }

    // Navigation Tab Functionality
    function initializeNavigationTabs() {
        const navTabs = document.querySelectorAll('.nav-tab');
        console.log('Initializing navigation tabs, found:', navTabs.length);
        
        navTabs.forEach((tab, index) => {
            console.log(`Setting up tab ${index}:`, tab.textContent.trim());
            tab.addEventListener('click', function(e) {
                console.log('Tab clicked:', this.textContent.trim());
                e.preventDefault();
                e.stopPropagation();
                
                // Remove active class from all tabs
                navTabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Get the tab text to determine which view to show
                const tabText = this.textContent.trim();
                console.log('Switching to tab:', tabText);
                switchTabView(tabText);
            });
        });
    }

    function switchTabView(tabName) {
        console.log('switchTabView called with:', tabName);
        
        // Update active tab
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.textContent.trim().toLowerCase() === tabName.toLowerCase()) {
                tab.classList.add('active');
            }
        });
        
        const mainContent = document.querySelector('.two-column-layout');
        console.log('Main content found:', !!mainContent);
        
        // Hide all tab content
        const allTabContent = document.querySelectorAll('.tab-content');
        console.log('Found tab content elements:', allTabContent.length);
        allTabContent.forEach(content => {
            content.style.display = 'none';
            console.log('Hiding:', content.id);
        });
        
        // Handle page title - always set to "Payments analytics"
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
            pageTitle.textContent = 'Payments analytics';
        }
        
        // Show the appropriate content based on tab name
        switch(tabName.toLowerCase()) {
            case 'acceptance':
                console.log('Showing acceptance view');
                showAcceptanceView();
                break;
            case 'authentication':
                console.log('Showing authentication view');
                showAuthenticationView();
                break;
            case 'disputes':
                console.log('Showing disputes view');
                showDisputesView();
                break;
            case 'payment methods':
                console.log('Showing payment methods view');
                showPaymentMethodsView();
                break;
            case 'optimization':
                console.log('Showing optimization view');
                showOptimizationView();
                break;
            default:
                console.log('Showing default acceptance view');
                showAcceptanceView();
        }
    }

    function showAcceptanceView() {
        // This is the default view - show the current content
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'grid';
            mainContent.style.gridTemplateColumns = '70% 30%';
            mainContent.style.gap = '24px';
            mainContent.style.marginTop = '24px';
            mainContent.style.width = '100%';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Show the filter sections when switching back from optimization
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'flex';
        });
        
        // Show the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'block';
        }
    }

    function showAuthenticationView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Show the filter sections when switching back from optimization
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'flex';
        });
        
        // Show the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'block';
        }
        
        // Create or show authentication view
        let authView = document.getElementById('authentication-view');
        if (!authView) {
            authView = createAuthenticationView();
        }
        authView.style.display = 'block';
    }

    function showDisputesView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Show the filter sections when switching back from optimization
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'flex';
        });
        
        // Show the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'block';
        }
        
        // Create or show disputes view
        let disputesView = document.getElementById('disputes-view');
        if (!disputesView) {
            disputesView = createDisputesView();
        }
        disputesView.style.display = 'block';
    }

    function showPaymentMethodsView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Show the filter sections when switching back from optimization
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'flex';
        });
        
        // Show the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'block';
        }
        
        // Create or show payment methods view
        let paymentMethodsView = document.getElementById('payment-methods-view');
        if (!paymentMethodsView) {
            paymentMethodsView = createPaymentMethodsView();
        }
        paymentMethodsView.style.display = 'block';
    }

    function showOptimizationView() {
        console.log('showOptimizationView called');
        
        // Hide the filter sections when optimization tab is active
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Hide the two-column layout
        const twoColumnLayout = document.querySelector('.two-column-layout');
        if (twoColumnLayout) {
            twoColumnLayout.style.display = 'none';
        }
        
        // Create or show optimization view
        let optimizationView = document.getElementById('optimization-view');
        console.log('Existing optimization view:', !!optimizationView);
        if (!optimizationView) {
            console.log('Creating new optimization view');
            optimizationView = createOptimizationView();
        }
        
        // Make sure the optimization view is visible and properly positioned
        optimizationView.style.display = 'block';
        optimizationView.style.width = '100%';
        optimizationView.style.maxWidth = 'none';
        optimizationView.style.margin = '0';
        optimizationView.style.padding = '0';
        
        // Update the optimization page with current business type data
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateOptimizationPage(currentBusinessType, currentDateRange);
        
        // Initialize optimization date range dropdown
        const optimizationDateRangeDropdown = document.getElementById('optimizationDateRangeDropdown');
        if (optimizationDateRangeDropdown) {
            // Set the dropdown to match the main date range dropdown
            optimizationDateRangeDropdown.textContent = currentDateRange;
            optimizationDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
            optimizationDateRangeDropdown.querySelector('i').classList.add('filter-icon');
            
            // Reinitialize lucide icons
            lucide.createIcons();
        }
        
        console.log('Optimization view should now be visible and updated');
    }

    function createOptimizationView() {
        const optimizationView = document.createElement('div');
        optimizationView.id = 'optimization-view';
        optimizationView.className = 'tab-content optimization-tab-content';
        optimizationView.style.cssText = `
            width: 100%;
            background: white;
            min-height: 100vh;
            display: block;
        `;

        const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        const generator = new RealisticDataGenerator(currentBusinessType, dateRange);
        const metrics = generator.getBusinessMetrics();

        optimizationView.innerHTML = `
                <!-- Simple Two Column Layout -->
                <div style="display: flex; gap: 24px; margin-top: 48px; width: 100%;">
                    <!-- Left Column -->
                    <div style="flex: 0 0 70%;">
                    <!-- Performance Header and Time Filter -->
                    <div class="performance-header-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--color-gray-900); line-height: 28px;">Performance</h2>
                        
                        <!-- Time Filter for Optimization Page -->
                        <div class="date-range-dropdown">
                            <button class="filter-btn dropdown-trigger" id="optimizationDateRangeDropdown">
                                Last 90 days
                                <i data-lucide="chevron-down" class="filter-icon"></i>
                            </button>
                            <div class="dropdown-menu" id="optimizationDateRangeMenu">
                                <div class="dropdown-item" data-range="7">Last 7 days</div>
                                <div class="dropdown-item" data-range="30">Last 30 days</div>
                                <div class="dropdown-item" data-range="60">Last 60 days</div>
                                <div class="dropdown-item active" data-range="90">Last 90 days</div>
                                <div class="dropdown-item" data-range="180">Last 6 months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Stats -->
                    <div class="performance-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 72px;">
                        <div class="performance-stat-card" data-metric="total-revenue" style="background: #fff; border: 1px solid var(--color-gray-200); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s;">
                            <div class="stat-value" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 4px;">$0</div>
                            <div class="stat-label" style="font-size: 14px; color: var(--color-gray-600);">Total revenue</div>
                        </div>
                        <div class="performance-stat-card" data-metric="revenue-recovered" style="background: #fff; border: 1px solid var(--color-gray-200); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s;">
                            <div class="stat-value" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 4px;">$0</div>
                            <div class="stat-label" style="font-size: 14px; color: var(--color-gray-600);">Total revenue recovered</div>
                        </div>
                        <div class="performance-stat-card" data-metric="recovered-payments" style="background: #fff; border: 1px solid var(--color-gray-200); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s;">
                            <div class="stat-value" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 4px;">134</div>
                            <div class="stat-label" style="font-size: 14px; color: var(--color-gray-600);">Recovered payments</div>
                        </div>
                        <div class="performance-stat-card" data-metric="success-rate" style="background: #fff; border: 1px solid var(--color-gray-200); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s;">
                            <div class="stat-value" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 4px;">0%</div>
                            <div class="stat-label" style="font-size: 14px; color: var(--color-gray-600);">Success rate</div>
                        </div>
                    </div>

                    <!-- Payment Lifecycle Header -->
                    <div class="lifecycle-header">
                        <h1 class="lifecycle-title">Payment lifecycle</h1>
                        <p class="lifecycle-subtitle">Optimize every stage of your payment journey for maximum revenue capture</p>
                    </div>

                    <!-- Payment Lifecycle Waterfall Chart -->
                    <div class="waterfall-chart">
                        
                        <div class="waterfall-container">
                            <!-- Acceptance -->
                            <div class="waterfall-item starting">
                                <div class="waterfall-bar" style="height: 100px; background: #3B82F6;"></div>
                                <div class="waterfall-label">Acceptance</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$0</span>
                                    <span class="detail-rate">0 transactions</span>
                                </div>
                            </div>

                            <!-- Authorization Losses -->
                            <div class="waterfall-item negative">
                                <div class="waterfall-bar" style="height: 20px; background: #EF4444;"></div>
                                <div class="waterfall-label">Declines</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$0</span>
                                    <span class="detail-rate">0 declined</span>
                                </div>
                            </div>

                            <!-- Dispute Losses -->
                            <div class="waterfall-item negative">
                                <div class="waterfall-bar" style="height: 10px; background: #F97316;"></div>
                                <div class="waterfall-label">Disputes</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$0</span>
                                    <span class="detail-rate">0 disputes</span>
                                </div>
                            </div>

                            <!-- Fraud -->
                            <div class="waterfall-item positive">
                                <div class="waterfall-bar" style="height: 50px; background: #10B981;"></div>
                                <div class="waterfall-label">Fraud</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$0</span>
                                    <span class="detail-rate">-$0 fraud losses</span>
                                </div>
                            </div>

                            <!-- Final Total -->
                            <div class="waterfall-item total">
                                <div class="waterfall-bar" style="height: 80px; background: #533AFD;"></div>
                                <div class="waterfall-label">Total revenue</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$0</span>
                                    <span class="detail-rate">0% success rate</span>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- Key Metrics -->
                    <div class="performance-snapshot">
                        <h2 class="snapshot-title">Key metrics</h2>
                        <div class="snapshot-grid">
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <h3 class="snapshot-card-title">Checkout conversion</h3>
                                    <div class="snapshot-card-value">0%</div>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>100%</span>
                                            <span>75%</span>
                                            <span>50%</span>
                                            <span>25%</span>
                                            <span>0%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200">
                                                    <path d="M0,34 L100,16 L200,4" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                                    <path d="M0,38 L100,22 L200,10" stroke="#533AFD" stroke-width="3" fill="none"/>
                                                    <path d="M0,84 L100,66 L200,44" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                            </div>
                                        </div>
                                        <div class="snapshot-chart-legend">
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #533AFD; border-radius: 2px;"></div>
                                                <span>Current</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #E4E7EC; border-radius: 2px;"></div>
                                                <span>Baseline</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #22C55E; border-radius: 2px; background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, #22C55E 2px, #22C55E 4px);"></div>
                                                <span>AI-optimized</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <h3 class="snapshot-card-title">Authorization rate</h3>
                                    <div class="snapshot-card-value">89%</div>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>100%</span>
                                            <span>75%</span>
                                            <span>50%</span>
                                            <span>25%</span>
                                            <span>0%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200">
                                                    <path d="M0,38 L100,22 L200,10" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                                    <path d="M0,38 L100,22 L200,10" stroke="#533AFD" stroke-width="3" fill="none"/>
                                                    <path d="M0,84 L100,66 L200,44" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                            </div>
                                        </div>
                                        <div class="snapshot-chart-legend">
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #533AFD; border-radius: 2px;"></div>
                                                <span>Current</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #E4E7EC; border-radius: 2px;"></div>
                                                <span>Baseline</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #22C55E; border-radius: 2px; background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, #22C55E 2px, #22C55E 4px);"></div>
                                                <span>AI-optimized</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <h3 class="snapshot-card-title">Dispute rate</h3>
                                    <div class="snapshot-card-value">0.4%</div>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>1.0%</span>
                                            <span>0.75%</span>
                                            <span>0.5%</span>
                                            <span>0.25%</span>
                                            <span>0%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200">
                                                    <path d="M0,184 L100,192 L200,196" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                                    <path d="M0,184 L100,192 L200,196" stroke="#533AFD" stroke-width="3" fill="none"/>
                                                    <path d="M0,184 L100,192 L200,196" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                            </div>
                                        </div>
                                        <div class="snapshot-chart-legend">
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #533AFD; border-radius: 2px;"></div>
                                                <span>Current</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #E4E7EC; border-radius: 2px;"></div>
                                                <span>Baseline</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #22C55E; border-radius: 2px; background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, #22C55E 2px, #22C55E 4px);"></div>
                                                <span>AI-optimized</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <h3 class="snapshot-card-title">Customer retention</h3>
                                    <div class="snapshot-card-value">67%</div>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>100%</span>
                                            <span>75%</span>
                                            <span>50%</span>
                                            <span>25%</span>
                                            <span>0%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200">
                                                    <path d="M0,84 L100,66 L200,44" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                                    <path d="M0,84 L100,66 L200,44" stroke="#533AFD" stroke-width="3" fill="none"/>
                                                    <path d="M0,84 L100,66 L200,44" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                            </div>
                                        </div>
                                        <div class="snapshot-chart-legend">
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #533AFD; border-radius: 2px;"></div>
                                                <span>Current</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #E4E7EC; border-radius: 2px;"></div>
                                                <span>Baseline</span>
                                            </div>
                                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--color-gray-600);">
                                                <div class="legend-color" style="width: 12px; height: 12px; background: #22C55E; border-radius: 2px; background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, #22C55E 2px, #22C55E 4px);"></div>
                                                <span>AI-optimized</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Optimization Opportunities Table -->
                    <div class="optimization-opportunities">
                        <div class="opportunities-header">
                            <div class="opportunities-title-section">
                                                            <h2 class="opportunities-title">Recommendations</h2>
                            <p class="opportunities-subtitle">Product recommendations to optimize your payment performance</p>
                            </div>
                            <a href="#" class="view-all-link" onclick="openAIPanel('Show me all optimization opportunities and their detailed analysis', '${currentBusinessType}', 'all-optimizations', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                View all
                                <i data-lucide="arrow-right" style="width: 14px; height: 14px;"></i>
                            </a>
                        </div>
                        
                        <div class="opportunities-table-container">
                            <table class="opportunities-table">
                                <thead>
                                    <tr>
                                        <th>Opportunity</th>
                                        <th>Impact</th>
                                        <th>Revenue</th>
                                        <th>Level</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="high-priority">
                                        <td>
                                            <div class="opportunity-cell">
                                                <div class="opportunity-info">
                                                    <div class="opportunity-title">Payment Intents</div>
                                                    <div class="opportunity-description">Implement Payment Intents for better authorization rates</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="impact-cell">
                                                <span class="impact-value">+2.5%</span>
                                                <span class="impact-label">approval rate</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="revenue-impact">+$45,000/year</span>
                                        </td>
                                        <td>
                                            <span class="effort-badge medium">Medium</span>
                                            <div class="effort-detail">1-2 dev days</div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="table-btn secondary" onclick="openAIPanel('How do I implement Payment Intents to improve my authorization rate?', '${currentBusinessType}', 'payment-intents', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                                    Get started
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="high-priority">
                                        <td>
                                            <div class="opportunity-cell">
                                                <div class="opportunity-info">
                                                    <div class="opportunity-title">Smart Retries</div>
                                                    <div class="opportunity-description">Enable intelligent retry logic for declined payments</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="impact-cell">
                                                <span class="impact-value">+2.1%</span>
                                                <span class="impact-label">recovery rate</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="revenue-impact">+$38,000/year</span>
                                        </td>
                                        <td>
                                            <span class="effort-badge easy">Easy</span>
                                            <div class="effort-detail">30 minute setup</div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="table-btn secondary" onclick="openAIPanel('How do I configure Smart Retries to recover declined transactions?', '${currentBusinessType}', 'smart-retries', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                                    Get started
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="medium-priority">
                                        <td>
                                            <div class="opportunity-cell">
                                                <div class="opportunity-info">
                                                    <div class="opportunity-title">Connect marketplace</div>
                                                    <div class="opportunity-description">Set up Connect for multi-party payment flows</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="impact-cell">
                                                <span class="impact-value">+1.8%</span>
                                                <span class="impact-label">revenue growth</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="revenue-impact">+$32,000/year</span>
                                        </td>
                                        <td>
                                            <span class="effort-badge medium">Medium</span>
                                            <div class="effort-detail">3-5 dev days</div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="table-btn secondary" onclick="openAIPanel('How do I set up Connect for marketplace payments?', '${currentBusinessType}', 'connect', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                                    Get started
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Experiments Table -->
                    <div class="ab-testing-section">
                        <div class="ab-header">
                            <h2 class="ab-title">Experiments</h2>
                            <button class="new-test-btn" onclick="openAIPanel('How do I set up experiments for payment optimization?', '${currentBusinessType}', 'ab-testing', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                New experiment
                            </button>
                        </div>
                        
                        <div class="ab-tests-table-container">
                            <table class="ab-tests-table">
                                <thead>
                                    <tr>
                                        <th>Test name</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Control</th>
                                        <th>Variant</th>
                                        <th>Improvement</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="active">
                                        <td>
                                            <div class="test-cell">
                                                <div class="test-title">3D Secure optimization</div>
                                                <div class="test-description">Testing automatic vs. challenge-based 3D Secure authentication</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="status-cell active">
                                                <span class="status-dot"></span>
                                                <span class="status-text">Active</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="progress-cell">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: 67%"></div>
                                                </div>
                                                <span class="progress-text">67% Complete</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="rate-value">89.2%</span>
                                        </td>
                                        <td>
                                            <span class="rate-value">91.8%</span>
                                        </td>
                                        <td>
                                            <span class="improvement">+2.6%</span>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="table-btn secondary">
                                                    <i data-lucide="bar-chart" style="width: 14px; height: 14px;"></i>
                                                    Details
                                                </button>
                                                <button class="table-btn secondary">
                                                    <i data-lucide="pause" style="width: 14px; height: 14px;"></i>
                                                    Pause
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="completed">
                                        <td>
                                            <div class="test-cell">
                                                <div class="test-title">Smart Retries configuration</div>
                                                <div class="test-description">Testing different retry strategies for declined payments</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="status-cell completed">
                                                <span class="status-dot"></span>
                                                <span class="status-text">Completed</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="progress-cell">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: 100%"></div>
                                                </div>
                                                <span class="progress-text">100% Complete</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="rate-value">85.1%</span>
                                        </td>
                                        <td>
                                            <span class="rate-value winner">87.3%</span>
                                        </td>
                                        <td>
                                            <span class="improvement">+2.2%</span>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="table-btn secondary">
                                                    <i data-lucide="check" style="width: 14px; height: 14px;"></i>
                                                    Deploy
                                                </button>
                                                <button class="table-btn secondary">
                                                    <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                                                    Report
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Progress Timeline -->
                    <div class="progress-timeline">
                        <h2 class="timeline-title">Optimization journey</h2>
                        <p class="timeline-subtitle">Track your progress and see the impact of implemented optimizations</p>
                        
                        <div class="timeline-container">
                            <div class="timeline-event completed">
                                <div class="event-marker completed">
                                    <i data-lucide="check" style="width: 16px; height: 16px; color: white;"></i>
                                </div>
                                <div class="event-content">
                                    <div class="event-header">
                                        <h3 class="event-title">Smart Retries Implemented</h3>
                                        <span class="event-date">June 15, 2024</span>
                                    </div>
                                    <p class="event-description">Configured intelligent retry logic for declined transactions</p>
                                    <div class="event-impact">
                                        <span class="impact-label">Impact:</span>
                                        <span class="impact-value">+2.2% authorization rate</span>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-event completed">
                                <div class="event-marker completed">
                                    <i data-lucide="check" style="width: 16px; height: 16px; color: white;"></i>
                                </div>
                                <div class="event-content">
                                    <div class="event-header">
                                        <h3 class="event-title">Digital Wallets Added</h3>
                                        <span class="event-date">May 28, 2024</span>
                                    </div>
                                    <p class="event-description">Integrated Apple Pay and Google Pay for mobile users</p>
                                    <div class="event-impact">
                                        <span class="impact-label">Impact:</span>
                                        <span class="impact-value">+1.5% conversion rate</span>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-event active">
                                <div class="event-marker active">
                                    <i data-lucide="play" style="width: 16px; height: 16px; color: white;"></i>
                                </div>
                                <div class="event-content">
                                    <div class="event-header">
                                        <h3 class="event-title">3D Secure Optimization</h3>
                                        <span class="event-date">Current</span>
                                    </div>
                                    <p class="event-description">Experiments automatic vs. challenge-based authentication</p>
                                    <div class="event-impact">
                                        <span class="impact-label">Expected:</span>
                                        <span class="impact-value">+2.6% authorization rate</span>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-event future">
                                <div class="event-marker future">
                                    <i data-lucide="target" style="width: 16px; height: 16px; color: var(--color-gray-400);"></i>
                                </div>
                                <div class="event-content">
                                    <div class="event-header">
                                        <h3 class="event-title">Card Network Tokens</h3>
                                        <span class="event-date">Planned</span>
                                    </div>
                                    <p class="event-description">Implement card network tokenization for improved security</p>
                                    <div class="event-impact">
                                        <span class="impact-label">Expected:</span>
                                        <span class="impact-value">+2.3% authorization rate</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    </div>
                    <!-- Right Column -->
                    <div style="flex: 0 0 30%; background: white; padding: 20px; border-radius: 8px;">
                        <!-- Ask Assistant Section -->
                        <div class="assistant-section">
                            <div class="assistant-header">
                                <i data-lucide="sparkles" class="sparkles-icon"></i>
                                <h3 class="assistant-title">Optimization assistant</h3>
                            </div>
                            <div class="suggested-prompts">
                                                            <button class="prompt-btn" onclick="openAIPanel('What are the highest-impact optimization opportunities for my business?', '${currentBusinessType}', 'optimization-priorities', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                What are my highest-impact optimization opportunities?
                            </button>
                                <button class="prompt-btn" onclick="openAIPanel('How do I calculate the ROI of payment optimizations?', '${currentBusinessType}', 'optimization-roi', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                    How do I calculate optimization ROI?
                                </button>
                                <button class="prompt-btn" onclick="openAIPanel('What experiments should I run for payment optimization?', '${currentBusinessType}', 'ab-testing-strategy', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                    What experiments should I run?
                                </button>
                            </div>
                        </div>
                        
                        <!-- Performance Insights -->
                        <div class="performance-insights">
                            <h3 class="insights-title">Performance insights</h3>
                            <div class="insight-card">
                                <div class="insight-header">
                                    <i data-lucide="trending-up" style="width: 16px; height: 16px; color: var(--color-green-500);"></i>
                                    <span class="insight-label">Top Performing Area</span>
                                </div>
                                <div class="insight-content">
                                    <span class="insight-value">Elements Integration</span>
                                    <div class="insight-description-container">
                                        <span class="insight-description">92% success rate - excellent payment method routing with Elements</span>
                                        <a href="#" class="learn-more-link">Learn more</a>
                                    </div>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-header">
                                    <i data-lucide="alert-triangle" style="width: 16px; height: 16px; color: var(--color-orange-500);"></i>
                                    <span class="insight-label">Needs Attention</span>
                                </div>
                                <div class="insight-content">
                                    <span class="insight-value">Radar Fraud Detection</span>
                                    <div class="insight-description-container">
                                        <span class="insight-description">0.4% dispute rate - consider enabling Radar for fraud prevention</span>
                                        <a href="#" class="learn-more-link">Learn more</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h3 class="actions-title">Quick actions</h3>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I set up a new experiment?', '${currentBusinessType}', 'setup-ab-test', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                Create experiment
                            </button>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I implement Payment Intents?', '${currentBusinessType}', 'implement-payment-intents', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="shield-check" style="width: 16px; height: 16px;"></i>
                                Implement Payment Intents
                            </button>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I configure Smart Retries?', '${currentBusinessType}', 'configure-retries', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                Configure Smart Retries
                            </button>
                        </div>
                        
                        <!-- Resources Section -->
                        <div class="resources-section">
                            <h3 class="resources-title">Resources</h3>
                            <div class="resource-item">
                                <i data-lucide="file-text" class="resource-icon"></i>
                                <div class="resource-content">
                                    <span class="resource-name">Payment optimization guide</span>
                                    <span class="resource-description">Learn how to optimize your payment performance and increase revenue.</span>
                                </div>
                            </div>
                            <div class="resource-item">
                                <i data-lucide="bar-chart" class="resource-icon"></i>
                                <div class="resource-content">
                                    <span class="resource-name">Experiments best practices</span>
                                    <span class="resource-description">Learn how to design and run effective payment optimization tests.</span>
                                </div>
                            </div>
                            <div class="resource-subsection">
                                <span class="subsection-title">View other optimization tools</span>
                                <div class="resource-link">
                                    <i data-lucide="arrow-right" class="arrow-icon"></i>
                                    <span>Radar fraud prevention</span>
                                </div>
                                <div class="resource-link">
                                    <i data-lucide="arrow-right" class="arrow-icon"></i>
                                    <span>Checkout optimization</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        `;

        // Add the view to the main content area
        const mainContentInner = document.querySelector('.main-content-inner');
        if (mainContentInner) {
            // Check if optimization view already exists in the main content
            let existingView = mainContentInner.querySelector('#optimization-view');
            if (existingView) {
                existingView.remove();
            }
            mainContentInner.appendChild(optimizationView);
        } else {
            document.body.appendChild(optimizationView);
        }
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Update the page with current business type data
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateOptimizationPage(currentBusinessType, currentDateRange);
        
        return optimizationView;
    }

    function createAuthenticationView() {
        const authView = document.createElement('div');
        authView.id = 'authentication-view';
        authView.className = 'tab-content';
        authView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-50);
            min-height: 100vh;
        `;

        authView.innerHTML = `
            <div class="auth-header">
                <h1 class="auth-title">Authentication & Security</h1>
                <p class="auth-subtitle">Manage your authentication settings and security configurations</p>
            </div>
            <div class="auth-content">
                <p>Authentication view coming soon...</p>
            </div>
        `;

        document.body.appendChild(authView);
        return authView;
    }

    function createDisputesView() {
        const disputesView = document.createElement('div');
        disputesView.id = 'disputes-view';
        disputesView.className = 'tab-content';
        disputesView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-50);
            min-height: 100vh;
        `;

        disputesView.innerHTML = `
            <div class="disputes-header">
                <h1 class="disputes-title">Disputes & Chargebacks</h1>
                <p class="disputes-subtitle">Monitor and manage payment disputes</p>
            </div>
            <div class="disputes-content">
                <p>Disputes view coming soon...</p>
            </div>
        `;

        document.body.appendChild(disputesView);
        return disputesView;
    }

    function createPaymentMethodsView() {
        const paymentMethodsView = document.createElement('div');
        paymentMethodsView.id = 'payment-methods-view';
        paymentMethodsView.className = 'tab-content';
        paymentMethodsView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-50);
            min-height: 100vh;
        `;

        paymentMethodsView.innerHTML = `
            <div class="payment-methods-header">
                <h1 class="payment-methods-title">Payment Methods</h1>
                <p class="payment-methods-subtitle">Configure and manage your payment methods</p>
            </div>
            <div class="payment-methods-content">
                <p>Payment methods view coming soon...</p>
            </div>
        `;

        document.body.appendChild(paymentMethodsView);
        return paymentMethodsView;
    }

    // Performance stat cards click functionality
    function initializePerformanceStatCards() {
        const performanceCards = document.querySelectorAll('.performance-stat-card');
        performanceCards.forEach(card => {
            card.addEventListener('click', function() {
                const metric = this.getAttribute('data-metric');
                openMetricDetailsModal(metric);
            });
        });
    }

    // Open metric details modal
    function openMetricDetailsModal(metric) {
        const modal = document.getElementById('metricDetailsModal');
        const title = document.querySelector('.metric-modal-title');
        const subtitle = document.querySelector('.metric-modal-subtitle');
        
        // Set title based on metric
        const metricLabels = {
            'total-revenue': 'Total Revenue',
            'revenue-recovered': 'Total Revenue Recovered',
            'recovered-payments': 'Recovered Payments',
            'success-rate': 'Success Rate'
        };
        
        title.textContent = metricLabels[metric] || 'Metric Details';
        subtitle.textContent = 'Time series data and trends';
        
        // Generate and display chart data
        generateMetricChart(metric);
        
        // Update AI insights based on metric
        updateAIInsights(metric);
        
        // Show modal
        modal.style.display = 'block';
        
        // Reinitialize Lucide icons for the modal
        lucide.createIcons();
    }

    // Close metric details modal
    function closeMetricDetailsModal() {
        const modal = document.getElementById('metricDetailsModal');
        modal.style.display = 'none';
    }

    // Generate chart data for the metric
    function generateMetricChart(metric) {
        const svg = document.getElementById('metricChartSvg');
        const xAxis = document.getElementById('metricChartXAxis');
        const yAxisMax = document.getElementById('metricYAxisMax');
        const yAxisMin = document.getElementById('metricYAxisMin');
        
        // Get current date range
        const currentDateRange = document.getElementById('optimizationDateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        const dateLabels = getDateLabels(currentDateRange);
        
        // Set Y-axis labels based on metric type
        if (metric === 'success-rate') {
            yAxisMax.textContent = '100%';
            yAxisMin.textContent = '0%';
        } else if (metric === 'recovered-payments') {
            yAxisMax.textContent = '12';
            yAxisMin.textContent = '0';
        } else {
            yAxisMax.textContent = '$12K';
            yAxisMin.textContent = '$0';
        }
        
        // Generate data based on metric
        const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
        let currentData, previousData, optimizedData;
        
        if (metric === 'total-revenue') {
            currentData = generator.generateTimeSeriesData(50, 0.2, 0.05);
            previousData = currentData.map(v => v * 0.8);
            optimizedData = currentData.map(v => v * 1.25);
        } else if (metric === 'revenue-recovered') {
            currentData = generator.generateTimeSeriesData(15, 0.3, 0.08);
            previousData = currentData.map(v => v * 0.9);
            optimizedData = currentData.map(v => v * 0.7);
        } else if (metric === 'recovered-payments') {
            currentData = generator.generateTimeSeriesData(8, 0.4, 0.1);
            previousData = currentData.map(v => v * 0.7);
            optimizedData = currentData.map(v => v * 1.4);
        } else if (metric === 'success-rate') {
            currentData = generator.generateTimeSeriesData(85, 0.1, 0.02);
            previousData = currentData.map(v => v * 0.95);
            optimizedData = currentData.map(v => Math.min(v * 1.08, 100));
        }
        
        // Convert to Y coordinates
        const xPoints = [60, 140, 220, 300, 380, 460, 540, 620];
        const maxValue = Math.max(...currentData, ...previousData, ...optimizedData);
        let scale;
        if (metric === 'success-rate') {
            scale = 300 / 100;
        } else if (metric === 'recovered-payments') {
            scale = 300 / 12; // Use count-based scale for recovered payments
        } else {
            scale = 300 / maxValue;
        }
        
        const currentY = currentData.map(v => 300 - (v * scale));
        const previousY = previousData.map(v => 300 - (v * scale));
        const optimizedY = optimizedData.map(v => 300 - (v * scale));
        
        // Build SVG paths
        let currentLine = '';
        let previousLine = '';
        let optimizedLine = '';
        
        for (let i = 0; i < xPoints.length; i++) {
            if (i === 0) {
                currentLine = `M${xPoints[i]},${currentY[i]}`;
                previousLine = `M${xPoints[i]},${previousY[i]}`;
                optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
            } else {
                currentLine += ` L${xPoints[i]},${currentY[i]}`;
                previousLine += ` L${xPoints[i]},${previousY[i]}`;
                optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
            }
        }
        
        // Update SVG content
        svg.innerHTML = `
            <!-- Baseline performance line (gray) -->
            <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
            <!-- Current performance line (purple) -->
            <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
            <!-- AI-optimized performance line (green) -->
            <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
        `;
        
        // Update X-axis labels
        xAxis.innerHTML = dateLabels.map(label => `<span>${label}</span>`).join('');
    }

    // Update AI insights based on metric
    function updateAIInsights(metric) {
        const insightMetricName = document.getElementById('insight-metric-name');
        const insightTrend = document.getElementById('insight-trend');
        const insightImprovement = document.getElementById('insight-improvement');
        const aiRecommendationText = document.getElementById('ai-recommendation-text');
        
        const insights = {
            'total-revenue': {
                metricName: 'total revenue',
                trend: 'strong upward trend',
                improvement: '18% increase',
                recommendation: 'Consider expanding payment methods and implementing dynamic pricing to capture an additional 15-20% in revenue potential.'
            },
            'revenue-recovered': {
                metricName: 'revenue recovery',
                trend: 'stable recovery pattern',
                improvement: '8% improvement',
                recommendation: 'Implement smart retry logic and fraud detection systems to potentially recover an additional 25-30% of declined transactions.'
            },
            'recovered-payments': {
                metricName: 'payment recovery',
                trend: 'positive recovery trend',
                improvement: '14% increase',
                recommendation: 'Optimize retry strategies and add alternative payment methods to potentially recover 40-50% more failed transactions.'
            },
            'success-rate': {
                metricName: 'success rate',
                trend: 'positive trend',
                improvement: '12% improvement',
                recommendation: 'Consider implementing smart retry logic to recover declined transactions and potentially improve your success rate by an additional 3-5%.'
            }
        };
        
        const insight = insights[metric] || insights['success-rate'];
        
        if (insightMetricName) insightMetricName.textContent = insight.metricName;
        if (insightTrend) insightTrend.textContent = insight.trend;
        if (insightImprovement) insightImprovement.textContent = insight.improvement;
        if (aiRecommendationText) aiRecommendationText.textContent = insight.recommendation;
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('metricDetailsModal');
        if (e.target === modal) {
            closeMetricDetailsModal();
        }
    });

    // Initialize performance stat cards when optimization view is created
    const originalCreateOptimizationView = createOptimizationView;
    createOptimizationView = function() {
        const view = originalCreateOptimizationView();
        setTimeout(() => {
            initializePerformanceStatCards();
        }, 100);
        return view;
    };




</script>

<!-- Business Type Tabs -->
<div class="business-type-tabs">
    <button class="business-type-tab" data-type="small" onclick="switchBusinessType('small')">Small Business</button>
    <button class="business-type-tab active" data-type="medium" onclick="switchBusinessType('medium')">Medium Business</button>
    <button class="business-type-tab" data-type="large" onclick="switchBusinessType('large')">Large Business</button>
    </div>

    <!-- Lo-fi Mode Toggle -->
    <div id="lofiToggle" class="lofi-toggle">
        <div class="toggle-switch" onclick="toggleLofiMode()">
            <div class="toggle-slider"></div>
        </div>
        <span class="toggle-label">Lo-fi mode</span>
    </div>

    <!-- AI Assistant Panel -->
<div class="ai-assistant-panel" id="aiAssistantPanel">
    <div class="ai-panel-header">
        <div class="ai-panel-title">
            <i data-lucide="sparkles" style="width: 16px; height: 16px; color: var(--color-purple-500);"></i>
            <h3>Assistant</h3>
        </div>
        <div class="ai-panel-controls">
            <button class="ai-panel-control-btn">
                <i data-lucide="more-horizontal" style="width: 18px; height: 18px;"></i>
            </button>
            <button class="ai-panel-control-btn">
                <i data-lucide="settings" style="width: 18px; height: 18px;"></i>
            </button>
            <button class="ai-panel-control-btn" onclick="closeAIPanel()">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
    </div>
    
    <div class="ai-panel-content">
        <div class="ai-chat-container" id="aiChatContainer">
            <!-- Chat messages will be dynamically added here -->
        </div>
        
        <div class="ai-input-container">
            <div class="ai-input-wrapper">
                <textarea 
                    class="ai-input" 
                    id="aiInput" 
                    placeholder="Ask a question"
                    rows="1"
                ></textarea>
                <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">
                    <i data-lucide="send" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Metric Details Popup Modal -->
<div class="metric-details-modal" id="metricDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; backdrop-filter: blur(4px);">
    <div class="metric-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 32px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div class="metric-modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
            <div>
                <h2 class="metric-modal-title" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 8px 0;">Metric Details</h2>
                <p class="metric-modal-subtitle" style="font-size: 14px; color: var(--color-gray-600); margin: 0;">Time series data and trends</p>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="view-in-studio-btn" style="background: var(--color-purple-500); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                    View in studio
                </button>
                <button class="metric-modal-close" onclick="closeMetricDetailsModal()" style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.15s;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: var(--color-gray-500);"></i>
                </button>
            </div>
        </div>
        
        <div class="metric-modal-body">
            <div class="metric-chart-container" style="margin-bottom: 24px;">
                <div class="metric-chart-content" style="position: relative; height: 300px; width: 100%;">
                    <div class="metric-chart-y-axis" style="position: absolute; left: 0; top: 0; bottom: 0; width: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: var(--color-gray-500); font-weight: 500; padding-right: 12px;">
                        <span id="metricYAxisMax">$12K</span>
                        <span>$8K</span>
                        <span>$4K</span>
                        <span id="metricYAxisMin">$0</span>
                    </div>
                    <div class="metric-chart-area" style="position: absolute; top: 0; left: 40px; right: 0; bottom: 40px; background: white;">
                        <div class="metric-chart-grid" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px); background-size: 100% 25%; opacity: 0.3;"></div>
                        <div class="metric-chart-lines" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%;">
                            <svg class="metric-chart-svg" id="metricChartSvg" viewBox="0 0 700 300" style="width: 100%; height: 100%;">
                                <!-- Chart lines will be dynamically added here -->
                            </svg>
                        </div>
                        <div class="metric-chart-x-axis" id="metricChartXAxis" style="position: absolute; left: 0; right: 0; bottom: -40px; display: flex; justify-content: space-between; font-size: 12px; color: var(--color-gray-500); font-weight: 500; padding-left: 40px; padding-right: 40px;">
                            <!-- X-axis labels will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div class="metric-chart-footer" style="margin-top: 48px;">
                    <div class="metric-chart-legend" style="display: flex; gap: 24px; margin-bottom: 16px;">
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color current" style="width: 12px; height: 3px; background: #533AFD; border-radius: 2px;"></div>
                            <span style="font-size: 14px; color: var(--color-gray-700);">Current performance</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color previous" style="width: 12px; height: 3px; background: #E4E7EC; border-radius: 2px;"></div>
                            <span style="font-size: 14px; color: var(--color-gray-700);">Baseline performance</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color optimized" style="width: 12px; height: 3px; background: #22C55E; border-radius: 2px; border-top: 2px dashed #22C55E;"></div>
                            <span style="font-size: 14px; color: var(--color-gray-700);">AI-optimized potential</span>
                        </div>
                    </div>
                    <span class="update-status" style="font-size: 12px; color: var(--color-gray-500);">Updated yesterday</span>
                </div>
            </div>
            
            <!-- AI Insights Section -->
            <div class="ai-insights-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--color-gray-200);">
                <div class="ai-insights-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px; color: var(--color-purple-500);"></i>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--color-gray-900); margin: 0;">AI Insights</h3>
                </div>
                <div class="ai-insight-content" style="background: var(--color-gray-50); border-radius: 8px; padding: 16px;">
                    <p style="font-size: 14px; color: var(--color-gray-700); margin: 0 0 12px 0; line-height: 1.5;">
                        <strong>Performance Analysis:</strong> Your <span id="insight-metric-name">success rate</span> shows a <span id="insight-trend">positive trend</span> over the last 90 days, with a <span id="insight-improvement">12% improvement</span> compared to baseline performance.
                    </p>
                    <div class="ai-recommendation" style="background: white; border-radius: 6px; padding: 12px; margin-top: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="lightbulb" style="width: 14px; height: 14px; color: var(--color-yellow-500);"></i>
                            <span style="font-size: 13px; font-weight: 600; color: var(--color-gray-900);">Recommendation</span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            <span id="ai-recommendation-text">Consider implementing smart retry logic to recover declined transactions and potentially improve your success rate by an additional 3-5%.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html> 
</html> 