<!DOCTYPE html>
<!-- Payment Assistant AI - Deployed via GitHub Pages -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Payment Performance</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js" onerror="console.error('Primary Lucide CDN failed, trying fallback...')"></script>
<script>
        // Test if Lucide is loaded
        window.addEventListener("load", function() {
            console.log("Page loaded, checking Lucide...");
            if (typeof lucide !== "undefined") {
                console.log("Lucide library found, creating icons...");
                lucide.createIcons();
                console.log("Icons created successfully");
                // Re-initialize icons after a delay to ensure all are created
                setTimeout(() => {
                    lucide.createIcons();
                    console.log("Icons re-initialized");
                }, 1000);
            } else {
                console.error("Lucide library not found!");
            }
        });
    </script>
    <style>
        :root {
            --color-purple-500: #533AFD;
            --color-purple-600: #4A2FE8;
            --color-gray-50: #F9FAFB;
            --color-gray-100: #F3F4F6;
            --color-gray-150: #EBEDF0;
            --color-gray-200: #E4E7EC;
            --color-gray-300: #D2D6DC;
            --color-gray-400: #9AA2B1;
            --color-gray-500: #6C7689;
            --color-gray-600: #4F566B;
            --color-gray-700: #3D4456;
            --color-gray-800: #2B3040;
            --color-gray-900: #1A1F2E;
            --sidebar-width: 280px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #ffffff;
            color: var(--color-gray-900);
        }
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid var(--color-gray-200);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px 12px 20px;
        }
        .sidebar-logo {
            width: 28px;
            height: 28px;
            background: var(--color-gray-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-gray-500);
            font-size: 13px;
        }
        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            line-height: 20px;
            letter-spacing: -0.15px;
        }
        .sidebar-dropdown {
            margin-left: auto;
            color: var(--color-gray-400);
            font-size: 16px;
        }
        .nav-section {
            margin-top: 32px;
        }
        .nav-section:first-of-type {
            margin-top: 16px;
        }
        .nav-section-title {
            font-size: 12px;
            font-weight: 400;
            color: var(--color-gray-500);
            text-transform: none;
            letter-spacing: 0;
            padding: 0 20px 4px 20px;
            margin-bottom: 4px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            line-height: 16px;
            display: flex;
            align-items: center;
        }
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0 12px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 14px 5px 14px;
            border-radius: 8px;
            color: var(--color-gray-600);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 13px;
            line-height: 20px;
            letter-spacing: -0.15px;
            text-decoration: none;
            transition: color 0.15s;
            cursor: pointer;
            background: none;
        }
        .nav-item.active {
            color: #533AFD;
            font-weight: 600;
            background: none;
        }
        .nav-item:hover:not(.active) {
            color: var(--color-gray-900);
            background: var(--color-gray-100);
        }
        .nav-item-icon {
            width: 14px;
            height: 14px;
            color: inherit;
            flex-shrink: 0;
        }
        .nav-expand {
            margin-left: auto;
            color: var(--color-gray-400);
            width: 14px;
            height: 14px;
        }
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 0;
            border-top: 1px solid var(--color-gray-200);
            background: #fff;
            margin-top: 32px;
        }
        .footer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 400;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.15s, color 0.15s;
        }
        .footer-item:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-900);
        }
        .footer-icon {
            width: 14px;
            height: 14px;
            color: inherit;
        }
        .nav-sub-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-left: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .nav-sub-item {
            color: var(--color-gray-600);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 13px;
            line-height: 20px;
            letter-spacing: -0.15px;
            padding: 5px 14px 5px 40px;
            border-radius: 8px;
            text-decoration: none;
            transition: color 0.15s;
            cursor: pointer;
            background: none;
            display: flex;
            align-items: center;
            margin-left: 0;
        }
        .nav-sub-item:hover {
            color: var(--color-gray-900);
            background: var(--color-gray-100);
        }
        
        .nav-sub-item.active {
            color: #533AFD;
            font-weight: 600;
            background: none;
        }
        
        /* Top Bar Styles */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: #fff;
            height: 64px;
            width: calc(100vw - var(--sidebar-width));
            position: fixed;
            top: 0;
            z-index: 999;
            box-sizing: border-box;
            left: var(--sidebar-width);
            display: flex;
            justify-content: center;
        }
        
        .top-bar-inner {
            width: 100%;
            max-width: 1280px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-container {
            position: relative;
            width: 300px;
            margin-left: 0;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--color-gray-400);
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            background: var(--color-gray-100);
            transition: background 0.15s;
            color: var(--color-gray-600);
        }
        
        .search-input::placeholder {
            color: var(--color-gray-500);
        }
        
        .search-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 1px var(--color-purple-500);
        }
        
        .top-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .right-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .segmented-control {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: var(--color-gray-100);
        }
        
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            border-radius: 4px;
            color: var(--color-gray-600);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .icon-btn:hover {
            background: var(--color-gray-100);
        }
        
        .search-container {
            flex: 0 0 auto;
            min-width: 300px;
        }
        
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            width: 18px;
            height: 18px;
            color: var(--color-gray-600);
            z-index: 1;
        }
        
        .search-input {
            width: 100%;
            height: 40px;
            padding: 10px 16px 10px 44px;
            border: none;
            border-radius: 12px;
            background: var(--color-gray-100);
            font-size: 14px;
            color: var(--color-gray-700);
            transition: all 0.15s;
            font-weight: 500;
        }
        
        .search-input::placeholder {
            color: var(--color-gray-500);
            font-weight: 400;
        }
        
        .search-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 1px var(--color-gray-200);
        }
        
        .standalone-icons {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .standalone-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 6px;
            color: var(--color-gray-900);
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        
        .standalone-icon-btn:hover {
            background: var(--color-gray-100);
        }
        
        .notification-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 6px;
            color: var(--color-gray-900);
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        
        .notification-container:hover {
            background: var(--color-gray-100);
        }
        
        .notification-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: #3B82F6;
            border-radius: 50%;
        }
        
        /* Notification Panel Styles */
        .notification-panel {
            position: fixed;
            top: 72px;
            right: 32px;
            width: 400px;
            max-height: 70vh;
            background: #fff;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s;
        }
        
        .notification-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px 12px 20px;
            border-bottom: 1px solid var(--color-gray-100);
            font-weight: 600;
            font-size: 16px;
        }
        
        .notification-list {
            padding: 12px 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid var(--color-gray-200);
            transition: all 0.15s;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        

        
        .notification-dot-indicator {
            width: 8px;
            height: 8px;
            background: #3B82F6;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        
        .notification-type {
            font-size: 12px;
            font-weight: 600;
            color: #EF4444;
            background: #FEF2F2;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .notification-timestamp {
            font-size: 12px;
            color: var(--color-gray-500);
        }
        
        .notification-message {
            display: block;
            font-size: 14px;
            color: var(--color-gray-900);
            margin-bottom: 12px;
            font-weight: 400;
            line-height: 1.4;
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
        }
        
        .notification-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .notification-btn:hover {
            background: var(--color-gray-100);
        }
        
        .notification-btn.primary {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }
        
        .notification-btn.primary:hover {
            background: var(--color-purple-600);
        }
        
        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-gray-400);
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px);}
            to { opacity: 1; transform: translateY(0);}
        }
        
        .notification-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: #3B82F6;
            border-radius: 50%;
        }
        
        .new-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-purple-500);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .new-btn:hover {
            background: var(--color-purple-600);
        }
        
        .icon {
            width: 16px;
            height: 16px;
            color: inherit;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
        }
        
        .new-icon {
            width: 16px;
            height: 16px;
        }
        
        /* Main Content Styles */
        .main-content {
            padding: 24px;
            width: calc(100vw - var(--sidebar-width));
            max-width: none;
            margin-left: var(--sidebar-width);
            margin-top: 64px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        .main-content-inner {
            width: 100%;
            max-width: 1280px;
        }
        
        .page-title {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-style: normal;
            font-weight: 700;
            font-size: 28px;
            line-height: 36px;
            display: flex;
            align-items: center;
            letter-spacing: 0.38px;
            font-feature-settings: 'pnum' on, 'lnum' on;
            color: #353A44;
            margin: 0;
        }
        
        /* Page Header Styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .share-feedback-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .share-feedback-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }
        
        /* Navigation Tabs Styles */
        .nav-tabs {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--color-gray-200);
            padding-bottom: 0;
        }
        
        .nav-tab {
            padding: 12px 0;
            border: none;
            background: none;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.15s;
            pointer-events: auto;
            z-index: 10;
        }
        
        .nav-tab:hover {
            color: var(--color-gray-900);
        }
        
        .nav-tab.active {
            color: var(--color-purple-500);
            font-weight: 600;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-purple-500);
            border-radius: 1px;
        }
        
        /* Filter Styles */
        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .filter-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }
        
        .filter-btn.active {
            background: white;
            color: #533AFD;
            border-color: var(--color-gray-200);
        }
        
        .filter-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }
        
        .filter-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px dashed var(--color-gray-300);
            border-radius: 20px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .filter-chip:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-400);
        }
        
        .filter-chip.active {
            background: var(--color-purple-50);
            border-color: var(--color-purple-300);
            color: var(--color-purple-700);
            border-style: solid;
        }
        
        .filter-chip.active:hover {
            background: var(--color-purple-100);
            border-color: var(--color-purple-400);
        }
        
        .chip-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        /* Date Range Dropdown Styles */
        .date-range-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-trigger:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 140px;
            display: none;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--color-gray-600);
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--color-gray-100);
        }

        .dropdown-item.active {
            background: var(--color-purple-50);
            color: var(--color-purple-500);
            font-weight: 500;
        }
        
        /* Separator */
        .separator {
            height: 1px;
            background: var(--color-gray-200);
            margin: 24px 0;
        }

        /* Two Column Layout Styles */
        .two-column-layout {
            display: grid;
            grid-template-columns: 70% 30%;
            gap: 24px;
            margin-top: 24px;
            width: 100%;
            align-items: start;
            height: 100%;
        }

        .left-column, .right-column {
            padding: 0;
            overflow: visible;
            overflow-x: auto;
            min-width: 0;
            height: 100%;
            display: block;
            box-sizing: border-box;
        }
        
        .right-column {
            position: relative;
            min-height: 400px;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .metrics-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .metrics-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .compared-to {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .comparison-dropdown {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 4px;
            background: white;
            color: var(--color-gray-900);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .comparison-dropdown:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .dropdown-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-500);
        }

        .date-range {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 6px;
            border: 1px solid var(--color-gray-200);
            border-radius: 4px;
            background: white;
            color: var(--color-gray-600);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .download-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .download-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-600);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 16px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            /* Debug: add a subtle border to make cards more visible */
            border: 2px solid var(--color-gray-200);
        }

        .metric-card:hover {
            background: white !important;
            border-color: var(--color-purple-500) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04) !important;
            transform: translateY(-1px) !important;
        }

        .metric-card.selected {
            background: white;
            border-color: var(--color-purple-500);
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.1);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
        }

        .info-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.2;
        }

        .metric-change {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive {
            color: #6B7280; /* Medium gray */
        }

        .negative {
            color: #EF4444; /* Red */
        }



        .chart-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .chart-filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .chart-filter-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .chart-filter-btn.active {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .chart-container {
            height: 400px;
            background: white;
            margin-top: 0;
            padding: 0;
            width: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .chart-legend {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .snapshot-chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            justify-content: center;
            padding: 8px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid var(--color-gray-200);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--color-gray-600);
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-color.current {
            background: var(--color-purple-500);
        }

        .legend-color.previous {
            background: var(--color-gray-300);
        }

        .legend-color.optimized {
            background: #22C55E;
        }

        .legend-color.industry-benchmark {
            background: #10B981;
        }

        .chart-content {
            position: relative;
            height: 300px;
            margin-bottom: 16px;
            width: 100%;
            padding: 0;
        }

        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 8px;
        }

        .chart-area {
            position: absolute;
            top: 0;
            left: 40px;
            right: 40px;
            bottom: 40px;
            background: white;
            padding: 0;
        }

        .chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px);
            background-size: 100% 25%;
            opacity: 0.3;
        }

        .chart-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        .chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -40px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 40px;
            padding-right: 40px;
        }

        .chart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .insights-section {
            margin-bottom: 36px;
            padding: 0;
            background: transparent;
            width: 100%;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(0);
            overflow: visible;
            min-height: 120px;
        }
        

        
        .assistant-section {
            margin-bottom: 48px;
            padding: 0;
            background: transparent;
            width: 100%;
            transition: all 0.3s ease-in-out;
            position: relative;
            top: 0;
        }

        /* Move optimization assistant up by 20px on overview page */
.overview-page .assistant-section {
    margin-top: -20px;
}

/* Optimization Insights Styles */
.optimization-insights {
    display: flex;
    flex-direction: column;
    gap: 0px;
    margin-top: 16px;
}

.insight-card {
    background: #FFFFFF;
    border: none;
    border-radius: 6px;
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 48px;
}

.insight-header {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.insight-icon {
    width: 16px;
    height: 16px;
    color: #64748B;
    flex-shrink: 0;
}

.insight-content {
    flex: 1;
    min-width: 0;
}

.insight-title {
    font-size: 14px;
    font-weight: 500;
    color: #1E293B;
    margin: 0;
    line-height: 1.3;
}

.insight-description {
    font-size: 12px;
    color: #64748B;
    margin: 2px 0 0 0;
    line-height: 1.3;
}

.insight-impact {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 1px;
    margin-left: 12px;
}

.insight-impact .impact-value {
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #1E293B !important;
    line-height: 1.2 !important;
}

.insight-impact .impact-label {
    font-size: 11px !important;
    color: #94A3B8 !important;
    text-transform: none !important;
    letter-spacing: 0.3px !important;
    font-weight: 500 !important;
}
        
        .assistant-section.slide-up {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            margin-bottom: 0;
            z-index: 10;
        }

        .assistant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .assistant-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sparkles-icon {
            width: 16px !important;
            height: 16px !important;
            color: var(--color-purple-500) !important;
            transition: none !important;
            transform: none !important;
            font-size: 16px !important;
            line-height: 16px !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }
        
        .sparkles-icon:hover,
        .sparkles-icon:focus,
        .sparkles-icon:active {
            width: 16px !important;
            height: 16px !important;
            transform: none !important;
            transition: none !important;
            font-size: 16px !important;
            line-height: 16px !important;
        }
        
        /* Override any Lucide icon specific styles */
        [data-lucide="sparkles"].sparkles-icon {
            width: 16px !important;
            height: 16px !important;
            transition: none !important;
            transform: none !important;
        }

        .assistant-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .view-all-link {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #64748B;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.15s ease;
            margin-right: -15px;
        }

        .view-all-link:hover {
            color: #3B82F6;
        }

        .suggested-prompts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .prompt-btn {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 12px;
            padding: 16px;
            border: 2.5px solid rgba(83, 58, 253, 0.3);
            border-radius: 24px;
            background: white;
            color: var(--color-gray-900);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            line-height: 1.4;
            width: 100%;
        }

        .prompt-btn:hover {
            background: var(--color-gray-100);
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.1);
        }

        .resources-section {
            padding: 0;
            background: transparent;
            width: 100%;
            margin-bottom: 24px;
        }

        .resources-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 20px;
        }

        .resource-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: var(--color-gray-100);
            margin-bottom: 16px;
            transition: all 0.15s;
            cursor: pointer;
            width: 100%;
        }

        .resource-item:hover {
            background: var(--color-gray-100);
        }

        .resource-icon {
            width: 24px;
            height: 24px;
            color: var(--color-purple-500);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .resource-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .resource-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .resource-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .resource-subsection {
            margin-top: 20px;
        }

        .subsection-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-900);
            margin-bottom: 16px;
        }

        .resource-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 400;
            text-decoration: none;
            transition: color 0.15s;
            padding: 8px 0;
            cursor: pointer;
        }

        .resource-link:hover {
            color: var(--color-gray-900);
        }

        .arrow-icon {
            width: 14px;
            height: 14px;
            color: var(--color-gray-400);
        }

        /* Card Payments Breakdown Styles */
        .breakdown-section {
            margin-top: 32px;
            background: white;
            border-radius: 0;
            border: none;
            width: 100%;
        }

        .breakdown-header {
            padding: 24px 0 16px 0;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .breakdown-title-section {
            margin-bottom: 12px;
        }

        .breakdown-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .breakdown-subtitle {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0;
            line-height: 20px;
        }

        .breakdown-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breakdown-filters {
            display: flex;
            gap: 8px;
        }

        .breakdown-filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-600);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .breakdown-filter-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .breakdown-filter-btn.active {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
            border-width: 1px;
        }

        .breakdown-dropdowns {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-900);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .breakdown-total {
            padding: 12px 0;
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .total-label {
            font-size: 13px;
            color: var(--color-gray-600);
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .total-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-gray-900);
            display: block;
            margin-top: 4px;
        }

        .bar-chart-container {
            padding: 0;
        }

        .bar-chart-content {
            position: relative;
            height: 300px;
            margin-bottom: 12px;
            width: 100%;
            padding: 0;
        }

        .bar-chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 8px;
        }

        .bar-chart-area {
            position: absolute;
            top: 0;
            left: 40px;
            right: 40px;
            bottom: 40px;
            background: white;
            border: none;
            outline: none;
            padding: 0;
        }

        .bar-chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px);
            background-size: 100% 25%;
            opacity: 0.3;
        }

        .bar-chart-bars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .bar-chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        .bar-chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -40px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 40px;
            padding-right: 40px;
        }

        .bar-chart-footer {
            display: flex;
            justify-content: flex-end;
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .data-table-container {
            padding: 0 0 20px 0;
            margin-top: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            text-align: left;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-gray-200);
            font-weight: 600;
            color: var(--color-gray-700);
            background: white;
            font-size: 13px;
            letter-spacing: -0.15px;
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-gray-150);
            color: var(--color-gray-900);
            font-size: 13px;
            line-height: 20px;
            background: white;
        }

        .data-table tbody tr:hover {
            background: white;
        }

        .data-table tbody tr {
            background: white;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .checkbox-header {
            width: 40px;
        }

        .data-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-purple-500);
        }

        .total-row {
            background: white;
            border-top: 2px solid var(--color-gray-200);
        }

        .data-table th {
            background: white;
        }

        .total-row td {
            font-weight: 600;
            color: var(--color-gray-900);
            font-size: 13px;
        }

        .data-table .reason-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .data-table .reason-icon {
            width: 16px;
            height: 16px;
            color: var(--color-purple-500);
            flex-shrink: 0;
        }

        .active-optimization {
            background: #F0F9FF !important;
        }

        .active-optimization td {
            background: #F0F9FF !important;
        }

        .status-badge.active {
            background: #10B981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .data-table input[type="checkbox"]:checked {
            accent-color: #10B981;
        }



        /* Business Type Tabs (Horizontal Navigation) */
        .business-type-tabs {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        .business-type-tab {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            background: none;
            white-space: nowrap;
        }
        .business-type-tab:hover {
            background: var(--color-gray-100);
        }
        .business-type-tab.active {
            color: var(--color-purple-500);
            background: var(--color-purple-50);
            border-bottom: 2px solid var(--color-purple-500);
        }
        .business-type-tab:not(:last-child) {
            border-right: 1px solid var(--color-gray-200);
        }

        /* Lo-fi Mode Toggle Styles */
        .lofi-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px 16px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-200);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--color-gray-300);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--color-purple-500);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        .toggle-label {
            white-space: nowrap;
        }

        /* Skeleton Styles for Lo-fi Mode */
        .skeleton-block {
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .skeleton-block::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            transform: translateX(-100%);
        }

        .skeleton-title {
            height: 28px;
            width: 240px;
            margin-bottom: 16px;
            background: #e8e8e8;
        }

        .skeleton-subtitle {
            height: 18px;
            width: 320px;
            margin-bottom: 24px;
            background: #f0f0f0;
        }

        .skeleton-card {
            height: 140px;
            width: 100%;
            margin-bottom: 16px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .skeleton-card-header {
            height: 20px;
            width: 60%;
            background: #e8e8e8;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-card-content {
            height: 16px;
            width: 80%;
            background: #f0f0f0;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-card-metric {
            height: 32px;
            width: 40%;
            background: #e8e8e8;
            border-radius: 6px;
        }

        .skeleton-table {
            height: 240px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-table-header {
            height: 20px;
            width: 100%;
            background: #e8e8e8;
            margin-bottom: 16px;
            border-radius: 4px;
        }

        .skeleton-table-row {
            height: 16px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-timeline {
            height: 320px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-timeline-item {
            height: 60px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 16px;
        }

        .skeleton-timeline-dot {
            width: 12px;
            height: 12px;
            background: #e8e8e8;
            border-radius: 50%;
            margin-right: 16px;
        }

        .skeleton-timeline-content {
            flex: 1;
        }

        .skeleton-timeline-title {
            height: 16px;
            width: 70%;
            background: #e8e8e8;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-timeline-subtitle {
            height: 14px;
            width: 50%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-insights {
            height: 180px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-insight-item {
            height: 40px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .skeleton-insight-icon {
            width: 16px;
            height: 16px;
            background: #e8e8e8;
            border-radius: 50%;
            margin-right: 12px;
        }

        .skeleton-insight-text {
            flex: 1;
            height: 14px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-actions {
            height: 120px;
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-action-button {
            height: 40px;
            width: 100%;
            background: #f0f0f0;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        /* High-fidelity skeleton styles */
        .skeleton-waterfall {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            height: 200px;
            padding: 20px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
        }

        .skeleton-waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .skeleton-waterfall-bar {
            width: 60px;
            height: 80px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-waterfall-label {
            height: 16px;
            width: 80%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-waterfall-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .skeleton-detail-value {
            height: 14px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-detail-rate {
            height: 12px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .skeleton-metric-card {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .skeleton-metric-title {
            height: 18px;
            width: 120px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-metric-value {
            height: 24px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-metric-chart {
            display: flex;
            gap: 12px;
        }

        .skeleton-chart-y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px;
        }

        .skeleton-axis-label {
            height: 12px;
            width: 30px;
            background: #f0f0f0;
            border-radius: 2px;
        }

        .skeleton-chart-area {
            flex: 1;
            position: relative;
            height: 120px;
            background: #fafafa;
            border-radius: 4px;
        }

        .skeleton-chart-line {
            position: absolute;
            height: 2px;
            background: #e8e8e8;
            border-radius: 1px;
        }

        .skeleton-chart-line:nth-child(1) {
            top: 20%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-line:nth-child(2) {
            top: 50%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-line:nth-child(3) {
            top: 80%;
            left: 0;
            right: 0;
            width: 100%;
        }

        .skeleton-chart-legend {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .skeleton-legend-item {
            height: 12px;
            width: 60px;
            background: #f0f0f0;
            border-radius: 2px;
        }

        .skeleton-table {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-table-header {
            display: flex;
            background: #f0f0f0;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .skeleton-table-th {
            flex: 1;
            height: 16px;
            background: #e8e8e8;
            border-radius: 4px;
            margin-right: 16px;
        }

        .skeleton-table-th:last-child {
            margin-right: 0;
        }

        .skeleton-table-row {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .skeleton-table-row:last-child {
            border-bottom: none;
        }

        .skeleton-table-td {
            flex: 1;
            margin-right: 16px;
        }

        .skeleton-table-td:last-child {
            margin-right: 0;
        }

        .skeleton-opportunity-title {
            height: 16px;
            width: 80%;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-opportunity-desc {
            height: 12px;
            width: 60%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-impact-value {
            height: 16px;
            width: 50px;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .skeleton-impact-label {
            height: 12px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-revenue {
            height: 16px;
            width: 100px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-effort-badge {
            height: 20px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 12px;
            margin-bottom: 4px;
        }

        .skeleton-action-btn {
            height: 32px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        /* Additional skeleton elements for experiments */
        .skeleton-test-title {
            height: 16px;
            width: 80%;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-test-desc {
            height: 12px;
            width: 60%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-status-badge {
            height: 20px;
            width: 60px;
            background: #e8e8e8;
            border-radius: 12px;
        }

        .skeleton-progress-bar {
            height: 8px;
            width: 100px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .skeleton-rate-value {
            height: 16px;
            width: 50px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-improvement {
            height: 16px;
            width: 40px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        /* Performance stats skeleton styles */
        .skeleton-stat-card {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .skeleton-stat-value {
            height: 28px;
            width: 80px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-stat-label {
            height: 16px;
            width: 120px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* Acceptance page skeleton styles */
        .skeleton-chart {
            display: flex;
            gap: 12px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            height: 200px;
        }

        .skeleton-breakdown-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .skeleton-total-label {
            height: 16px;
            width: 120px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-total-value {
            height: 24px;
            width: 80px;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-bar-chart {
            display: flex;
            gap: 12px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            height: 200px;
            margin-bottom: 16px;
        }

        .skeleton-bar-chart-y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .skeleton-bar-chart-area {
            flex: 1;
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding-bottom: 20px;
        }

        .skeleton-bar {
            flex: 1;
            background: #e8e8e8;
            border-radius: 2px;
            min-height: 20px;
        }

        .skeleton-bar-chart-x-axis {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
        }

        .skeleton-data-table {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-resource-item {
            display: flex;
            gap: 12px;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .skeleton-resource-icon {
            width: 20px;
            height: 20px;
            background: #e8e8e8;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .skeleton-resource-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skeleton-resource-name {
            height: 16px;
            width: 80%;
            background: #e8e8e8;
            border-radius: 4px;
        }

        .skeleton-resource-description {
            height: 12px;
            width: 60%;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .skeleton-resource-subsection {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
        }

        .skeleton-subsection-title {
            height: 16px;
            width: 70%;
            background: #e8e8e8;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .skeleton-resource-link {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .skeleton-arrow-icon {
            width: 12px;
            height: 12px;
            background: #e8e8e8;
            border-radius: 2px;
        }

        .skeleton-link-text {
            height: 14px;
            width: 100px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* Filter skeleton styles */
        .skeleton-filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .skeleton-filter-btn {
            height: 36px;
            width: 120px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .skeleton-filter-chips {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .skeleton-filter-chip {
            height: 32px;
            width: 100px;
            background: #f0f0f0;
            border-radius: 16px;
        }

        .skeleton-breakdown-filters {
            display: flex;
            gap: 8px;
        }

        .skeleton-breakdown-dropdowns {
            display: flex;
            gap: 8px;
        }

        .skeleton-dropdown-btn {
            height: 36px;
            width: 100px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .skeleton-download-btn {
            height: 36px;
            width: 80px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        /* AI Assistant Panel Styles */
        .ai-assistant-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: white;
            border-left: 1px solid var(--color-gray-200);
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.08);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        /* Experiment Drawer Styles */
        .experiment-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: white;
            border-left: 1px solid var(--color-gray-200);
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.08);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        
        .experiment-drawer.open {
            transform: translateX(0);
        }
        
        .experiment-drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--color-gray-150);
            background: white;
        }
        
        .experiment-drawer-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .experiment-drawer-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .experiment-drawer-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
        }
        
        .experiment-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 32px;
            overflow-y: auto;
        }
        
        .experiment-section {
            margin-bottom: 32px;
        }
        
        .experiment-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 16px 0;
        }
        
        .experiment-recommendation {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .recommendation-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }
        
        .recommendation-description {
            font-size: 14px;
            color: var(--color-gray-600);
            margin: 0 0 16px 0;
            line-height: 1.5;
        }
        
        .recommendation-uplift {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .uplift-badge {
            background: #22C55E;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .uplift-text {
            font-size: 14px;
            color: var(--color-gray-700);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            font-size: 14px;
            color: var(--color-gray-900);
            background: white;
            transition: all 0.15s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-purple-500);
            box-shadow: 0 0 0 3px rgba(83, 58, 253, 0.1);
        }
        
        .slider-container {
            position: relative;
            padding: 20px 0;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            background: var(--color-gray-200);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-purple-500);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-purple-500);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slider-value {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-purple-500);
            margin-top: 8px;
        }
        
        .experiment-actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid var(--color-gray-200);
        }
        
        .experiment-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .experiment-btn.primary {
            background: var(--color-purple-500);
            color: white;
        }
        
        .experiment-btn.primary:hover {
            background: var(--color-purple-600);
        }
        
        .experiment-btn.secondary {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-200);
        }
        
        .experiment-btn.secondary:hover {
            background: var(--color-gray-200);
        }

        /* Toast Notification Styles */
        .experiment-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transition: transform 0.3s ease-out;
            font-size: 14px;
            color: var(--color-gray-900);
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        
        .experiment-toast a:hover {
            text-decoration: underline;
        }
        
        /* Experiment Selection Modal Styles */
        .experiment-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .experiment-selection-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .experiment-selection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .experiment-selection-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--color-gray-500);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.15s;
        }
        
        .close-btn:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
        }
        
        .experiment-selection-body {
            padding: 32px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .selection-description {
            margin: 0 0 24px 0;
            color: var(--color-gray-600);
            font-size: 14px;
        }
        
        .experiment-options {
            display: grid;
            gap: 16px;
        }
        
        .experiment-option {
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .experiment-option:hover {
            border-color: var(--color-purple-500);
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.1);
        }
        
        .experiment-option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .experiment-option-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
        }
        
        .experiment-option-description {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--color-gray-600);
            line-height: 1.5;
        }
        
        .experiment-option-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--color-gray-500);
        }
        
        .experiment-option-meta .revenue {
            color: var(--color-green-600);
            font-weight: 500;
        }
        
        .experiment-option-meta .effort {
            color: var(--color-orange-600);
            font-weight: 500;
        }

        .ai-assistant-panel.open {
            transform: translateX(0);
        }

        /* Main content adjustment when AI panel is open */
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }

        .main-content.ai-panel-open {
            margin-right: 480px;
        }

        /* Top bar adjustment when AI panel is open */
        .top-bar {
            transition: margin-right 0.3s ease-in-out;
        }

        .top-bar.ai-panel-open {
            margin-right: 480px;
        }

        /* Business type tabs adjustment when AI panel is open */
        .business-type-tabs {
            transition: left 0.3s ease-in-out;
        }

        .business-type-tabs.ai-panel-open {
            left: calc(var(--sidebar-width) + 20px - 480px);
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 32px;
            border-bottom: 1px solid var(--color-gray-150);
            background: white;
        }

        .ai-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-panel-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--color-gray-900);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ai-panel-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-panel-control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 6px;
            color: var(--color-gray-500);
            cursor: pointer;
            transition: all 0.15s;
        }

        .ai-panel-control-btn:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
        }

        .ai-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
        }

        .ai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 32px;
            overflow-y: auto;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.02) 2px,
                    rgba(0, 0, 0, 0.02) 4px
                );
        }

        .ai-message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.4s ease-out forwards;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .ai-message-avatar.assistant {
            background: var(--color-purple-500);
            color: white;
        }

        .ai-message-avatar.user {
            background: var(--color-gray-100);
            color: var(--color-gray-600);
        }

        .ai-message-content {
            flex: 1;
            max-width: calc(100% - 52px);
        }

        .ai-message-bubble {
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ai-message-bubble.assistant {
            background: white;
            color: var(--color-gray-900);
            border: 1px solid var(--color-gray-150);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .ai-message-bubble.assistant p {
            margin: 0 0 10px 0;
            line-height: 1.5;
            font-size: 13px;
        }

        .ai-message-bubble.assistant strong {
            color: var(--color-gray-900);
            font-weight: 600;
            font-size: 13px;
        }

        .ai-message-bubble.assistant h4 {
            margin: 12px 0 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            line-height: 1.4;
        }

        .ai-message-bubble.assistant ul {
            margin: 8px 0;
            padding-left: 16px;
            list-style-type: none;
        }

        .ai-message-bubble.assistant li {
            margin: 4px 0;
            line-height: 1.4;
            font-size: 13px;
            position: relative;
            padding-left: 8px;
        }

        .ai-message-bubble.assistant li:before {
            content: "";
            color: var(--color-purple-500);
            font-weight: bold;
            position: absolute;
            left: -8px;
        }

        .ai-message-bubble.user {
            background: var(--color-purple-500);
            color: white;
            box-shadow: 0 2px 8px rgba(83, 58, 253, 0.2);
        }

        .ai-input-container {
            padding: 24px 32px 32px 32px;
            background: white;
            border-top: 1px solid var(--color-gray-150);
        }

        .ai-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            position: relative;
        }

        .ai-input {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            min-height: 52px;
            max-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: white;
            transition: all 0.15s;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--color-purple-500);
            box-shadow: 0 0 0 3px rgba(83, 58, 253, 0.1);
        }

        .ai-input::placeholder {
            color: var(--color-gray-500);
        }

        .ai-send-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            border: none;
            background: var(--color-gray-200);
            color: var(--color-gray-600);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .ai-send-btn:hover {
            background: var(--color-purple-500);
            color: white;
            transform: scale(1.05);
        }

        .ai-send-btn:disabled {
            background: var(--color-gray-200);
            color: var(--color-gray-400);
            cursor: not-allowed;
            transform: none;
        }

        /* Backdrop for panel */
        .ai-panel-backdrop {
            display: none;
        }

        .ai-panel-backdrop.visible {
            display: none;
        }

        /* Layout adjustments when AI panel is open */
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }

        .main-content.ai-panel-open {
            margin-right: 480px;
        }

        /* Top bar adjustment when AI panel is open */
        .top-bar {
            transition: margin-right 0.3s ease-in-out;
        }

        .top-bar.ai-panel-open {
            margin-right: 480px;
        }

        /* Business type tabs adjustment when AI panel is open */
        .business-type-tabs {
            transition: left 0.3s ease-in-out;
        }

        .business-type-tabs.ai-panel-open {
            left: calc(var(--sidebar-width) + 20px - 480px);
        }

        /* AI Prompt Pills Styles */
        .ai-prompt-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .ai-prompt-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            max-width: 200px;
        }

        .ai-prompt-pill:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-prompt-pill.primary {
            background: var(--color-purple-500);
            border-color: var(--color-purple-500);
            color: white;
        }

        .ai-prompt-pill.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
            color: white;
        }

        .ai-prompt-pill.secondary {
            background: var(--color-gray-100);
            border-color: var(--color-gray-200);
            color: var(--color-gray-700);
        }

        .ai-prompt-pill.secondary:hover {
            background: var(--color-gray-200);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        .ai-prompt-pill-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-prompt-pill-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }
        
        .ai-prompt-pill i[data-lucide] {
            width: 14px !important;
            height: 14px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            vertical-align: middle !important;
            line-height: 1 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .ai-prompt-pill {
            display: inline-flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 8px 12px !important;
            background: white !important;
            border: 1px solid var(--color-gray-200) !important;
            border-radius: 20px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: var(--color-gray-700) !important;
            cursor: pointer !important;
            transition: all 0.15s !important;
            text-decoration: none !important;
            max-width: 200px !important;
            line-height: 1.2 !important;
        }

        /* Chart Tooltip Styles */
        .chart-tooltip {
            position: fixed;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            font-size: 13px;
            line-height: 1.4;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 336px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            top: 0;
            left: 0;
        }

        .chart-tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .tooltip-header {
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 8px;
            font-size: 13px;
        }

        .tooltip-data {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tooltip-data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-label {
            color: var(--color-gray-600);
            font-size: 12px;
        }

        .tooltip-value {
            color: var(--color-gray-900);
            font-weight: 500;
            font-size: 12px;
        }

        .tooltip-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .tooltip-ask-btn {
            background: white;
            color: var(--color-gray-600);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            z-index: 10000;
            position: relative;
        }

        .tooltip-ask-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        .tooltip-ask-btn i {
            width: 10px;
            height: 10px;
        }

        .tooltip-changes-btn {
            background: white;
            color: var(--color-gray-600);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            z-index: 10000;
            position: relative;
        }

        .tooltip-changes-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        .tooltip-changes-btn i {
            width: 10px;
            height: 10px;
        }

        /* Chart hover states */
        .chart-lines path,
        .bar-chart-bars rect {
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .chart-lines path:hover,
        .bar-chart-bars rect:hover {
            opacity: 0.8;
        }

        /* Data point indicators */
        .data-point {
            cursor: pointer;
            transition: all 0.15s;
        }

        .data-point:hover {
            opacity: 0.8;
        }

        /* Hover areas for better interaction */
        .hover-area {
            cursor: pointer;
            transition: all 0.15s;
        }

        .hover-area:hover {
            opacity: 0.8;
        }

        .tooltip-color-swatch {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .tooltip-label {
            color: var(--color-gray-600);
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        /* AI Message Animations */
        .ai-message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.4s ease-out forwards;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Graph Load Animations */
        .chart-svg {
            opacity: 0.5;
            transform: scale(0.99);
            animation: graphLoadIn 0.4s ease-out 0.1s forwards;
        }

        @keyframes graphLoadIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .bar-chart-svg {
            opacity: 0.5;
            transform: scale(0.99);
            animation: graphLoadIn 0.4s ease-out 0.1s forwards;
        }

        /* AI optimized line (third path) should be dotted */
        .chart-lines path:nth-child(3) {
            stroke-dasharray: 5, 5;
        }

        /* Bar chart bars animation */
        .bar-chart-bars rect {
            transform: scaleY(0.5);
            transform-origin: bottom;
            animation: growBar 0.6s ease-out 0.3s forwards;
        }

        @keyframes growBar {
            to {
                transform: scaleY(1);
            }
        }

        /* AI Insight Indicator Styles */
        .ai-insight-indicator {
            cursor: pointer;
            transition: all 0.3s ease;
            /* Remove any animations to keep it fixed */
            animation: none !important;
        }

        .ai-insight-sparkle {
            pointer-events: none;
        }

        /* Ensure AI insight indicator is completely static */
        .ai-insight-indicator,
        .ai-insight-indicator * {
            animation: none !important;
            transform: none !important;
        }

        .ai-insight-indicator {
            transform-origin: center center;
        }

        .ai-insight-indicator:hover {
            /* No transform to prevent movement */
            filter: drop-shadow(0 4px 8px rgba(83, 58, 253, 0.4));
        }

        /* AI Insight Overlay Styles */
        .ai-insight-overlay {
            backdrop-filter: blur(4px);
        }

        .ai-overlay-content {
            animation: aiOverlaySlideIn 0.3s ease-out;
        }

        @keyframes aiOverlaySlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .ai-metric-card {
            transition: all 0.2s ease;
        }

        .ai-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .ai-insight-item {
            transition: all 0.2s ease;
        }

        .ai-insight-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .ai-recommendation-item {
            transition: all 0.2s ease;
        }

        .ai-recommendation-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .ai-quick-tooltip {
            animation: aiTooltipSlideIn 0.2s ease-out;
        }

        @keyframes aiTooltipSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Acceptance Alert Indicator Styles - Best Practices Implementation */
        .acceptance-alert-indicator {
            cursor: pointer;
            transition: transform 0.15s ease-out, filter 0.15s ease-out;
            z-index: 1000;
            pointer-events: auto;
            /* Prevent any layout shifts */
            transform-origin: center;
            will-change: transform, filter;
            /* Ensure stable positioning */
            position: relative;
        }
        
        /* Ensure red dot stays in fixed position */
        .acceptance-alert-indicator .red-dot {
            transform: none !important;
            animation: redDotPulse 3s ease-in-out infinite;
        }

        /* Hover state - subtle and stable */
        .acceptance-alert-indicator:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 3px 6px rgba(239, 68, 68, 0.4));
        }

        /* Hover area - invisible but functional */
        .acceptance-alert-indicator .hover-area {
            pointer-events: auto;
            cursor: pointer;
        }

        /* Red dot visual element */
        .acceptance-alert-indicator .red-dot {
            transition: transform 0.15s ease-out, filter 0.15s ease-out;
            animation: redDotPulse 3s ease-in-out infinite;
        }

        .acceptance-alert-indicator:hover .red-dot {
            animation: none;
            transform: scale(1.1);
            filter: drop-shadow(0 4px 8px rgba(239, 68, 68, 0.6));
        }

        /* Stable pulsing animation */
        @keyframes redDotPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
            }
            50% {
                transform: scale(1.08);
                filter: drop-shadow(0 3px 5px rgba(239, 68, 68, 0.4));
            }
        }

        @keyframes aiInsightGlow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* Data points animation */
        .data-point, .hover-area {
            opacity: 0.5;
            animation: fadeInDataPoints 0.3s ease-out 0.6s forwards;
        }
        
        /* Prevent red dot from interfering with other elements */
        .acceptance-alert-indicator {
            isolation: isolate;
        }
        
        /* Blue dot indicator styles for Payment success rate charts */
        .blue-dot-indicator {
            transform-origin: center;
            will-change: transform, filter;
            /* Ensure stable positioning */
            position: relative;
        }
        
        /* Blue dot visual element - stable positioning */
        .blue-dot-indicator .blue-dot {
            animation: blueDotPulse 3s ease-in-out infinite;
            transition: filter 0.15s ease-out;
        }

        /* Hover state - subtle and stable */
        .blue-dot-indicator:hover {
            filter: drop-shadow(0 3px 6px rgba(83, 58, 253, 0.4));
        }

        /* Hover area - invisible but functional */
        .blue-dot-indicator .hover-area {
            pointer-events: auto;
            cursor: pointer;
        }

        .blue-dot-indicator:hover .blue-dot {
            animation: none;
            filter: drop-shadow(0 4px 8px rgba(83, 58, 253, 0.6));
        }

        /* Stable pulsing animation for blue dots */
        @keyframes blueDotPulse {
            0%, 100% {
                filter: drop-shadow(0 2px 4px rgba(83, 58, 253, 0.3));
            }
            50% {
                filter: drop-shadow(0 3px 5px rgba(83, 58, 253, 0.4));
            }
        }
        
        /* Sparkle pulse animation for AI insight icons */
        @keyframes sparklePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        /* Prevent blue dot from interfering with other elements */
        .blue-dot-indicator {
            isolation: isolate;
        }
        
        /* Line hover areas - invisible but functional */
        .line-hover-area {
            cursor: pointer;
            transition: opacity 0.1s ease;
            /* Make slightly visible for debugging */
            opacity: 0.05;
        }
        
        /* Make hover areas more visible on hover for debugging */
        .line-hover-area:hover {
            opacity: 0.3;
            background: rgba(83, 58, 253, 0.2);
        }

        @keyframes fadeInDataPoints {
            to {
                opacity: 1;
            }
        }

        /* Tooltip pulse animation for acceptance alert */
        @keyframes tooltipPulse {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Payment Lifecycle Optimization Styles */
        .lifecycle-header {
            margin-bottom: 32px;
        }

        .lifecycle-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
        }

        .lifecycle-title-section {
            flex: 1;
        }

        .lifecycle-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .lifecycle-subtitle {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: -10px 0 0 0;
        }

        /* Chart Style Dropdown */
        .chart-style-dropdown {
            position: relative;
            z-index: 10;
        }

        .chart-style-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-style-btn:hover {
            border-color: var(--color-gray-300);
            background: var(--color-gray-50);
        }

        .chart-style-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 4px;
            min-width: 120px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: all 0.2s ease;
        }

        .chart-style-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .chart-style-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--color-gray-700);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .chart-style-item:hover {
            background: var(--color-gray-50);
        }

        .chart-style-item.active {
            background: var(--color-blue-50);
            color: var(--color-blue-600);
        }

        .chart-style-item i {
            color: inherit;
        }

        /* Waterfall Chart Styles */
        .waterfall-chart {
            background: white;
            padding: 0;
            margin-bottom: 72px;
            width: 100%;
        }

        .waterfall-header {
            margin-bottom: 24px;
        }

        .waterfall-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .waterfall-header p {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0;
        }

        .waterfall-container {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex: 1;
            gap: 8px;
        }

        .waterfall-bar {
            width: 100%;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 4px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            min-height: 40px;
        }

        .waterfall-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .bar-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: center;
            line-height: 1.2;
        }

        .bar-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--color-gray-700);
            text-align: center;
        }

        .waterfall-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: center;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .waterfall-details {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Chart Container Styles */
        .chart-container-wrapper {
            background: white;
            padding: 0;
            margin-bottom: 72px;
            width: 100%;
        }

        /* Bar Chart Styles */
        .bar-chart {
            display: block;
        }

        .bar-chart .waterfall-container {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .bar-chart         .waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex: 1;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .waterfall-item:hover {
            transform: translateY(-2px);
        }

        .bar-chart .waterfall-bar {
            width: 100%;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 4px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            min-height: 40px;
        }

        .bar-chart .waterfall-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Waterfall Chart Styles */
        .waterfall-chart-style {
            display: none;
        }

        .waterfall-chart-style .waterfall-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .waterfall-chart-style .waterfall-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            flex: 1;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .waterfall-chart-style .waterfall-bar {
            width: 100%;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 4px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            min-height: 40px;
        }

        .waterfall-chart-style .waterfall-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Sparkline Charts Styles */
        .sparkline-charts-container {
            background: white;
            padding: 0;
            margin-bottom: 72px;
        }

        .sparkline-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .sparkline-row:last-child {
            margin-bottom: 0;
        }

        .sparkline-card {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 16px;
            flex: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sparkline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sparkline-content {
            flex: 1;
        }

        .sparkline-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin: 0 0 8px 0;
        }

        .sparkline-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin: 0;
            display: inline-block;
        }

        .sparkline-trend {
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sparkline-trend.positive {
            color: #059669;
        }

        .sparkline-trend.negative {
            color: #DC2626;
        }

        .sparkline-trend.neutral {
            color: #6B7280;
        }

        .sparkline-rate {
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
        }

        .sparkline-chart {
            flex-shrink: 0;
            width: 60px;
        }

        .sparkline-chart svg {
            width: 100%;
            height: 30px;
        }

        /* Sankey Chart Styles */
        .sankey-chart {
            display: none;
            padding: 24px 0;
        }

        .sankey-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .sankey-stage {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .sankey-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            flex: 1;
        }

        .sankey-bar {
            width: 100%;
            border-radius: 6px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
        }

        .sankey-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        

        .sankey-connection {
            position: absolute;
            background: var(--color-gray-200);
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .sankey-connection:hover {
            background: var(--color-gray-300);
        }

        .sankey-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: center;
        }

        .sankey-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-gray-900);
            text-align: center;
        }

        .sankey-rate {
            font-size: 11px;
            color: var(--color-gray-600);
            text-align: center;
        }

        .detail-value {
            font-size: 20px !important;
            color: var(--color-gray-600);
            text-align: center;
        }

        .detail-rate {
            font-size: 12px;
            color: var(--color-gray-500);
            text-align: center;
        }

        .waterfall-item.starting .waterfall-bar {
            background: #3B82F6;
        }

        .waterfall-item.positive .waterfall-bar {
            background: #10B981;
        }

        .waterfall-item.negative .waterfall-bar {
            background: #EF4444;
        }

        .waterfall-item.total .waterfall-bar {
            background: #533AFD;
        }

        .waterfall-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-gray-200);
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--color-gray-100);
            border-radius: 8px;
        }

        .summary-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .summary-icon.positive {
            background: #10B981;
        }

        .summary-icon.negative {
            background: #EF4444;
        }

        .summary-icon.neutral {
            background: #533AFD;
        }

        .summary-content {
            flex: 1;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gray-900);
            line-height: 1.2;
        }

        .summary-label {
            font-size: 12px;
            color: var(--color-gray-600);
            margin-top: 2px;
        }

        .lifecycle-flow {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .lifecycle-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .stage-icon {
            width: 48px;
            height: 48px;
            background: var(--color-gray-100);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stage-content {
            flex: 1;
        }

        .stage-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .stage-description {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .stage-health {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stage-health.good .health-indicator {
            background: #22C55E;
        }

        .stage-health.warning .health-indicator {
            background: #F59E0B;
        }

        .stage-health.poor .health-indicator {
            background: #EF4444;
        }

        .health-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .stage-connector {
            display: flex;
            align-items: center;
            color: var(--color-gray-400);
        }

        /* Performance Snapshot Styles */
        .performance-snapshot {
            background: white;
            padding: 0;
            margin-bottom: 72px;
        }

        .snapshot-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 20px 0;
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .snapshot-card {
            background: white;
            border: 1px solid var(--color-gray-100);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.15s;
        }

        .snapshot-card:hover {
            box-shadow: 2px 5px 7px 0px rgba(214,17,17,0.06),-1px 0px 10px 0px rgba(187,175,255,0.34);
        }

        .performance-stat-card:hover {
            box-shadow: 2px 5px 7px 0px rgba(214,17,17,0.06),-1px 0px 10px 0px rgba(187,175,255,0.34);
        }

        /* Overview page specific styles - remove hover and change background */
        .overview-page .performance-stat-card {
            background: #F5F6F8 !important;
            border: none !important;
        }

        .overview-page .performance-stat-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
            transform: translateY(-1px) !important;
            transition: all 0.2s ease !important;
        }

        .snapshot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .snapshot-card-title-section {
            flex: 1;
        }

        .snapshot-card-title-section h3 {
            margin: 0 0 4px 0;
        }

        .snapshot-card-title-section .snapshot-card-value {
            margin: 0 0 4px 0;
        }

        .snapshot-card-title-section .snapshot-card-change {
            margin: 0;
        }

        .snapshot-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .snapshot-card-value {
            font-size: 16px !important;
            font-weight: 600;
            color: var(--color-purple-500);
        }

        .snapshot-card-change {
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .snapshot-card-change.positive {
            color: #22C55E;
        }

        .snapshot-card-change.negative {
            color: #EF4444;
        }

        .explore-link {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--color-gray-500);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-top: 3px;
            opacity: 0;
            transform: translateY(5px);
            pointer-events: none;
        }

        .snapshot-card:hover .explore-link {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .explore-link:hover {
            color: var(--color-gray-700);
        }

        .explore-link i {
            color: inherit;
        }

        .snapshot-chart-container {
            padding: 0;
            background: white;
            border-radius: 4px;
        }

        .snapshot-chart-content {
            position: relative;
            height: 120px;
            margin-bottom: 0;
            width: 100%;
            padding: 8px;
        }

        .snapshot-chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-right: 2px;
        }

        .snapshot-chart-area {
            position: absolute;
            top: 0;
            left: 20px;
            right: 0;
            bottom: 30px;
            background: white;
            border: none;
            outline: none;
            padding: 0;
            width: calc(100% - 20px);
        }

        .snapshot-chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to right, var(--color-gray-100) 1px, transparent 1px),
                linear-gradient(to bottom, var(--color-gray-100) 1px, transparent 1px);
            background-size: 33.33% 25%;
            opacity: 0.5;
        }

        .snapshot-chart-bars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .snapshot-chart-svg {
            width: 100%;
            height: 100%;
            max-width: none;
            overflow: visible;
        }

        .snapshot-chart-x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -30px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--color-gray-500);
            font-weight: 500;
            padding-left: 25px;
            padding-right: 25px;
        }

        .snapshot-chart-x-axis span {
            flex: 1;
            text-align: center;
        }

        /* Impact Quantification Styles */
        .impact-quantification {
            margin-bottom: 32px;
        }

        .impact-card {
            background: white;
            padding: 24px;
        }

        .impact-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .impact-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .impact-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .impact-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .impact-label {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .impact-value {
            font-size: 24px;
            font-weight: 700;
        }

        .impact-metric.positive .impact-value {
            color: #22C55E;
        }

        .impact-metric.negative .impact-value {
            color: #EF4444;
        }

        .impact-period {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .impact-calculator-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--color-purple-500);
            border-radius: 8px;
            background: var(--color-purple-500);
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .impact-calculator-btn:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Optimization Opportunities Styles */
        .optimization-opportunities {
            margin-bottom: 72px;
        }

        .opportunities-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .opportunities-title-section {
            flex: 1;
        }

        .opportunities-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .opportunities-subtitle {
            font-size: 12px;
            color: var(--color-gray-600);
            margin: -10px 0 0 0;
        }

        .view-all-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            color: var(--color-purple-500);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .view-all-link:hover {
            background: var(--color-purple-50);
            color: var(--color-purple-600);
        }

        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .opportunity-card {
            background: white;
            padding: 24px;
            transition: all 0.15s;
        }

        .opportunity-card:hover {
            background: var(--color-gray-100);
        }

        .opportunity-card.high-priority {
            border-left: 4px solid #22C55E;
        }

        .opportunity-card.medium-priority {
            border-left: 4px solid #F59E0B;
        }

        .opportunity-card.complex {
            border-left: 4px solid #EF4444;
        }

        .opportunity-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .opportunity-icon {
            width: 48px;
            height: 48px;
            background: var(--color-gray-100);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .opportunity-meta {
            flex: 1;
        }

        .opportunity-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .opportunity-impact {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .impact-value {
            font-size: 16px;
            font-weight: 700;
            color: #22C55E;
        }

        .impact-label {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .opportunity-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .detail-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .effort-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .effort-badge.easy {
            background: #DCFCE7;
            color: #166534;
        }

        .effort-badge.medium {
            background: #FEF3C7;
            color: #92400E;
        }

        .effort-badge.complex {
            background: #FEE2E2;
            color: #991B1B;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            background: var(--color-gray-100);
            color: var(--color-gray-600);
            margin-top: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-top: 4px;
        }

        .status-badge.completed {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.in-progress {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-badge.blocked {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-badge.future {
            background: #F3F4F6;
            color: #6B7280;
        }



        .opportunity-actions {
            display: flex;
            gap: 12px;
        }

        .implement-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            background: white;
            color: var(--color-gray-700);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .implement-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .implement-btn.primary {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .implement-btn.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Experiments Styles */
        .ab-testing-section {
            margin-bottom: 72px;
        }

        .ab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .ab-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .new-test-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 1px solid var(--color-purple-500);
            border-radius: 6px;
            background: var(--color-purple-500);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-test-btn:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        .ab-tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .ab-test-card {
            background: white;
            padding: 24px;
            transition: all 0.15s;
        }

        .ab-test-card:hover {
            background: var(--color-gray-100);
        }

        .ab-test-card.active {
            border-left: 4px solid #22C55E;
        }

        .ab-test-card.completed {
            border-left: 4px solid #3B82F6;
        }

        .test-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .test-status.active .status-dot {
            background: #22C55E;
        }

        .test-status.completed .status-dot {
            background: #3B82F6;
        }

        .status-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .test-meta {
            flex: 1;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .test-description {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0;
        }

        .test-progress {
            margin-bottom: 20px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 13px;
            color: var(--color-gray-600);
        }

        .progress-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray-900);
        }

        .progress-bar {
            height: 6px;
            background: var(--color-gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-purple-500);
            border-radius: 3px;
        }

        .test-results {
            margin-bottom: 20px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-gray-100);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-row.winner {
            background: #F0FDF4;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 0 -12px;
        }

        .variant-label {
            font-size: 13px;
            color: var(--color-gray-700);
        }

        .variant-rate {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .improvement {
            font-size: 12px;
            font-weight: 500;
            color: #22C55E;
        }

        .test-actions {
            display: flex;
            gap: 12px;
        }

        .test-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .test-action-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        /* Progress Timeline Styles */
        .progress-timeline {
            margin-bottom: 48px;
        }

        .timeline-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 8px 0;
        }

        .timeline-subtitle {
            font-size: 12px;
            color: var(--color-gray-600);
            margin: -10px 0 16px 0;
        }

        .timeline-container {
            position: relative;
        }



        .timeline-event {
            position: relative;
            margin-bottom: 16px;
        }

        .timeline-event:last-child {
            margin-bottom: 0;
        }

        .event-marker {
            position: absolute;
            left: -24px;
            top: 20px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .event-marker.completed {
            background: #22C55E;
        }

        .event-marker.active {
            background: var(--color-purple-500);
        }

        .event-marker.future {
            background: var(--color-gray-300);
        }

        .event-content {
            background: white;
            padding: 16px;
            margin-left: 12px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .event-date {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .event-description {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .event-impact {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .impact-label {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .impact-value {
            font-size: 10px;
            font-weight: 500;
            color: var(--color-gray-900);
        }
        
        .timeline-event .event-impact .impact-value {
            font-size: 20px !important;
            font-weight: 700 !important;
            color: var(--color-gray-900) !important;
        }

        /* Right Column Additional Styles */
        .performance-insights {
            margin-bottom: 24px;
        }

        .insights-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 16px 0;
        }

        .insight-card {
            background: transparent;
            padding: 12px 0;
            margin-bottom: 8px;
            margin-left: 0;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .insight-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-600);
        }

        .insight-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 4px;
        }

        .insight-description {
            font-size: 12px;
            color: var(--color-gray-600);
        }

        .insight-description-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .learn-more-link {
            font-size: 11px;
            color: var(--color-purple-500);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.15s;
        }

        .learn-more-link:hover {
            color: var(--color-purple-600);
            text-decoration: underline;
        }

        .quick-actions {
            margin-bottom: 36px;
            margin-top: 24px;
        }

        .actions-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 20px;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 0;
            background: transparent;
            color: var(--color-gray-700);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 6px;
            margin-left: 0;
        }

                .quick-action-btn:last-child {
            margin-bottom: 0;
        }

        .action-btn.secondary {
            background: var(--color-gray-100);
            color: var(--color-gray-700);
        }

        .action-btn.secondary:hover {
            background: var(--color-gray-200);
        }

        .ai-insights-section {
            margin-bottom: 48px;
        }

        .ai-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .ai-insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-insight-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .ai-insight-text {
            font-size: 13px;
            color: var(--color-gray-700);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .ai-insight-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--color-purple-500);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .ai-insight-btn:hover {
            background: var(--color-purple-600);
        }

        /* Funnel Chart Styles */
        .funnel-chart {
            margin-bottom: 32px;
            background: white;
            padding: 24px;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 8px;
            background: var(--color-gray-100);
            transition: all 0.15s;
        }

        .funnel-stage:hover {
            background: var(--color-gray-100);
            transform: translateX(4px);
        }

        .funnel-stage:last-child {
            margin-bottom: 0;
        }

        .funnel-visual {
            flex: 0 0 120px;
            position: relative;
        }

        .funnel-bar {
            height: 40px;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .funnel-bar:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .funnel-label {
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .funnel-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .funnel-icon {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .funnel-details {
            flex: 1;
        }

        .funnel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0 0 4px 0;
        }

        .funnel-description {
            font-size: 13px;
            color: var(--color-gray-600);
            margin: 0 0 8px 0;
        }

        .funnel-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .funnel-metrics .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-gray-900);
        }

        .funnel-metrics .metric-label {
            font-size: 12px;
            color: var(--color-gray-500);
        }

        .funnel-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .funnel-status.good {
            background: #DCFCE7;
            color: #166534;
        }

        .funnel-status.warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .funnel-status.critical {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .funnel-connector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0 8px 140px;
            padding: 8px 16px;
            background: var(--color-gray-100);
            border-radius: 6px;
            border-left: 3px solid var(--color-gray-300);
        }

        .connector-line {
            flex: 1;
            height: 2px;
            background: var(--color-gray-300);
            position: relative;
        }

        .connector-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -2px;
            width: 0;
            height: 0;
            border-left: 6px solid var(--color-gray-300);
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
        }

        .connector-loss {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 60px;
        }

        .loss-amount {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-700);
        }

        .loss-label {
            font-size: 10px;
            color: var(--color-gray-500);
        }

        .funnel-summary {
            margin-bottom: 72px;
        }

        .summary-card {
            background: white;
            padding: 0;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin: 0;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            width: 100%;
            min-width: 0;
        }

        .summary-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--color-gray-100);
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .summary-stat .stat-value {
            display: block;
            font-size: 20px !important;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 2px;
        }

        .summary-stat .stat-label {
            font-size: 11px;
            color: var(--color-gray-600);
        }

        /* Table Styles */
        .opportunities-table-container,
        .ab-tests-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .opportunities-table,
        .ab-tests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .opportunities-table thead,
        .ab-tests-table thead {
            background: white;
        }

        .opportunities-table th,
        .ab-tests-table th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--color-gray-700);
            border-bottom: 1px solid var(--color-gray-200);
            font-size: 13px;
        }

        .opportunities-table td,
        .ab-tests-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--color-gray-100);
            vertical-align: top;
        }

        .opportunities-table tbody tr:hover,
        .ab-tests-table tbody tr:hover {
            background: white;
        }

        .opportunities-table tbody tr:last-child td,
        .ab-tests-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Opportunity Table Specific Styles */
        .opportunity-cell {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .opportunity-icon {
            width: 32px;
            height: 32px;
            background: var(--color-gray-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .opportunity-info {
            flex: 1;
        }

        .opportunity-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: 4px;
        }

        .opportunity-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .impact-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .impact-value {
            font-size: 16px;
            font-weight: 700;
            color: #22C55E;
        }

        .impact-label {
            font-size: 11px;
            color: var(--color-gray-500);
        }

        .revenue-impact {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .effort-detail {
            font-size: 11px;
            color: var(--color-gray-500);
            margin-top: 2px;
        }

        .implementation-time {
            font-size: 13px;
            color: var(--color-gray-700);
        }

        /* Experiments Table Specific Styles */
        .test-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .test-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .test-description {
            font-size: 12px;
            color: var(--color-gray-600);
            line-height: 1.4;
        }

        .status-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-cell.active .status-dot {
            background: #22C55E;
        }

        .status-cell.completed .status-dot {
            background: #3B82F6;
        }

        .status-cell.future .status-dot {
            background: #9CA3AF;
        }

        .status-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .progress-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-bar {
            height: 4px;
            background: var(--color-gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-purple-500);
            border-radius: 2px;
        }

        .progress-text {
            font-size: 11px;
            color: var(--color-gray-500);
        }

        .rate-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .rate-value.winner {
            color: var(--color-gray-900);
        }

        .improvement {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-gray-900);
        }

        .date-value {
            font-size: 13px;
            color: var(--color-gray-600);
            font-weight: 500;
        }

        .outcome-value {
            font-size: 13px;
            color: var(--color-gray-700);
            font-weight: 500;
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            color: var(--color-gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .table-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .table-btn.primary {
            background: var(--color-purple-500);
            color: white;
            border-color: var(--color-purple-500);
        }

        .table-btn.primary:hover {
            background: var(--color-purple-600);
            border-color: var(--color-purple-600);
        }

        /* Priority Indicators */
        .opportunities-table tr.high-priority {
            border-left: none;
        }

        .opportunities-table tr.medium-priority {
            border-left: none;
        }

        .ab-tests-table tr.active {
            border-left: none;
        }

        .ab-tests-table tr.completed {
            border-left: none;
        }

        /* Tab Content Styles */
        .tab-content {
            display: none;
        }

        /* Color variables for optimization page */
        :root {
            --color-green-500: #22C55E;
            --color-blue-500: #3B82F6;
            --color-orange-500: #F59E0B;
        }

        /* Optimization tab specific styles */
        .optimization-tab-content {
            width: 100%;
            background: white;
            min-height: 100vh;
            display: block;
        }

        .optimization-tab-content .two-column-layout {
            display: grid !important;
            grid-template-columns: 70% 30% !important;
            gap: 24px !important;
            margin-top: 48px;
            width: 100%;
            align-items: start;
            height: 100%;
        }

        .optimization-tab-content .left-column,
        .optimization-tab-content .right-column {
            padding: 0;
            overflow: visible;
            overflow-x: auto;
            min-width: 0;
            height: 100%;
            display: block;
            box-sizing: border-box;
            float: none !important;
            clear: none !important;
        }

        .optimization-tab-content .left-column {
            grid-column: 1;
        }

        .optimization-tab-content .right-column {
            grid-column: 2;
        }

        .data-point {
            fill: transparent;
            stroke: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .data-point:hover {
            fill: transparent;
            stroke: none;
        }
        
        .data-point.enhanced-hover {
            fill: transparent;
            stroke: none;
        }
    </style>
</head>
<body>
<div class="flex">
    <aside class="sidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="sidebar-logo">S</div>
            <span class="sidebar-title">Stripe Shop</span>
            <i data-lucide="chevron-down" class="sidebar-dropdown"></i>
        </div>
        <!-- Main Navigation -->
        <nav class="nav-section">
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="home" class="nav-item-icon"></i>
                    Home
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="list" class="nav-item-icon"></i>
                    Balances
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="repeat" class="nav-item-icon"></i>
                    Transactions
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="user" class="nav-item-icon"></i>
                    Customers
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="box" class="nav-item-icon"></i>
                    Product catalog
                </a>
            </div>
        </nav>
        <!-- Shortcuts -->
        <div class="nav-section">
            <div class="nav-section-title">Shortcuts</div>
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="wand-2" class="nav-item-icon"></i>
                    Radar
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Orchestration
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Sigma
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="clock" class="nav-item-icon"></i>
                    Custom metrics
                </a>
            </div>
        </div>
        <!-- Products -->
        <div class="nav-section">
            <div class="nav-section-title">Products</div>
            <div class="nav-list">
                <a class="nav-item" href="#">
                    <i data-lucide="layers" class="nav-item-icon"></i>
                    Connect
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="wallet" class="nav-item-icon"></i>
                    Payments
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <div class="nav-sub-list">
                                            <a class="nav-sub-item active" href="#">Performance</a>
                    <a class="nav-sub-item" href="#">Orchestration</a>
                    <a class="nav-sub-item" href="#">Disputes</a>
                    <a class="nav-sub-item" href="#">Radar</a>
                    <a class="nav-sub-item" href="#">Payment Links</a>
                    <a class="nav-sub-item" href="#">Terminal</a>
                </div>
                <a class="nav-item" href="#">
                    <i data-lucide="file-text" class="nav-item-icon"></i>
                    Billing
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="bar-chart-2" class="nav-item-icon"></i>
                    Reporting
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
                <a class="nav-item" href="#">
                    <i data-lucide="more-horizontal" class="nav-item-icon"></i>
                    More
                    <i data-lucide="chevron-down" class="nav-expand"></i>
                </a>
            </div>
        </div>
        <!-- Footer -->
        <div class="sidebar-footer">
            <a class="footer-item" href="#">
                <i data-lucide="code-2" class="footer-icon"></i>
                Developers
            </a>
        </div>
    </aside>
    <!-- Main content placeholder -->
    <main class="flex-1 bg-white flex flex-col">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-inner">
                <div class="top-controls">
                    <div class="search-container">
                        <div class="search-input-wrapper">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search">
                        </div>
                    </div>
                    <div class="right-controls">
                        <div class="segmented-control">
                            <button class="icon-btn">
                                <i data-lucide="square" class="icon"></i>
                            </button>
                            <button class="icon-btn">
                                <i data-lucide="grid-3x3" class="icon"></i>
                            </button>
                            <button class="icon-btn">
                                <i data-lucide="star" class="icon"></i>
                            </button>
                        </div>
                        <div class="standalone-icons">
                            <button class="standalone-icon-btn">
                                <i data-lucide="help-circle" class="icon"></i>
                            </button>
                            <button class="notification-container" onclick="toggleNotificationPanel()">
                                <i data-lucide="bell" class="icon"></i>
                                <div class="notification-dot"></div>
                            </button>
                            <button class="standalone-icon-btn">
                                <i data-lucide="settings" class="icon"></i>
                            </button>
                        </div>
                        <button class="new-btn">
                            <i data-lucide="plus" class="new-icon"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-content-inner">
            <!-- Page Header -->
            <div class="page-header">
                                    <h1 class="page-title">Payments performance</h1>
                <button class="share-feedback-btn">
                    Share feedback
                </button>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTabView('overview')">Overview</button>
                <button class="nav-tab" onclick="switchTabView('acceptance')">Acceptance</button>
                <button class="nav-tab" onclick="switchTabView('authentication')">Authentication</button>
                <button class="nav-tab" onclick="switchTabView('disputes')">Disputes</button>
                <button class="nav-tab" onclick="switchTabView('cost')">Cost</button>
                <button class="nav-tab" onclick="switchTabView('payment methods')">Payment methods</button>
                <button class="nav-tab" onclick="switchTabView('optimization')">Optimization</button>
            </div>
            
            <!-- Filter Section Row 1 -->
            <div class="filter-row">
                <div class="date-range-dropdown">
                    <button class="filter-btn dropdown-trigger" id="dateRangeDropdown">
                        Last 90 days
                        <i data-lucide="chevron-down" class="filter-icon"></i>
                    </button>
                    <div class="dropdown-menu" id="dateRangeMenu">
                        <div class="dropdown-item" data-range="7">Last 7 days</div>
                        <div class="dropdown-item" data-range="30">Last 30 days</div>
                        <div class="dropdown-item" data-range="60">Last 60 days</div>
                        <div class="dropdown-item active" data-range="90">Last 90 days</div>
                        <div class="dropdown-item" data-range="180">Last 6 months</div>
                        <div class="dropdown-item" data-range="365">Last 12 months</div>
                    </div>
                </div>
                <button class="filter-btn">
                    Deduplicated
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
                <button class="filter-btn">
                    Payment success rate
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
                <button class="filter-btn">
                    Include connected accounts
                    <i data-lucide="chevrons-up-down" class="filter-icon"></i>
                </button>
            </div>
            
            <!-- Filter Section Row 2 -->
            <div class="filter-row">
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Processor
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card type
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card country
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Card brand
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    Interaction type
                </button>
                <button class="filter-chip">
                    <i data-lucide="plus" class="chip-icon"></i>
                    More filters
                </button>
            </div>
            
            <!-- Separator Line -->
            <div class="separator"></div>
            
            <!-- Two Column Layout -->
            <div class="two-column-layout">
                                    <!-- Left Column: Payment Performance -->
                <div class="left-column">
                    <!-- Key Metrics Header -->
                    <div class="metrics-header">
                        <h2 class="metrics-title">Key metrics for cards</h2>
                        <div class="metrics-controls">
                            <div class="comparison-controls">
                                <span class="compared-to">Compared to</span>
                                <button class="comparison-dropdown">
                                    Previous month
                                    <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                </button>
                            </div>
                            <span class="date-range">Mar 23 - Jun 17</span>
                            <button class="download-btn">
                                <i data-lucide="download" class="download-icon"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <!-- Key Metrics Cards -->
                    <div class="metrics-grid">
                        <div class="metric-card selected">
                            <div class="metric-header">
                                <span class="metric-label">Payment success rate</span>
                            </div>
                            <div class="metric-value">63.27%</div>
                            <div class="metric-change positive">+3.27%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Accepted volume</span>
                            </div>
                            <div class="metric-value">$33.03</div>
                            <div class="metric-change positive">+48.12%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Accepted payments</span>
                            </div>
                            <div class="metric-value">31</div>
                            <div class="metric-change positive">+72.22%</div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>100%</span>
                                <span>75%</span>
                                <span>50%</span>
                                <span>25%</span>
                                <span>0%</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="M80,150 L200,120 L320,130 L440,110 L560,120 L680,100 L720,110" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="M80,120 L200,100 L320,110 L440,90 L560,100 L680,80 L720,90" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- Industry benchmark line (green) - more varied and generally higher -->
                                        <path d="M80,95 L200,80 L320,90 L440,70 L560,85 L680,65 L720,75" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                        
                                        <!-- AI Insight Indicator will be added dynamically by JavaScript -->
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    <span>Apr 20</span>
                                    <span>May 4</span>
                                    <span>May 18</span>
                                    <span>Jun 1</span>
                                    <span>Jun 15</span>
                                    <span>Jun 29</span>
                                    <span>Jul 13</span>
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                    <span id="legend-current-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                    <span id="legend-baseline-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color industry-benchmark"></div>
                                    <span>Industry benchmark</span>
                                    <span id="legend-industry-benchmark-value" style="font-weight:600;margin-left:6px;"></span>
                                </div>

                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Payments Breakdown Section -->
                    <div class="breakdown-section">
                        <div class="breakdown-header">
                            <div class="breakdown-title-section">
                                <h3 class="breakdown-title">Card payments breakdown</h3>
                                <p class="breakdown-subtitle">Review card acceptance by different attributes. Includes blocked and failed payments, and payments that didn't complete 3D Secure authentication.</p>
                            </div>
                            <div class="breakdown-controls">
                                <div class="breakdown-filters">
                                    <button class="breakdown-filter-btn active" data-metric="volume">Payment volume</button>
                                    <button class="breakdown-filter-btn" data-metric="payments">Payments</button>
                                    <button class="breakdown-filter-btn" data-metric="share">Share of payments</button>
                                    <button class="breakdown-filter-btn" data-metric="success">Success rate</button>
                                </div>
                                <div class="breakdown-dropdowns">
                                    <button class="dropdown-btn">
                                        Card type
                                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                    </button>
                                    <button class="download-btn">
                                        <i data-lucide="download" class="download-icon"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown-total">
                            <div class="total-label">
                                <span id="metric-label">Payment volume</span>
                                <i data-lucide="info" class="info-icon" style="width: 14px; height: 14px; color: var(--color-gray-400);"></i>
                            </div>
                            <span class="total-value" id="metric-value">$642.57</span>
                        </div>
                        
                        <!-- Bar Chart Container -->
                        <div class="bar-chart-container">
                            <div class="bar-chart-content">
                                <div class="bar-chart-y-axis">
                                    <span>$240</span>
                                    <span>$180</span>
                                    <span>$120</span>
                                    <span>$60</span>
                                    <span>$0</span>
                                </div>
                                <div class="bar-chart-area">
                                    <div class="bar-chart-grid"></div>
                                    <div class="bar-chart-bars">
                                        <svg class="bar-chart-svg" viewBox="0 0 800 200">
                                            <!-- Default bar groups - will be updated by JavaScript -->
                                            <g class="bar-group" transform="translate(80, 0)">
                                                <rect x="0" y="80" width="20" height="100" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="120" width="20" height="60" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(200, 0)">
                                                <rect x="0" y="60" width="20" height="120" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="100" width="20" height="80" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(320, 0)">
                                                <rect x="0" y="100" width="20" height="80" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="140" width="20" height="40" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(440, 0)">
                                                <rect x="0" y="120" width="20" height="60" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="160" width="20" height="20" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(560, 0)">
                                                <rect x="0" y="90" width="20" height="90" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="130" width="20" height="50" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(680, 0)">
                                                <rect x="0" y="70" width="20" height="110" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="110" width="20" height="70" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(720, 0)">
                                                <rect x="0" y="50" width="20" height="130" fill="#3B82F6" opacity="0.8"/>
                                                <rect x="25" y="90" width="20" height="90" fill="#533AFD" opacity="0.8"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="bar-chart-x-axis">
                                        <span>Apr 20</span>
                                        <span>May 4</span>
                                        <span>May 18</span>
                                        <span>Jun 1</span>
                                        <span>Jun 15</span>
                                        <span>Jun 29</span>
                                        <span>Jul 13</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bar-chart-footer">
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-header">
                                            <input type="checkbox" checked>
                                        </th>
                                        <th>Card type</th>
                                        <th>Payment volume</th>
                                        <th>Payments</th>
                                        <th>Share of payments</th>
                                        <th>Success rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Credit card</td>
                                        <td>$239.13</td>
                                        <td>43</td>
                                        <td>87.76%</td>
                                        <td>65.12%</td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Debit card</td>
                                        <td>$402.94</td>
                                        <td>5</td>
                                        <td>10.20%</td>
                                        <td>40.00%</td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox" checked></td>
                                        <td>Prepaid card</td>
                                        <td>$0.50</td>
                                        <td>1</td>
                                        <td>2.04%</td>
                                        <td>100.00%</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td></td>
                                        <td style="font-weight: 700;">Total</td>
                                        <td style="font-weight: 700;">$642.57</td>
                                        <td style="font-weight: 700;">49</td>
                                        <td style="font-weight: 700;">100.00%</td>
                                        <td style="font-weight: 700;">63.27%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Failed Card Payments Section -->
                    <div class="breakdown-section">
                        <div class="breakdown-header">
                            <div class="breakdown-title-section">
                                <h3 class="breakdown-title">Failed card payments</h3>
                                <p class="breakdown-subtitle">Find out why card payments failed. <a href="#" style="color: var(--color-purple-500); text-decoration: none;">Learn more about decline codes</a>.</p>
                            </div>
                            <div class="breakdown-controls">
                                <div class="breakdown-filters">
                                    <button class="breakdown-filter-btn active" data-metric="failed-volume">Failed volume</button>
                                    <button class="breakdown-filter-btn" data-metric="failed-count">Failed</button>
                                    <button class="breakdown-filter-btn" data-metric="share-failures">Share of failures</button>
                                    <button class="breakdown-filter-btn" data-metric="failure-rate">Failure rate</button>
                                </div>
                                <div class="breakdown-dropdowns">
                                    <button class="dropdown-btn">
                                        Blocked and 6 more
                                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                    </button>
                                    <button class="download-btn">
                                        <i data-lucide="download" class="download-icon"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown-total">
                            <div class="total-label">
                                <span id="failed-metric-label">Failed payment volume</span>
                                <i data-lucide="info" class="info-icon" style="width: 14px; height: 14px; color: var(--color-gray-400);"></i>
                            </div>
                            <span class="total-value" id="failed-metric-value">$609.54</span>
                        </div>
                        
                        <!-- Bar Chart Container -->
                        <div class="bar-chart-container">
                            <div class="bar-chart-content">
                                <div class="bar-chart-y-axis">
                                    <span>$200</span>
                                    <span>$150</span>
                                    <span>$100</span>
                                    <span>$50</span>
                                    <span>$0</span>
                                </div>
                                <div class="bar-chart-area">
                                    <div class="bar-chart-grid"></div>
                                    <div class="bar-chart-bars">
                                        <svg class="bar-chart-svg" viewBox="0 0 800 200">
                                            <!-- Default failed payment bars - will be updated by JavaScript -->
                                            <g class="bar-group" transform="translate(80, 0)">
                                                <rect x="0" y="180" width="25" height="20" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(200, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(320, 0)">
                                                <rect x="0" y="10" width="25" height="190" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(440, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(560, 0)">
                                                <rect x="0" y="155" width="25" height="45" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(680, 0)">
                                                <rect x="0" y="195" width="25" height="5" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(720, 0)">
                                                <rect x="0" y="10" width="25" height="190" fill="#EF4444" opacity="0.8"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="bar-chart-x-axis">
                                        <span>Apr 20</span>
                                        <span>May 4</span>
                                        <span>May 18</span>
                                        <span>Jun 1</span>
                                        <span>Jun 15</span>
                                        <span>Jun 29</span>
                                        <span>Jul 13</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-footer">
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reason</th>
                                        <th>Failed volume</th>
                                        <th>Failed count</th>
                                        <th>Share of failures</th>
                                        <th>Failure rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check" class="reason-icon"></i>
                                                Stripe
                                            </div>
                                        </td>
                                        <td>$609.54</td>
                                        <td>18</td>
                                        <td>100.00%</td>
                                        <td>36.73%</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check" class="reason-icon"></i>
                                                Bank
                                            </div>
                                        </td>
                                        <td>$0.00</td>
                                        <td>0</td>
                                        <td>0.00%</td>
                                        <td>0.00%</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td>Total</td>
                                        <td>$609.54</td>
                                        <td>18</td>
                                        <td>100.00%</td>
                                        <td>36.73%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Assistant and Resources -->
                <div class="right-column">
                    
                    <!-- Ask Assistant Section -->
                    <div class="assistant-section">
                        <div class="assistant-header">
                            <div class="assistant-title-section">
                                <i data-lucide="sparkles" class="sparkles-icon"></i>
                                <h3 class="assistant-title">Ask Assistant</h3>
                            </div>
                        </div>
                        <div class="suggested-prompts">
                            <button class="prompt-btn" id="prompt-1">
                                Why is my payment success rate lower than last month?
                            </button>
                            <button class="prompt-btn" id="prompt-2">
                                Which card types have the highest failure rates?
                            </button>
                            <button class="prompt-btn" id="prompt-3">
                                How can I improve my authorization rate?
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resources Section -->
                    <div class="resources-section">
                        <h3 class="resources-title">Resources</h3>
                        <div class="resource-item">
                            <i data-lucide="file-text" class="resource-icon"></i>
                            <div class="resource-content">
                                <span class="resource-name">Acceptance performance</span>
                                <span class="resource-description">Learn more about analyzing your card payments acceptance.</span>
                            </div>
                        </div>
                        <div class="resource-subsection">
                            <span class="subsection-title">View other payment reports</span>
                            <div class="resource-link">
                                <i data-lucide="arrow-right" class="arrow-icon"></i>
                                <span>Network costs</span>
                            </div>
                            <div class="resource-link">
                                <i data-lucide="arrow-right" class="arrow-icon"></i>
                                <span>Radar performance</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
    </main>
</div>

<!-- Chart Tooltip -->
<div class="chart-tooltip" id="chartTooltip">
    <div class="tooltip-header" id="tooltipHeader">Data Point</div>
    <div class="tooltip-data" id="tooltipData">
        <!-- Data will be populated dynamically -->
    </div>
    <div class="tooltip-actions">
        <button class="tooltip-changes-btn" id="tooltipChangesBtn">
            <i data-lucide="trending-up" style="width: 10px; height: 10px;"></i>
            What's changed?
        </button>
        <button class="tooltip-ask-btn" id="tooltipAskBtn">
            <i data-lucide="sparkles" style="width: 10px; height: 10px;"></i>
            Ask Assistant
        </button>
    </div>
</div>

<!-- Acceptance Alert Tooltip -->
<div class="chart-tooltip" id="acceptanceAlertTooltip" style="display: none;">
    <div class="tooltip-header" id="acceptanceTooltipHeader">Acceptance Alert</div>
    <div class="tooltip-data" id="acceptanceTooltipData">
        <div class="tooltip-data-item">
            <span class="tooltip-label">Current Rate:</span>
            <span class="tooltip-value">78.5%</span>
        </div>
        <div class="tooltip-data-item">
            <span class="tooltip-label">Previous Rate:</span>
            <span class="tooltip-value">80.6%</span>
        </div>
        <div class="tooltip-data-item">
            <span class="tooltip-label">Potential Recovery:</span>
            <span class="tooltip-value">$480</span>
        </div>
    </div>
    <div class="tooltip-actions">
        <button class="tooltip-changes-btn" onclick="showAcceptanceAlertDetails()">
            <i data-lucide="bar-chart-3"></i>
            Analyze Drop
        </button>
        <button class="tooltip-ask-btn" onclick="askAIAboutAcceptanceDrop()">
            <i data-lucide="zap"></i>
            Enable Smart Retries
        </button>
    </div>
</div>

<!-- Changes Analysis Popup -->
<div class="changes-popup" id="changesPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; backdrop-filter: blur(4px);">
    <div class="changes-popup-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div class="changes-popup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div>
                <h3 class="changes-popup-title" style="font-size: 18px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 4px 0;">What's Changed</h3>
                <p class="changes-popup-subtitle" style="font-size: 13px; color: var(--color-gray-600); margin: 0;" id="changesPopupSubtitle">Analysis for this data point</p>
            </div>
            <button class="changes-popup-close" onclick="closeChangesPopup()" style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.15s;">
                <i data-lucide="x" style="width: 20px; height: 20px; color: var(--color-gray-500);"></i>
            </button>
        </div>
        
        <div class="changes-popup-body" id="changesPopupBody">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>



    <script>
    lucide.createIcons();
    
    // Test function to verify JavaScript is working
    console.log('JavaScript loaded successfully');
    

    
    // Tab switching functionality
    function switchTabView(tabName) {
        console.log('Switching to tab:', tabName);
        
        // Remove active class from all tabs
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        
        // Add active class to clicked tab
        const activeTab = document.querySelector(`[onclick*="${tabName}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Hide all content sections
        const contentSections = document.querySelectorAll('.content-section');
        contentSections.forEach(section => {
            section.style.display = 'none';
        });
        
        // Show the selected content section
        const selectedSection = document.getElementById(`${tabName}Content`);
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }
        
        // Initialize the view for the selected tab
        if (tabName === 'overview') {
            createOverviewView();
        } else if (tabName === 'optimization') {
            createOptimizationViewNew();
        } else if (tabName === 'acceptance') {
            showAcceptanceView();
        }
    }
    
    // Chart Tooltip Functionality
    let currentTooltipData = null;
    let currentHoverTarget = null;
    let isTooltipVisible = false;
    let tooltipPosition = { x: 0, y: 0 }; // Store last tooltip position
    
    function initializeChartTooltips() {
        const tooltip = document.getElementById('chartTooltip');
        const tooltipAskBtn = document.getElementById('tooltipAskBtn');
        const tooltipChangesBtn = document.getElementById('tooltipChangesBtn');
        
        if (!tooltip || !tooltipAskBtn || !tooltipChangesBtn) {
            console.error('Tooltip elements not found');
            return;
        }
        
        // Add click handler for the "What's changed?" button
        tooltipChangesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Add visual feedback
            this.style.backgroundColor = '#533AFD';
            this.style.color = 'white';
            setTimeout(() => {
                this.style.backgroundColor = '';
                this.style.color = '';
            }, 200);
            
            if (currentTooltipData) {
                showChangesPopup(currentTooltipData);
                hideTooltip();
            }
        });
        
        // Add click handler for the "Ask Assistant" button
        tooltipAskBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Add visual feedback
            this.style.backgroundColor = '#533AFD';
            this.style.color = 'white';
            setTimeout(() => {
                this.style.backgroundColor = '';
                this.style.color = '';
            }, 200);
            
            // Check if tooltip is visible and has data
            if (!tooltip.classList.contains('visible')) {
                // Continue with available data
            }
            
            if (currentTooltipData) {
                
                // Ensure all required properties are present
                const tooltipData = {
                    ...currentTooltipData,
                    dateRange: currentTooltipData.dateRange || document.getElementById('dateRangeDropdown').textContent.trim(),
                    payments: currentTooltipData.payments || 0,
                    metric: currentTooltipData.metric || 'Performance',
                    value: currentTooltipData.value || currentTooltipData.current
                };
                

                
                // Determine if this is the sparkle icon (AI insight)
                const chartArea = document.querySelector('.chart-area');
                const barChartArea = document.querySelector('.bar-chart-area');
                const failedChartArea = document.querySelector('.breakdown-section:last-child .bar-chart-area');
                let chartType = 'main chart';
                let topic = 'data-analysis';
                let question = '';
                
                // Check for AI insight (sparkle) context
                let isAIInsight = false;
                let aiRecommendation = '';
                if (typeof tooltipData.dataIndex !== 'undefined') {
                    // Recompute insightIndex for the current chart
                    let chartData = null;
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        chartData = new RealisticDataGenerator(currentBusinessType, tooltipData.dateRange).generateMainChartData();
                    } else if (barChartArea && !failedChartArea) {
                        chartData = new RealisticDataGenerator(currentBusinessType, tooltipData.dateRange).generateBreakdownData();
                    }
                    if (chartData) {
                        const insightIndex = findHighestChangePoint(chartData);
                        isAIInsight = tooltipData.dataIndex === insightIndex;
                    }
                }
                // If this is the sparkle icon, use the stored insight and recommendation
                if (isAIInsight && chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                    // Use the stored insight and recommendation from the tooltip
                    const storedData = window.currentHoverData;
                    if (storedData && storedData.insight && storedData.recommendation) {
                        question = `I'm looking at the AI insight for ${tooltipData.date} (${tooltipData.dateRange}) and want to learn more`;
                    } else {
                        // Fallback to computed recommendation
                        const currentPercent = parseFloat(tooltipData.current);
                        const baselinePercent = parseFloat(tooltipData.baseline);
                        const optimizedPercent = parseFloat(tooltipData.optimized);
                        const optimizationGap = optimizedPercent - currentPercent;
                        if (optimizationGap > 8) {
                            aiRecommendation = 'Enable Link authentication and optimize your 3D Secure settings to capture this significant improvement.';
                        } else if (optimizationGap > 5) {
                            aiRecommendation = 'Review your fraud detection rules and consider adding Apple Pay/Google Pay to reduce authentication friction.';
                        } else if (optimizationGap > 2) {
                            aiRecommendation = 'Optimize your payment form and enable saved payment methods to reduce checkout friction.';
                        } else if (optimizationGap > 0) {
                            aiRecommendation = 'Review Radar rules and expand fraud detection coverage to capture this improvement.';
                        } else {
                            aiRecommendation = 'Excellent work! Consider expanding to new payment methods to capture additional revenue.';
                        }
                        question = `What specific steps should I take to achieve the industry benchmark for ${tooltipData.date} (${tooltipData.dateRange})? The AI recommendation is: ${aiRecommendation}`;
                    }
                    topic = 'ai-insight';
                } else if (isAIInsight && barChartArea && !failedChartArea) {
                    // Bar chart AI insight - use stored insight and recommendation
                    const storedData = window.currentHoverData;
                    if (storedData && storedData.insight && storedData.recommendation) {
                        question = `I'm looking at the AI insight for ${tooltipData.date} (${tooltipData.dateRange}) and want to learn more`;
                    } else {
                        // Fallback
                        aiRecommendation = 'Review your payment method mix to optimize for lower fees.';
                        question = `How can I act on the AI insight for ${tooltipData.date} (${tooltipData.dateRange})? The AI recommendation is: ${aiRecommendation}`;
                    }
                    topic = 'bar-chart-insight';
                } else {
                    // Default/fallback logic
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        chartType = 'authorization rate chart';
                        topic = 'success-rate';
                        question = `I'm looking to learn about the authorization rate performance for ${tooltipData.date} (${tooltipData.dateRange}). The current rate is ${tooltipData.current}, baseline is ${tooltipData.baseline}, and industry benchmark is ${tooltipData.optimized}. Can you help me understand what's driving these numbers and how to improve them?`;
                    } else if (barChartArea && !failedChartArea) {
                        chartType = 'payment volume breakdown chart';
                        topic = 'optimization';
                        question = `I'm looking to learn about payment volume performance for ${tooltipData.date} (${tooltipData.dateRange}). Credit card volume is ${tooltipData.creditVolume} with ${tooltipData.creditPayments} payments, and debit card volume is ${tooltipData.debitVolume} with ${tooltipData.debitPayments} payments. Can you help me understand the payment mix and optimization opportunities?`;
                    } else if (failedChartArea) {
                        chartType = 'failed payments chart';
                        topic = 'failure-analysis';
                        question = `I'm looking to learn about failed payment performance for ${tooltipData.date} (${tooltipData.dateRange}). Failed volume is ${tooltipData.failedVolume} with ${tooltipData.failedPayments} failed payments and a ${tooltipData.failureRate} failure rate. Can you help me understand what's causing these failures and how to reduce them?`;
                    } else {
                        question = `I'm looking to learn about this data point from the ${chartType}: ${tooltipData.date} - ${tooltipData.metric} ${tooltipData.value} (${tooltipData.dateRange}). Can you help me understand what this data means and how to improve performance?`;
                    }
                }
                

                
                try {
                    openAIPanel(question, currentBusinessType, topic, tooltipData.value, tooltipData.dateRange, tooltipData.payments);
                    hideTooltip();
                    // Clear the tooltip data after successfully opening the AI panel
                    currentTooltipData = null;
                } catch (error) {
                    console.error('Error opening AI panel:', error);
                    alert('Error opening AI assistant. Please try again.');
                }
            } else {
                // Try to extract data from the visible tooltip as a fallback
                const tooltipHeader = document.getElementById('tooltipHeader');
                const tooltipDataDiv = document.getElementById('tooltipData');
                
                if (tooltipHeader && tooltipDataDiv && tooltip.classList.contains('visible')) {
                    const date = tooltipHeader.textContent;
                    const dataText = tooltipDataDiv.textContent;
                    const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    
                    // Create a contextual question based on the visible data and current chart
                    let question = '';
                    let topic = 'data-analysis';
                    let metric = 85.2; // Default metric
                    
                    if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                        // Authorization rate chart
                        topic = 'success-rate';
                        question = `I'm looking at the authorization rate data for ${date} (${dateRange.toLowerCase()}). Can you help me understand what's driving these performance numbers and how to improve them?`;
                    } else if (barChartArea && !failedChartArea) {
                        // Payment volume chart
                        topic = 'optimization';
                        question = `I'm looking at the payment volume breakdown for ${date} (${dateRange.toLowerCase()}). Can you help me understand the payment mix and identify optimization opportunities?`;
                    } else if (failedChartArea) {
                        // Failed payments chart
                        topic = 'failure-analysis';
                        question = `I'm looking at the failed payment data for ${date} (${dateRange.toLowerCase()}). Can you help me understand what's causing these failures and how to reduce them?`;
                    } else {
                        // Fallback
                        question = `I'm looking at the data for ${date} (${dateRange.toLowerCase()}). Can you help me understand this data and provide recommendations for improvement?`;
                    }
                    
                    try {
                        openAIPanel(question, currentBusinessType, topic, metric, dateRange, 0);
                        hideTooltip();
                        currentTooltipData = null;
                    } catch (error) {
                        console.error('Error opening AI panel with fallback data:', error);
                        alert('Error opening AI assistant. Please try hovering over a data point again.');
                    }
                } else {
                    console.log('No tooltip data available, but AI panel should still work');
                    // Try to open AI panel with contextual data based on current chart
                    try {
                        const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                        const generator = new RealisticDataGenerator(currentBusinessType, dateRange);
                        const metrics = generator.getBusinessMetrics();
                        const successRate = 85.2; // Default success rate
                        
                        // Create contextual question based on business type and current chart
                        let question = '';
                        let topic = 'data-analysis';
                        
                        if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
                            // Authorization rate chart
                            topic = 'success-rate';
                            question = `How can I improve my ${successRate.toFixed(1)}% authorization rate for the ${dateRange.toLowerCase()}?`;
                        } else if (barChartArea && !failedChartArea) {
                            // Payment volume chart
                            topic = 'optimization';
                            const volume = metrics.dailyTransactions * generator.getTimeframeMultipliers().days * 50; // Approximate volume
                            question = `Are my current payment methods limiting my $${volume.toFixed(0)} volume for the ${dateRange.toLowerCase()}?`;
                        } else if (failedChartArea) {
                            // Failed payments chart
                            topic = 'failure-analysis';
                            const failedVolume = metrics.dailyTransactions * generator.getTimeframeMultipliers().days * 2; // Approximate failed volume
                            question = `What's causing my $${Math.round(failedVolume)} in failed payments for the ${dateRange.toLowerCase()} and how can I reduce this?`;
                        } else {
                            // Fallback
                            question = `How can I improve my payment performance for the ${dateRange.toLowerCase()}?`;
                        }
                        
                        openAIPanel(question, currentBusinessType, topic, successRate, dateRange, metrics.dailyTransactions * generator.getTimeframeMultipliers().days);
                        hideTooltip();
                        currentTooltipData = null;
                    } catch (error) {
                        console.error('Error opening AI panel with contextual data:', error);
                    }
                }
            }
        });
        
        // Add hover listeners to chart areas
        addChartHoverListeners();
        
        // Add tooltip hover listeners to keep tooltip open when mouse enters it
        addTooltipHoverListeners();
    }
    
    function addChartHoverListeners() {
        console.log('addChartHoverListeners called');
        
        // Initialize simple hover system
        if (window.SimpleChartHover) {
            if (!window.simpleChartHover) {
                window.simpleChartHover = new SimpleChartHover();
            }
            console.log('Simple chart hover system initialized');
        } else {
            console.warn('SimpleChartHover not found');
        }
        
        // Add mouseover event listeners for chart hover
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            // Remove existing listeners to prevent duplicates
            chartContainer.removeEventListener('mouseover', handleChartHover);
            chartContainer.removeEventListener('mouseout', handleChartMouseOut);
            
            // Add new listeners
            chartContainer.addEventListener('mouseover', handleChartHover);
            chartContainer.addEventListener('mouseout', handleChartMouseOut);
            
            console.log('Chart hover listeners added');
            
            // Ensure hover areas are created for the current chart
            const svg = chartContainer.querySelector('.chart-svg');
            if (svg) {
                console.log('Chart SVG found, ensuring hover areas are created...');
                const hoverAreas = svg.querySelectorAll('.simple-hover-area');
                console.log('Existing hover areas:', hoverAreas.length);
                
                if (hoverAreas.length === 0) {
                    console.log('No hover areas found, creating them...');
                    // Get the current chart data and xPoints
                    const generator = new RealisticDataGenerator('medium', 'Last 90 days');
                    const chartData = generator.generateMainChartData();
                    const xPoints = [80, 200, 320, 440, 560, 680, 720];
                    addLineHoverAreas(svg, xPoints, chartData);
                }
            }
        } else {
            console.warn('Chart container not found');
        }
    }
    
    function handleUnifiedHover(event) {
        // Disabled - using modern hover system
        console.log('Legacy hover system disabled');
    }

    function isHoverableElement(element) {
        if (!element) {
            return false;
        }
        
        if (!element.classList) {
            return false;
        }
        
        const hasDataPoint = element.classList.contains('data-point');
        const hasHoverArea = element.classList.contains('hover-area');
        const hasAIInsight = element.classList.contains('ai-insight-indicator');
        const hasAcceptanceAlert = element.classList.contains('acceptance-alert-indicator');
        const hasDebugRectangle = element.classList.contains('debug-rectangle');
        
        const isHoverable = hasDataPoint || hasHoverArea || hasAIInsight || hasAcceptanceAlert || hasDebugRectangle;
        
        if (isHoverable) {
            console.log('Element is hoverable:', element.className, 'with classes:', element.classList.toString());
        }
        
        return isHoverable;
    }

    function handleAcceptanceAlertHover(target) {
        console.log('Acceptance alert hover detected');
        
        // Hide any existing tooltips first
        hideAllTooltips();
        
        // Show acceptance alert tooltip
        const cx = parseFloat(target.getAttribute('cx'));
        const cy = parseFloat(target.getAttribute('cy'));
        showAcceptanceAlertTooltip(cx, cy);
    }

    function handleDataPointHover(target) {
        try {
            // Add null check for target
            if (!target) {
                return;
            }
            
            // Hide any existing tooltips first
            hideAllTooltips();
            
            // Handle debugging rectangles
            if (target.classList && target.classList.contains('debug-rectangle')) {
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                    showDataPointTooltip(target, index);
                }
            } else if (target.classList && target.classList.contains('data-point')) {
                // Show regular chart tooltip
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                    showDataPointTooltip(target, index);
                }
            }
        } catch (error) {
            console.error('Error in handleDataPointHover:', error);
            // Don't show error message for hover issues
        }
    }

    function handleAIInsightHover(target) {
        console.log('AI insight hover detected');
        
        // Hide any existing tooltips first
        hideAllTooltips();
        
        // Show AI insight tooltip
        const index = parseInt(target.dataset.index);
        if (!isNaN(index)) {
            showAIInsightTooltip(target, index);
        }
    }

    function hideAllTooltips() {
        // Hide all tooltips
        const tooltips = document.querySelectorAll('#chartTooltip, #acceptanceAlertTooltip, #simpleTooltip');
        tooltips.forEach(tooltip => {
            if (tooltip) {
                tooltip.style.display = 'none';
                tooltip.classList.remove('visible');
            }
        });
    }

    function showDataPointTooltip(target, index) {
        try {
            const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
            const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
            const chartData = generator.generateMainChartData();
            
            // Convert Y coordinates back to percentages
            const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
            
            // Use hardcoded coordinates that match the SVG path exactly
            const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
            const exactBaselineY = [150, 130, 140, 120, 130, 110, 120];
            const exactIndustryBenchmarkY = [95, 80, 90, 70, 85, 65, 75];
            
            // Safety check for index bounds
            if (index < 0 || index >= exactCurrentY.length) {
                console.error('Invalid index for tooltip:', index);
                return;
            }
            
            const tooltipData = {
                date: dateLabels[index],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                current: yToPercent(exactCurrentY[index]),
                baseline: yToPercent(exactBaselineY[index]),
                optimized: yToPercent(exactIndustryBenchmarkY[index]),
                metric: 'Authorization rate',
                value: yToPercent(exactCurrentY[index]),
                payments: generator.getBusinessMetrics().dailyTransactions * generator.getTimeframeMultipliers().days,
                dataIndex: index
            };
            
            // Create a mock event object for positioning
            const rect = target.getBoundingClientRect();
            const mockEvent = {
                clientX: rect.left + rect.width / 2,
                clientY: rect.top + rect.height / 2
            };
            
            showTooltip(mockEvent, tooltipData);
        } catch (error) {
            console.error('Error in showDataPointTooltip:', error);
            // Don't show error message for hover issues
        }
    }

    // Enhanced tooltip function for all chart lines
    function showEnhancedDataPointTooltip(target, index, chartData) {
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        // Use hardcoded coordinates that match the SVG path exactly
        const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
        const exactBaselineY = [150, 130, 140, 120, 130, 110, 120];
        const exactIndustryBenchmarkY = [95, 80, 90, 70, 85, 65, 75];
        
        // Safety check for index bounds
        if (index < 0 || index >= exactCurrentY.length) {
            console.error('Invalid index for tooltip:', index);
            return;
        }
        
        // Get values for all three lines
        const currentValue = yToPercent(exactCurrentY[index]);
        const baselineValue = yToPercent(exactBaselineY[index]);
        const optimizedValue = yToPercent(exactIndustryBenchmarkY[index]);
        
        // Create enhanced tooltip content
        const tooltipHTML = `
            <div style="padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <div style="font-weight: 600; font-size: 13px; color: #1A1F2E; margin-bottom: 8px;">
                    ${dateLabels[index]}
                </div>
                
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #533AFD; margin-right: 8px;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Current performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${currentValue}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #E4E7EC; margin-right: 8px; border-top: 2px dashed #E4E7EC;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Baseline performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${baselineValue}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <div style="width: 12px; height: 3px; background: #22C55E; margin-right: 8px; border-top: 2px dashed #22C55E;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Industry benchmark:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${optimizedValue}</span>
                    </div>
                </div>
            </div>
        `;
        
        // Create or get tooltip element
        let tooltip = document.getElementById('chartTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'chartTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #E4E7EC;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: none;
                pointer-events: none;
            `;
            document.body.appendChild(tooltip);
        }
        
        // Position tooltip
        const rect = target.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 + 20) + 'px';
        tooltip.style.top = (rect.top - 80) + 'px';
        tooltip.style.display = 'block';
        tooltip.innerHTML = tooltipHTML;
    }

    function showAIInsightTooltip(target, index) {
        // Implementation for AI insight tooltips
        console.log('Showing AI insight tooltip for index:', index);
        
        // Hide any existing tooltips to prevent conflicts
        hideAllTooltips();
        
        const tooltip = document.getElementById('acceptanceAlertTooltip');
        const tooltipHeader = document.getElementById('acceptanceTooltipHeader');
        const tooltipData = document.getElementById('acceptanceTooltipData');
        
        if (tooltip && tooltipHeader && tooltipData) {
            // Update tooltip content to show "View AI insights"
            tooltipHeader.textContent = 'AI Insights Available';
            
            const tooltipHTML = `
                <div class="tooltip-data-section" style="margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #1A1F2E; line-height: 1.4; margin-bottom: 8px;">
                        <i data-lucide="sparkles" style="width: 14px; height: 14px; display: inline-block; margin-right: 6px; color: #533AFD;"></i>
                        <strong>View AI insights</strong> for this data point
                    </div>
                    <div style="font-size: 12px; color: #6C7689; font-style: italic;">
                        Click to get personalized recommendations and analysis
                    </div>
                </div>
            `;
            
            tooltipData.innerHTML = tooltipHTML;
            
            // Position tooltip using best practices - simple and reliable
            const rect = target.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.display = 'block';
            tooltip.style.left = (rect.left + rect.width / 2 + 40) + 'px';
            tooltip.style.top = (rect.top + rect.height / 2 - 140) + 'px';
            tooltip.style.zIndex = '10000';
            
            // Add a subtle animation
            tooltip.style.animation = 'tooltipPulse 0.3s ease-out';
            
            // Reinitialize lucide icons for the tooltip
            lucide.createIcons();
            
            // Add simple hover events to the tooltip
            initializeSimpleTooltipHover(tooltip);
        } else {
            console.error('AI insight tooltip elements not found');
        }
    }
    
    // Simple tooltip functions for reliable hover states
    function showSimpleTooltip(target, index, chartData) {
        // Showing tooltip for index
        
        // Hide any existing tooltips first
        hideSimpleTooltip();
        
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        // Use hardcoded coordinates that match the SVG path exactly
        const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
        const exactBaselineY = [150, 130, 140, 120, 130, 110, 120];
        const exactIndustryBenchmarkY = [95, 80, 90, 70, 85, 65, 75];
        
        // Safety check for index bounds
        if (index < 0 || index >= exactCurrentY.length) {
            console.error('Invalid index for tooltip:', index);
            return;
        }
        
        const tooltipData = {
            date: dateLabels[index],
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            current: yToPercent(exactCurrentY[index]),
            baseline: yToPercent(exactBaselineY[index]),
            optimized: yToPercent(exactIndustryBenchmarkY[index]),
            metric: 'Performance',
            value: yToPercent(exactCurrentY[index]),
            dataIndex: index
        };
        
        // Create or get the tooltip element
        let tooltip = document.getElementById('chartTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'chartTooltip';
            tooltip.className = 'chart-tooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #E4E7EC;
                border-radius: 8px;
                padding: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-size: 12px;
                min-width: 200px;
                display: none;
                pointer-events: none;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            `;
            document.body.appendChild(tooltip);
        }
        
        // Position tooltip near the mouse with better positioning
        const rect = target.getBoundingClientRect();
        const tooltipX = rect.left + rect.width / 2;
        const tooltipY = rect.top - 10;
        
        // Ensure tooltip doesn't go off-screen
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const tooltipWidth = 200;
        const tooltipHeight = 120;
        
        let finalX = tooltipX;
        let finalY = tooltipY;
        
        // Adjust horizontal position if tooltip goes off-screen
        if (finalX + tooltipWidth > viewportWidth - 10) {
            finalX = rect.left - tooltipWidth - 10;
        }
        
        // Adjust vertical position if tooltip goes off-screen
        if (finalY < 10) {
            finalY = rect.bottom + 10;
        }
        
        // Ensure minimum distance from edges
        finalX = Math.max(10, Math.min(finalX, viewportWidth - tooltipWidth - 10));
        finalY = Math.max(10, Math.min(finalY, viewportHeight - tooltipHeight - 10));
        
        tooltip.style.left = finalX + 'px';
        tooltip.style.top = finalY + 'px';
        
        // Set tooltip content
        tooltip.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">${tooltipData.date}</div>
            <div style="margin-bottom: 4px;">
                <span style="color: #533AFD;"></span> Current: ${tooltipData.current}
            </div>
            <div style="margin-bottom: 4px;">
                <span style="color: #E4E7EC;"></span> Baseline: ${tooltipData.baseline}
            </div>
            <div>
                <span style="color: #22C55E;"></span> Benchmark: ${tooltipData.optimized}
            </div>
        `;
        
        // Show tooltip
        tooltip.style.display = 'block';
        
        // Tooltip shown
    }
    
    function hideSimpleTooltip() {
        const tooltip = document.getElementById('chartTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }
    
    function handleUnifiedMouseOut(event) {
        const target = event.target;
        
        // Check if we're moving to a child element (don't hide if moving within the same element)
        if (target.contains(event.relatedTarget) || target === event.relatedTarget) {
            return;
        }

        // Check if we're moving to the tooltip itself
        const tooltip = document.getElementById('chartTooltip') || document.getElementById('acceptanceAlertTooltip');
        if (tooltip && (tooltip.contains(event.relatedTarget) || tooltip === event.relatedTarget)) {
            return;
        }

        // Clear current hover target
        currentHoverTarget = null;

        // Hide tooltip immediately
        hideAllTooltips();
        isTooltipVisible = false;
    }
    
    // Legacy functions - kept for compatibility but no longer used
    function handleChartMouseOver(e) {
        // Now handled by unified system
    }
    
    function handleChartMouseOut(e) {
        // Hide tooltips when mouse leaves chart area
        setTimeout(() => {
            hideAllTooltips();
        }, 100);
    }
    
    function addTooltipHoverListeners() {
        const tooltips = document.querySelectorAll('#chartTooltip, #acceptanceAlertTooltip');
        
        tooltips.forEach(tooltip => {
            if (!tooltip) return;
            
            // Keep tooltip open when mouse enters
            tooltip.addEventListener('mouseenter', function(e) {
                console.log('Mouse entered tooltip, keeping it open');
                currentHoverTarget = this;
                isTooltipVisible = true;
            });
            
            // Hide tooltip when mouse leaves
            tooltip.addEventListener('mouseleave', function(e) {
                console.log('Mouse left tooltip');
                currentHoverTarget = null;
                isTooltipVisible = false;
                hideAllTooltips();
            });
            
            // Prevent tooltip from hiding when clicking inside
            tooltip.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('Tooltip clicked, preventing hide');
                currentHoverTarget = this;
                isTooltipVisible = true;
            });
        });
    }
    
    function handleChartHover(event) {
        // Only show tooltip if hovering over a data point, hover area, or AI insight indicator
        if (!event.target || !event.target.classList || (!event.target.classList.contains('data-point') && !event.target.classList.contains('hover-area') && !event.target.classList.contains('ai-insight-indicator'))) {
            return;
        }
        
        const dataIndex = parseInt(event.target.dataset.index);
        if (isNaN(dataIndex)) return;
        
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const chartData = generator.generateMainChartData();
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        const tooltipData = {
            date: dateLabels[dataIndex],
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            current: yToPercent(chartData.current[dataIndex]),
            baseline: yToPercent(chartData.baseline[dataIndex]),
                            optimized: yToPercent(chartData.industryBenchmark[dataIndex]),
            metric: 'Authorization rate',
            value: yToPercent(chartData.current[dataIndex]),
            payments: generator.getBusinessMetrics().dailyTransactions * generator.getTimeframeMultipliers().days,
            dataIndex: dataIndex
        };
        
        console.log('Tooltip data for index', dataIndex, ':', {
            date: tooltipData.date,
            current: tooltipData.current,
            baseline: tooltipData.baseline,
            optimized: tooltipData.optimized,
            rawData: {
                current: chartData.current[dataIndex],
                baseline: chartData.baseline[dataIndex],
                optimized: chartData.industryBenchmark[dataIndex]
            }
        });
        
        showTooltip(event, tooltipData);
    }
    
    function handleBarChartHover(event) {
        // Only show tooltip if hovering over a data point, hover area, or AI insight indicator
        if (!event.target || !event.target.classList || (!event.target.classList.contains('data-point') && !event.target.classList.contains('hover-area') && !event.target.classList.contains('ai-insight-indicator'))) {
            return;
        }
        
        const dataIndex = parseInt(event.target.dataset.index);
        if (isNaN(dataIndex)) return;
        
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const breakdownData = generator.generateBreakdownData();
        
        const tooltipData = {
            date: dateLabels[dataIndex],
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            creditVolume: `$${breakdownData.bars[dataIndex].credit.toFixed(2)}`,
            debitVolume: `$${breakdownData.bars[dataIndex].debit.toFixed(2)}`,
            creditPayments: breakdownData.bars[dataIndex].payments.credit,
            debitPayments: breakdownData.bars[dataIndex].payments.debit,
            metric: 'Payment volume',
            value: `$${(breakdownData.bars[dataIndex].credit + breakdownData.bars[dataIndex].debit).toFixed(2)}`,
            payments: breakdownData.bars[dataIndex].payments.credit + breakdownData.bars[dataIndex].payments.debit,
            dataIndex: dataIndex
        };
        
        showTooltip(event, tooltipData);
    }
    
    function findClosestDataPoint(mouseX, xPoints) {
        let closestIndex = -1;
        let closestDistance = Infinity;
        
        for (let i = 0; i < xPoints.length; i++) {
            const distance = Math.abs(mouseX - xPoints[i]);
            if (distance < closestDistance && distance < 50) { // Within 50px threshold
                closestDistance = distance;
                closestIndex = i;
            }
        }
        
        return closestIndex;
    }
    
    function showTooltip(event, data) {
        try {
            // Don't show tooltip if AI panel is open
            const aiPanel = document.getElementById('aiAssistantPanel');
            if (aiPanel && aiPanel.classList.contains('open')) {
                return;
            }
            
            const tooltip = document.getElementById('chartTooltip');
            const tooltipHeader = document.getElementById('tooltipHeader');
            const tooltipData = document.getElementById('tooltipData');
            
            if (!tooltip || !tooltipHeader || !tooltipData) {
                console.error('Tooltip elements not found');
                return;
            }
        
        // Check if we're already showing the same data to prevent unnecessary re-rendering
        if (currentTooltipData && 
            currentTooltipData.dataIndex === data.dataIndex && 
            currentTooltipData.date === data.date &&
            tooltip.classList.contains('visible')) {
            console.log('Same tooltip data, not re-rendering');
            return;
        }
        
        // Ensure currentTooltipData has all required properties for the assistant
        currentTooltipData = {
            ...data,
            dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
            payments: data.payments || 0,
            metric: data.metric || 'Performance',
            value: data.value || data.current
        };
        
        console.log('Set currentTooltipData:', currentTooltipData);
        
        // Position tooltip relative to the mouse cursor for stable positioning
        const tooltipWidth = 336;
        const tooltipHeight = 200;
        
        // Use mouse position for more stable tooltip positioning
        let tooltipX = event.clientX + 15; // 15px to the right of cursor
        let tooltipY = event.clientY - 10; // 10px above cursor
        
        // Ensure tooltip doesn't go off-screen
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Adjust horizontal position if tooltip goes off-screen
        if (tooltipX + tooltipWidth > viewportWidth - 10) {
            tooltipX = event.clientX - tooltipWidth - 15; // Position to the left of cursor
        }
        
        // Adjust vertical position if tooltip goes off-screen
        if (tooltipY < 10) {
            tooltipY = event.clientY + 15; // Position below cursor
        }
        
        // Ensure minimum distance from edges
        tooltipX = Math.max(10, Math.min(tooltipX, viewportWidth - tooltipWidth - 10));
        tooltipY = Math.max(10, Math.min(tooltipY, viewportHeight - tooltipHeight - 10));
        
        // Update tooltip position
        tooltipPosition = { x: tooltipX, y: tooltipY };
        tooltip.style.left = tooltipX + 'px';
        tooltip.style.top = tooltipY + 'px';
        
        // Update tooltip content
        tooltipHeader.textContent = data.date;
        
        // Check if this is the AI insight indicator (sparkle icon)
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        const chartData = generator.generateMainChartData();
        const insightIndex = findHighestChangePoint(chartData);
        const isAIInsight = data.dataIndex === insightIndex;
        
        let dataHTML = '';
        if (data.current && data.baseline && data.optimized) {
            // Line chart data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Performance:
                    </span>
                    <span class="tooltip-value">${data.current}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #E4E7EC;"></div>
                        Baseline performance:
                    </span>
                    <span class="tooltip-value">${data.baseline}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #22C55E;"></div>
                        Industry benchmark:
                    </span>
                    <span class="tooltip-value">${data.optimized}</span>
                </div>
            `;
            
            // Add AI insight for the sparkle icon
            if (isAIInsight) {
                const currentPercent = parseFloat(data.current);
                const baselinePercent = parseFloat(data.baseline);
                const optimizedPercent = parseFloat(data.optimized);
                const optimizationGap = optimizedPercent - currentPercent;
                // Refined insight copy
                const insight = `Your payment approval rate of ${currentPercent.toFixed(1)}% could increase by ${optimizationGap.toFixed(1)}% if you implement our AI-recommended optimizations to reach ${optimizedPercent.toFixed(0)}%.`;
                const recommendation = ' Enable Link authentication and adjust your 3D Secure settings to unlock this revenue opportunity.';
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                            ${recommendation}
                        </div>
                    </div>
                `;
                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'performance',
                    insight: insight,
                    recommendation: recommendation
                };
            } else {
                // Add simple AI insight available text for non-insight data points
                dataHTML += `
                    <div style="border-top: 1px solid #E4E7EC; padding-top: 8px; margin-top: 8px;">
                        <div style="font-size: 11px; color: #533AFD; text-align: center; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 4px;">
                            <i data-lucide="sparkles" style="width: 10px; height: 10px; color: #533AFD;"></i>
                            AI insight available
                        </div>
                    </div>
                `;
            }
        } else if (data.creditVolume && data.debitVolume) {
            // Bar chart data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #3B82F6;"></div>
                        Credit Card Volume:
                    </span>
                    <span class="tooltip-value">${data.creditVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #3B82F6;"></div>
                        Credit Card Payments:
                    </span>
                    <span class="tooltip-value">${data.creditPayments}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Debit Card Volume:
                    </span>
                    <span class="tooltip-value">${data.debitVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #533AFD;"></div>
                        Debit Card Payments:
                    </span>
                    <span class="tooltip-value">${data.debitPayments}</span>
                </div>
            `;
            
            // Add AI insight for bar chart sparkle icon
            if (isAIInsight) {
                const creditVolume = parseFloat(data.creditVolume.replace('$', ''));
                const debitVolume = parseFloat(data.debitVolume.replace('$', ''));
                const totalVolume = creditVolume + debitVolume;
                const creditShare = (creditVolume / totalVolume * 100).toFixed(1);
                const debitShare = (debitVolume / totalVolume * 100).toFixed(1);
                
                let insight = '';
                let recommendation = '';
                
                if (creditShare > 70) {
                    insight = `Credit cards dominate ${creditShare}% of your payment volume on ${data.date}.`;
                    recommendation = 'Consider optimizing debit card acceptance to reduce processing fees.';
                } else if (debitShare > 40) {
                    insight = `Strong debit card usage at ${debitShare}% shows good payment method diversity.`;
                    recommendation = 'Explore adding digital wallets to capture more mobile transactions.';
                } else if (totalVolume > 100) {
                    insight = `High payment volume of ${formatUSD(totalVolume)} indicates strong customer engagement.`;
                    recommendation = 'Review your payment method mix to optimize for lower fees.';
                } else {
                    insight = `Payment volume of ${formatUSD(totalVolume)} shows room for growth.`;
                    recommendation = 'Consider enabling more payment methods to increase conversion.';
                }
                
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                             ${recommendation}
                        </div>
                    </div>
                `;

                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'payment-volume',
                    insight: insight,
                    recommendation: recommendation
                };
            } else {
                // Add simple AI insight available text for non-insight data points
                dataHTML += `
                    <div style="border-top: 1px solid #E4E7EC; padding-top: 8px; margin-top: 8px;">
                        <div style="font-size: 11px; color: #533AFD; text-align: center; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 4px;">
                            <i data-lucide="sparkles" style="width: 10px; height: 10px; color: #533AFD;"></i>
                            AI insight available
                        </div>
                    </div>
                `;
            }
        } else if (data.failedVolume && data.failedPayments) {
            // Failed payments data
            dataHTML = `
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failed Volume:
                    </span>
                    <span class="tooltip-value">${data.failedVolume}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failed Payments:
                    </span>
                    <span class="tooltip-value">${data.failedPayments}</span>
                </div>
                <div class="tooltip-data-item">
                    <span class="tooltip-label">
                        <div class="tooltip-color-swatch" style="background: #EF4444;"></div>
                        Failure Rate:
                    </span>
                    <span class="tooltip-value">${data.failureRate}</span>
                </div>
            `;
            
            // Add AI insight for failed payments sparkle icon
            if (isAIInsight) {
                const failedVolume = parseFloat(data.failedVolume.replace('$', ''));
                const failedPayments = parseInt(data.failedPayments);
                const failureRate = parseFloat(data.failureRate.replace('%', ''));
                
                let insight = '';
                let recommendation = '';
                
                if (failureRate > 30) {
                    insight = `High failure rate of ${failureRate}% on ${data.date} indicates authentication issues.`;
                    recommendation = 'Review your 3D Secure settings and consider enabling Link for better authentication.';
                } else if (failedVolume > 50) {
                    insight = `Failed volume of ${formatUSD(failedVolume)} suggests potential fraud or card issues.`;
                    recommendation = 'Check your Radar rules and consider adding additional fraud detection.';
                } else if (failedPayments > 10) {
                    insight = `${failedPayments} failed payments may indicate customer experience issues.`;
                    recommendation = 'Review your payment form and consider adding saved payment methods.';
                } else {
                    insight = `Low failure rate of ${failureRate}% shows good payment processing health.`;
                    recommendation = 'Consider enabling more payment methods to reduce dependency on cards.';
                }
                
                dataHTML += `
                    <div class="tooltip-insight" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E7EC;">
                        <div style="font-size: 12px; color: #6C7689; margin-bottom: 4px;">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                            AI Insight
                        </div>
                        <div style="font-size: 13px; color: #1A1F2E; margin-bottom: 6px; line-height: 1.4;">
                            ${insight}
                        </div>
                        <div style="font-size: 12px; color: #533AFD; font-weight: 500;">
                             ${recommendation}
                        </div>
                    </div>
                `;

                // Store hover data for assistant integration
                window.currentHoverData = {
                    date: data.date,
                    current: data.current,
                    baseline: data.baseline,
                    optimized: data.optimized,
                    type: 'failure-analysis'
                };
            }
        }
        
        tooltipData.innerHTML = dataHTML;
        tooltip.style.display = 'block';
        tooltip.classList.add('visible');
        
        // Reinitialize lucide icons for the tooltip
        lucide.createIcons();
        } catch (error) {
            console.error('Error in showTooltip:', error);
            // Don't show error message for hover issues
        }
    }
    
    function hideTooltip() {
        const tooltip = document.getElementById('chartTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
            tooltip.classList.remove('visible');
            // Don't clear currentTooltipData immediately - let the AI panel handle it
        }
        
        // Also hide acceptance alert tooltip
        const acceptanceTooltip = document.getElementById('acceptanceAlertTooltip');
        if (acceptanceTooltip) {
            acceptanceTooltip.style.display = 'none';
        }
        
        // Also hide simple tooltip
        const simpleTooltip = document.getElementById('simpleTooltip');
        if (simpleTooltip) {
            simpleTooltip.style.display = 'none';
        }
    }
    
    function showChangesPopup(tooltipData) {
        const popup = document.getElementById('changesPopup');
        const subtitle = document.getElementById('changesPopupSubtitle');
        const body = document.getElementById('changesPopupBody');
        
        if (!popup || !subtitle || !body) {
            console.error('Changes popup elements not found');
            return;
        }
        
        // Set subtitle
        subtitle.textContent = `Analysis for ${tooltipData.date} (${tooltipData.dateRange || 'Last 7 days'})`;
        
        // Generate analysis content based on the data
        const analysis = generateChangesAnalysis(tooltipData);
        
        // Populate the popup body
        body.innerHTML = analysis;
        
        // Show the popup
        popup.style.display = 'block';
        
        // Reinitialize lucide icons
        lucide.createIcons();
    }
    
    function closeChangesPopup() {
        const popup = document.getElementById('changesPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }
    
    function generateChangesAnalysis(tooltipData) {
        const current = parseFloat(tooltipData.current);
        const baseline = parseFloat(tooltipData.baseline);
        const optimized = parseFloat(tooltipData.optimized);
        const change = current - baseline;
        const optimizationGap = optimized - current;
        
        let analysis = '';
        
        // Determine chart type and generate appropriate analysis
        const chartArea = document.querySelector('.chart-area');
        const barChartArea = document.querySelector('.bar-chart-area');
        const failedChartArea = document.querySelector('.breakdown-section:last-child .bar-chart-area');
        
        if (chartArea && chartArea.contains(document.querySelector('.chart-svg'))) {
            // Authorization rate chart analysis
            analysis = `
                <div class="changes-section">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 12px 0;">Authorization rate changes</h4>
                    <div class="change-item" style="margin-bottom: 16px;">
                        <div class="change-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="change-indicator ${change >= 0 ? 'positive' : 'negative'}" style="width: 8px; height: 8px; border-radius: 50%; background: ${change >= 0 ? '#22C55E' : '#EF4444'};"></span>
                            <span style="font-size: 13px; font-weight: 500; color: var(--color-gray-900);">
                                ${change >= 0 ? '+' : ''}${change.toFixed(1)}% vs baseline
                            </span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            ${change >= 0 ? 
                                'Your authorization rate has improved compared to the baseline period. This could be due to:' :
                                'Your authorization rate has decreased compared to the baseline period. This could be due to:'
                            }
                        </p>
                        <ul style="font-size: 13px; color: var(--color-gray-700); margin: 8px 0 0 0; padding-left: 20px; line-height: 1.4;">
                            ${change >= 0 ? `
                                <li>Improved fraud detection rules</li>
                                <li>Better 3D Secure authentication</li>
                                <li>Enhanced payment form optimization</li>
                                <li>Stronger customer verification</li>
                            ` : `
                                <li>Increased fraud attempts</li>
                                <li>3D Secure authentication issues</li>
                                <li>Payment form friction</li>
                                <li>Regional payment restrictions</li>
                            `}
                        </ul>
                    </div>
                    
                    <div class="optimization-opportunity" style="background: var(--color-gray-100); border-radius: 8px; padding: 12px; margin-top: 16px;">
                        <div class="opportunity-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="lightbulb" style="width: 14px; height: 14px; color: var(--color-purple-500);"></i>
                            <span style="font-size: 13px; font-weight: 600; color: var(--color-gray-900);">Optimization Opportunity</span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            You could improve your authorization rate by an additional <strong>${optimizationGap.toFixed(1)}%</strong> by implementing AI-optimized strategies.
                        </p>
                    </div>
                </div>
            `;
        } else if (barChartArea && !failedChartArea) {
            // Payment volume chart analysis
            analysis = `
                <div class="changes-section">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 12px 0;">Payment volume changes</h4>
                    <div class="change-item" style="margin-bottom: 16px;">
                        <div class="change-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="change-indicator positive" style="width: 8px; height: 8px; border-radius: 50%; background: #22C55E;"></span>
                            <span style="font-size: 13px; font-weight: 500; color: var(--color-gray-900);">
                                Payment mix analysis
                            </span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            Your payment volume breakdown shows the following trends:
                        </p>
                        <ul style="font-size: 13px; color: var(--color-gray-700); margin: 8px 0 0 0; padding-left: 20px; line-height: 1.4;">
                            <li>Credit card volume: ${tooltipData.creditVolume || '$12.4K'} (${tooltipData.creditPayments || '1,240'} payments)</li>
                            <li>Debit card volume: ${tooltipData.debitVolume || '$8.2K'} (${tooltipData.debitPayments || '820'} payments)</li>
                            <li>Digital wallet adoption increasing</li>
                            <li>Regional payment preferences vary</li>
                        </ul>
                    </div>
                    
                    <div class="optimization-opportunity" style="background: var(--color-gray-100); border-radius: 8px; padding: 12px; margin-top: 16px;">
                        <div class="opportunity-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="lightbulb" style="width: 14px; height: 14px; color: var(--color-purple-500);"></i>
                            <span style="font-size: 13px; font-weight: 600; color: var(--color-gray-900);">Optimization Opportunity</span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            Consider expanding digital wallet options and optimizing for regional payment preferences to increase volume.
                        </p>
                    </div>
                </div>
            `;
        } else if (failedChartArea) {
            // Failed payments chart analysis
            analysis = `
                <div class="changes-section">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 12px 0;">Failed Payment Analysis</h4>
                    <div class="change-item" style="margin-bottom: 16px;">
                        <div class="change-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="change-indicator negative" style="width: 8px; height: 8px; border-radius: 50%; background: #EF4444;"></span>
                            <span style="font-size: 13px; font-weight: 500; color: var(--color-gray-900);">
                                ${tooltipData.failureRate || '2.1%'} failure rate
                            </span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            Failed payment volume of ${tooltipData.failedVolume || '$2.1K'} (${tooltipData.failedPayments || '210'} payments) could be due to:
                        </p>
                        <ul style="font-size: 13px; color: var(--color-gray-700); margin: 8px 0 0 0; padding-left: 20px; line-height: 1.4;">
                            <li>Insufficient funds</li>
                            <li>Card expiration</li>
                            <li>Fraud detection blocks</li>
                            <li>3D Secure authentication failures</li>
                            <li>Regional payment restrictions</li>
                        </ul>
                    </div>
                    
                    <div class="optimization-opportunity" style="background: var(--color-gray-100); border-radius: 8px; padding: 12px; margin-top: 16px;">
                        <div class="opportunity-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="lightbulb" style="width: 14px; height: 14px; color: var(--color-purple-500);"></i>
                            <span style="font-size: 13px; font-weight: 600; color: var(--color-gray-900);">Reduction Opportunity</span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            Implement smart retry logic and improve fraud detection to reduce failed payments by up to 40%.
                        </p>
                    </div>
                </div>
            `;
        } else {
            // Generic analysis
            analysis = `
                <div class="changes-section">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 12px 0;">Data Point Analysis</h4>
                    <div class="change-item" style="margin-bottom: 16px;">
                        <div class="change-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="change-indicator neutral" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-gray-400);"></span>
                            <span style="font-size: 13px; font-weight: 500; color: var(--color-gray-900);">
                                Performance analysis
                            </span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            Current performance: ${tooltipData.current || 'N/A'}<br>
                            Baseline comparison: ${tooltipData.baseline || 'N/A'}<br>
                            Optimization potential: ${tooltipData.optimized || 'N/A'}
                        </p>
                    </div>
                </div>
            `;
        }
        
        return analysis;
    }
    
    // Test function to verify JavaScript is working
    console.log('JavaScript loaded successfully');
    
    // Function to update main chart with new data
    function updateMainChart(dateRange, businessType = 'growth') {
        console.log('updateMainChart called with:', dateRange, 'business type:', businessType);
        const chartContainer = document.querySelector('.chart-container');
        if (!chartContainer) {
            console.log('Chart container not found!');
            return;
        }
        console.log('Chart container found');

        // Use the realistic data generator
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const mainChartData = generator.generateMainChartData();
        
        console.log('Raw main chart data:', mainChartData);
        
        // Ensure we have exactly 7 data points to match the x-coordinates
        if (!mainChartData || !mainChartData.current || !mainChartData.baseline || !mainChartData.industryBenchmark ||
            mainChartData.current.length !== 7 || mainChartData.baseline.length !== 7 || mainChartData.industryBenchmark.length !== 7) {
            console.error('Data length mismatch. Expected 7, got:', mainChartData);
            return;
        }
        
        // Validate data and prevent NaN values
        const validateData = (dataArray) => {
            return dataArray.map(val => {
                const num = parseFloat(val);
                if (isNaN(num)) {
                    console.warn('NaN value detected, replacing with 100:', val);
                    return 100;
                }
                return Math.max(0, num);
            });
        };
        
        const validatedCurrent = validateData(mainChartData.current);
        const validatedBaseline = validateData(mainChartData.baseline);
        const validatedIndustryBenchmark = validateData(mainChartData.industryBenchmark);
        console.log('Validated chart data:', { validatedCurrent, validatedBaseline, validatedIndustryBenchmark });

        // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
        // These coordinates correspond to the visual positions of the x-axis labels
        // IMPORTANT: These must match the static SVG coordinates exactly
        const xPoints = [80, 200, 320, 440, 560, 680, 720];



        // Build SVG paths with perfect alignment using validated data
        let currentLine = '';
        let baselineLine = '';
        let industryBenchmarkLine = '';
        let optimizedLine = '';
        for (let i = 0; i < xPoints.length; i++) {
            if (i === 0) {
                currentLine = `M${xPoints[i]},${validatedCurrent[i]}`;
                baselineLine = `M${xPoints[i]},${validatedBaseline[i]}`;
                industryBenchmarkLine = `M${xPoints[i]},${validatedIndustryBenchmark[i]}`;
                optimizedLine = `M${xPoints[i]},${validatedIndustryBenchmark[i]}`;
            } else {
                currentLine += ` L${xPoints[i]},${validatedCurrent[i]}`;
                baselineLine += ` L${xPoints[i]},${validatedBaseline[i]}`;
                industryBenchmarkLine += ` L${xPoints[i]},${validatedIndustryBenchmark[i]}`;
                optimizedLine += ` L${xPoints[i]},${validatedIndustryBenchmark[i]}`;
            }
        }
        
        // Update the SVG paths with proper stroke widths
        const svg = chartContainer.querySelector('.chart-svg');
        if (svg) {
            svg.setAttribute('viewBox', '0 0 800 200');
            const paths = svg.querySelectorAll('path');
            if (paths.length >= 4) {
                paths[0].setAttribute('d', baselineLine);
                paths[0].setAttribute('stroke-width', '2');
                paths[1].setAttribute('d', currentLine);
                paths[1].setAttribute('stroke-width', '3');
                paths[2].setAttribute('d', industryBenchmarkLine);
                paths[2].setAttribute('stroke-width', '2');
                paths[2].setAttribute('stroke-dasharray', '3,3');
                paths[3].setAttribute('d', optimizedLine);
                paths[3].setAttribute('stroke-width', '3');
                paths[3].setAttribute('stroke-dasharray', '5,5');
            }
        }
        
        // Initialize modern hover system
        if (svg) {
            // Don't try to update AI insight indicator here - let the global system handle it
            // The global addAIInsightIndicator function will create/update it correctly
            
            addChartHoverListeners();
        } else {
            console.error('SVG container not found!');
        }

        // Update legend values
        const legendCurrent = document.getElementById('legend-current-value');
        const legendBaseline = document.getElementById('legend-baseline-value');
        const legendIndustryBenchmark = document.getElementById('legend-industry-benchmark-value');

        if (legendCurrent && legendBaseline && legendIndustryBenchmark) {
            // Convert Y back to percent for display
            const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
            
            const lastIndex = validatedCurrent.length - 1;
            const currentValue = yToPercent(validatedCurrent[lastIndex]);
            const baselineValue = yToPercent(validatedBaseline[lastIndex]);
            const industryBenchmarkValue = yToPercent(validatedIndustryBenchmark[lastIndex]);

            

            
            legendCurrent.textContent = currentValue;
            legendBaseline.textContent = baselineValue;
            legendIndustryBenchmark.textContent = industryBenchmarkValue;

        }
        
        // Reinitialize hover listeners after main chart update
        setTimeout(() => {
            addChartHoverListeners();
            
            // Remove test tooltip creation
            
            // Test metric card hover detection
            const metricCards = document.querySelectorAll('.metric-card');
            
            metricCards.forEach((card, index) => {
                card.addEventListener('mouseenter', function() {
                    // Metric card hover detected
                    this.style.borderColor = 'red';
                });
                
                card.addEventListener('mouseleave', function() {
                    // Metric card hover leave detected
                    this.style.borderColor = '';
                });
            });
        }, 200);
    }
    
    // Function to add invisible data points for hover detection (for Accepted volume chart - no indicators)
    function addDataPointsForAcceptedVolume(svg, xPoints, chartData) {
        // Remove existing data points and indicators (but NOT the acceptance alert indicator)
        const existingPoints = svg.querySelectorAll('.data-point, .ai-insight-indicator');
        existingPoints.forEach(point => point.remove());
        
        // Find the July 17th data point index to skip it (red dot will handle this area)
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        let july17Index = 5; // Default to 5th data point (July 17th)
        if (dateLabels.length >= 7) {
            for (let i = 0; i < dateLabels.length; i++) {
                if (dateLabels[i].includes('Jul 17')) {
                    july17Index = i;
                    break;
                }
            }
        }
        
        // Add precise invisible hover areas at each data point position (except July 22nd)
        const numDataPoints = xPoints.length;
        for (let i = 0; i < numDataPoints; i++) {
            // Skip the July 17th data point - red dot will handle this area
            if (i === july17Index) {
                continue;
            }
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            const dataPointX = xPoints[i]; // Use exact x-coordinate from the array
            const hoverWidth = 60; // Comfortable hover area
            
            // Get the Y position of the current data point for the line
            const currentY = chartData.current[i];
            const buffer = 20; // Buffer around the line
            
            rect.setAttribute('x', dataPointX - (hoverWidth / 2));
            rect.setAttribute('y', Math.max(0, currentY - buffer));
            rect.setAttribute('width', hoverWidth.toString());
            rect.setAttribute('height', Math.min(200, buffer * 2));
            rect.setAttribute('fill', 'transparent');
            rect.setAttribute('stroke', 'none');
            rect.setAttribute('pointer-events', 'all');
            rect.classList.add('data-point');
            rect.dataset.index = i;
            
            // Simple, reliable event listeners
            rect.addEventListener('mouseenter', function(e) {
                e.stopPropagation();
                const rect = this.getBoundingClientRect();
                showSimpleTooltip(rect.left + rect.width / 2, rect.top + rect.height / 2, i, chartData);
            });
            
            rect.addEventListener('mouseleave', function(e) {
                e.stopPropagation();
                hideSimpleTooltip();
            });
            
            svg.appendChild(rect);
        }
        
        // Add hover areas along the chart lines for better interaction
        addLineHoverAreas(svg, xPoints, chartData);
    }
    
    // SIMPLE WORKING HOVER SYSTEM - Replace complex broken system
    function addLineHoverAreas(svg, xPoints, chartData) {
        console.log('Creating simple hover system for', xPoints.length, 'data points');
        
        // Remove any existing hover areas
        const existingHoverAreas = svg.querySelectorAll('.simple-hover-area');
        existingHoverAreas.forEach(area => area.remove());
        
        // Create a single hover area for the entire chart
        const chartRect = svg.getBoundingClientRect();
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        
        hoverArea.setAttribute('x', '0');
        hoverArea.setAttribute('y', '0');
        hoverArea.setAttribute('width', '100%');
        hoverArea.setAttribute('height', '100%');
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('pointer-events', 'all');
        hoverArea.classList.add('simple-hover-area');
        
        // Single mouse move handler for the entire chart
        hoverArea.addEventListener('mousemove', function(e) {
            const rect = svg.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Find the closest data point
            let closestIndex = 0;
            let closestDistance = Infinity;
            
            for (let i = 0; i < xPoints.length; i++) {
                const distance = Math.abs(mouseX - xPoints[i]);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = i;
                }
            }
            
            // Show tooltip if close enough to a data point
            if (closestDistance < 30) {
                showSimpleTooltip(e.clientX, e.clientY, closestIndex, chartData);
            } else {
                hideSimpleTooltip();
            }
        });
        
        hoverArea.addEventListener('mouseleave', function() {
            hideSimpleTooltip();
        });
        
        svg.appendChild(hoverArea);
        console.log('Simple hover system created');
    }
    
    // SIMPLE TOOLTIP SYSTEM - Replace complex broken tooltips
    function showSimpleTooltip(x, y, index, chartData) {
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        // Use hardcoded coordinates that match the SVG path exactly
        const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
        const exactBaselineY = [150, 130, 140, 120, 130, 110, 120];
        const exactIndustryBenchmarkY = [95, 80, 90, 70, 85, 65, 75];
        
        // Safety check for index bounds
        if (index < 0 || index >= exactCurrentY.length) {
            console.error('Invalid index for tooltip:', index);
            return;
        }
        
        const currentValue = yToPercent(exactCurrentY[index]);
        const baselineValue = yToPercent(exactBaselineY[index]);
        const optimizedValue = yToPercent(exactIndustryBenchmarkY[index]);
        
        const tooltipHTML = `
            <div style="padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <div style="font-weight: 600; font-size: 13px; color: #1A1F2E; margin-bottom: 8px;">
                    ${dateLabels[index]}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #533AFD; margin-right: 8px;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Current performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${currentValue}</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #E4E7EC; margin-right: 8px; border-top: 2px dashed #E4E7EC;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Baseline performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${baselineValue}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 12px; height: 3px; background: #22C55E; margin-right: 8px; border-top: 2px dashed #22C55E;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Industry benchmark:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${optimizedValue}</span>
                    </div>
                </div>
            </div>
        `;
        
        // Create or get tooltip element
        let tooltip = document.getElementById('simpleTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'simpleTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #E4E7EC;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: none;
                pointer-events: none;
            `;
            document.body.appendChild(tooltip);
        }
        
        // Position tooltip
        tooltip.style.left = (x + 20) + 'px';
        tooltip.style.top = (y - 60) + 'px';
        tooltip.style.display = 'block';
        tooltip.innerHTML = tooltipHTML;
        
        // Reinitialize lucide icons for the tooltip
        lucide.createIcons();
        
        console.log('Simple tooltip shown for index:', index, 'at position:', x, y);
    }
    
    // Function to enhance sparkle icons with animation
    function enhanceSparkleIcons() {
        const sparkleIcons = document.querySelectorAll('[data-lucide="sparkles"]');
        sparkleIcons.forEach(icon => {
            icon.style.width = '12px';
            icon.style.height = '12px';
            icon.style.animation = 'sparklePulse 2s ease-in-out infinite';
        });
    }
    
    function hideSimpleTooltip() {
        const tooltip = document.getElementById('simpleTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }
    
    // ========================================
    // MODERN HOVER SYSTEM INITIALIZATION
    // ========================================
    
    // Initialize simple hover system when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, initializing simple chart hover system...');
        
        // Wait a bit for all scripts to load
        setTimeout(() => {
            if (window.SimpleChartHover) {
                try {
                    window.simpleChartHover = new SimpleChartHover();
                    console.log('Simple chart hover system initialized successfully');
                } catch (error) {
                    console.error('Error initializing simple hover system:', error);
                }
            } else {
                console.warn('SimpleChartHover not found');
            }
        }, 300);
    });

    // Test function for simple hover system
    window.testSimpleHoverSystem = function() {
        console.log('Testing Simple Hover System...');
        
        if (window.simpleChartHover) {
            console.log('Hover system status:', {
                active: window.simpleChartHover.isActive,
                tooltip: !!window.simpleChartHover.tooltip
            });
            
            // Test hover areas
            const hoverAreas = document.querySelectorAll('.simple-hover-area');
            console.log('Hover areas found:', hoverAreas.length);
            
            if (hoverAreas.length > 0) {
                // Simulate hover on first area
                const firstArea = hoverAreas[0];
                const index = parseInt(firstArea.getAttribute('data-index'));
                console.log('Testing hover on area with index:', index);
                
                const mouseEvent = new MouseEvent('mouseenter', {
                    bubbles: true,
                    cancelable: true,
                    clientX: 100,
                    clientY: 100
                });
                
                firstArea.dispatchEvent(mouseEvent);
                
                // Hide after 3 seconds
                setTimeout(() => {
                    const leaveEvent = new MouseEvent('mouseleave', {
                        bubbles: true,
                        cancelable: true
                    });
                    firstArea.dispatchEvent(leaveEvent);
                }, 3000);
            }
        } else {
            console.error('Simple hover system not found!');
        }
    };
    
    // Test function specifically for acceptance page tooltips
    window.testAcceptanceTooltips = function() {
        console.log('Testing Acceptance Page Tooltips...');
        
        // Check if we're on the acceptance page
        const isOnAcceptanceTab = document.querySelector('.nav-tab.active')?.textContent?.includes('Acceptance');
        console.log('On acceptance tab:', isOnAcceptanceTab);
        
        // Check for chart SVG
        const chartSvg = document.querySelector('.chart-area .chart-svg');
        console.log('Chart SVG found:', !!chartSvg);
        
        if (chartSvg) {
            // Check for hover areas
            const hoverAreas = chartSvg.querySelectorAll('.simple-hover-area');
            console.log('Hover areas found:', hoverAreas.length);
            
            // Check for tooltip element
            const tooltip = document.getElementById('simpleTooltip');
            console.log('Tooltip element found:', !!tooltip);
            
            // Force reinitialize hover system
            addChartHoverListeners();
            
            // Test hover after a short delay
            setTimeout(() => {
                const newHoverAreas = chartSvg.querySelectorAll('.simple-hover-area');
                console.log('Hover areas after reinit:', newHoverAreas.length);
                
                if (newHoverAreas.length > 0) {
                    console.log('Testing hover on first area...');
                    const firstArea = newHoverAreas[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        bubbles: true,
                        cancelable: true,
                        clientX: 200,
                        clientY: 100
                    });
                    firstArea.dispatchEvent(mouseEvent);
                }
            }, 100);
        }
    };

    // Check simple hover system status
    window.checkSimpleHoverSystem = function() {
        console.log('=== Simple Hover System Status ===');
        
        if (window.simpleChartHover) {
            console.log('System active:', window.simpleChartHover.isActive);
            console.log('Tooltip exists:', !!window.simpleChartHover.tooltip);
            
            const hoverAreas = document.querySelectorAll('.simple-hover-area');
            console.log('Hover areas created:', hoverAreas.length);
            
            return {
                active: window.simpleChartHover.isActive,
                tooltip: !!window.simpleChartHover.tooltip,
                hoverAreas: hoverAreas.length
            };
        } else {
            console.error('Simple hover system not found');
            return null;
        }
    };

    // Function to add invisible data points for hover detection
    function addDataPoints(svg, xPoints, chartData) {
        // Determine chart type and conditions
        const isAcceptanceTab = document.querySelector('.tab-btn[data-tab="acceptance"].active');
        const selectedMetricCard = document.querySelector('.metric-card.selected .metric-label');
        const selectedMetricText = selectedMetricCard ? selectedMetricCard.textContent : '';
        const isAcceptedVolume = selectedMetricText === 'Accepted volume';
        const isAcceptedVolumeChart = isAcceptanceTab && isAcceptedVolume;
        
        // Remove existing data points and AI indicators
        // For Accepted volume chart, don't remove the acceptance alert indicator
        if (isAcceptedVolumeChart) {
            const existingPoints = svg.querySelectorAll('.data-point, .ai-insight-indicator');
            existingPoints.forEach(point => point.remove());
        } else {
            const existingPoints = svg.querySelectorAll('.data-point, .ai-insight-indicator, .acceptance-alert-indicator');
            existingPoints.forEach(point => point.remove());
        }
        
        // Find the data point with the highest rate of change
        const insightIndex = findHighestChangePoint(chartData);
        
        // Add precise invisible hover areas at each data point position
        const numDataPoints = xPoints.length;
        
        for (let i = 0; i < numDataPoints; i++) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            const dataPointX = xPoints[i];
            const hoverWidth = 60; // Same as Accepted volume chart
            const currentY = chartData.current[i];
            const buffer = 20; // Same as Accepted volume chart
            
            // Set rectangle properties
            rect.setAttribute('x', (dataPointX - (hoverWidth / 2)).toString());
            rect.setAttribute('y', Math.max(0, currentY - buffer).toString());
            rect.setAttribute('width', hoverWidth.toString());
            rect.setAttribute('height', Math.min(200, buffer * 2).toString());
            rect.setAttribute('fill', 'transparent'); // Make fully transparent
            rect.setAttribute('stroke', 'none');      // No border
            rect.setAttribute('pointer-events', 'all');
            rect.setAttribute('style', 'cursor: pointer;');
            
            rect.classList.add('data-point');
            rect.dataset.index = i;
            
            // Add direct event listeners like the accepted volume chart
            rect.addEventListener('mouseenter', function(e) {
                e.stopPropagation();
                const rect = this.getBoundingClientRect();
                showSimpleTooltip(rect.left + rect.width / 2, rect.top + rect.height / 2, i, chartData);
            });
            
            rect.addEventListener('mouseleave', function(e) {
                e.stopPropagation();
                hideSimpleTooltip();
            });
            
            svg.appendChild(rect);
            
            // For Accepted volume chart: don't add any indicators (they're added manually)
            // For Payment success rate chart: add AI insight indicator and red dots
            if (!isAcceptedVolumeChart || selectedMetricText === 'Payment success rate') {
                // Show purple star on insight point for non-Accepted volume charts or Payment success rate
                if (i === insightIndex) {
                    addAIInsightIndicator(svg, dataPointX, chartData, i);
                }
            }
        }
        
        // Add hover areas along the chart lines for better interaction (same as Accepted volume)
        addLineHoverAreas(svg, xPoints, chartData);
        
        // Only add blue dots for Payment success rate charts
        const isPaymentSuccessRateSelected = selectedMetricText === 'Payment success rate';
        const currentSelectedCard = document.querySelector('.metric-card.selected');
        const isPaymentSuccessRateCard = currentSelectedCard?.querySelector('.metric-label')?.textContent === 'Payment success rate';
        
        // Only add blue dots if Payment success rate is specifically selected
        if (isPaymentSuccessRateSelected && isPaymentSuccessRateCard) {
            // Remove any existing blue dots first
            const existingBlueDots = svg.querySelectorAll('.blue-dot-indicator');
            existingBlueDots.forEach(dot => dot.remove());
            
            // Use the exact SVG path coordinates for perfect alignment
            // SVG path Y coordinates: [120, 100, 110, 90, 100, 80, 90]
            const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
            
            // June 1st (index 3) - key insight point
            const june1X = xPoints[3];
            const june1Y = exactCurrentY[3]; // This should be 90
            addBlueDotIndicator(svg, june1X, june1Y, 3, 'payment-success-rate');
            
            // June 15th (index 4) - another key data point
            const june15X = xPoints[4];
            const june15Y = exactCurrentY[4]; // This should be 100
            addBlueDotIndicator(svg, june15X, june15Y, 4, 'payment-success-rate');
        } else {
            // Remove any existing blue dots if not on Payment success rate
            const existingBlueDots = svg.querySelectorAll('.blue-dot-indicator');
            existingBlueDots.forEach(dot => dot.remove());
        }
    }
    
    // Function to find the data point with the highest rate of change
    function findHighestChangePoint(chartData) {
        // Target June 1st data point (index 3) where we want the AI insight indicator
        return 3; // June 1st data point
    }
    
    // Function to add AI insight indicator
    function addAIInsightIndicator(svg, x, chartData, index) {
        // Validate inputs to prevent undefined values
        if (typeof x === 'undefined' || typeof chartData === 'undefined' || typeof index === 'undefined') {
            console.error('addAIInsightIndicator: Invalid parameters', { x, chartData, index });
            return;
        }
        
        // Get the exact y-coordinate from SVG path for perfect alignment
        const exactCurrentY = [120, 100, 110, 90, 100, 80, 90];
        const y = exactCurrentY[index];
        
        // Validate y coordinate
        if (typeof y === 'undefined' || isNaN(y)) {
            console.error('addAIInsightIndicator: Invalid y coordinate', { y, chartData, index });
            return;
        }
        
        // Create AI insight indicator group
        const aiIndicator = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        aiIndicator.setAttribute('class', 'ai-insight-indicator');
        aiIndicator.setAttribute('data-index', index);
        aiIndicator.style.cursor = 'pointer';

        // Create purple circle background (40% larger)
        const sparkle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        sparkle.setAttribute('cx', x);
        sparkle.setAttribute('cy', y);
        sparkle.setAttribute('r', '11.2'); // Increased from 8 to 11.2 (40% larger)
        sparkle.setAttribute('fill', '#533AFD');
        sparkle.setAttribute('stroke', 'white');
        sparkle.setAttribute('stroke-width', '2');
        sparkle.style.filter = 'drop-shadow(0 2px 4px rgba(83, 58, 253, 0.3))';

        // Create white star icon using SVG lines for clean design
        const starIcon = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        starIcon.setAttribute('transform', `translate(${x}, ${y})`);
        
        // Create main star using SVG lines
        const mainStar = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        
        // Create 4-pointed star using lines
        const starLines = [
            { x1: 0, y1: -3, x2: 0, y2: 3 },     // vertical line
            { x1: -3, y1: 0, x2: 3, y2: 0 },     // horizontal line
            { x1: -2, y1: -2, x2: 2, y2: 2 },    // diagonal line 1
            { x1: -2, y1: 2, x2: 2, y2: -2 }     // diagonal line 2
        ];
        
        starLines.forEach(line => {
            const lineElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            lineElement.setAttribute('x1', line.x1);
            lineElement.setAttribute('y1', line.y1);
            lineElement.setAttribute('x2', line.x2);
            lineElement.setAttribute('y2', line.y2);
            lineElement.setAttribute('stroke', 'white');
            lineElement.setAttribute('stroke-width', '2');
            lineElement.setAttribute('stroke-linecap', 'round');
            mainStar.appendChild(lineElement);
        });
        
        // Create small star in upper right using lines
        const smallStar = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        smallStar.setAttribute('transform', 'translate(5, -5)');
        
        const smallStarLines = [
            { x1: 0, y1: -1.5, x2: 0, y2: 1.5 },     // vertical line
            { x1: -1.5, y1: 0, x2: 1.5, y2: 0 },     // horizontal line
            { x1: -1, y1: -1, x2: 1, y2: 1 },        // diagonal line 1
            { x1: -1, y1: 1, x2: 1, y2: -1 }         // diagonal line 2
        ];
        
        smallStarLines.forEach(line => {
            const lineElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            lineElement.setAttribute('x1', line.x1);
            lineElement.setAttribute('y1', line.y1);
            lineElement.setAttribute('x2', line.x2);
            lineElement.setAttribute('y2', line.y2);
            lineElement.setAttribute('stroke', 'white');
            lineElement.setAttribute('stroke-width', '1.5');
            lineElement.setAttribute('stroke-linecap', 'round');
            smallStar.appendChild(lineElement);
        });
        
        starIcon.appendChild(mainStar);
        starIcon.appendChild(smallStar);

        aiIndicator.appendChild(sparkle);
        aiIndicator.appendChild(starIcon);

        // Add hover area for better interaction (also 40% larger)
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hoverArea.setAttribute('cx', x);
        hoverArea.setAttribute('cy', y);
        hoverArea.setAttribute('r', '28'); // Increased from 20 to 28 (40% larger)
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('stroke', 'none');

        aiIndicator.appendChild(hoverArea);
        
        // Add event listeners to the AI insight indicator
        aiIndicator.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            handleAIInsightHover(this);
        });
        
        aiIndicator.addEventListener('mouseleave', function(e) {
            e.stopPropagation();
            hideAllTooltips();
        });
        
        // Add click handler to open AI assistant with contextual data
        aiIndicator.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Use cached selectors for better performance
            const businessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            const dateRange = document.getElementById('dateRangeDropdown')?.textContent?.trim() || 'Last 90 days';
            
            // Simplified contextual question for payment success rate
            const question = 'I see an interesting data point on Jun 1. Can you analyze this payment success rate and provide specific recommendations for optimization?';
            
            // Open AI panel immediately with minimal processing
            openAIPanel(question, businessType, 'success-rate-optimization', 85.2, dateRange, 0);
        });
        
        svg.appendChild(aiIndicator);
    }
    
    // Function to add red dot indicators to line charts
    function addRedDotIndicator(svg, x, y, index, chartType = 'accepted-volume') {
        console.log('Creating red dot indicator at coordinates:', x, y, 'for chart type:', chartType);
        
        // Remove any existing red dot indicators to prevent duplicates
        const existingIndicators = svg.querySelectorAll('.red-dot-indicator');
        if (existingIndicators.length > 0) {
            console.log(`Removing ${existingIndicators.length} existing red dot indicators`);
            existingIndicators.forEach(indicator => indicator.remove());
        }
        
        // Create a stable red dot indicator with best practices
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.classList.add('red-dot-indicator');
        group.dataset.index = index;
        group.dataset.chartType = chartType;
        group.style.pointerEvents = 'all';
        group.style.zIndex = '1000';
        
        // Create the red circle indicator with proper class
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', '7.5');
        circle.setAttribute('fill', '#EF4444');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('filter', 'drop-shadow(0 2px 4px rgba(239, 68, 68, 0.5))');
        circle.classList.add('red-dot');
        
        // Create a stable, invisible hover area
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hoverArea.setAttribute('cx', x);
        hoverArea.setAttribute('cy', y);
        hoverArea.setAttribute('r', '40'); // Larger hover area to prevent interference
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('stroke', 'transparent');
        hoverArea.classList.add('hover-area');
        
        // Add elements to group in proper order (hover area first for better interaction)
        group.appendChild(hoverArea);
        group.appendChild(circle);
        
        // Implement robust hover state management
        let isHovered = false;
        let tooltipVisible = false;
        let hideTimeout;
        
        // Mouse enter handler
        const handleMouseEnter = function(e) {
            e.stopPropagation();
            console.log('Red dot mouse enter - showing standard tooltip with AI insight note');
            isHovered = true;
            
            // Clear any pending hide timeout
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            // Show standard tooltip with AI insight note
            if (!tooltipVisible) {
                const rect = this.getBoundingClientRect();
                showRedDotTooltip(rect.left + rect.width / 2, rect.top + rect.height / 2, index, chartType);
                tooltipVisible = true;
            }
        };
        
        // Mouse leave handler
        const handleMouseLeave = function(e) {
            e.stopPropagation();
            isHovered = false;
            
            // Set a delay before hiding to allow moving to tooltip
            hideTimeout = setTimeout(() => {
                if (!isHovered) {
                    hideSimpleTooltip();
                    tooltipVisible = false;
                }
            }, 150);
        };
        
        // Add event listeners
        group.addEventListener('mouseenter', handleMouseEnter);
        group.addEventListener('mouseleave', handleMouseLeave);
        
        // Add click handler (using the exact same approach as the working test red dot)
        group.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Red dot clicked - opening AI panel');
            
            // Use cached selectors for better performance
            const businessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            const dateRange = document.getElementById('dateRangeDropdown')?.textContent?.trim() || 'Last 90 days';
            
            // Simplified question generation (same as working test red dot)
            const question = 'I noticed a significant change in my accepted volume on this date. What insights can you provide about this trend and how can I optimize my payment processing to maintain consistent volume growth?';
            
            // Open AI panel immediately with minimal processing
            openAIPanel(question, businessType, 'german-card-diagnosis', 85.2, dateRange, 0);
        });
        
        svg.appendChild(group);
        console.log('Red dot indicator added successfully at fixed position:', x, y);
        console.log('Red dot class:', group.classList.toString());
        console.log('Red dot chart type:', chartType);
        console.log('Red dot index:', index);
        
        // Test if the red dot is clickable
        setTimeout(() => {
            const redDot = svg.querySelector('.red-dot-indicator');
            if (redDot) {
                console.log(' Red dot indicator found in DOM');
                console.log('Red dot classes:', redDot.classList.toString());
                console.log('Red dot dataset:', redDot.dataset);
            } else {
                console.log(' Red dot indicator not found in DOM');
            }
        }, 100);
        
        // Check again after a longer delay to see if it gets removed
        setTimeout(() => {
            const redDot = svg.querySelector('.red-dot-indicator');
            if (redDot) {
                console.log(' Red dot indicator still exists after 500ms');
            } else {
                console.log(' Red dot indicator was removed within 500ms');
            }
        }, 500);
    }

    // Function to add acceptance alert indicator for July 17th (legacy function - keeping for compatibility)
    function addAcceptanceAlertIndicator(svg, x, y, index) {
        console.log('Creating acceptance alert indicator at coordinates:', x, y);
        
        // Remove any existing acceptance alert indicators to prevent duplicates
        const existingIndicators = svg.querySelectorAll('.acceptance-alert-indicator');
        existingIndicators.forEach(indicator => indicator.remove());
        
        // Store the position in a data attribute for consistency
        svg.dataset.redDotX = x;
        svg.dataset.redDotY = y;
        svg.dataset.redDotIndex = index;
        
        // Create a stable red dot indicator with best practices
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.classList.add('acceptance-alert-indicator');
        group.dataset.index = index;
        group.dataset.type = 'acceptance-alert';
        group.style.pointerEvents = 'all';
        group.style.zIndex = '1000';
        
        // Create the red circle indicator with proper class
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', '7.5');
        circle.setAttribute('fill', '#EF4444');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('filter', 'drop-shadow(0 2px 4px rgba(239, 68, 68, 0.5))');
        circle.classList.add('red-dot');
        
        // Create a stable, invisible hover area
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hoverArea.setAttribute('cx', x);
        hoverArea.setAttribute('cy', y);
        hoverArea.setAttribute('r', '40'); // Larger hover area to prevent interference
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('stroke', 'transparent');
        hoverArea.classList.add('hover-area');
        
        // Add elements to group in proper order (hover area first for better interaction)
        group.appendChild(hoverArea);
        group.appendChild(circle);
        
        // Implement robust hover state management
        let isHovered = false;
        let tooltipVisible = false;
        let hideTimeout;
        
        // Mouse enter handler
        const handleMouseEnter = function(e) {
            e.stopPropagation();
            console.log('Red dot mouse enter - showing AI insights tooltip');
            isHovered = true;
            
            // Clear any pending hide timeout
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            // Show tooltip immediately
            if (!tooltipVisible) {
                const rect = this.getBoundingClientRect();
                showAcceptanceAlertTooltip(rect.left + rect.width / 2, rect.top + rect.height / 2);
                tooltipVisible = true;
            }
        };
        
        // Mouse leave handler
        const handleMouseLeave = function(e) {
            e.stopPropagation();
            isHovered = false;
            
            // Set a delay before hiding to allow moving to tooltip
            hideTimeout = setTimeout(() => {
                if (!isHovered) {
                    hideAcceptanceAlertTooltip();
                    tooltipVisible = false;
                }
            }, 150);
        };
        
        // Add event listeners
        group.addEventListener('mouseenter', handleMouseEnter);
        group.addEventListener('mouseleave', handleMouseLeave);
        
        group.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Red dot clicked - opening AI panel');
            
            // Use cached selectors for better performance
            const businessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            const dateRange = document.getElementById('dateRangeDropdown')?.textContent?.trim() || 'Last 90 days';
            
            // Simplified question generation
            const question = 'I noticed a significant change in my accepted volume on July 17th. What insights can you provide about this trend and how can I optimize my payment processing to maintain consistent volume growth?';
            
            // Open AI panel immediately with minimal processing
            openAIPanel(question, businessType, 'german-card-diagnosis', 85.2, dateRange, 0);
        });
        
        svg.appendChild(group);
        console.log('Acceptance alert indicator added successfully at fixed position:', x, y);
        
        // Ensure the red dot stays in position even if chart is updated
        const ensureRedDotPosition = () => {
            const redDot = svg.querySelector('.acceptance-alert-indicator');
            if (redDot) {
                const circle = redDot.querySelector('.red-dot');
                const hoverArea = redDot.querySelector('.hover-area');
                if (circle && hoverArea) {
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    hoverArea.setAttribute('cx', x);
                    hoverArea.setAttribute('cy', y);
                }
            }
        };
        
        // Store the position function for later use
        svg._ensureRedDotPosition = ensureRedDotPosition;
    }
    
    // Function to add blue/purple dot indicators for Payment success rate charts
    function addBlueDotIndicator(svg, x, y, index, chartType = 'payment-success-rate') {
        console.log('Creating blue dot indicator at coordinates:', x, y, 'for chart type:', chartType);
        
        // Remove any existing blue dot indicators to prevent duplicates
        const existingIndicators = svg.querySelectorAll('.blue-dot-indicator');
        if (existingIndicators.length > 0) {
            console.log(`Removing ${existingIndicators.length} existing blue dot indicators`);
            existingIndicators.forEach(indicator => indicator.remove());
        }
        
        // Create a stable blue dot indicator with best practices
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.classList.add('blue-dot-indicator');
        group.dataset.index = index;
        group.dataset.chartType = chartType;
        group.style.pointerEvents = 'all';
        group.style.zIndex = '1000';
        
        // Create the blue/purple circle indicator with proper class
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', '7.5');
        circle.setAttribute('fill', '#533AFD'); // Blue/purple color instead of red
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        circle.setAttribute('filter', 'drop-shadow(0 2px 4px rgba(83, 58, 253, 0.5))'); // Blue/purple shadow
        circle.classList.add('blue-dot');
        
        // Create a stable, invisible hover area
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hoverArea.setAttribute('cx', x);
        hoverArea.setAttribute('cy', y);
        hoverArea.setAttribute('r', '40'); // Larger hover area to prevent interference
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('stroke', 'transparent');
        hoverArea.classList.add('hover-area');
        
        // Add elements to group in proper order (hover area first for better interaction)
        group.appendChild(hoverArea);
        group.appendChild(circle);
        
        // Implement robust hover state management
        let isHovered = false;
        let tooltipVisible = false;
        let hideTimeout;
        
        // Mouse enter handler
        const handleMouseEnter = function(e) {
            e.stopPropagation();
            console.log('Blue dot mouse enter - showing standard tooltip with AI insight note');
            isHovered = true;
            
            // Clear any pending hide timeout
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            // Show standard tooltip with AI insight note
            if (!tooltipVisible) {
                const rect = this.getBoundingClientRect();
                showBlueDotTooltip(rect.left + rect.width / 2, rect.top + rect.height / 2, index, chartType);
                tooltipVisible = true;
            }
        };
        
        // Mouse leave handler
        const handleMouseLeave = function(e) {
            e.stopPropagation();
            isHovered = false;
            
            // Set a delay before hiding to allow moving to tooltip
            hideTimeout = setTimeout(() => {
                if (!isHovered) {
                    hideSimpleTooltip();
                    tooltipVisible = false;
                }
            }, 150);
        };
        
        // Add event listeners
        group.addEventListener('mouseenter', handleMouseEnter);
        group.addEventListener('mouseleave', handleMouseLeave);
        
        // Add click handler for Payment success rate insights
        group.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Blue dot clicked - opening AI panel for payment success rate');
            
            // Use cached selectors for better performance
            const businessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            const dateRange = document.getElementById('dateRangeDropdown')?.textContent?.trim() || 'Last 90 days';
            
            // Question specific to payment success rate
            const question = 'I noticed a significant change in my payment success rate on this date. What insights can you provide about this trend and how can I optimize my payment processing to improve success rates?';
            
            // Open AI panel immediately with minimal processing
            openAIPanel(question, businessType, 'success-rate-optimization', 78.45, dateRange, 0);
        });
        
        svg.appendChild(group);
        console.log('Blue dot indicator added successfully at position:', x, y);
    }
    
    // Function to navigate to optimization tab
    function navigateToOptimizationTab() {
        console.log('Navigating to optimization tab');
        // Find the optimization tab button
        const optimizationTab = document.querySelector('.nav-tab[onclick*="optimization"]');
        if (optimizationTab) {
            optimizationTab.click();
        } else {
            // Fallback: try to find the tab by text content
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes('optimization')) {
                    tab.click();
                }
            });
        }
    }

    // Function to show red dot tooltip with standard format and AI insight note
    function showRedDotTooltip(x, y, index, chartType) {
        console.log('showRedDotTooltip called with:', x, y, index, chartType);
        
        // Get chart data for the current chart
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        const dateLabels = getDateLabels(currentDateRange);
        
        // Generate chart data based on chart type
        let chartData;
        if (chartType === 'accepted-volume') {
            const generator = new RealisticDataGenerator(
                document.querySelector('.business-type-tab.active')?.dataset.type || 'medium',
                currentDateRange
            );
            const volumeData = generator.generateTimeSeriesData(85, 0.15, 0.03);
            const previousVolumeData = volumeData.map(v => v * 0.92);
            const optimizedVolumeData = volumeData.map(v => v * 1.18);
            
            chartData = {
                current: volumeData.map(v => 200 - (v * 2)),
                baseline: previousVolumeData.map(v => 200 - (v * 2)),
                optimized: optimizedVolumeData.map(v => 200 - (v * 2))
            };
        } else if (chartType === 'payment-success-rate') {
            const generator = new RealisticDataGenerator(
                document.querySelector('.business-type-tab.active')?.dataset.type || 'medium',
                currentDateRange
            );
            const successData = generator.generateTimeSeriesData(85, 0.08, 0.02);
            const previousSuccessData = successData.map(v => v * 0.95);
            const optimizedSuccessData = successData.map(v => v * 1.12);
            
            chartData = {
                current: successData.map(v => 200 - (v * 2)),
                baseline: previousSuccessData.map(v => 200 - (v * 2)),
                optimized: optimizedSuccessData.map(v => 200 - (v * 2))
            };
        } else if (chartType === 'accepted-payments') {
            const generator = new RealisticDataGenerator(
                document.querySelector('.business-type-tab.active')?.dataset.type || 'medium',
                currentDateRange
            );
            const paymentsData = generator.generateTimeSeriesData(25, 0.25, 0.02);
            const previousPaymentsData = paymentsData.map(v => v * 0.85);
            const optimizedPaymentsData = paymentsData.map(v => v * 1.3);
            
            chartData = {
                current: paymentsData.map(v => 200 - (v * 4)),
                baseline: previousPaymentsData.map(v => 200 - (v * 4)),
                optimized: optimizedPaymentsData.map(v => 200 - (v * 4))
            };
        }
        
        if (!chartData) {
            console.error('Could not generate chart data for chart type:', chartType);
            return;
        }
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        const currentValue = yToPercent(chartData.current[index]);
        const baselineValue = yToPercent(chartData.baseline[index]);
        const optimizedValue = yToPercent(chartData.optimized[index]);
        
        // Create standard tooltip with AI insight note at bottom
        const tooltipHTML = `
            <div style="padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <div style="font-weight: 600; font-size: 13px; color: #1A1F2E; margin-bottom: 8px;">
                    ${dateLabels[index]}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #533AFD; margin-right: 8px;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Current performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${currentValue}</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #E4E7EC; margin-right: 8px; border-top: 2px dashed #E4E7EC;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Baseline performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${baselineValue}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 12px; height: 3px; background: #22C55E; margin-right: 8px; border-top: 2px dashed #22C55E;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Industry benchmark:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${optimizedValue}</span>
                    </div>
                </div>
                <div style="border-top: 1px solid #E4E7EC; padding-top: 8px; margin-top: 8px;">
                    <div style="font-size: 11px; color: #533AFD; text-align: center; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <i data-lucide="sparkles" style="width: 10px; height: 10px; color: #533AFD;"></i>
                        AI insight available
                    </div>
                </div>
            </div>
        `;
        
        // Create or get tooltip element
        let tooltip = document.getElementById('simpleTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'simpleTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #E4E7EC;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: none;
                pointer-events: none;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            `;
            document.body.appendChild(tooltip);
        }
        
        tooltip.innerHTML = tooltipHTML;
        
        // Position tooltip
        tooltip.style.position = 'fixed';
        tooltip.style.display = 'block';
        tooltip.style.left = (x + 40) + 'px';
        tooltip.style.top = (y - 140) + 'px';
        tooltip.style.zIndex = '10000';
        
        // Reinitialize lucide icons for the tooltip
        lucide.createIcons();
    }
    
    // Function to show blue dot tooltip with standard format and AI insight note
    function showBlueDotTooltip(x, y, index, chartType) {
        console.log('showBlueDotTooltip called with:', x, y, index, chartType);
        
        // Get chart data for the current chart
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        const dateLabels = getDateLabels(currentDateRange);
        
        // Generate chart data based on chart type
        let chartData;
        if (chartType === 'payment-success-rate') {
            const generator = new RealisticDataGenerator(
                document.querySelector('.business-type-tab.active')?.dataset.type || 'medium',
                currentDateRange
            );
            const successData = generator.generateTimeSeriesData(85, 0.08, 0.02);
            const previousSuccessData = successData.map(v => v * 0.95);
            const optimizedSuccessData = successData.map(v => v * 1.12);
            
            chartData = {
                current: successData.map(v => 200 - (v * 2)),
                baseline: previousSuccessData.map(v => 200 - (v * 2)),
                optimized: optimizedSuccessData.map(v => 200 - (v * 2))
            };
        }
        
        if (!chartData) {
            console.error('Could not generate chart data for chart type:', chartType);
            return;
        }
        
        // Convert Y coordinates back to percentages
        const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
        
        const currentValue = yToPercent(chartData.current[index]);
        const baselineValue = yToPercent(chartData.baseline[index]);
        const optimizedValue = yToPercent(chartData.optimized[index]);
        
        // Create standard tooltip with AI insight note at bottom
        const tooltipHTML = `
            <div style="padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <div style="font-weight: 600; font-size: 13px; color: #1A1F2E; margin-bottom: 8px;">
                    ${dateLabels[index]}
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #533AFD; margin-right: 8px;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Current performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${currentValue}</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 12px; height: 3px; background: #E4E7EC; margin-right: 8px; border-top: 2px dashed #E4E7EC;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Baseline performance:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${baselineValue}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 12px; height: 3px; background: #22C55E; margin-right: 8px; border-top: 2px dashed #22C55E;"></div>
                        <span style="font-size: 12px; color: #6C7689;">Industry benchmark:</span>
                        <span style="font-size: 12px; font-weight: 600; color: #1A1F2E; margin-left: auto;">${optimizedValue}</span>
                    </div>
                </div>
                <div style="border-top: 1px solid #E4E7EC; padding-top: 8px; margin-top: 8px;">
                    <div style="font-size: 11px; color: #533AFD; text-align: center; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <i data-lucide="sparkles" style="width: 10px; height: 10px; color: #533AFD;"></i>
                        AI insight available
                    </div>
                </div>
            </div>
        `;
        
        // Create or get tooltip element
        let tooltip = document.getElementById('simpleTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'simpleTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #E4E7EC;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                display: none;
                pointer-events: none;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            `;
            document.body.appendChild(tooltip);
        }
        
        tooltip.innerHTML = tooltipHTML;
        
        // Position tooltip
        tooltip.style.position = 'fixed';
        tooltip.style.display = 'block';
        tooltip.style.left = (x + 40) + 'px';
        tooltip.style.top = (y - 140) + 'px';
        tooltip.style.zIndex = '10000';
        
        // Reinitialize lucide icons for the tooltip
        lucide.createIcons();
    }
    
    // Function to show acceptance alert tooltip - Best Practices Implementation
    function showAcceptanceAlertTooltip(x, y) {
        console.log('showAcceptanceAlertTooltip called with:', x, y);
        // Hide any existing tooltips to prevent conflicts
        hideAllTooltips();
        
        const tooltip = document.getElementById('acceptanceAlertTooltip');
        const tooltipHeader = document.getElementById('acceptanceTooltipHeader');
        const tooltipData = document.getElementById('acceptanceTooltipData');
        
        if (tooltip && tooltipHeader && tooltipData) {
            // Update tooltip content to show "View AI insights"
            tooltipHeader.textContent = 'AI Insights Available';
            
            const tooltipHTML = `
                <div class="tooltip-data-section" style="margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #1A1F2E; line-height: 1.4; margin-bottom: 8px;">
                        <i data-lucide="sparkles" style="width: 14px; height: 14px; display: inline-block; margin-right: 6px; color: #533AFD;"></i>
                        <strong>View AI insights</strong> for this data point
                    </div>
                    <div style="font-size: 12px; color: #6C7689; font-style: italic;">
                        Click to get personalized recommendations and analysis
                    </div>
                </div>
            `;
            
            tooltipData.innerHTML = tooltipHTML;
            
                                // Position tooltip using best practices - simple and reliable
                    tooltip.style.position = 'fixed';
                    tooltip.style.display = 'block';
                    tooltip.style.left = (x + 40) + 'px';
                    tooltip.style.top = (y - 140) + 'px';
                    tooltip.style.zIndex = '10000';
                    
                    // Add a subtle animation
                    tooltip.style.animation = 'tooltipPulse 0.3s ease-out';
                    
                    // Reinitialize lucide icons for the tooltip
                    lucide.createIcons();
                    
                    // Add simple hover events to the tooltip
                    initializeSimpleTooltipHover(tooltip);
        } else {
            console.error('Acceptance alert tooltip elements not found');
        }
    }
    
    // Simple tooltip hover function - Best Practices
    function initializeSimpleTooltipHover(tooltip) {
        // Remove any existing listeners
        tooltip.removeEventListener('mouseenter', tooltip._keepVisible);
        tooltip.removeEventListener('mouseleave', tooltip._hideOnLeave);
        
        // Keep tooltip visible when hovering over it
        tooltip._keepVisible = function(e) {
            e.stopPropagation();
        };
        
        // Hide tooltip when leaving
        tooltip._hideOnLeave = function(e) {
            e.stopPropagation();
            setTimeout(() => {
                hideAcceptanceAlertTooltip();
            }, 100);
        };
        
        // Add listeners
        tooltip.addEventListener('mouseenter', tooltip._keepVisible);
        tooltip.addEventListener('mouseleave', tooltip._hideOnLeave);
    }
    
    // Removed complex hover bridge - using simpler approach
    
    // Helper function to hide all tooltips
    function hideAllTooltips() {
        const regularTooltip = document.getElementById('chartTooltip');
        if (regularTooltip) {
            regularTooltip.style.display = 'none';
        }
        
        const changesPopup = document.getElementById('changesPopup');
        if (changesPopup) {
            changesPopup.style.display = 'none';
        }
        
        const allTooltips = document.querySelectorAll('[id*="tooltip"]');
        allTooltips.forEach(tooltip => {
            if (tooltip.id !== 'acceptanceAlertTooltip') {
                tooltip.style.display = 'none';
            }
        });
    }

    // Function to hide acceptance alert tooltip
    function hideAcceptanceAlertTooltip() {
        const tooltip = document.getElementById('acceptanceAlertTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }
    


    // Global function to test tooltip system
    window.testTooltip = function() {
        console.log('Testing tooltip system...');
        const testTooltip = document.createElement('div');
        testTooltip.id = 'testTooltip';
        testTooltip.style.cssText = `
            position: fixed;
            top: 100px;
            left: 100px;
            background: white;
            border: 1px solid #E4E7EC;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
        `;
        testTooltip.innerHTML = '<strong>Test Tooltip</strong><br>If you see this, tooltips are working!';
        document.body.appendChild(testTooltip);
        
        setTimeout(() => {
            if (testTooltip.parentNode) {
                testTooltip.remove();
            }
        }, 3000);
        
        console.log('Test tooltip created');
    };
    
    // Metric card interaction functionality
    document.addEventListener('DOMContentLoaded', function() {
        const metricCards = document.querySelectorAll('.metric-card');
        const chartContainer = document.querySelector('.chart-container');
        const metricsTitle = document.querySelector('.metrics-title');
        
        // Store original chart content
        const originalChartContent = chartContainer.innerHTML;
        const originalTitle = metricsTitle.textContent;
        
        // Flag to track when Accepted volume chart is active
        let isAcceptedVolumeChartActive = false;
        
        metricCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected state from all cards
                metricCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected state to clicked card
                this.classList.add('selected');
                
                // Get the metric label
                const metricLabel = this.querySelector('.metric-label').textContent;
                
                // Update the title
                metricsTitle.textContent = `Key metrics for ${metricLabel.toLowerCase()}`;
                
                // Create different chart content based on the metric
                if (metricLabel === 'Accepted volume') {
                    isAcceptedVolumeChartActive = true;
                    console.log('Accepted volume chart is now active');
                    
                    // Remove any existing blue dots since this is not a Payment success rate chart
                    const chartSvg = document.querySelector('.chart-area .chart-svg');
                    if (chartSvg) {
                        const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                        existingBlueDots.forEach(dot => dot.remove());
                    }
                    
                    // Use the same date range as the main filter
                    const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    const dateLabels = getDateLabels(currentDateRange);
                    console.log('Creating Accepted volume chart with dates:', dateLabels);
                    
                    // Generate realistic volume data first to get the correct number of data points
                    const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
                    const volumeData = generator.generateTimeSeriesData(50, 0.2, 0.05);
                    const previousVolumeData = volumeData.map(v => v * 0.8);
                    const optimizedVolumeData = volumeData.map(v => v * 1.25); // Industry benchmark
                    
                    // Ensure we have valid data
                    console.log('Raw volume data:', volumeData);
                    if (!volumeData || volumeData.length === 0 || volumeData.some(v => isNaN(v) || v < 0)) {
                        console.error('Invalid volume data generated, using fallback');
                        // Fallback data
                        const fallbackData = [45, 48, 52, 49, 55, 51, 47, 43];
                        volumeData.splice(0, volumeData.length, ...fallbackData);
                        previousVolumeData.splice(0, previousVolumeData.length, ...fallbackData.map(v => v * 0.8));
                        optimizedVolumeData.splice(0, optimizedVolumeData.length, ...fallbackData.map(v => v * 1.25));
                    }
                    
                    // Calculate x-coordinates based on the number of data points
                    const numDataPoints = volumeData.length;
                    const svgWidth = 800;
                    const xPoints = [];
                    for (let i = 0; i < numDataPoints; i++) {
                        if (numDataPoints === 1) {
                            xPoints.push(400); // Center point if only one data point
                        } else {
                            xPoints.push(80 + (i * (svgWidth - 160) / (numDataPoints - 1)));
                        }
                    }
                    
                    // Convert to Y coordinates (scale to fit the 200px height)
                    const maxValue = Math.max(...volumeData, ...previousVolumeData, ...optimizedVolumeData);
                    const scale = 180 / maxValue; // Leave 20px margin
                    const currentY = volumeData.map(v => 200 - (v * scale));
                    const previousY = previousVolumeData.map(v => 200 - (v * scale));
                    const optimizedY = optimizedVolumeData.map(v => 200 - (v * scale));
                    
                    // Find the July 22nd data point index (typically around index 5 in a 7-point series)
                    let july22Index = 5; // Default to 5th data point
                    if (dateLabels.length >= 7) {
                        // Look specifically for July 22nd in the date labels
                        for (let i = 0; i < dateLabels.length; i++) {
                            if (dateLabels[i].includes('Jul 22')) {
                                july22Index = i;
                                break;
                            }
                        }
                    }
                    
                    // Introduce a visible drop on the July 22nd data point for the acceptance alert demo
                    if (currentY.length > july22Index) {
                        const previousValue = currentY[Math.max(0, july22Index - 1)];
                        // Create a more visible drop (about 15-20% to make it obvious)
                        const dropAmount = previousValue * 0.18;
                        currentY[july22Index] = previousValue - dropAmount;
                        console.log('Created drop on July 22nd at index:', july22Index, 'with drop amount:', dropAmount);
                    }
                    
                    // Debug logging
                    console.log('Volume data:', volumeData);
                    console.log('X points:', xPoints);
                    console.log('Current Y:', currentY);
                    console.log('Previous Y:', previousY);
                    console.log('Optimized Y:', optimizedY);
                    
                    // Build SVG paths
                    let currentLine = '';
                    let previousLine = '';
                    let optimizedLine = '';
                    for (let i = 0; i < xPoints.length; i++) {
                        if (i === 0) {
                            currentLine = `M${xPoints[i]},${currentY[i]}`;
                            previousLine = `M${xPoints[i]},${previousY[i]}`;
                            optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
                        } else {
                            currentLine += ` L${xPoints[i]},${currentY[i]}`;
                            previousLine += ` L${xPoints[i]},${previousY[i]}`;
                            optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
                        }
                    }
                    
                    console.log('Current line path:', currentLine);
                    console.log('Previous line path:', previousLine);
                    console.log('Optimized line path:', optimizedLine);
                    
                    chartContainer.innerHTML = `
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>$60</span>
                                <span>$50</span>
                                <span>$40</span>
                                <span>$30</span>
                                <span>$20</span>
                                <span>$10</span>
                                <span>$0</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200" style="width: 100%; height: 100%;">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- Industry benchmark line (green) -->
                                        <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    ${dateLabels.map(label => `<span>${label}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color optimized"></div>
                                    <span>Industry benchmark</span>
                                </div>
                            </div>
                            <span class="update-status">Updated yesterday</span>
                        </div>
                    `;
                    
                    // Add the red dot indicator for the acceptance alert
                    setTimeout(() => {
                        const svg = chartContainer.querySelector('svg');
                        if (svg) {
                            console.log('Adding red dot indicator to Accepted volume chart');
                            console.log('Last X coordinate:', xPoints[xPoints.length - 1]);
                            console.log('Last Y coordinate:', currentY[currentY.length - 1]);
                            console.log('All X points:', xPoints);
                            console.log('All current Y points:', currentY);
                            
                            // Add hover areas for all data points (but don't add indicators since we already added the red dot)
                            addDataPointsForAcceptedVolume(svg, xPoints, {
                                current: currentY,
                                baseline: previousY,
                                optimized: optimizedY
                            });
                            
                            // Add hover event listeners
                            addChartHoverListeners();
                            
                            // Add red dots AFTER all hover areas to ensure they're on top and clickable
                            // July 17th (index 5) - significant volume change
                            const july17Index = 5;
                            const july17X = xPoints[july17Index];
                            const july17Y = currentY[july17Index];
                            addRedDotIndicator(svg, july17X, july17Y, july17Index, 'accepted-volume');
                            
                            // June 15th (index 4) - another key data point
                            const june15Index = 4;
                            const june15X = xPoints[june15Index];
                            const june15Y = currentY[june15Index];
                            addRedDotIndicator(svg, june15X, june15Y, june15Index, 'accepted-volume');
                            
                            // Verify the red dots were added after hover areas
                            setTimeout(() => {
                                const redDots = svg.querySelectorAll('.red-dot-indicator');
                                if (redDots.length > 0) {
                                    console.log(` ${redDots.length} red dot(s) successfully added after hover areas!`);
                                    redDots.forEach((dot, index) => {
                                        console.log(`Red dot ${index + 1} position:`, dot.querySelector('.red-dot')?.getAttribute('cx'), dot.querySelector('.red-dot')?.getAttribute('cy'));
                                    });
                                } else {
                                    console.log(' Red dots not found after addition');
                                }
                            }, 50);
                        } else {
                            console.error('SVG element not found in chart container');
                        }
                    }, 100);
                    

                } else if (metricLabel === 'Accepted payments') {
                    // Remove any existing blue dots since this is not a Payment success rate chart
                    const chartSvg = document.querySelector('.chart-area .chart-svg');
                    if (chartSvg) {
                        const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                        existingBlueDots.forEach(dot => dot.remove());
                    }
                    
                    // Use the same date range as the main filter
                    const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                    const dateLabels = getDateLabels(currentDateRange);
                    console.log('Creating Accepted payments chart with dates:', dateLabels);
                    
                    // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
                    const xPoints = [80, 200, 320, 440, 560, 680, 720];
                    
                    // Generate realistic payment count data
                    const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
                    const paymentsData = generator.generateTimeSeriesData(25, 0.25, 0.02);
                    const previousPaymentsData = paymentsData.map(v => v * 0.85);
                    const optimizedPaymentsData = paymentsData.map(v => v * 1.3); // Industry benchmark
                    
                    // Convert to Y coordinates
                    const currentY = paymentsData.map(v => 200 - (v * 4));
                    const previousY = previousPaymentsData.map(v => 200 - (v * 4));
                    const optimizedY = optimizedPaymentsData.map(v => 200 - (v * 4));
                    
                    // Build SVG paths
                    let currentLine = '';
                    let previousLine = '';
                    let optimizedLine = '';
                    for (let i = 0; i < xPoints.length; i++) {
                        if (i === 0) {
                            currentLine = `M${xPoints[i]},${currentY[i]}`;
                            previousLine = `M${xPoints[i]},${previousY[i]}`;
                            optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
                        } else {
                            currentLine += ` L${xPoints[i]},${currentY[i]}`;
                            previousLine += ` L${xPoints[i]},${previousY[i]}`;
                            optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
                        }
                    }
                    
                    chartContainer.innerHTML = `
                        <div class="chart-content">
                            <div class="chart-y-axis">
                                <span>60</span>
                                <span>50</span>
                                <span>40</span>
                                <span>30</span>
                                <span>20</span>
                                <span>10</span>
                                <span>0</span>
                            </div>
                            <div class="chart-area">
                                <div class="chart-grid"></div>
                                <div class="chart-lines">
                                    <svg class="chart-svg" viewBox="0 0 800 200">
                                        <!-- Baseline performance line (gray) -->
                                        <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
                                        <!-- Current performance line (purple) -->
                                        <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
                                        <!-- Industry benchmark line (green) -->
                                        <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
                                    </svg>
                                </div>
                                <div class="chart-x-axis">
                                    ${dateLabels.map(label => `<span>${label}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color current"></div>
                                    <span>Current performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color previous"></div>
                                    <span>Baseline performance</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color optimized"></div>
                                    <span>Industry benchmark</span>
                                </div>
                            </div>
                            <span class="update-status">Updated yesterday</span>
                        </div>
                    `;
                    
                    // Add data points and hover areas first, then red dots
                    setTimeout(() => {
                        const svg = chartContainer.querySelector('svg');
                        if (svg) {
                            console.log('Adding hover areas to Accepted payments chart');
                            
                            // Add data points and hover areas
                            addDataPoints(svg, xPoints, {
                                current: currentY,
                                baseline: previousY,
                                optimized: optimizedY
                            });
                            
                            // Add hover event listeners
                            addChartHoverListeners();
                            
                            // Add red dots AFTER all hover areas to ensure they're on top and clickable
                            console.log('Adding red dot indicators to Accepted payments chart');
                            
                            // June 1st (index 3) - key data point
                            const june1Index = 3;
                            const june1X = xPoints[june1Index];
                            const june1Y = currentY[june1Index];
                            addRedDotIndicator(svg, june1X, june1Y, june1Index, 'accepted-payments');
                            
                            // June 15th (index 4) - another key data point
                            const june15Index = 4;
                            const june15X = xPoints[june15Index];
                            const june15Y = currentY[june15Index];
                            addRedDotIndicator(svg, june15X, june15Y, june15Index, 'accepted-payments');
                        } else {
                            console.error('SVG element not found in Accepted payments chart container');
                        }
                    }, 100);
                } else {
                    // Default chart (Payment success rate)
                    isAcceptedVolumeChartActive = false;
                    console.log('Accepted volume chart is no longer active');
                    
                    chartContainer.innerHTML = originalChartContent;
                    metricsTitle.textContent = originalTitle;
                    
                    // Update the chart with the current date range (only for default chart)
                    setTimeout(() => {
                        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
                        updateMainChart(currentDateRange);
                    }, 10);
                }
            });
        });
    });

    // Chart data for different metrics
    const chartData = {
        volume: {
            label: "Payment volume",
            total: "$642.57",
            yAxis: ["$240", "$180", "$120", "$60", "$0"],
            bars: [
                { credit: 120, debit: 100 },
                { credit: 140, debit: 120 },
                { credit: 100, debit: 80 },
                { credit: 60, debit: 40 },
                { credit: 80, debit: 60 },
                { credit: 120, debit: 100 },
                { credit: 140, debit: 120 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        payments: {
            label: "Payments",
            total: "49",
            yAxis: ["40", "30", "20", "10", "0"],
            bars: [
                { credit: 25, debit: 20 },
                { credit: 30, debit: 25 },
                { credit: 20, debit: 15 },
                { credit: 10, debit: 8 },
                { credit: 15, debit: 12 },
                { credit: 25, debit: 20 },
                { credit: 30, debit: 25 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        share: {
            label: "Share of payments",
            total: "100.00%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [
                { credit: 60, debit: 50 },
                { credit: 70, debit: 60 },
                { credit: 50, debit: 40 },
                { credit: 30, debit: 20 },
                { credit: 40, debit: 30 },
                { credit: 60, debit: 50 },
                { credit: 70, debit: 60 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        },
        success: {
            label: "Success rate",
            total: "63.27%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [
                { credit: 65, debit: 40 },
                { credit: 75, debit: 60 },
                { credit: 55, debit: 45 },
                { credit: 35, debit: 25 },
                { credit: 45, debit: 35 },
                { credit: 65, debit: 40 },
                { credit: 75, debit: 60 }
            ],
            table: [
                { type: 'Credit card', volume: '$239.13', payments: 43, share: '87.76%', success: '65.12%' },
                { type: 'Debit card', volume: '$402.94', payments: 5, share: '10.20%', success: '40.00%' },
                { type: 'Prepaid card', volume: '$0.50', payments: 1, share: '2.04%', success: '100.00%' }
            ]
        }
    };

    // Function to update chart
    function updateChart(metric) {
        const data = chartData[metric];
        
        // Check if data exists
        if (!data) {
            console.error('No data found for metric:', metric);
            return;
        }
        
        // Update labels and total
        const metricLabel = document.getElementById('metric-label');
        const metricValue = document.getElementById('metric-value');
        
        if (metricLabel) metricLabel.textContent = data.label;
        if (metricValue) metricValue.textContent = data.total;
        
        // Update Y-axis labels
        const yAxisLabels = document.querySelectorAll('.bar-chart-y-axis span');
        data.yAxis.forEach((label, index) => {
            if (yAxisLabels[index]) {
                yAxisLabels[index].textContent = label;
            }
        });
        
        // Update bar chart SVG
        const svg = document.querySelector('.bar-chart-svg');
        if (svg) {
            let bars = '';
            const barWidth = 20; // Wider bars for better visibility
            // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
            const xPoints = [80, 200, 320, 440, 560, 680, 720];
            const totalBars = data.bars.length;
            
            data.bars.forEach((barData, i) => {
                // Use exact x-coordinates for perfect alignment
                const x = xPoints[i];
                const creditY = 200 - barData.credit;
                const debitY = 200 - barData.debit;
                bars += `
                    <g class="bar-group" transform="translate(${x}, 0)">
                        <rect x="0" y="${creditY}" width="${barWidth}" height="${barData.credit}" fill="#3B82F6" opacity="0.8"/>
                        <rect x="${barWidth + 5}" y="${debitY}" width="${barWidth}" height="${barData.debit}" fill="#533AFD" opacity="0.8"/>
                    </g>
                `;
            });
            svg.innerHTML = bars;
            
            console.log('Bar chart updated with', totalBars, 'bars');
            
            // Add invisible hover areas for each bar
            addBarHoverAreas(svg, xPoints, data.bars);
            
            // Reset animations for the updated chart
            setTimeout(() => resetGraphAnimations(), 100);
        }
        
        // Update data table
        const tableBody = document.querySelector('.data-table tbody');
        if (tableBody && data.table && Array.isArray(data.table)) {
            let tableHTML = '';
            data.table.forEach(row => {
                tableHTML += `
                    <tr>
                        <td><input type="checkbox" checked></td>
                        <td>${row.type}</td>
                        <td>${row.volume}</td>
                        <td>${row.payments}</td>
                        <td>${row.share}</td>
                        <td>${row.success}</td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalVolume = data.table.reduce((sum, row) => sum + parseFloat(row.volume.replace('$', '') || 0), 0);
            const totalPayments = data.table.reduce((sum, row) => sum + parseInt(row.payments) || 0, 0);
            
            tableHTML += `
                <tr class="total-row">
                    <td></td>
                    <td style="font-weight: 700;">Total</td>
                    <td style="font-weight: 700;">$${totalVolume.toFixed(2)}</td>
                    <td style="font-weight: 700;">${totalPayments}</td>
                    <td style="font-weight: 700;">100.00%</td>
                    <td style="font-weight: 700;">${data.total}</td>
                </tr>
            `;
            
            tableBody.innerHTML = tableHTML;
        }
        
        // Reinitialize hover listeners after chart update
        setTimeout(() => {
            addChartHoverListeners();
        }, 100);
    }






            






    // Function to generate data based on date range and business type
    function generateDataForTimeframe(dateRange, businessType = 'medium') {
        try {
            // Check if RealisticDataGenerator is available
            if (typeof RealisticDataGenerator === 'undefined') {
                console.error('RealisticDataGenerator is not defined');
                throw new Error('RealisticDataGenerator not available');
            }
            
            const generator = new RealisticDataGenerator(businessType, dateRange);
            
            // Check if the generator has the required method
            if (typeof generator.generateAllData !== 'function') {
                console.error('generateAllData method not found on generator');
                throw new Error('generateAllData method not available');
            }
            
            const allData = generator.generateAllData();
            
            console.log('generateDataForTimeframe - allData:', allData);
            
            // Check if data is valid
            if (!allData || !allData.metrics || !allData.breakdownData) {
                console.error('Invalid data structure from DataGenerator:', allData);
                // Return fallback data
                return {
                    volume: {
                        label: "Payment volume",
                        total: "$0.00",
                        yAxis: ["$0", "$0", "$0", "$0", "$0"],
                        bars: [],
                        table: []
                    },
                    payments: {
                        label: "Payments",
                        total: "0",
                        yAxis: ["0", "0", "0", "0", "0"],
                        bars: [],
                        table: []
                    },
                    share: {
                        label: "Share of payments",
                        total: "100.00%",
                        yAxis: ["100%", "75%", "50%", "25%", "0%"],
                        bars: [],
                        table: []
                    },
                    success: {
                        label: "Success rate",
                        total: "0.00%",
                        yAxis: ["100%", "75%", "50%", "25%", "0%"],
                        bars: [],
                        table: []
                    }
                };
            }
            
            // Extract metrics safely
            const metrics = allData.metrics;
            const breakdownData = allData.breakdownData;
            
            // Calculate totals from breakdown data
            const totalVolume = metrics.volume || 0;
            const totalPayments = metrics.payments || 0;
            const successRate = metrics.successRate || 0;
            
            const data = {
                volume: {
                    label: "Payment volume",
                    total: formatUSD(totalVolume),
                    yAxis: generateYAxisLabels(totalVolume, '$'),
                    bars: [], // Simplified for now
                    table: [] // Simplified for now
                },
                payments: {
                    label: "Payments",
                    total: totalPayments.toString(),
                    yAxis: generateYAxisLabels(totalPayments, ''),
                    bars: [], // Simplified for now
                    table: [] // Simplified for now
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [], // Simplified for now
                    table: [] // Simplified for now
                },
                success: {
                    label: "Success rate",
                    total: `${successRate.toFixed(2)}%`,
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [], // Simplified for now
                    table: [] // Simplified for now
                }
            };

            return data;
        } catch (error) {
            console.error('Error in generateDataForTimeframe:', error);
            // Return fallback data on error
            return {
                volume: {
                    label: "Payment volume",
                    total: "$0.00",
                    yAxis: ["$0", "$0", "$0", "$0", "$0"],
                    bars: [],
                    table: []
                },
                payments: {
                    label: "Payments",
                    total: "0",
                    yAxis: ["0", "0", "0", "0", "0"],
                    bars: [],
                    table: []
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [],
                    table: []
                },
                success: {
                    label: "Success rate",
                    total: "0.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [],
                    table: []
                }
            };
        }
    }

    // Helper function to generate Y-axis labels
    function generateYAxisLabels(maxValue, prefix = '') {
        const max = Math.ceil(maxValue * 1.2);
        const step = max / 4;
        return [
            `${prefix}${max.toLocaleString()}`,
            `${prefix}${Math.round(max * 0.75).toLocaleString()}`,
            `${prefix}${Math.round(max * 0.5).toLocaleString()}`,
            `${prefix}${Math.round(max * 0.25).toLocaleString()}`,
            `${prefix}0`
        ];
    }

    // Function to update all chart x-axes based on selected date range
    function updateChartDateRanges(dateRange, businessType = 'medium') {
        console.log('updateChartDateRanges called with:', dateRange, 'business type:', businessType);
        
        try {
            const dateLabels = getDateLabels(dateRange);
            // Generate new data for the selected timeframe and business type
            const newChartData = generateDataForTimeframe(dateRange, businessType);
            
            // Check if data generation was successful
            if (!newChartData) {
                console.error('Failed to generate data for timeframe:', dateRange, businessType);
                return;
            }
            
            // Update the global chartData with new data
            if (typeof chartData === 'object' && chartData !== null) {
                Object.assign(chartData, newChartData);
            } else {
                console.warn('chartData is not properly initialized, creating new object');
                chartData = newChartData;
            }
        
        // Update main chart x-axis
        const mainChartXAxis = document.querySelector('.chart-x-axis');
        if (mainChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            mainChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                mainChartXAxis.appendChild(span);
            });
        }
        
        // Update bar chart x-axis
        const barChartXAxis = document.querySelector('.bar-chart-x-axis');
        if (barChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            barChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                barChartXAxis.appendChild(span);
            });
        }
        
        // Update failed chart x-axis
        const failedChartXAxis = document.querySelector('.breakdown-section:last-child .bar-chart-x-axis');
        if (failedChartXAxis) {
            // Clear existing spans and create new ones to match the data points
            failedChartXAxis.innerHTML = '';
            dateLabels.forEach(label => {
                const span = document.createElement('span');
                span.textContent = label;
                failedChartXAxis.appendChild(span);
            });
        }
        
        // Generate new failed payments data for the selected timeframe
        const newFailedData = generateFailedDataForTimeframe(dateRange, businessType);
        
        // Update the global failedChartData with new data
        Object.assign(failedChartData, newFailedData);
        
        // Update main metrics cards based on timeframe and business type
        updateMainMetrics(dateRange, businessType);
        
        // Always update main chart with new data (remove conditional logic)
        updateMainChart(dateRange, businessType);
        
        // Update the currently active metric chart
        const activeMetric = document.querySelector('.breakdown-filter-btn.active');
        if (activeMetric) {
            const metric = activeMetric.getAttribute('data-metric');
            updateChart(metric);
        }
        
        // Update metric card charts if they are currently displayed
        const selectedMetricCard = document.querySelector('.metric-card.selected');
        if (selectedMetricCard) {
            const metricLabel = selectedMetricCard.querySelector('.metric-label').textContent;
            if (metricLabel === 'Accepted volume' || metricLabel === 'Accepted payments') {
                // Force update the chart with new date range
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    // Recreate the chart content with new date labels
                    const dateLabels = getDateLabels(dateRange);
                    const xAxisSpans = chartContainer.querySelectorAll('.chart-x-axis span');
                    dateLabels.forEach((label, index) => {
                        if (xAxisSpans[index]) {
                            xAxisSpans[index].textContent = label;
                        }
                    });
                }
            }
        }
        
        // Update failed payments data too
        const activeFailedMetric = document.querySelector('.breakdown-section:last-child .breakdown-filter-btn.active');
        if (activeFailedMetric) {
            const failedMetric = activeFailedMetric.getAttribute('data-metric');
            updateFailedChart(failedMetric);
        }
        
        // Force update all overview page components
        const overviewView = document.getElementById('overview-view');
        if (overviewView && overviewView.style.display !== 'none') {
            console.log('Forcing overview page update for date range:', dateRange);
            updateOverviewPage(businessType, dateRange);
        }
        } catch (error) {
            console.error('Error in updateChartDateRanges:', error);
            // Don't throw the error to prevent "Something went wrong" messages
            // Just log it and continue with basic functionality
        }
    }

    // Function to update main metrics cards
    function updateMainMetrics(dateRange, businessType = 'medium') {
        try {
            const generator = new RealisticDataGenerator(businessType, dateRange);
            const allData = generator.generateAllData();
            
            // Check if data generation was successful
            if (!allData || !allData.metrics) {
                console.error('Failed to generate metrics data for:', dateRange, businessType);
                return;
            }
        
        // Update metric cards with realistic data
        const successRateCard = document.querySelector('.metric-card .metric-value');
        const volumeCard = document.querySelectorAll('.metric-card .metric-value')[1];
        const paymentsCard = document.querySelectorAll('.metric-card .metric-value')[2];

                    if (successRateCard) successRateCard.textContent = allData.metrics.successRate.toFixed(2) + '%';
            if (volumeCard) volumeCard.textContent = formatUSD(allData.metrics.volume);
        if (paymentsCard) paymentsCard.textContent = Math.round(allData.metrics.payments).toString();

        // Generate realistic change percentages based on business type and timeframe
        const changes = document.querySelectorAll('.metric-change');
        if (changes.length >= 3) {
            // Generate consistent changes based on business type and timeframe
            const businessMetrics = generator.getBusinessMetrics();
            const timeframeMultipliers = generator.getTimeframeMultipliers();
            
            // Success rate changes (smaller for larger businesses)
            const successChange = (businessType === 'startup' ? 3.2 : businessType === 'growth' ? 2.1 : businessType === 'scale' ? 1.4 : 0.9) + (Math.random() - 0.5) * 2;
            
            // Volume changes (larger for smaller businesses due to growth potential)
            const volumeChange = (businessType === 'startup' ? 35 : businessType === 'growth' ? 22 : businessType === 'scale' ? 15 : 8) + (Math.random() - 0.5) * 10;
            
            // Payment count changes
            const paymentsChange = (businessType === 'startup' ? 25 : businessType === 'growth' ? 18 : businessType === 'scale' ? 12 : 6) + (Math.random() - 0.5) * 6;

            changes[0].textContent = (successChange > 0 ? '+' : '') + successChange.toFixed(2) + '%';
            changes[1].textContent = (volumeChange > 0 ? '+' : '') + volumeChange.toFixed(2) + '%';
            changes[2].textContent = (paymentsChange > 0 ? '+' : '') + paymentsChange.toFixed(2) + '%';
        }
        } catch (error) {
            console.error('Error in updateMainMetrics:', error);
            // Don't throw the error to prevent "Something went wrong" messages
            // Just log it and continue with basic functionality
        }
    }



    // Function to generate date labels based on selected range
    function getDateLabels(dateRange) {
        const today = new Date();
        const labels = [];
        
        switch (dateRange) {
            case 'Last 7 days':
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 30 days':
                for (let i = 29; i >= 0; i -= 4) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 60 days':
                for (let i = 59; i >= 0; i -= 8) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Last 90 days':
                // Ensure we get exactly 7 data points for the default view
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (89 - i * 15));
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                console.log('Generated 90-day labels:', labels);
                break;
            case 'Last 6 months':
                for (let i = 179; i >= 0; i -= 25) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                break;
            case 'Aug 14 - Aug 20':
                labels.push('Aug 14', 'Aug 15', 'Aug 16', 'Aug 17', 'Aug 18', 'Aug 19', 'Aug 20');
                break;
            default:
                // Default to last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
        }
        
        return labels;
    }

    // Add click handlers to breakdown filter buttons
    document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('.breakdown-filter-btn');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons in the same section
                const section = this.closest('.breakdown-section');
                const sectionButtons = section.querySelectorAll('.breakdown-filter-btn');
                sectionButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update chart based on selected metric
                const metric = this.getAttribute('data-metric');
                if (metric.startsWith('failed-')) {
                    updateFailedChart(metric);
                } else {
                    updateChart(metric);
                }
            });
        });

        // Date Range Dropdown Functionality
        const dateRangeDropdown = document.getElementById('dateRangeDropdown');
        const dateRangeMenu = document.getElementById('dateRangeMenu');
        const dropdownItems = document.querySelectorAll('.dropdown-item');

        // Toggle dropdown
        dateRangeDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            dateRangeMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            dateRangeMenu.classList.remove('show');
        });

        // Handle dropdown item selection
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                console.log('Dropdown item clicked:', this.textContent);
                
                // Remove active class from all items
                dropdownItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                
                // Add active class to selected item
                this.classList.add('active');
                
                // Update dropdown trigger text
                dateRangeDropdown.textContent = this.textContent;
                dateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                dateRangeDropdown.querySelector('i').classList.add('filter-icon');
                
                console.log('About to call updateChartDateRanges with:', this.textContent);
                
                // Update charts with current business type
                updateChartDateRanges(this.textContent, currentBusinessType);
                
                // Update AI assistant prompts with new date range
                updateAssistantPrompts(currentBusinessType, this.textContent);
                
                // Update overview page if it's currently visible
                const overviewView = document.getElementById('overview-view');
                if (overviewView && overviewView.style.display !== 'none') {
                    updateOverviewPage(currentBusinessType, this.textContent);
                    
                    // Also update the overview dropdown to keep them in sync
                    const overviewDateRangeDropdown = document.getElementById('overviewDateRangeDropdown');
                    if (overviewDateRangeDropdown) {
                        overviewDateRangeDropdown.textContent = this.textContent;
                        overviewDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                        overviewDateRangeDropdown.querySelector('i').classList.add('filter-icon');
                    }
                }
                
                // Preserve the correct page title
                preservePageTitle();
                
                // Close dropdown
                dateRangeMenu.classList.remove('show');
                
                // Reinitialize lucide icons
                lucide.createIcons();
            });
        });

        // Initialize with default date range and business type
        updateChartDateRanges('Last 90 days', 'growth');
        
        // Initialize AI assistant prompts
        console.log('Initializing AI assistant prompts...');
        updateAssistantPrompts('medium', 'Last 90 days');
        

        
        // Fallback: Update prompts after a delay to ensure everything is loaded
        setTimeout(() => {
            console.log('Fallback: Updating AI assistant prompts...');
            updateAssistantPrompts('medium', 'Last 90 days');
        }, 1000);
        
        // Initialize chart tooltips
        initializeChartTooltips();
        lucide.createIcons();
        
        // Optimization Date Range Dropdown Functionality
        const optimizationDateRangeDropdown = document.getElementById('optimizationDateRangeDropdown');
        const optimizationDateRangeMenu = document.getElementById('optimizationDateRangeMenu');
        const optimizationDropdownItems = document.querySelectorAll('#optimizationDateRangeMenu .dropdown-item');

        // Toggle dropdown
        if (optimizationDateRangeDropdown) {
            optimizationDateRangeDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                optimizationDateRangeMenu.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            if (optimizationDateRangeMenu) {
                optimizationDateRangeMenu.classList.remove('show');
            }
        });

        // Handle dropdown item selection
        optimizationDropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                console.log('Optimization dropdown item clicked:', this.textContent);
                
                // Remove active class from all items
                optimizationDropdownItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                
                // Add active class to selected item
                this.classList.add('active');
                
                // Update dropdown trigger text
                optimizationDateRangeDropdown.textContent = this.textContent;
                optimizationDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                optimizationDateRangeDropdown.querySelector('i').classList.add('filter-icon');
                
                // Update optimization page with new date range
                if (currentBusinessType) {
                    updateOptimizationPage(currentBusinessType, this.textContent);
                }
                
                // Preserve the correct page title
                preservePageTitle();
                
                // Close dropdown
                optimizationDateRangeMenu.classList.remove('show');
                
                // Reinitialize lucide icons
                lucide.createIcons();
            });
        });
    });

    // Overview Date Range Dropdown Functionality
    function initializeOverviewDateRangeDropdown() {
        const overviewDateRangeDropdown = document.getElementById('overviewDateRangeDropdown');
        const overviewDateRangeMenu = document.getElementById('overviewDateRangeMenu');
        const overviewDropdownItems = document.querySelectorAll('#overviewDateRangeMenu .dropdown-item');

        if (overviewDateRangeDropdown && overviewDateRangeMenu) {
            // Toggle dropdown
            overviewDateRangeDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                overviewDateRangeMenu.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                if (overviewDateRangeMenu) {
                    overviewDateRangeMenu.classList.remove('show');
                }
            });

            // Handle dropdown item selection
            overviewDropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    console.log('Overview dropdown item clicked:', this.textContent);
                    
                    // Remove active class from all items
                    overviewDropdownItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                    
                    // Add active class to selected item
                    this.classList.add('active');
                    
                    // Update dropdown trigger text
                    overviewDateRangeDropdown.textContent = this.textContent;
                    overviewDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                    overviewDateRangeDropdown.querySelector('i').classList.add('filter-icon');
                    
                    // Update overview page with new date range
                    updateOverviewPage(currentBusinessType, this.textContent);
                    
                    // Also update the main date range dropdown to keep them in sync
                    const mainDateRangeDropdown = document.getElementById('dateRangeDropdown');
                    if (mainDateRangeDropdown) {
                        mainDateRangeDropdown.textContent = this.textContent;
                        mainDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
                        mainDateRangeDropdown.querySelector('i').classList.add('filter-icon');
                    }
                    
                    // Update main charts and metrics
                    updateChartDateRanges(this.textContent, currentBusinessType);
                    
                    // Close dropdown
                    overviewDateRangeMenu.classList.remove('show');
                    
                    // Reinitialize lucide icons
                    lucide.createIcons();
                });
            });
        }
    }

    // Failed card payments chart data (now includes bars and table)
    let failedChartData = {
        'failed-volume': {
            label: "Failed payment volume",
            total: "$609.54",
            yAxis: ["$200", "$150", "$100", "$50", "$0"],
            bars: [10, 30, 190, 10, 10, 150, 120],
            table: [
                { reason: 'Stripe', value: '$609.54', count: 18, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'failed-count': {
            label: "Failed",
            total: "18",
            yAxis: ["20", "15", "10", "5", "0"],
            bars: [2, 2, 12, 2, 2, 10, 8],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 18, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'share-failures': {
            label: "Share of failures",
            total: "100.00%",
            yAxis: ["100%", "75%", "50%", "25%", "0%"],
            bars: [100, 100, 100, 100, 100, 100, 100],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        },
        'failure-rate': {
            label: "Failure rate",
            total: "36.73%",
            yAxis: ["50%", "40%", "30%", "20%", "0%"],
            bars: [20, 25, 40, 10, 5, 35, 30],
            table: [
                { reason: 'Stripe', value: '$0.00', count: 0, share: '0.00%', rate: '36.73%' },
                { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
            ]
        }
    };

    // Function to generate failed payments data based on date range and business type
    function generateFailedDataForTimeframe(dateRange, businessType = 'medium') {
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const failedData = generator.generateFailedData();
        
        // Safety check: ensure failedData has the required properties
        if (!failedData || typeof failedData !== 'object') {
            console.error('generateFailedData returned invalid data:', failedData);
            // Return default data structure
            return {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$0.00",
                    yAxis: ["$0", "$0", "$0", "$0", "$0"],
                    bars: [0, 0, 0, 0, 0, 0, 0],
                    table: [
                        { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: '0.00%' },
                        { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                    ]
                },
                'failed-count': {
                    label: "Failed",
                    total: "0",
                    yAxis: ["0", "0", "0", "0", "0"],
                    bars: [0, 0, 0, 0, 0, 0, 0],
                    table: [
                        { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: '0.00%' },
                        { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                    ]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [100, 100, 100, 100, 100, 100, 100],
                    table: [
                        { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: '0.00%' },
                        { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                    ]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "0.00%",
                    yAxis: ["50%", "40%", "30%", "20%", "0%"],
                    bars: [0, 0, 0, 0, 0, 0, 0],
                    table: [
                        { reason: 'Stripe', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' },
                        { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                    ]
                }
            };
        }
        
        // Ensure all required properties exist with fallbacks
        const volume = failedData.volume || [0, 0, 0, 0, 0, 0, 0];
        const payments = failedData.payments || [0, 0, 0, 0, 0, 0, 0];
        const totalVolume = failedData.totalVolume || 0;
        const totalPayments = failedData.totalPayments || 0;
        const failureRate = failedData.failureRate || 0;
        
        const newFailedData = {
            'failed-volume': {
                label: "Failed payment volume",
                total: formatUSD(totalVolume),
                yAxis: generateYAxisLabels(totalVolume, '$'),
                bars: volume,
                table: [
                    { reason: 'Stripe', value: formatUSD(totalVolume), count: Math.round(totalPayments), share: '100.00%', rate: `${failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'failed-count': {
                label: "Failed",
                total: Math.round(totalPayments).toString(),
                yAxis: generateYAxisLabels(totalPayments, ''),
                bars: payments,
                table: [
                    { reason: 'Stripe', value: '$0.00', count: Math.round(totalPayments), share: '100.00%', rate: `${failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'share-failures': {
                label: "Share of failures",
                total: "100.00%",
                yAxis: ["100%", "75%", "50%", "25%", "0%"],
                bars: volume.map(() => 100), // All failures are Stripe
                table: [
                    { reason: 'Stripe', value: '$0.00', count: 0, share: '100.00%', rate: `${failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            },
            'failure-rate': {
                label: "Failure rate",
                total: `${failureRate.toFixed(2)}%`,
                yAxis: ["50%", "40%", "30%", "20%", "0%"],
                bars: volume.map(() => failureRate), // Consistent failure rate
                table: [
                    { reason: 'Stripe', value: '$0.00', count: 0, share: '0.00%', rate: `${failureRate.toFixed(2)}%` },
                    { reason: 'Bank', value: '$0.00', count: 0, share: '0.00%', rate: '0.00%' }
                ]
            }
        };

        return newFailedData;
    }

    // Function to update failed chart (now updates bars and table)
    function updateFailedChart(metric) {
        const data = failedChartData[metric];
        
        // Safety check: if data is undefined, use default data
        if (!data) {
            console.warn(`Failed chart data not found for metric: ${metric}, using default`);
            const defaultData = failedChartData['failed-volume'];
            if (!defaultData) {
                console.error('Default failed chart data not available');
                return;
            }
            // Update labels and total with default data
            const labelElement = document.getElementById('failed-metric-label');
            if (labelElement) labelElement.textContent = defaultData.label;
            const valueElement = document.getElementById('failed-metric-value');
            if (valueElement) valueElement.textContent = defaultData.total;
            return;
        }
        
        // Additional safety check for required properties
        if (!data.label || !data.total || !data.yAxis || !data.bars || !data.table) {
            console.error('Invalid chart data structure:', data);
            return;
        }
        
        // Update labels and total
        const labelElement = document.getElementById('failed-metric-label');
        if (labelElement) labelElement.textContent = data.label;
        document.getElementById('failed-metric-value').textContent = data.total;
        // Update Y-axis labels
        const yAxisLabels = document.querySelectorAll('.breakdown-section:last-child .bar-chart-y-axis span');
        data.yAxis.forEach((label, index) => {
            if (yAxisLabels[index]) {
                yAxisLabels[index].textContent = label;
            }
        });
        // Update bar chart SVG
        const svg = document.querySelector('.breakdown-section:last-child .bar-chart-svg');
        if (svg && data.bars && Array.isArray(data.bars)) {
            let bars = '';
            const barWidth = 25;
            // PERFECT ALIGNMENT: Use exact x-coordinates that match the x-axis label positions
            const xPoints = [80, 200, 320, 440, 560, 680, 720];
            const totalBars = data.bars.length;
            for (let i = 0; i < totalBars; i++) {
                const x = xPoints[i];
                const y = 200 - data.bars[i];
                bars += `<g class="bar-group" transform="translate(${x}, 0)"><rect x="0" y="${y}" width="${barWidth}" height="${data.bars[i]}" fill="#EF4444" opacity="0.8"/></g>`;
            }
            svg.innerHTML = bars;
            
            // Add invisible hover areas for failed chart
            addBarHoverAreas(svg, xPoints, data.bars);
            
            // Reset animations for the updated chart
            setTimeout(() => resetGraphAnimations(), 100);
        }
        // Update table
        const tableBody = document.querySelector('.breakdown-section:last-child .data-table tbody');
        if (tableBody && data.table && Array.isArray(data.table)) {
            tableBody.innerHTML = data.table.map(row => `
                <tr>
                    <td><div style="display: flex; align-items: center; gap: 8px;"><i data-lucide="check" style="width: 16px; height: 16px; color: var(--color-purple-500);"></i>${row.reason}</div></td>
                    <td>${row.value}</td>
                    <td>${row.count}</td>
                    <td>${row.share}</td>
                    <td>${row.rate}</td>
                </tr>
            `).join('') + `
                <tr class="total-row">
                    <td style="font-weight: 700;">Total</td>
                    <td style="font-weight: 700;">${data.total}</td>
                    <td style="font-weight: 700;">${data.total === '18' ? '18' : ''}</td>
                    <td style="font-weight: 700;">100.00%</td>
                    <td style="font-weight: 700;">36.73%</td>
                </tr>
            `;
            // Reinitialize lucide icons for the new check icons
            lucide.createIcons();
        }
    }

    // Data simulation functionality
    const businessData = {
        'startup': {
            metrics: {
                'Payment success rate': { value: '78.45%', change: '+2.15%' },
                'Accepted volume': { value: '$1,247.83', change: '+12.34%' },
                'Accepted payments': { value: '156', change: '+8.67%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$1,247.83",
                    yAxis: ["$600", "$450", "$300", "$150", "$0"],
                    bars: [
                        { credit: 180, debit: 140 },
                        { credit: 220, debit: 180 },
                        { credit: 160, debit: 120 },
                        { credit: 100, debit: 80 },
                        { credit: 140, debit: 100 },
                        { credit: 200, debit: 160 },
                        { credit: 240, debit: 200 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "156",
                    yAxis: ["80", "60", "40", "20", "0"],
                    bars: [
                        { credit: 45, debit: 35 },
                        { credit: 55, debit: 45 },
                        { credit: 40, debit: 30 },
                        { credit: 25, debit: 20 },
                        { credit: 35, debit: 25 },
                        { credit: 50, debit: 40 },
                        { credit: 60, debit: 50 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "78.45%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 80, debit: 60 },
                        { credit: 85, debit: 70 },
                        { credit: 75, debit: 65 },
                        { credit: 70, debit: 50 },
                        { credit: 78, debit: 65 },
                        { credit: 82, debit: 68 },
                        { credit: 88, debit: 75 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$341.17",
                    yAxis: ["$100", "$75", "$50", "$25", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "43",
                    yAxis: ["50", "40", "30", "20", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "21.55%",
                    yAxis: ["30%", "25%", "20%", "15%", "0%"]
                }
            }
        },
        'growth': {
            metrics: {
                'Payment success rate': { value: '85.23%', change: '+3.45%' },
                'Accepted volume': { value: '$12,847.56', change: '+18.67%' },
                'Accepted payments': { value: '1,247', change: '+15.23%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$12,847.56",
                    yAxis: ["$6,000", "$4,500", "$3,000", "$1,500", "$0"],
                    bars: [
                        { credit: 1800, debit: 1400 },
                        { credit: 2200, debit: 1800 },
                        { credit: 1600, debit: 1200 },
                        { credit: 1000, debit: 800 },
                        { credit: 1400, debit: 1000 },
                        { credit: 2000, debit: 1600 },
                        { credit: 2400, debit: 2000 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "1,247",
                    yAxis: ["800", "600", "400", "200", "0"],
                    bars: [
                        { credit: 450, debit: 350 },
                        { credit: 550, debit: 450 },
                        { credit: 400, debit: 300 },
                        { credit: 250, debit: 200 },
                        { credit: 350, debit: 250 },
                        { credit: 500, debit: 400 },
                        { credit: 600, debit: 500 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "85.23%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 85, debit: 70 },
                        { credit: 88, debit: 75 },
                        { credit: 82, debit: 68 },
                        { credit: 80, debit: 65 },
                        { credit: 84, debit: 70 },
                        { credit: 87, debit: 72 },
                        { credit: 90, debit: 78 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$2,152.44",
                    yAxis: ["$1,000", "$750", "$500", "$250", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "216",
                    yAxis: ["250", "200", "150", "100", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "14.77%",
                    yAxis: ["20%", "15%", "10%", "5%", "0%"]
                }
            }
        },
        'scale': {
            metrics: {
                'Payment success rate': { value: '91.67%', change: '+2.89%' },
                'Accepted volume': { value: '$89,432.15', change: '+24.56%' },
                'Accepted payments': { value: '8,943', change: '+22.34%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$89,432.15",
                    yAxis: ["$40,000", "$30,000", "$20,000", "$10,000", "$0"],
                    bars: [
                        { credit: 12000, debit: 10000 },
                        { credit: 15000, debit: 13000 },
                        { credit: 11000, debit: 9000 },
                        { credit: 8000, debit: 6000 },
                        { credit: 13000, debit: 11000 },
                        { credit: 18000, debit: 15000 },
                        { credit: 22000, debit: 18000 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "8,943",
                    yAxis: ["5,000", "4,000", "3,000", "2,000", "0"],
                    bars: [
                        { credit: 2800, debit: 2200 },
                        { credit: 3500, debit: 2900 },
                        { credit: 2500, debit: 2000 },
                        { credit: 1800, debit: 1400 },
                        { credit: 3200, debit: 2600 },
                        { credit: 3500, debit: 2900 },
                        { credit: 4200, debit: 3500 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 65, debit: 55 },
                        { credit: 75, debit: 65 },
                        { credit: 55, debit: 45 },
                        { credit: 35, debit: 25 },
                        { credit: 45, debit: 35 },
                        { credit: 70, debit: 60 },
                        { credit: 80, debit: 70 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "91.67%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 90, debit: 75 },
                        { credit: 92, debit: 80 },
                        { credit: 88, debit: 72 },
                        { credit: 85, debit: 70 },
                        { credit: 89, debit: 74 },
                        { credit: 93, debit: 78 },
                        { credit: 95, debit: 82 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$8,067.85",
                    yAxis: ["$4,000", "$3,000", "$2,000", "$1,000", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "813",
                    yAxis: ["1,000", "800", "600", "400", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "8.33%",
                    yAxis: ["12%", "10%", "8%", "4%", "0%"]
                }
            }
        },
        'enterprise': {
            metrics: {
                'Payment success rate': { value: '94.80%', change: '+1.89%' },
                'Accepted volume': { value: '$289,432.15', change: '+18.67%' },
                'Accepted payments': { value: '124,780', change: '+15.23%' }
            },
            chartData: {
                volume: {
                    label: "Payment volume",
                    total: "$289,432.15",
                    yAxis: ["$150,000", "$100,000", "$50,000", "$25,000", "$0"],
                    bars: [
                        { credit: 40000, debit: 30000 },
                        { credit: 50000, debit: 40000 },
                        { credit: 35000, debit: 25000 },
                        { credit: 25000, debit: 20000 },
                        { credit: 45000, debit: 35000 },
                        { credit: 55000, debit: 45000 },
                        { credit: 65000, debit: 50000 }
                    ]
                },
                payments: {
                    label: "Payments",
                    total: "124,780",
                    yAxis: ["60,000", "40,000", "20,000", "10,000", "0"],
                    bars: [
                        { credit: 18000, debit: 14000 },
                        { credit: 22000, debit: 18000 },
                        { credit: 16000, debit: 12000 },
                        { credit: 12000, debit: 9000 },
                        { credit: 20000, debit: 16000 },
                        { credit: 25000, debit: 20000 },
                        { credit: 30000, debit: 24000 }
                    ]
                },
                share: {
                    label: "Share of payments",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 80, debit: 20 },
                        { credit: 85, debit: 15 },
                        { credit: 75, debit: 25 },
                        { credit: 70, debit: 30 },
                        { credit: 80, debit: 20 },
                        { credit: 85, debit: 15 },
                        { credit: 90, debit: 10 }
                    ]
                },
                success: {
                    label: "Success rate",
                    total: "94.80%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"],
                    bars: [
                        { credit: 95, debit: 85 },
                        { credit: 96, debit: 88 },
                        { credit: 94, debit: 82 },
                        { credit: 92, debit: 80 },
                        { credit: 95, debit: 85 },
                        { credit: 97, debit: 90 },
                        { credit: 98, debit: 92 }
                    ]
                }
            },
            failedData: {
                'failed-volume': {
                    label: "Failed payment volume",
                    total: "$15,567.85",
                    yAxis: ["$8,000", "$6,000", "$4,000", "$2,000", "$0"]
                },
                'failed-count': {
                    label: "Failed",
                    total: "6,520",
                    yAxis: ["8,000", "6,000", "4,000", "2,000", "0"]
                },
                'share-failures': {
                    label: "Share of failures",
                    total: "100.00%",
                    yAxis: ["100%", "75%", "50%", "25%", "0%"]
                },
                'failure-rate': {
                    label: "Failure rate",
                    total: "5.20%",
                    yAxis: ["8%", "6%", "4%", "2%", "0%"]
                }
            }
        }
    };

            let currentBusinessType = 'growth';
    
            // Function to preserve the correct page title - always "Payments performance"
        function preservePageTitle() {
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                pageTitle.textContent = 'Payments performance';
            }
        }

    // Simple function to switch business type
    function switchBusinessType(businessType) {
        console.log('switchBusinessType called with:', businessType);
        
        // Remove active class from all tabs
        document.querySelectorAll('.business-type-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked tab
        const activeTab = document.querySelector(`[data-type="${businessType}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        } else {
            console.error('Could not find tab with data-type:', businessType);
        }
        
        // Update business data
        updateBusinessData(businessType);
        
        // Force immediate prompt update
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateAssistantPrompts(businessType, currentDateRange);
        
        console.log('Business type switched to:', businessType);
    }

    function updateBusinessData(businessType) {
        console.log('updateBusinessData called with:', businessType);
        currentBusinessType = businessType;
        
        // Get current date range
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        console.log('Current date range:', currentDateRange);
        
        // Update all data using the realistic data generator
        updateChartDateRanges(currentDateRange, businessType);
        
        // Update AI assistant prompts with new business context
        updateAssistantPrompts(businessType, currentDateRange);
        
        // Update optimization page if it exists
        updateOptimizationPage(businessType, currentDateRange);
        
        // Update overview page if it exists
        updateOverviewPage(businessType, currentDateRange);
        
        // Preserve the correct page title based on current active tab
        preservePageTitle();
        
        console.log('Business data updated for:', businessType);
    }



    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Remove duplicate initialization - this is already handled in the main initialization below
        // updateBusinessData('medium');
        
        // Ensure business type tabs are properly initialized
        console.log('DOM loaded, initializing business type tabs...');
        const businessTypeTabs = document.querySelectorAll('.business-type-tab');
        console.log('Found business type tabs:', businessTypeTabs.length);
        
        // Set initial business type
        currentBusinessType = 'growth';
        console.log('Initial business type set to:', currentBusinessType);
        
        // Initialize overview page with default values
        console.log('Initializing overview page...');
        setTimeout(() => {
            try {
                updateOverviewPage('growth', 'Last 90 days');
                console.log('Overview page initialized successfully');
            } catch (error) {
                console.error('Error initializing overview page:', error);
            }
        }, 500); // Small delay to ensure all components are loaded
    });

    // Chart Style Dropdown Functionality
    function initializeChartStyleDropdown() {
        const chartStyleDropdown = document.getElementById('chartStyleDropdown');
        const chartStyleMenu = document.getElementById('chartStyleMenu');
        const chartStyleItems = document.querySelectorAll('.chart-style-item');

        if (chartStyleDropdown && chartStyleMenu) {
            // Toggle dropdown
            chartStyleDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                chartStyleMenu.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                if (chartStyleMenu) {
                    chartStyleMenu.classList.remove('show');
                }
            });

            // Handle chart style selection
            chartStyleItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const selectedStyle = this.getAttribute('data-style');
                    console.log('Chart style selected:', selectedStyle);
                    
                    // Remove active class from all items
                    chartStyleItems.forEach(dropdownItem => dropdownItem.classList.remove('active'));
                    
                    // Add active class to selected item
                    this.classList.add('active');
                    
                    // Update dropdown text
                    const chartStyleText = document.getElementById('chartStyleText');
                    if (chartStyleText) {
                        chartStyleText.textContent = this.querySelector('span').textContent;
                    }
                    
                    // Switch chart display
                    switchChartStyle(selectedStyle);
                    
                    // Close dropdown
                    chartStyleMenu.classList.remove('show');
                    
                    // Reinitialize Lucide icons
                    lucide.createIcons();
                });
            });
        }
    }

    // Function to switch between chart styles
    function switchChartStyle(style) {
        const sparklineContainer = document.querySelector('.sparkline-charts-container');
        const chartContainerWrapper = document.querySelector('.chart-container-wrapper');
        const barChart = document.querySelector('.bar-chart');
        const waterfallChartStyle = document.querySelector('.waterfall-chart-style');
        const sankeyChart = document.querySelector('.sankey-chart');
        
        // Hide all charts
        if (sparklineContainer) sparklineContainer.style.display = 'none';
        if (chartContainerWrapper) chartContainerWrapper.style.display = 'none';
        if (barChart) barChart.style.display = 'none';
        if (waterfallChartStyle) waterfallChartStyle.style.display = 'none';
        if (sankeyChart) sankeyChart.style.display = 'none';
        
        // Show selected chart
        switch (style) {
            case 'sparkline':
                if (sparklineContainer) sparklineContainer.style.display = 'block';
                break;
            case 'bar':
                if (chartContainerWrapper) chartContainerWrapper.style.display = 'block';
                if (barChart) barChart.style.display = 'block';
                break;
            case 'waterfall':
                if (chartContainerWrapper) chartContainerWrapper.style.display = 'block';
                if (waterfallChartStyle) waterfallChartStyle.style.display = 'block';
                break;
            case 'sankey':
                if (chartContainerWrapper) chartContainerWrapper.style.display = 'block';
                if (sankeyChart) sankeyChart.style.display = 'block';
                break;
            default:
                if (sparklineContainer) sparklineContainer.style.display = 'block';
        }
    }

    // Function to update overview page with realistic data based on business type and timeframe
    function updateOverviewPage(businessType, dateRange) {
        console.log('=== updateOverviewPage START ===');
        console.log('Business type:', businessType);
        console.log('Date range:', dateRange);
        console.log('Current business type before update:', currentBusinessType);
        const overviewView = document.getElementById('overview-view');
        if (!overviewView) {
            console.log('Overview view not found!');
            return;
        }
        console.log('Found overview view, updating content...');
        
        try {
        
        // Generate data for the selected business type and timeframe
        let generator, businessMetrics, allData, optimizationData;
        
        // Use DataGenerator for consistent data across all pages
        console.log('Using DataGenerator for consistent data');
        console.log('Business type being passed to DataGenerator:', businessType);
        console.log('Date range being passed to DataGenerator:', dateRange);
        
        try {
            generator = new RealisticDataGenerator(businessType, dateRange);
            console.log('DataGenerator created successfully:', generator);
            
            businessMetrics = generator.getBusinessMetrics();
            console.log('Business metrics retrieved:', businessMetrics);
            
            allData = generator.generateAllData();
            console.log('All data generated:', allData);
            
            optimizationData = generator.generateOptimizationData();
            console.log('Optimization data generated:', optimizationData);
        } catch (error) {
            console.error('Error creating DataGenerator or generating data:', error);
            // Fallback to default data
            businessType = 'growth'; // Ensure we have a valid business type
            generator = new RealisticDataGenerator(businessType, dateRange);
            businessMetrics = generator.getBusinessMetrics();
            allData = generator.generateAllData();
            optimizationData = generator.generateOptimizationData();
        }
        
        // Data is now generated consistently from DataGenerator
        // businessMetrics, allData, and optimizationData are already set above
        
        console.log('Static data loaded successfully for', businessType);
        console.log('Business metrics for', businessType, ':', businessMetrics);
        console.log('All data volume for', businessType, ':', allData.metrics.volume);
        console.log('Generated optimization data in updateOverviewPage:', optimizationData);
        
        // Validate business metrics before using them
        if (!businessMetrics || !businessMetrics.successRate) {
            console.error('Invalid business metrics:', businessMetrics);
            console.error('Business type was:', businessType);
            // Force fallback to growth business type
            businessType = 'growth';
            generator = new RealisticDataGenerator(businessType, dateRange);
            businessMetrics = generator.getBusinessMetrics();
            allData = generator.generateAllData();
            optimizationData = generator.generateOptimizationData();
        }
        
        // Calculate key metrics with safety checks
        const totalRevenue = allData?.metrics?.volume || 0;
        const totalPayments = allData?.metrics?.payments || 0;
        const successRate = businessMetrics?.successRate || 85.0;
        
        console.log('Calculated metrics:', {
            totalRevenue,
            totalPayments,
            successRate,
            businessMetrics: businessMetrics,
            allData: allData
        });
        
        // Update performance stats with realistic data
        const performanceSparklines = overviewView.querySelectorAll('.sparkline-charts-container .sparkline-row .sparkline-card');
        if (performanceSparklines.length >= 3) {
            // Total processing volume (in thousands)
            const totalVolume = totalRevenue / 1000; // Convert to K
            const volumeTrend = (Math.random() - 0.5) * 15; // 7.5K variation
            performanceSparklines[0].querySelector('.sparkline-value').textContent = `$${totalVolume.toFixed(1)}K`;
            performanceSparklines[0].querySelector('.sparkline-trend').textContent = `${volumeTrend > 0 ? '+' : ''}${volumeTrend.toFixed(1)}K`;
            performanceSparklines[0].querySelector('.sparkline-trend').className = `sparkline-trend ${volumeTrend > 0 ? 'positive' : 'negative'}`;
            performanceSparklines[0].querySelector('.sparkline-rate').textContent = `Benchmark: $${(totalVolume * 1.2).toFixed(1)}K`;
            
            // Net revenue (after processing costs and fraud)
            const processingCost = businessMetrics?.processingCost || 2.8;
            const fraudRate = businessMetrics?.fraudRate || 0.7;
            const disputeRate = businessMetrics?.disputeRate || 0.9;
            
            const netRevenue = totalRevenue * (1 - processingCost/100 - fraudRate/100);
            const netRevenueK = netRevenue / 1000;
            const netTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 12; // 6K variation
            performanceSparklines[1].querySelector('.sparkline-value').textContent = `$${netRevenueK.toFixed(1)}K`;
            performanceSparklines[1].querySelector('.sparkline-trend').textContent = `${netTrend > 0 ? '+' : ''}${netTrend.toFixed(1)}K`;
            performanceSparklines[1].querySelector('.sparkline-trend').className = `sparkline-trend ${netTrend > 0 ? 'positive' : 'negative'}`;
            performanceSparklines[1].querySelector('.sparkline-rate').textContent = `Benchmark: $${(netRevenueK * 1.15).toFixed(1)}K`;
            
            // Lost revenue (processing costs + fraud + disputes)
            const lostRevenue = totalRevenue * (processingCost/100 + fraudRate/100 + disputeRate/100);
            const lostRevenueK = lostRevenue / 1000;
            const lostTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 8; // 4K variation
            performanceSparklines[2].querySelector('.sparkline-value').textContent = `$${lostRevenueK.toFixed(1)}K`;
            performanceSparklines[2].querySelector('.sparkline-trend').textContent = `${lostTrend > 0 ? '+' : ''}${lostTrend.toFixed(1)}K`;
            performanceSparklines[2].querySelector('.sparkline-trend').className = `sparkline-trend ${lostTrend < 0 ? 'positive' : 'negative'}`;
            performanceSparklines[2].querySelector('.sparkline-rate').textContent = `Benchmark: $${(lostRevenueK * 0.8).toFixed(1)}K`;
        }
        
        // Update sparkline charts with realistic data
        const sparklineValues = overviewView.querySelectorAll('.sparkline-value');
        const sparklineTrends = overviewView.querySelectorAll('.sparkline-trend');
        
        if (sparklineValues.length >= 6) {
            // Get safe values with defaults
            const safeSuccessRate = businessMetrics?.successRate || 85.0;
            const safeAuthRate = businessMetrics?.authorizationRate || 91.0;
            const safeDisputeRate = businessMetrics?.disputeRate || 0.9;
            const safeProcessingCost = businessMetrics?.processingCost || 2.8;
            
            // Acceptance rate
            const acceptanceRate = safeSuccessRate + ((generator ? generator.rng() : Math.random()) - 0.5) * 3;
            sparklineValues[0].textContent = `${Math.min(100, Math.max(0, acceptanceRate)).toFixed(1)}%`;
            const acceptanceTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 4;
            sparklineTrends[0].textContent = `${acceptanceTrend > 0 ? '+' : ''}${acceptanceTrend.toFixed(1)}%`;
            sparklineTrends[0].className = `sparkline-trend ${acceptanceTrend > 0 ? 'positive' : 'negative'}`;
            
            // Auth success
            const authSuccess = safeAuthRate + ((generator ? generator.rng() : Math.random()) - 0.5) * 2;
            sparklineValues[1].textContent = `${Math.min(100, Math.max(0, authSuccess)).toFixed(1)}%`;
            const authTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 3;
            sparklineTrends[1].textContent = `${authTrend > 0 ? '+' : ''}${authTrend.toFixed(1)}%`;
            sparklineTrends[1].className = `sparkline-trend ${authTrend > 0 ? 'positive' : 'negative'}`;
            
            // Dispute rate
            const disputeRate = safeDisputeRate + ((generator ? generator.rng() : Math.random()) - 0.5) * 0.3;
            sparklineValues[2].textContent = `${Math.max(0, disputeRate).toFixed(1)}%`;
            const disputeTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 0.4;
            sparklineTrends[2].textContent = `${disputeTrend > 0 ? '+' : ''}${disputeTrend.toFixed(1)}%`;
            sparklineTrends[2].className = `sparkline-trend ${disputeTrend < 0 ? 'positive' : 'negative'}`;
            
            // Processing cost
            const processingCost = safeProcessingCost + ((generator ? generator.rng() : Math.random()) - 0.5) * 0.4;
            sparklineValues[3].textContent = `${Math.max(0, processingCost).toFixed(1)}%`;
            const costTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 0.5;
            sparklineTrends[3].textContent = `${costTrend > 0 ? '+' : ''}${costTrend.toFixed(1)}%`;
            sparklineTrends[3].className = `sparkline-trend ${costTrend < 0 ? 'positive' : 'negative'}`;
            
            // Payment methods
            const paymentMethods = 85 + ((generator ? generator.rng() : Math.random()) - 0.5) * 10;
            sparklineValues[4].textContent = `${Math.min(100, Math.max(0, paymentMethods)).toFixed(1)}%`;
            const methodsTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 5;
            sparklineTrends[4].textContent = `${methodsTrend > 0 ? '+' : ''}${methodsTrend.toFixed(1)}%`;
            sparklineTrends[4].className = `sparkline-trend ${methodsTrend > 0 ? 'positive' : 'negative'}`;
            
            // Optimizations
            const optimizations = 12 + ((generator ? generator.rng() : Math.random()) - 0.5) * 8;
            sparklineValues[5].textContent = optimizations.toFixed(0);
            const optTrend = ((generator ? generator.rng() : Math.random()) - 0.5) * 4;
            sparklineTrends[5].textContent = `${optTrend > 0 ? '+' : ''}${optTrend.toFixed(1)}`;
            sparklineTrends[5].className = `sparkline-trend ${optTrend > 0 ? 'positive' : 'negative'}`;
        }
        
        // Update payment success rate sparkline to match acceptance tab data
        const paymentSuccessRateElement = overviewView.querySelector('#overview-payment-success-rate');
        const paymentSuccessChangeElement = overviewView.querySelector('#overview-payment-success-change');
        
        if (paymentSuccessRateElement && paymentSuccessChangeElement) {
            // Get the data from the business data structure (same as acceptance tab)
            const businessDataForType = businessData[businessType] || businessData['growth'];
            const paymentSuccessData = businessDataForType.metrics['Payment success rate'];
            
            paymentSuccessRateElement.textContent = paymentSuccessData.value;
            paymentSuccessChangeElement.textContent = paymentSuccessData.change;
            
            // Set the trend class based on whether the change is positive or negative
            const isPositive = paymentSuccessData.change.startsWith('+');
            paymentSuccessChangeElement.className = `sparkline-trend ${isPositive ? 'positive' : 'negative'}`;
            
            console.log('Updated payment success rate sparkline:', {
                businessType: businessType,
                value: paymentSuccessData.value,
                change: paymentSuccessData.change,
                isPositive: isPositive
            });
        }
        
        // Key metrics section is now hidden - removed update logic
        // const keyMetricsValues = overviewView.querySelectorAll('.snapshot-card-value');
        // const keyMetricsChanges = overviewView.querySelectorAll('.snapshot-card-change');
        
        // Update optimization impact chart
        const optimizationMetricValue = overviewView.querySelector('#optimization-metric-value');
        const optimizationChartBars = overviewView.querySelectorAll('.bar-group rect');
        
        console.log('=== OPTIMIZATION METRIC UPDATE ===');
        console.log('Optimization metric value element found:', !!optimizationMetricValue);
        console.log('Optimization chart bars found:', optimizationChartBars.length);
        console.log('Optimization data:', optimizationData);
        console.log('Optimization data volume:', optimizationData?.volume);
        
        if (optimizationMetricValue && optimizationData?.volume) {
            const newValue = `$${optimizationData.volume.toFixed(2)}`;
            optimizationMetricValue.textContent = newValue;
            console.log('Updated optimization metric value to:', newValue);
            console.log('Element text content after update:', optimizationMetricValue.textContent);
        } else {
            console.error('Optimization metric value element not found or optimization data invalid!');
            console.error('Optimization data:', optimizationData);
        }
        
                 if (optimizationChartBars.length >= 7 && optimizationData?.volume) {
             // Update bar heights based on optimization data
             const maxHeight = 160;
             console.log('Chart bars - optimizationData.volume:', optimizationData.volume);
             
             // Use a more realistic scaling - if volume is $56K, make bars proportional
             const baseHeight = Math.min(maxHeight, maxHeight * (optimizationData.volume / 100000)); // Scale to $100K max
             console.log('Chart bars - baseHeight:', baseHeight);
             
             optimizationChartBars.forEach((bar, index) => {
                 // Create a realistic trend: start high, dip in middle, recover slightly
                 const trendFactor = index === 0 ? 1.0 : 
                                   index === 1 ? 0.95 : 
                                   index === 2 ? 0.90 : 
                                   index === 3 ? 0.70 : 
                                   index === 4 ? 0.65 : 
                                   index === 5 ? 0.50 : 0.45;
                 
                 const height = Math.max(20, baseHeight * trendFactor);
                 bar.setAttribute('height', height);
                 bar.setAttribute('y', 200 - height);
                 console.log(`Bar ${index}: height=${height}, trendFactor=${trendFactor}`);
             });
         }
         
         // FORCE UPDATE: Set realistic chart bar heights
         console.log('=== FORCE CHART UPDATE ===');
         const chartBars = overviewView.querySelectorAll('.bar-group rect');
         if (chartBars.length >= 7) {
             // Set realistic heights for $56K total volume
             const realisticHeights = [160, 152, 144, 112, 104, 80, 72]; // Proportional to $56K
             
             chartBars.forEach((bar, index) => {
                 if (index < realisticHeights.length) {
                     const height = realisticHeights[index];
                     bar.setAttribute('height', height);
                     bar.setAttribute('y', 200 - height);
                     console.log(`FORCE: Set bar ${index} height to ${height}`);
                 }
             });
         }
         
                 // Update optimization impact table with dynamic data
        updateOptimizationImpactTable(overviewView, optimizationData);
        
        // FORCE UPDATE: Directly set realistic values as fallback
        console.log('=== FORCE UPDATE START ===');
        
        // Force update the main metric value based on business type
        const metricValue = overviewView.querySelector('#optimization-metric-value');
        if (metricValue) {
            const businessTypeValues = {
                'startup': '$12,000.00',
                'growth': '$56,800.00',
                'scale': '$125,000.00',
                'enterprise': '$289,000.00'
            };
            const value = businessTypeValues[businessType] || businessTypeValues['growth'];
            metricValue.textContent = value;
            console.log('FORCE: Set metric value to', value, 'for', businessType);
        }
        
        // Force update table cells directly
        const tableBody = overviewView.querySelector('.data-table tbody');
        if (tableBody) {
            // Update Adaptive Acceptance based on business type
            const adaptiveVolume = tableBody.querySelector('#adaptive-volume');
            if (adaptiveVolume) {
                const adaptiveValues = {
                    'startup': '+$3,000.00',
                    'growth': '+$12,500.00',
                    'scale': '+$28,000.00',
                    'enterprise': '+$65,000.00'
                };
                const adaptiveValue = adaptiveValues[businessType] || adaptiveValues['growth'];
                adaptiveVolume.textContent = adaptiveValue;
                console.log('FORCE: Set Adaptive Acceptance volume to', adaptiveValue, 'for', businessType);
            }
            
            const adaptivePayments = tableBody.querySelector('#adaptive-payments');
            if (adaptivePayments) {
                adaptivePayments.textContent = '+45';
                console.log('FORCE: Set Adaptive Acceptance payments to +45');
            }
            
            const adaptiveSuccess = tableBody.querySelector('#adaptive-success');
            if (adaptiveSuccess) {
                adaptiveSuccess.textContent = '+2.80%';
                console.log('FORCE: Set Adaptive Acceptance success to +2.80%');
            }
            
            // Update Network Tokens
            const networkVolume = tableBody.querySelector('#network-volume');
            if (networkVolume) {
                networkVolume.textContent = '+$8,200.00';
                console.log('FORCE: Set Network Tokens volume to +$8,200.00');
            }
            
            const networkPayments = tableBody.querySelector('#network-payments');
            if (networkPayments) {
                networkPayments.textContent = '+28';
                console.log('FORCE: Set Network Tokens payments to +28');
            }
            
            const networkSuccess = tableBody.querySelector('#network-success');
            if (networkSuccess) {
                networkSuccess.textContent = '+1.50%';
                console.log('FORCE: Set Network Tokens success to +1.50%');
            }
            
            // Update Card Account Updater
            const updaterVolume = tableBody.querySelector('#updater-volume');
            if (updaterVolume) {
                updaterVolume.textContent = '+$6,800.00';
                console.log('FORCE: Set Card Account Updater volume to +$6,800.00');
            }
            
            const updaterPayments = tableBody.querySelector('#updater-payments');
            if (updaterPayments) {
                updaterPayments.textContent = '+22';
                console.log('FORCE: Set Card Account Updater payments to +22');
            }
            
            const updaterSuccess = tableBody.querySelector('#updater-success');
            if (updaterSuccess) {
                updaterSuccess.textContent = '+1.20%';
                console.log('FORCE: Set Card Account Updater success to +1.20%');
            }
            
            // Update totals based on business type
            const totalVolume = tableBody.querySelector('#total-volume');
            if (totalVolume) {
                const totalValues = {
                    'startup': '+$12,000.00',
                    'growth': '+$56,800.00',
                    'scale': '+$125,000.00',
                    'enterprise': '+$289,000.00'
                };
                const totalValue = totalValues[businessType] || totalValues['growth'];
                totalVolume.innerHTML = `<strong>${totalValue}</strong>`;
                console.log('FORCE: Set total volume to', totalValue, 'for', businessType);
            }
            
            const totalPayments = tableBody.querySelector('#total-payments');
            if (totalPayments) {
                totalPayments.innerHTML = '<strong>+200</strong>';
                console.log('FORCE: Set total payments to +200');
            }
            
            const totalSuccess = tableBody.querySelector('#total-success');
            if (totalSuccess) {
                totalSuccess.innerHTML = '<strong>+10.00%</strong>';
                console.log('FORCE: Set total success to +10.00%');
            }
        }
        
        console.log('=== FORCE UPDATE COMPLETE ===');
        
        // Ensure the force update persists by running it again after a short delay
        setTimeout(() => {
            console.log('=== PERSISTENCE CHECK ===');
            
            // Check if the metric value was overridden and fix it
            const metricValue = overviewView.querySelector('#optimization-metric-value');
            if (metricValue && metricValue.textContent === '$1.00') {
                metricValue.textContent = formatUSD(56800);
                console.log('PERSISTENCE: Re-fixed metric value to', formatUSD(56800));
            }
            
            // Check if table values were overridden and fix them
            const tableBody = overviewView.querySelector('.data-table tbody');
            if (tableBody) {
                const adaptiveVolume = tableBody.querySelector('#adaptive-volume');
                if (adaptiveVolume && adaptiveVolume.textContent === '+$0.00') {
                    adaptiveVolume.textContent = `+${formatUSD(12500)}`;
                    console.log('PERSISTENCE: Re-fixed Adaptive Acceptance volume');
                }
                
                const networkVolume = tableBody.querySelector('#network-volume');
                if (networkVolume && networkVolume.textContent === '+$0.00') {
                    networkVolume.textContent = `+${formatUSD(8200)}`;
                    console.log('PERSISTENCE: Re-fixed Network Tokens volume');
                }
                
                const updaterVolume = tableBody.querySelector('#updater-volume');
                if (updaterVolume && updaterVolume.textContent === '+$0.00') {
                    updaterVolume.textContent = `+${formatUSD(6800)}`;
                    console.log('PERSISTENCE: Re-fixed Card account updater volume');
                }
                
                const totalVolume = tableBody.querySelector('#total-volume');
                if (totalVolume && totalVolume.textContent.includes('$0.00')) {
                    totalVolume.innerHTML = `<strong>+${formatUSD(27500)}</strong>`;
                    console.log('PERSISTENCE: Re-fixed total volume');
                }
                
                // Fix payments and success rate cells
                const adaptivePayments = tableBody.querySelector('#adaptive-payments');
                if (adaptivePayments && adaptivePayments.textContent === '+0') {
                    adaptivePayments.textContent = '+45';
                    console.log('PERSISTENCE: Re-fixed Adaptive Acceptance payments');
                }
                
                const networkPayments = tableBody.querySelector('#network-payments');
                if (networkPayments && networkPayments.textContent === '+0') {
                    networkPayments.textContent = '+28';
                    console.log('PERSISTENCE: Re-fixed Network Tokens payments');
                }
                
                const updaterPayments = tableBody.querySelector('#updater-payments');
                if (updaterPayments && updaterPayments.textContent === '+0') {
                    updaterPayments.textContent = '+22';
                    console.log('PERSISTENCE: Re-fixed Card account updater payments');
                }
                
                const totalPayments = tableBody.querySelector('#total-payments');
                if (totalPayments && totalPayments.textContent === '+0') {
                    totalPayments.innerHTML = '<strong>+95</strong>';
                    console.log('PERSISTENCE: Re-fixed total payments');
                }
                
                // Fix success rate cells
                const adaptiveSuccess = tableBody.querySelector('#adaptive-success');
                if (adaptiveSuccess && adaptiveSuccess.textContent === '+0.00%') {
                    adaptiveSuccess.textContent = '+2.80%';
                    console.log('PERSISTENCE: Re-fixed Adaptive Acceptance success rate');
                }
                
                const networkSuccess = tableBody.querySelector('#network-success');
                if (networkSuccess && networkSuccess.textContent === '+0.00%') {
                    networkSuccess.textContent = '+1.50%';
                    console.log('PERSISTENCE: Re-fixed Network Tokens success rate');
                }
                
                const updaterSuccess = tableBody.querySelector('#updater-success');
                if (updaterSuccess && updaterSuccess.textContent === '+0.00%') {
                    updaterSuccess.textContent = '+1.20%';
                    console.log('PERSISTENCE: Re-fixed Card account updater success rate');
                }
                
                const totalSuccess = tableBody.querySelector('#total-success');
                if (totalSuccess && totalSuccess.textContent === '+0.00%') {
                    totalSuccess.innerHTML = '<strong>+5.50%</strong>';
                    console.log('PERSISTENCE: Re-fixed total success rate');
                }
            }
        }, 500);
        
        console.log('Overview page updated successfully');
        
        // Reinitialize chart style dropdown after content update
        setTimeout(() => {
            initializeChartStyleDropdown();
        }, 100);
        
        // Force populate optimization table with realistic data
        setTimeout(() => {
            forcePopulateOptimizationTable();
        }, 200);
        } catch (error) {
            console.error('Error updating overview page:', error);
        }
    }

    // Function to force populate optimization table with realistic data
    function forcePopulateOptimizationTable() {
        console.log('Force populating optimization table with realistic data...');
        
        // Update main metric
        const metricValue = document.getElementById('optimization-metric-value');
        if (metricValue) {
            metricValue.textContent = formatUSD(56800);
            console.log('Updated main metric to:', formatUSD(56800));
        }
        
        // Update table cells directly
        const adaptiveVolume = document.getElementById('adaptive-volume');
        const networkVolume = document.getElementById('network-volume');
        const updaterVolume = document.getElementById('updater-volume');
        
        const adaptivePayments = document.getElementById('adaptive-payments');
        const networkPayments = document.getElementById('network-payments');
        const updaterPayments = document.getElementById('updater-payments');
        
        const adaptiveSuccess = document.getElementById('adaptive-success');
        const networkSuccess = document.getElementById('network-success');
        const updaterSuccess = document.getElementById('updater-success');
        
        const totalVolume = document.getElementById('total-volume');
        const totalPayments = document.getElementById('total-payments');
        const totalSuccess = document.getElementById('total-success');
        
        // Populate all cells
        if (adaptiveVolume) adaptiveVolume.textContent = `+${formatUSD(12500)}`;
        if (adaptivePayments) adaptivePayments.textContent = '+45';
        if (adaptiveSuccess) adaptiveSuccess.textContent = '+2.80%';
        
        if (networkVolume) networkVolume.textContent = `+${formatUSD(8200)}`;
        if (networkPayments) networkPayments.textContent = '+28';
        if (networkSuccess) networkSuccess.textContent = '+1.50%';
        
        if (updaterVolume) updaterVolume.textContent = `+${formatUSD(6800)}`;
        if (updaterPayments) updaterPayments.textContent = '+22';
        if (updaterSuccess) updaterSuccess.textContent = '+1.20%';
        
        if (totalVolume) totalVolume.innerHTML = `<strong>+${formatUSD(27500)}</strong>`;
        if (totalPayments) totalPayments.innerHTML = `<strong>+95</strong>`;
        if (totalSuccess) totalSuccess.innerHTML = `<strong>+5.50%</strong>`;
        
        console.log('Optimization table populated successfully');
    }

    // Function to update optimization impact table with dynamic data
    function updateOptimizationImpactTable(container, optimizationData) {
        console.log('=== updateOptimizationImpactTable START ===');
        console.log('Container:', container);
        console.log('Optimization data:', optimizationData);
        console.log('Container found:', !!container);
        
        // Use static optimization data instead of DataGenerator
        const activeOptimizations = [
            { id: 'adaptive-acceptance', title: 'Adaptive Acceptance', status: 'active' },
            { id: 'network-tokens', title: 'Network Tokens', status: 'active' },
            { id: 'card-account-updater', title: 'Card account updater', status: 'active' }
        ];
        const allOptimizations = activeOptimizations;
        
        console.log('Active optimizations:', activeOptimizations);
        console.log('All optimizations:', allOptimizations);
        console.log('Optimization data features:', optimizationData.features);
        
        // Update the table body with dynamic data
        const tableBody = container.querySelector('.data-table tbody');
        console.log('Table body found:', !!tableBody);
        if (tableBody) {
            // Instead of replacing the entire table, update specific cells
            allOptimizations.forEach(opt => {
                const isActive = opt.status === 'active';
                const featureData = optimizationData.features[opt.title] || {
                    volume: 0,
                    payments: 0,
                    successRate: 0
                };
                
                console.log(`Optimization "${opt.title}":`, {
                    isActive,
                    featureData,
                    availableFeatures: Object.keys(optimizationData.features)
                });
                
                // Find the row for this optimization and update its cells
                const rows = tableBody.querySelectorAll('tr');
                console.log(`Looking for optimization: "${opt.title}"`);
                console.log(`Available rows:`, rows.length);
                
                let found = false;
                rows.forEach((row, rowIndex) => {
                    const titleCell = row.querySelector('.reason-cell span');
                    if (titleCell) {
                        console.log(`Row ${rowIndex}: "${titleCell.textContent}" vs "${opt.title}"`);
                    }
                    if (titleCell && titleCell.textContent === opt.title) {
                        found = true;
                        console.log(`Found matching row for "${opt.title}"`);
                        // Update the volume cell
                        const volumeCell = row.querySelector('td:nth-child(3)');
                        if (volumeCell) {
                            volumeCell.textContent = `+${formatUSD(featureData.volume)}`;
                            console.log(`Updated volume for "${opt.title}": +${formatUSD(featureData.volume)}`);
                        }
                        
                        // Update the payments cell
                        const paymentsCell = row.querySelector('td:nth-child(4)');
                        if (paymentsCell) {
                            paymentsCell.textContent = `+${featureData.payments.toFixed(0)}`;
                            console.log(`Updated payments for "${opt.title}": +${featureData.payments.toFixed(0)}`);
                        }
                        
                        // Update the success rate cell
                        const successCell = row.querySelector('td:nth-child(5)');
                        if (successCell) {
                            successCell.textContent = `+${featureData.successRate.toFixed(2)}%`;
                            console.log(`Updated success rate for "${opt.title}": +${featureData.successRate.toFixed(2)}%`);
                        }
                        
                        // Update checkbox status
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = isActive;
                        }
                        
                        // Update icon color
                        const icon = row.querySelector('.reason-icon');
                        if (icon) {
                            icon.style.color = isActive ? '#10B981' : '#9CA3AF';
                        }
                    }
                });
                
                            if (!found) {
                console.warn(`No matching row found for optimization: "${opt.title}"`);
            }
        });
        
        // Direct table population - force realistic data regardless of DataGenerator status
        const adaptiveVolume = document.getElementById('adaptive-volume');
        const networkVolume = document.getElementById('network-volume');
        const updaterVolume = document.getElementById('updater-volume');
        
        const adaptivePayments = document.getElementById('adaptive-payments');
        const networkPayments = document.getElementById('network-payments');
        const updaterPayments = document.getElementById('updater-payments');
        
        const adaptiveSuccess = document.getElementById('adaptive-success');
        const networkSuccess = document.getElementById('network-success');
        const updaterSuccess = document.getElementById('updater-success');
        
        // Force populate with realistic data
        if (adaptiveVolume) {
            adaptiveVolume.textContent = `+${formatUSD(12500)}`;
            console.log('Updated Adaptive Acceptance volume');
        }
        if (adaptivePayments) {
            adaptivePayments.textContent = '+45';
            console.log('Updated Adaptive Acceptance payments');
        }
        if (adaptiveSuccess) {
            adaptiveSuccess.textContent = '+2.80%';
            console.log('Updated Adaptive Acceptance success rate');
        }
        
        if (networkVolume) {
            networkVolume.textContent = `+${formatUSD(8200)}`;
            console.log('Updated Network Tokens volume');
        }
        if (networkPayments) {
            networkPayments.textContent = '+28';
            console.log('Updated Network Tokens payments');
        }
        if (networkSuccess) {
            networkSuccess.textContent = '+1.50%';
            console.log('Updated Network Tokens success rate');
        }
        
        if (updaterVolume) {
            updaterVolume.textContent = `+${formatUSD(6800)}`;
            console.log('Updated Card account updater volume');
        }
        if (updaterPayments) {
            updaterPayments.textContent = '+22';
            console.log('Updated Card account updater payments');
        }
        if (updaterSuccess) {
            updaterSuccess.textContent = '+1.20%';
            console.log('Updated Card account updater success rate');
        }
        
                // Update total row
        const totalRow = tableBody.querySelector('.total-row');
        if (totalRow) {
            const totalVolumeCell = totalRow.querySelector('td:nth-child(3)');
            const totalPaymentsCell = totalRow.querySelector('td:nth-child(4)');
            const totalSuccessCell = totalRow.querySelector('td:nth-child(5)');
            
            console.log('Updating total row with:', {
                volume: optimizationData.volume,
                payments: optimizationData.payments,
                successRate: optimizationData.successRate
            });
            
            if (totalVolumeCell) {
                totalVolumeCell.innerHTML = `<strong>+${formatUSD(optimizationData.volume)}</strong>`;
                console.log('Updated total volume to:', `+${formatUSD(optimizationData.volume)}`);
            }
            if (totalPaymentsCell) {
                totalPaymentsCell.innerHTML = `<strong>+${optimizationData.payments.toFixed(0)}</strong>`;
                console.log('Updated total payments to:', `+${optimizationData.payments.toFixed(0)}`);
            }
            if (totalSuccessCell) {
                totalSuccessCell.innerHTML = `<strong>+${optimizationData.successRate.toFixed(2)}%</strong>`;
                console.log('Updated total success rate to:', `+${optimizationData.successRate.toFixed(2)}%`);
            }
        }
        
        // Force update total cells with realistic sums
        const totalVolume = document.getElementById('total-volume');
        const totalPayments = document.getElementById('total-payments');
        const totalSuccess = document.getElementById('total-success');
        
        if (totalVolume) {
            totalVolume.innerHTML = `<strong>+${formatUSD(27500)}</strong>`;
            console.log('Updated total volume');
        }
        if (totalPayments) {
            totalPayments.innerHTML = `<strong>+95</strong>`;
            console.log('Updated total payments');
        }
        if (totalSuccess) {
            totalSuccess.innerHTML = `<strong>+5.50%</strong>`;
            console.log('Updated total success rate');
        }
        }
        
        // Update summary metrics (but preserve realistic values)
        const metricValue = container.querySelector('#optimization-metric-value');
        console.log('Metric value element found:', !!metricValue);
        if (metricValue) {
            // Force update to realistic value
            metricValue.textContent = formatUSD(56800);
            console.log('Updated metric value to:', formatUSD(56800));
        }
        
        // Update chart bars based on active optimizations
        updateOptimizationChartBars(container, optimizationData);
        
        // Reinitialize icons
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }

    // Function to toggle optimization on/off
    function toggleOptimization(optimizationId, enabled) {
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'growth';
        const currentDateRange = document.getElementById('overviewDateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        
        const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
        
        if (enabled) {
            generator.enableOptimization(optimizationId);
        } else {
            generator.disableOptimization(optimizationId);
        }
        
        // Update the overview page to reflect changes
        updateOverviewPage(currentBusinessType, currentDateRange);
        
        // Show feedback
        const optimization = generator.optimizationState[optimizationId];
        if (optimization) {
            const action = enabled ? 'enabled' : 'disabled';
            showNotification(`${optimization.title} ${action}`, enabled ? 'success' : 'info');
        }
    }

    // Function to update optimization chart bars
    function updateOptimizationChartBars(container, optimizationData) {
        const chartBars = container.querySelectorAll('.bar-group rect');
        const activeOptimizations = Object.values(optimizationData.features).filter(f => f.status === 'active');
        
        if (chartBars.length >= 7) {
            // Generate realistic bar heights based on optimization impact over time
            const maxHeight = 160;
            const baseImpact = optimizationData.volume;
            console.log('Chart bars - baseImpact:', baseImpact, 'maxHeight:', maxHeight);
            
            chartBars.forEach((bar, index) => {
                // Create a realistic trend: start high, dip in middle, recover slightly
                const trendFactor = index === 0 ? 1.0 : 
                                  index === 1 ? 0.95 : 
                                  index === 2 ? 0.90 : 
                                  index === 3 ? 0.70 : 
                                  index === 4 ? 0.65 : 
                                  index === 5 ? 0.50 : 0.45;
                
                const height = Math.max(20, maxHeight * (baseImpact / 2) * trendFactor);
                bar.setAttribute('height', height);
                bar.setAttribute('y', 200 - height);
            });
        }
    }

    // Function to show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10B981' : '#3B82F6'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    function updateOptimizationPage(businessType, dateRange) {
        console.log('updateOptimizationPage called with:', businessType, dateRange);
        const optimizationView = document.getElementById('optimization-view');
        if (!optimizationView) {
            console.log('Optimization view not found!');
            return;
        }
        console.log('Found optimization view, updating content...');
        console.log('Optimization view display style:', optimizationView.style.display);
        
        // Generate dynamic data based on business type and date range
        const generator = new RealisticDataGenerator(businessType, dateRange);
        const businessMetrics = generator.getBusinessMetrics();
        const timeframeMultipliers = generator.getTimeframeMultipliers();
        
        // Calculate base values for the selected timeframe
        const totalDays = timeframeMultipliers.days;
        const avgDailyVolume = businessMetrics.avgTransactionValue * businessMetrics.dailyTransactions;
        const totalVolume = avgDailyVolume * totalDays * timeframeMultipliers.volume;
        const totalTransactions = businessMetrics.dailyTransactions * totalDays * timeframeMultipliers.payments;
        
        // Generate realistic data with some variation
        const successRate = businessMetrics.successRate + (generator.rng() - 0.5) * 3; // 1.5% variation
        const authRate = Math.min(100, successRate + 5 + (generator.rng() - 0.5) * 4); // Slightly higher than success rate
        const disputeRate = businessMetrics.disputeRate + (generator.rng() - 0.5) * 0.2; // Small variation
        const retentionRate = 45 + (businessType === 'startup' ? 0 : businessType === 'growth' ? 20 : businessType === 'scale' ? 35 : 45) + (generator.rng() - 0.5) * 10;
        
        // Calculate derived metrics
        const finalRevenue = totalVolume * (successRate / 100);
        const revenueLost = totalVolume - finalRevenue;
        const declinedTransactions = Math.round(totalTransactions * (1 - authRate / 100));
        const disputeTransactions = Math.round(totalTransactions * disputeRate / 100);
        const fraudLosses = Math.round(totalVolume * 0.008); // 0.8% fraud rate
        
        const data = {
            totalVolume: Math.round(totalVolume),
            totalTransactions: Math.round(totalTransactions),
            successRate: Math.round(successRate * 10) / 10,
            authRate: Math.round(authRate * 10) / 10,
            disputeRate: Math.round(disputeRate * 10) / 10,
            retentionRate: Math.round(retentionRate * 10) / 10,
            finalRevenue: Math.round(finalRevenue),
            revenueLost: Math.round(revenueLost),
            declinedTransactions: declinedTransactions,
            disputeTransactions: disputeTransactions,
            fraudLosses: fraudLosses,
            recoveredTransactions: 134 // Demo value for recovered payments count
        };
        
        // Update performance stats (the four cards at the top) - only if they exist
        const performanceCards = optimizationView.querySelectorAll('.performance-stat-card');
        if (performanceCards.length >= 4) {
            setTimeout(() => {
                updatePerformanceStats(optimizationView, data);
            }, 100);
        } else {
            console.log('Performance stat cards not found in optimization view, skipping update');
        }
        
        // Update summary stats (only if they exist)
        const summaryStats = optimizationView.querySelectorAll('.summary-stats .stat-value');
        if (summaryStats.length >= 4) {
            summaryStats[0].textContent = formatCurrency(data.totalVolume);
            summaryStats[1].textContent = formatCurrency(Math.abs(data.revenueLost));
            summaryStats[2].textContent = formatCurrency(data.finalRevenue);
            summaryStats[3].textContent = `${data.successRate}%`;
            console.log('Updated summary stats for', businessType, ':', {
                totalRevenue: formatCurrency(data.totalVolume),
                revenueRecovered: formatCurrency(Math.abs(data.revenueLost)),
                finalRevenue: formatCurrency(data.finalRevenue),
                successRate: `${data.successRate}%`
            });
        } else {
            console.log('No summary stats found, skipping summary stats update');
        }
        
        // Update waterfall chart
        updateWaterfallChart(optimizationView, data);
        
        // Update performance snapshot
        updatePerformanceSnapshot(optimizationView, data);
        
        // Update optimization opportunities
        updateOptimizationOpportunities(optimizationView, businessType, data, dateRange);
        
        // Update Experiments table
        updateABTestingTable(optimizationView, businessType, data, dateRange);
        
        // Update timeline
        updateTimeline(optimizationView, businessType, data);
        
        // Update performance insights
        updatePerformanceInsights(optimizationView, businessType, data);
        
        // Update quick actions
        updateQuickActions(optimizationView, businessType, data, dateRange);
        
        // Update resources section
        updateResourcesSection(optimizationView, businessType);
        
        // Update assistant prompts
        updateOptimizationAssistantPrompts(optimizationView, businessType, data, dateRange);
        
        // Add a visible indicator in the optimization view
        const lifecycleTitle = optimizationView.querySelector('.lifecycle-title');
        if (lifecycleTitle) {
            lifecycleTitle.textContent = `Payment lifecycle`;
        }
    }
    
    // Function to update performance stats cards
    function updatePerformanceStats(container, data) {
        console.log('updatePerformanceStats called with data:', data);
        console.log('Recovered transactions value:', data.recoveredTransactions);
        const performanceCards = container.querySelectorAll('.performance-stat-card');
        console.log('Found performance cards:', performanceCards.length);
        if (performanceCards.length >= 4) {
            // Total revenue
            const totalRevenueCard = performanceCards[0];
            const totalRevenueValue = totalRevenueCard.querySelector('.stat-value');
            if (totalRevenueValue) {
                totalRevenueValue.textContent = formatCurrency(data.totalVolume);
            }
            
            // Total revenue recovered
            const revenueLostCard = performanceCards[1];
            const revenueLostValue = revenueLostCard.querySelector('.stat-value');
            if (revenueLostValue) {
                // Display as positive value since it's "recovered" revenue
                revenueLostValue.textContent = formatCurrency(Math.abs(data.revenueLost));
            }
            
            // Recovered payments (count of recovered transactions)
            const recoveredVolumeCard = performanceCards[2];
            const recoveredVolumeValue = recoveredVolumeCard.querySelector('.stat-value');
            if (recoveredVolumeValue) {
                // Ensure we display as a count, not currency
                const count = data.recoveredTransactions || 0;
                recoveredVolumeValue.textContent = count.toString();
                console.log('Updated recovered payments card:', {
                    cardIndex: 2,
                    dataValue: data.recoveredTransactions,
                    displayValue: count.toString(),
                    elementFound: !!recoveredVolumeValue,
                    currentTextContent: recoveredVolumeValue.textContent,
                    element: recoveredVolumeValue
                });
            } else {
                console.error('Could not find recovered payments value element');
            }
            
            // Success rate
            const successRateCard = performanceCards[3];
            const successRateValue = successRateCard.querySelector('.stat-value');
            if (successRateValue) {
                successRateValue.textContent = `${data.successRate}%`;
            }
            
            console.log('Updated performance stats:', {
                totalRevenue: formatCurrency(data.totalVolume),
                revenueRecovered: formatCurrency(Math.abs(data.revenueLost)),
                recoveredPayments: data.recoveredTransactions || 0,
                successRate: `${data.successRate}%`
            });
        } else {
            console.error('Could not find performance stat cards:', performanceCards.length);
        }
    }
    
    function formatCurrency(amount) {
        // Handle undefined, null, or NaN values
        if (amount === undefined || amount === null || isNaN(amount)) {
            return '$0';
        }
        
        // Ensure amount is a number
        const numAmount = Number(amount);
        if (isNaN(numAmount)) {
            return '$0';
        }
        
        // Handle negative values
        const isNegative = numAmount < 0;
        const absAmount = Math.abs(numAmount);
        
        let formattedValue;
        if (absAmount >= 1000000) {
            // For amounts >= 1M, use abbreviated format with proper comma formatting
            const millions = absAmount / 1000000;
            if (millions >= 10) {
                // For 10M+, show as whole number with commas
                formattedValue = `${Math.round(millions).toLocaleString()}M`;
            } else {
                // For 1M-9.9M, show with one decimal
                formattedValue = `${millions.toFixed(1)}M`;
            }
        } else if (absAmount >= 1000) {
            // For amounts >= 1K, use abbreviated format with proper comma formatting
            const thousands = absAmount / 1000;
            if (thousands >= 10) {
                // For 10K+, show as whole number with commas
                formattedValue = `${Math.round(thousands).toLocaleString()}K`;
            } else {
                // For 1K-9.9K, show with one decimal
                formattedValue = `${thousands.toFixed(1)}K`;
            }
        } else {
            // For amounts < 1K, show as whole number
            formattedValue = `${Math.round(absAmount)}`;
        }
        
        return isNegative ? `-$${formattedValue}` : `$${formattedValue}`;
    }
    
    // New function for detailed USD formatting with commas
    function formatUSD(amount) {
        // Handle undefined, null, or NaN values
        if (amount === undefined || amount === null || isNaN(amount)) {
            return '$0.00';
        }
        
        // Ensure amount is a number
        const numAmount = Number(amount);
        if (isNaN(numAmount)) {
            return '$0.00';
        }
        
        // Handle negative values
        const isNegative = numAmount < 0;
        const absAmount = Math.abs(numAmount);
        
        // Format with proper USD formatting including commas
        const formattedValue = absAmount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        return isNegative ? `-$${formattedValue}` : `$${formattedValue}`;
    }
    
    function updateWaterfallChart(container, data) {
        const waterfallItems = container.querySelectorAll('.waterfall-item');
        if (waterfallItems.length >= 5) {
            // Calculate bar heights based on data (max height 200px)
            const maxValue = Math.max(data.totalVolume, data.finalRevenue);
            const scaleFactor = 200 / maxValue;
            
            // Authentication
            const authItem = waterfallItems[0];
            const authHeight = Math.round(data.totalVolume * scaleFactor);
            authItem.querySelector('.waterfall-bar').style.height = `${authHeight}px`;
            authItem.querySelector('.detail-value').textContent = formatCurrency(data.totalVolume);
            authItem.querySelector('.detail-rate').textContent = `${data.totalTransactions.toLocaleString()} transactions`;
            
            // Declines
            const declineItem = waterfallItems[1];
            const declineAmount = data.totalVolume * (1 - data.authRate / 100);
            const declineHeight = Math.round(declineAmount * scaleFactor);
            declineItem.querySelector('.waterfall-bar').style.height = `${declineHeight}px`;
            declineItem.querySelector('.detail-value').textContent = formatCurrency(-declineAmount);
            declineItem.querySelector('.detail-rate').textContent = `${data.declinedTransactions.toLocaleString()} declined`;
            
            // Disputes
            const disputeItem = waterfallItems[2];
            const disputeAmount = data.totalVolume * data.disputeRate / 100;
            const disputeHeight = Math.round(disputeAmount * scaleFactor);
            disputeItem.querySelector('.waterfall-bar').style.height = `${disputeHeight}px`;
            disputeItem.querySelector('.detail-value').textContent = formatCurrency(-disputeAmount);
            disputeItem.querySelector('.detail-rate').textContent = `${data.disputeTransactions} disputes`;
            
            // Fraud
            const fraudItem = waterfallItems[3];
            const fraudHeight = Math.round(data.fraudLosses * scaleFactor);
            fraudItem.querySelector('.waterfall-bar').style.height = `${fraudHeight}px`;
            fraudItem.querySelector('.detail-value').textContent = formatCurrency(-data.fraudLosses);
            fraudItem.querySelector('.detail-rate').textContent = `${formatCurrency(-data.fraudLosses)} fraud losses`;
            
            // Final Revenue
            const finalItem = waterfallItems[4];
            const finalHeight = Math.round(data.finalRevenue * scaleFactor);
            finalItem.querySelector('.waterfall-bar').style.height = `${finalHeight}px`;
            finalItem.querySelector('.detail-value').textContent = formatCurrency(data.finalRevenue);
            finalItem.querySelector('.detail-rate').textContent = `${data.successRate}% success rate`;
        }
    }
    
    function updatePerformanceSnapshot(container, data) {
        const snapshotCards = container.querySelectorAll('.snapshot-card');
        if (snapshotCards.length >= 4) {
            // Checkout conversion
            snapshotCards[0].querySelector('.snapshot-card-value').textContent = `${data.successRate}%`;
            updateSnapshotChart(snapshotCards[0], data.successRate, 100);
            
            // Authorization rate
            snapshotCards[1].querySelector('.snapshot-card-value').textContent = `${data.authRate}%`;
            updateSnapshotChart(snapshotCards[1], data.authRate, 100);
            
            // Dispute rate
            snapshotCards[2].querySelector('.snapshot-card-value').textContent = `${data.disputeRate}%`;
            updateSnapshotChart(snapshotCards[2], data.disputeRate, 1.0);
            
            // Customer retention
            snapshotCards[3].querySelector('.snapshot-card-value').textContent = `${data.retentionRate}%`;
            updateSnapshotChart(snapshotCards[3], data.retentionRate, 100);
        }
    }
    
    function updateSnapshotChart(card, currentValue, maxValue) {
        const svg = card.querySelector('.snapshot-chart-svg');
        if (!svg) return;

        // Generate time series data for the line chart
        const generator = new RealisticDataGenerator(currentBusinessType, 'Last 90 days');

        // Generate data points for the three lines
        const baselineData = generator.generateTimeSeriesData(currentValue * 0.85, 0.1, 0.05);
        const currentData = generator.generateTimeSeriesData(currentValue, 0.08, 0.02);
        const optimizedData = generator.generateTimeSeriesData(Math.min(currentValue * 1.08, maxValue), 0.06, 0.03);

        // Define x-coordinates for the line chart (10 points for smoother curves)
        // Use coordinates that span the full width of the SVG (0 to 200)
        const xPoints = [0, 22, 44, 67, 89, 111, 133, 156, 178, 200]; // Span the full width from 0 to 200 (200 units wide)

        // Convert to Y coordinates (invert for SVG coordinate system)
        const baselineY = baselineData.slice(0, 10).map(v => 200 - (v / maxValue * 200));
        const currentY = currentData.slice(0, 10).map(v => 200 - (v / maxValue * 200));
        const optimizedY = optimizedData.slice(0, 10).map(v => 200 - (v / maxValue * 200));

        // Ensure the first and last points are at the absolute edges
        xPoints[0] = 0;
        xPoints[xPoints.length - 1] = 200;

        // Build SVG paths with simple line segments to ensure full width
        let baselineLine = `M${xPoints[0]},${baselineY[0]}`;
        let currentLine = `M${xPoints[0]},${currentY[0]}`;
        let optimizedLine = `M${xPoints[0]},${optimizedY[0]}`;

        // Add line segments for full width coverage
        for (let i = 1; i < xPoints.length; i++) {
            baselineLine += ` L${xPoints[i]},${baselineY[i]}`;
            currentLine += ` L${xPoints[i]},${currentY[i]}`;
            optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
        }

        // Update SVG content with line paths
        svg.innerHTML = `
            <!-- Baseline line (dashed gray) -->
            <path d="${baselineLine}" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
            <!-- Current line (solid blue) -->
            <path d="${currentLine}" stroke="#3B82F6" stroke-width="2" fill="none"/>
        `;
    }
    
    function updateOptimizationOpportunities(container, businessType, data, dateRange) {
        console.log('updateOptimizationOpportunities called with:', businessType, data);
        const opportunities = {
            small: [
                {
                    title: "Excessive 3DS Outside SCA Scope",
                    description: "You're frequently triggering 3DS outside SCA-mandated regions on low-risk transactions, reducing conversion with a minor effect on fraud",
                    impact: "Up to $120K",
                    impactLabel: "USD annual revenue increase",
                    revenue: "+$120,000/year",
                    effort: "Easy",
                    effortDetail: "No code required",
                    timeline: "Same day",
                    category: "Authentication",
                    cta: "Experiment",
                    implementation: "No code required",
                    appearsOn: "/acceptance"
                },
                {
                    title: "3DS Abandonment",
                    description: "High 3DS abandonment could point to an error in your integration setup",
                    impact: "Up to $120K",
                    impactLabel: "USD annual revenue increase",
                    revenue: "+$120,000/year",
                    effort: "Easy",
                    effortDetail: "No code required",
                    timeline: "Same day",
                    category: "Authentication",
                    cta: "Experiment",
                    implementation: "No code required"
                },
                {
                    title: "Enable Adaptive Acceptance",
                    description: "Improve your authorization rate by selectively retrying declined payments in real time",
                    impact: "Up to $5K",
                    impactLabel: "CAD revenue annually",
                    revenue: "+$5,000/year",
                    effort: "Easy",
                    effortDetail: "No code required",
                    timeline: "Same day",
                    category: "Acceptance",
                    cta: "Experiment",
                    implementation: "No code required",
                    appearsOn: "/acceptance"
                },
                {
                    title: "Enable {Afterpay/Klarna}",
                    description: "Help improve your conversion rate by enabling {Afterpay/Klarna}, a Buy Now, Pay Later (BNPL) payment method",
                    impact: "Up to $120K",
                    impactLabel: "USD annual revenue increase",
                    revenue: "+$120,000/year",
                    effort: "Medium",
                    effortDetail: "Depends on Integration",
                    timeline: "1-2 weeks",
                    category: "Acceptance / LPM",
                    cta: "Depends on integration",
                    implementation: "Depends on Integration",
                    appearsOn: "/acceptance, /payment-methods"
                },
                {
                    title: "Enable Apple Pay",
                    description: "Help improve your conversion rate by enabling Apple Pay",
                    impact: "Up to $120K",
                    impactLabel: "USD annual revenue increase",
                    revenue: "+$120,000/year",
                    effort: "Medium",
                    effortDetail: "Depends on Integration",
                    timeline: "1-2 weeks",
                    category: "Acceptance / LPM",
                    cta: "Depends on integration",
                    implementation: "Depends on Integration",
                    appearsOn: "/acceptance, /payment-methods"
                }
            ],
            medium: [
                {
                    title: "Enable Network Tokens",
                    description: "Increase your authorization rate by replacing card numbers with secure tokens",
                    impact: "Up to $6.72M",
                    impactLabel: "GBP revenue annually",
                    revenue: "+$6,720,000/year",
                    effort: "Easy",
                    effortDetail: "No code required",
                    timeline: "Same day",
                    category: "Acceptance",
                    cta: "Experiment",
                    implementation: "No code required",
                    appearsOn: "/acceptance"
                },
                {
                    title: "Enable Card Account Updater",
                    description: "Raise your authorization rate by refreshing outdated customer payment details",
                    impact: "Up to $650K",
                    impactLabel: "USD revenue annually",
                    revenue: "+$650,000/year",
                    effort: "Easy",
                    effortDetail: "No code required",
                    timeline: "Same day",
                    category: "Acceptance",
                    cta: "Experiment",
                    implementation: "No code required",
                    appearsOn: "/acceptance"
                },
                {
                    title: "Use Stored Credentials API (Private Preview)",
                    description: "Send authorization messages in card networks' required format to increase authorization rate",
                    impact: "Up to $650K",
                    impactLabel: "USD revenue annually",
                    revenue: "+$650,000/year",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1-2 weeks",
                    category: "Acceptance",
                    cta: "Experiment",
                    implementation: "Requires code"
                },
                {
                    title: "Share ZIP Code for Visa Cards",
                    description: "Decrease penalties by sending your customer's billing address and zip code in the API",
                    impact: "Up to $9.1K",
                    impactLabel: "USD cost savings annually",
                    revenue: "+$9,100/year",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1 week",
                    category: "Cost",
                    cta: "Experiment",
                    implementation: "Requires code",
                    status: "In Progress"
                },
                {
                    title: "Share Payment Fraud Signals",
                    description: "Decrease fraud by using Stripe.js to collect device information and IP addresses for card payments",
                    impact: "Up to 36%",
                    impactLabel: "fraud model improvement",
                    revenue: "+36% fraud reduction",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1 week",
                    category: "Acceptance / Fraud",
                    cta: "Experiment",
                    implementation: "Requires code",
                    appearsOn: "/acceptance"
                }
            ],
            large: [
                {
                    title: "Share ZIP Code for Visa Cards",
                    description: "Decrease penalties by sending your customer's billing address and zip code in the API",
                    impact: "Up to $9.1K",
                    impactLabel: "USD cost savings annually",
                    revenue: "+$9,100/year",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1 week",
                    category: "Cost",
                    cta: "Experiment",
                    implementation: "Requires code",
                    status: "In Progress"
                },
                {
                    title: "Send Sales and Tax Data",
                    description: "Decrease network costs by sharing detailed sales information on business and corporate cards",
                    impact: "Up to $650K",
                    impactLabel: "CZK cost savings annually",
                    revenue: "+$650,000/year",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1-2 weeks",
                    category: "Cost",
                    cta: "Experiment",
                    implementation: "Requires code"
                },
                {
                    title: "Share Customer Fraud Signals",
                    description: "Reduce fraud by sharing your customer's name and email address in the API for all card payments",
                    impact: "Up to 11%",
                    impactLabel: "fraud model improvement",
                    revenue: "+11% fraud reduction",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1 week",
                    category: "Acceptance / Fraud",
                    cta: "Experiment",
                    implementation: "Requires code",
                    appearsOn: "/acceptance"
                },
                {
                    title: "Send Sales and Tax Data",
                    description: "Decrease network costs by sharing detailed sales information on business and corporate cards",
                    impact: "Up to $650K",
                    impactLabel: "CZK cost savings annually",
                    revenue: "+$650,000/year",
                    effort: "Medium",
                    effortDetail: "Requires code",
                    timeline: "1-2 weeks",
                    category: "Cost",
                    cta: "Experiment",
                    implementation: "Requires code"
                }
            ]
        };
        
        const filteredOpportunities = getRecommendations(businessType);
        
        const tableBody = container.querySelector('.opportunities-table tbody');
        
        console.log('Found opportunities table body:', !!tableBody);
        console.log('Business opportunities for', businessType, ':', filteredOpportunities.length, 'items');
        
        if (tableBody) {
            tableBody.innerHTML = filteredOpportunities.map((opp, index) => {
                const statusBadge = opp.status ? `<span class="status-badge ${opp.status.toLowerCase().includes('finished') ? 'completed' : opp.status.toLowerCase().includes('progress') ? 'in-progress' : 'blocked'}">${opp.status}</span>` : '';
                const categoryBadge = opp.category ? `<span class="category-badge">${opp.category}</span>` : '';
                
                return `
                    <tr class="${index === 0 ? 'high-priority' : index === 1 ? 'high-priority' : 'medium-priority'}">
                        <td>
                            <div class="opportunity-cell">
                                <div class="opportunity-info">
                                    <div class="opportunity-title">${opp.title}</div>
                                    <div class="opportunity-description">${opp.description}</div>
                                    ${categoryBadge}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="revenue-impact">${opp.revenue}</span>
                        </td>
                        <td>
                            <span class="effort-badge ${opp.effort.toLowerCase()}">${opp.effort}</span>
                            <div class="effort-detail">${opp.implementation || opp.effortDetail}</div>
                            ${statusBadge}
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="table-btn secondary" onclick="openExperimentDrawer({
                                    id: '${opp.id}',
                                    title: '${opp.title}',
                                    description: '${opp.description}',
                                    uplift: ${parseInt(opp.impact.replace(/[^0-9]/g, '')) || 0},
                                    revenue: '${opp.revenue}',
                                    effort: '${opp.effort}'
                                })">
                                    ${opp.cta || 'Get started'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update optimization insights cards with top 3 recommendations
        updateOptimizationInsightsCards(businessType);
    }
    
    function updateOptimizationInsightsCards(businessType = 'medium') {
        try {
            // Use the same data source as the Optimization tab
            const recommendations = getRecommendations(businessType);
            const topRecommendations = recommendations.slice(0, 3);
            
            console.log('Updating optimization insights with recommendations:', topRecommendations);
            
            // Update all optimization insights sections
            const insightsSections = document.querySelectorAll('.optimization-insights');
            
            insightsSections.forEach(section => {
                section.innerHTML = topRecommendations.map((opt, index) => `
                    <div class="insight-card" onclick="openExperimentDrawer({
                        id: '${opt.id}',
                        title: '${opt.title}',
                        description: '${opt.description}',
                        uplift: ${parseInt(opt.impact.replace(/[^0-9]/g, '')) || 0},
                        revenue: '${opt.revenue}',
                        effort: '${opt.effort}'
                    })">
                        <div class="insight-header">
                            <div class="insight-content">
                                <h4 class="insight-title">${opt.title}</h4>
                                <p class="insight-description">${opt.description}</p>
                            </div>
                        </div>
                        <div class="insight-impact">
                            <span class="impact-value">${opt.impact}</span>
                            <div class="impact-label">Est. impact</div>
                        </div>
                    </div>
                `).join('');
            });
            
            // Re-initialize icons after updating content
        if (window.lucide) {
            window.lucide.createIcons();
        }
        } catch (error) {
            console.error('Error in updateOptimizationInsightsCards:', error);
        }
    }

    // Function to enable optimization from insight card
    function enableOptimizationFromInsight(optimizationId) {
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'growth';
        const currentDateRange = document.getElementById('overviewDateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        
        const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
        const optimization = generator.optimizationState[optimizationId];
        
        if (optimization) {
            // Show confirmation dialog
            if (confirm(`Enable ${optimization.title}? This will start tracking its impact on your payment performance.`)) {
                generator.enableOptimization(optimizationId);
                
                // Update the overview page to reflect changes
                updateOverviewPage(currentBusinessType, currentDateRange);
                
                // Update optimization insights
                updateOptimizationInsightsCards(currentBusinessType);
                
                // Show success notification
                showNotification(`${optimization.title} enabled successfully!`, 'success');
            }
        }
    }
    
    function updateTimeline(container, businessType, data) {
        const timelines = {
            small: [
                {
                    title: "Digital Wallets Implementation",
                    description: "Successfully integrated Apple Pay and Google Pay for mobile users",
                    impact: "+1.5%",
                    impactLabel: "conversion rate",
                    date: "June 15, 2024",
                    status: "completed",
                    revenue: "+$2,100/year",
                    outcome: "Mobile conversion improved by 15%"
                },
                {
                    title: "Basic Retry Logic Setup",
                    description: "Implemented simple retry rules for declined transactions",
                    impact: "+1.2%",
                    impactLabel: "recovery rate",
                    date: "May 28, 2024",
                    status: "completed",
                    revenue: "+$1,800/year",
                    outcome: "Recovered $1,800 in previously lost revenue"
                },
                {
                    title: "Payment Method Expansion",
                    description: "Added local payment options for your region",
                    impact: "+0.8%",
                    impactLabel: "conversion rate",
                    date: "April 10, 2024",
                    status: "completed",
                    revenue: "+$1,200/year",
                    outcome: "Regional payment adoption at 23%"
                },
                {
                    title: "Address Verification",
                    description: "Implemented basic address verification for fraud prevention",
                    impact: "+1.1%",
                    impactLabel: "approval rate",
                    date: "March 22, 2024",
                    status: "completed",
                    revenue: "+$1,600/year",
                    outcome: "Fraud rate reduced by 0.3%"
                }
            ],
            medium: [
                {
                    title: "Smart Retries Implementation",
                    description: "Successfully configured intelligent retry logic for declined transactions",
                    impact: "+2.2%",
                    impactLabel: "authorization rate",
                    date: "June 15, 2024",
                    status: "completed",
                    revenue: "+$38,000/year",
                    outcome: "Recovered $38K in previously declined payments"
                },
                {
                    title: "Digital Wallets Integration",
                    description: "Successfully integrated Apple Pay and Google Pay for mobile users",
                    impact: "+1.5%",
                    impactLabel: "conversion rate",
                    date: "May 28, 2024",
                    status: "completed",
                    revenue: "+$26,000/year",
                    outcome: "Mobile conversion improved by 18%"
                },
                {
                    title: "3D Secure Optimization",
                    description: "Successfully implemented automatic vs. challenge-based authentication",
                    impact: "+2.6%",
                    impactLabel: "authorization rate",
                    date: "April 12, 2024",
                    status: "completed",
                    revenue: "+$45,000/year",
                    outcome: "3DS abandonment reduced by 40%"
                },
                {
                    title: "Card Network Tokens",
                    description: "Successfully implemented card network tokenization for improved security",
                    impact: "+2.3%",
                    impactLabel: "authorization rate",
                    date: "March 8, 2024",
                    status: "completed",
                    revenue: "+$40,000/year",
                    outcome: "Tokenization coverage at 87%"
                }
            ],
            large: [
                {
                    title: "Machine Learning Fraud Detection",
                    description: "Successfully deployed AI-powered fraud prevention systems",
                    impact: "+3.2%",
                    impactLabel: "authorization rate",
                    date: "June 15, 2024",
                    status: "completed",
                    revenue: "+$320,000/year",
                    outcome: "Fraud rate reduced by 0.8%"
                },
                {
                    title: "Regional payment methods",
                    description: "Successfully added local payment options for international markets",
                    impact: "+2.8%",
                    impactLabel: "conversion rate",
                    date: "May 28, 2024",
                    status: "completed",
                    revenue: "+$280,000/year",
                    outcome: "International conversion improved by 25%"
                },
                {
                    title: "Advanced 3D Secure",
                    description: "Successfully implemented intelligent authentication routing",
                    impact: "+2.1%",
                    impactLabel: "authorization rate",
                    date: "April 20, 2024",
                    status: "completed",
                    revenue: "+$210,000/year",
                    outcome: "3DS success rate improved to 94%"
                },
                {
                    title: "Enterprise Link Deployment",
                    description: "Successfully deployed Link authentication across all customer touchpoints",
                    impact: "+1.8%",
                    impactLabel: "conversion rate",
                    date: "March 15, 2024",
                    status: "completed",
                    revenue: "+$180,000/year",
                    outcome: "Link adoption rate at 67%"
                }
            ]
        };
        
        const businessTimeline = timelines[businessType] || timelines.medium;
        const timelineContainer = container.querySelector('.timeline-container');
        
        if (timelineContainer) {
            timelineContainer.innerHTML = `
                <div class="ab-tests-table-container">
                    <table class="ab-tests-table">
                        <thead>
                            <tr>
                                <th>Optimization</th>
                                <th>Status</th>
                                <th>Revenue</th>
                                <th>Outcome</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${businessTimeline.map((event, index) => {
                                const statusCell = event.status === 'completed' ? 
                                    '<div class="status-cell completed"><span class="status-dot"></span><span class="status-text">Completed</span></div>' : 
                                    event.status === 'active' ? 
                                    '<div class="status-cell active"><span class="status-dot"></span><span class="status-text">Active</span></div>' :
                                    '<div class="status-cell future"><span class="status-dot"></span><span class="status-text">Planned</span></div>';
                                
                                const actionButton = event.status === 'completed' ? 
                                    '<button class="table-btn secondary"><i data-lucide="bar-chart" style="width: 14px; height: 14px;"></i> Report</button>' :
                                    event.status === 'active' ? 
                                    '<button class="table-btn secondary"><i data-lucide="pause" style="width: 14px; height: 14px;"></i> Pause</button>' :
                                    '<button class="table-btn secondary"><i data-lucide="play" style="width: 14px; height: 14px;"></i> Start</button>';
                                
                                return `
                                    <tr class="${event.status}">
                                        <td>
                                            <div class="test-cell">
                                                <div class="test-title">${event.title}</div>
                                                <div class="test-description">${event.description}</div>
                                            </div>
                                        </td>
                                        <td>
                                            ${statusCell}
                                        </td>
                                        <td>
                                            <span class="revenue-impact">${event.revenue}</span>
                                        </td>
                                        <td>
                                            <span class="outcome-value">${event.outcome}</span>
                                        </td>
                                        <td>
                                            <span class="date-value">${event.date}</span>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                ${actionButton}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }
    
    function updateOptimizationAssistantPrompts(container, businessType, data, dateRange) {
        const prompts = {
            small: [
                "What are my highest-impact optimization opportunities?",
                "How do I calculate optimization ROI?",
                "What experiments should I run?"
            ],
            medium: [
                "What are my highest-impact optimization opportunities?",
                "How do I calculate optimization ROI?",
                "What experiments should I run?"
            ],
            large: [
                "What enterprise optimization strategies should I implement?",
                "How do I scale Radar fraud detection for my volume?",
                "What international payment methods should I add?"
            ]
        };
        
        const businessPrompts = prompts[businessType] || prompts.medium;
        const promptButtons = container.querySelectorAll('.prompt-btn');
        
        promptButtons.forEach((button, index) => {
            if (businessPrompts[index]) {
                button.textContent = businessPrompts[index];
                button.onclick = () => {
                    openAIPanel(businessPrompts[index], businessType, 'optimization', data.successRate, dateRange, data.totalTransactions);
                };
            }
        });
    }

    function updateABTestingTable(container, businessType, data, dateRange) {
        console.log('updateABTestingTable called with:', businessType);
        const abTests = {
            small: [
                {
                    title: "Elements integration",
                    description: "Testing Elements vs. custom payment forms",
                    status: "active",
                    progress: 45,
                    control: "78.2%",
                    variant: "79.7%",
                    improvement: "+1.5%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Checkout optimization",
                    description: "Testing Checkout vs. embedded forms",
                    status: "completed",
                    progress: 100,
                    control: "75.1%",
                    variant: "76.3%",
                    improvement: "+1.2%",
                    actions: ["Deploy", "Report"]
                }
            ],
            medium: [
                {
                    title: "3D Secure optimization",
                    description: "Testing automatic vs. challenge-based 3D Secure authentication",
                    status: "active",
                    progress: 67,
                    control: "89.2%",
                    variant: "91.8%",
                    improvement: "+2.6%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Smart Retries configuration",
                    description: "Testing different retry strategies for declined payments",
                    status: "completed",
                    progress: 100,
                    control: "85.1%",
                    variant: "87.3%",
                    improvement: "+2.2%",
                    actions: ["Deploy", "Report"]
                }
            ],
            large: [
                {
                    title: "Custom Radar Rules",
                    description: "Testing custom fraud rules and machine learning",
                    status: "active",
                    progress: 78,
                    control: "91.2%",
                    variant: "94.4%",
                    improvement: "+3.2%",
                    actions: ["Details", "Pause"]
                },
                {
                    title: "Connect marketplace",
                    description: "Testing multi-party payment flows",
                    status: "completed",
                    progress: 100,
                    control: "89.8%",
                    variant: "92.6%",
                    improvement: "+2.8%",
                    actions: ["Deploy", "Report"]
                }
            ]
        };
        
        const businessTests = abTests[businessType] || abTests.medium;
        const tableBody = container.querySelector('.ab-tests-table tbody');
        
        if (tableBody) {
            tableBody.innerHTML = businessTests.map((test, index) => {
                const isWinner = test.status === 'completed' && test.variant.includes('winner');
                const variantClass = isWinner ? 'winner' : '';
                
                return `
                    <tr class="${test.status}">
                        <td>
                            <div class="test-cell">
                                <div class="test-title">${test.title}</div>
                                <div class="test-description">${test.description}</div>
                            </div>
                        </td>
                        <td>
                            <div class="status-cell ${test.status}">
                                <span class="status-dot"></span>
                                <span class="status-text">${test.status.charAt(0).toUpperCase() + test.status.slice(1)}</span>
                            </div>
                        </td>
                        <td>
                            <div class="progress-cell">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${test.progress}%"></div>
                                </div>
                                <span class="progress-text">${test.progress}% Complete</span>
                            </div>
                        </td>
                        <td>
                            <span class="rate-value">${test.control}</span>
                        </td>
                        <td>
                            <span class="rate-value ${variantClass}">${test.variant}</span>
                        </td>
                        <td>
                            <span class="improvement">${test.improvement}</span>
                        </td>
                        <td>
                            <div class="table-actions">
                                ${test.actions.map(action => {
                                    const icon = action === 'Details' ? 'bar-chart' : 
                                                action === 'Pause' ? 'pause' : 
                                                action === 'Deploy' ? 'check' : 'file-text';
                                    return `
                                        <button class="table-btn secondary" onclick="openAIPanel('How do I ${action.toLowerCase()} this experiment?', '${businessType}', 'ab-test-${action.toLowerCase()}', ${data.successRate}, '${dateRange}', ${data.totalTransactions})">
                                            <i data-lucide="${icon}" style="width: 14px; height: 14px;"></i>
                                            ${action}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    function updatePerformanceInsights(container, businessType, data) {
        console.log('updatePerformanceInsights called with:', businessType);
        const insights = {
            small: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Elements",
                    description: `${data.authRate}% success rate - excellent Elements integration`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Smart Retries",
                    description: `${data.disputeRate}% dispute rate - consider enabling Smart Retries`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ],
            medium: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Payment Intents",
                    description: `${data.authRate}% success rate - excellent Payment Intents implementation`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Radar",
                    description: `${data.disputeRate}% dispute rate - consider enabling Radar fraud detection`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ],
            large: [
                {
                    type: "top",
                    label: "Top Performing Area",
                    value: "Custom Radar Rules",
                    description: `${data.authRate}% success rate - excellent Radar fraud detection`,
                    icon: "trending-up",
                    color: "var(--color-green-500)"
                },
                {
                    type: "attention",
                    label: "Needs Attention",
                    value: "Connect",
                    description: `${data.disputeRate}% dispute rate - consider implementing Connect for marketplace payments`,
                    icon: "alert-triangle",
                    color: "var(--color-orange-500)"
                }
            ]
        };
        
        const businessInsights = insights[businessType] || insights.medium;
        const insightsContainer = container.querySelector('.performance-insights');
        
        if (insightsContainer) {
            const insightCards = insightsContainer.querySelectorAll('.insight-card');
            businessInsights.forEach((insight, index) => {
                if (insightCards[index]) {
                    const icon = insightCards[index].querySelector('i');
                    const label = insightCards[index].querySelector('.insight-label');
                    const value = insightCards[index].querySelector('.insight-value');
                    const description = insightCards[index].querySelector('.insight-description');
                    const learnMoreLink = insightCards[index].querySelector('.learn-more-link');
                    
                    if (icon) {
                        icon.setAttribute('data-lucide', insight.icon);
                        icon.style.color = insight.color;
                    }
                    if (label) label.textContent = insight.label;
                    if (value) value.textContent = insight.value;
                    if (description) description.textContent = insight.description;
                    if (learnMoreLink) {
                        learnMoreLink.onclick = (e) => {
                            e.preventDefault();
                            openAIPanel(`Tell me more about ${insight.value} optimization`, businessType, 'performance-insights', data.successRate, 'Last 30 days', data.totalTransactions);
                        };
                    }
                }
            });
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateQuickActions(container, businessType, data, dateRange) {
        console.log('updateQuickActions called with:', businessType);
        const actions = {
            small: [
                {
                    text: "Create experiment",
                    icon: "plus",
                    action: "setup-ab-test"
                },
                {
                    text: "Add Elements",
                    icon: "smartphone",
                    action: "add-elements"
                },
                {
                    text: "Configure Smart Retries",
                    icon: "refresh-cw",
                    action: "configure-retries"
                }
            ],
            medium: [
                {
                    text: "Create experiment",
                    icon: "plus",
                    action: "setup-ab-test"
                },
                {
                    text: "Implement Payment Intents",
                    icon: "shield-check",
                    action: "implement-payment-intents"
                },
                {
                    text: "Configure Smart Retries",
                    icon: "refresh-cw",
                    action: "configure-retries"
                }
            ],
            large: [
                {
                    text: "Setup Custom Radar Rules",
                    icon: "brain",
                    action: "setup-radar"
                },
                {
                    text: "Add Connect",
                    icon: "globe",
                    action: "add-connect"
                },
                {
                    text: "Optimize 3D Secure",
                    icon: "shield",
                    action: "optimize-3d-secure"
                }
            ]
        };
        
        const businessActions = actions[businessType] || actions.medium;
        const actionsContainer = container.querySelector('.quick-actions');
        
        if (actionsContainer) {
            const actionButtons = actionsContainer.querySelectorAll('.quick-action-btn');
            businessActions.forEach((action, index) => {
                if (actionButtons[index]) {
                    const icon = actionButtons[index].querySelector('i');
                    const text = actionButtons[index].querySelector('span') || actionButtons[index];
                    
                    if (icon) icon.setAttribute('data-lucide', action.icon);
                    if (text && text !== actionButtons[index]) {
                        text.textContent = action.text;
                    } else if (text === actionButtons[index]) {
                        actionButtons[index].innerHTML = `
                            <i data-lucide="${action.icon}" style="width: 16px; height: 16px;"></i>
                            ${action.text}
                        `;
                    }
                    
                    actionButtons[index].onclick = () => {
                        console.log('Action button clicked:', action);
                        // Special handling for smart-retries action to open experiment drawer
                        if (action.action === 'smart-retries') {
                            console.log('Smart retries action detected, opening experiment drawer...');
                            // Close AI panel first to avoid conflicts
                            closeAIPanel();
                            
                            const experimentData = {
                                id: 'smart-retries',
                                title: 'Smart Retries',
                                description: 'Automatically retry failed payments with intelligent timing and bank-specific strategies to recover lost revenue.',
                                impact: 'High',
                                effort: 'Medium',
                                category: 'Payment Optimization',
                                status: 'recommended',
                                metrics: {
                                    successRate: 85.2,
                                    revenueIncrease: 15,
                                    timeToImplement: '2-3 days'
                                }
                            };
                            console.log('Experiment data:', experimentData);
                            
                            // Add a small delay to ensure AI panel is closed
                            setTimeout(() => {
                                openExperimentDrawer(experimentData);
                            }, 100);
                        } else {
                            openAIPanel(`How do I ${action.text.toLowerCase()}?`, businessType, action.action, data.successRate, dateRange, data.totalTransactions);
                        }
                    };
                }
            });
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateResourcesSection(container, businessType) {
        console.log('updateResourcesSection called with:', businessType);
        const resources = {
            small: [
                {
                    name: "Payment optimization guide",
                    description: "Learn how to optimize your payment performance and increase revenue.",
                    icon: "file-text"
                },
                {
                    name: "Experiments best practices",
                    description: "Learn how to design and run effective payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Radar fraud prevention",
                        "Checkout optimization"
                    ]
                }
            ],
            medium: [
                {
                    name: "Advanced payment optimization",
                    description: "Learn enterprise-level payment optimization strategies and best practices.",
                    icon: "file-text"
                },
                {
                    name: "Experiments best practices",
                    description: "Learn how to design and run effective payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Radar fraud prevention",
                        "Checkout optimization"
                    ]
                }
            ],
            large: [
                {
                    name: "Enterprise optimization guide",
                    description: "Learn enterprise-level payment optimization strategies and best practices.",
                    icon: "file-text"
                },
                {
                    name: "Enterprise Experiments",
                    description: "Learn how to design and run enterprise-scale payment optimization tests.",
                    icon: "bar-chart"
                },
                {
                    subsection: "View other optimization tools",
                    links: [
                        "Custom Radar Rules fraud prevention",
                        "Connect marketplace payments"
                    ]
                }
            ]
        };
        
        const businessResources = resources[businessType] || resources.medium;
        const resourcesContainer = container.querySelector('.resources-section');
        
        if (resourcesContainer) {
            const resourceItems = resourcesContainer.querySelectorAll('.resource-item');
            const resourceSubsection = resourcesContainer.querySelector('.resource-subsection');
            
            // Update main resource items
            businessResources.forEach((resource, index) => {
                if (resource.name && resourceItems[index]) {
                    const icon = resourceItems[index].querySelector('.resource-icon');
                    const name = resourceItems[index].querySelector('.resource-name');
                    const description = resourceItems[index].querySelector('.resource-description');
                    
                    if (icon) icon.setAttribute('data-lucide', resource.icon);
                    if (name) name.textContent = resource.name;
                    if (description) description.textContent = resource.description;
                }
            });
            
            // Update subsection
            if (resourceSubsection) {
                const subsectionTitle = resourceSubsection.querySelector('.subsection-title');
                const resourceLinks = resourceSubsection.querySelectorAll('.resource-link span');
                
                const subsectionResource = businessResources.find(r => r.subsection);
                if (subsectionResource && subsectionTitle) {
                    subsectionTitle.textContent = subsectionResource.subsection;
                }
                
                if (subsectionResource && subsectionResource.links) {
                    subsectionResource.links.forEach((link, index) => {
                        if (resourceLinks[index]) {
                            resourceLinks[index].textContent = link;
                        }
                    });
                }
            }
            
            // Reinitialize Lucide icons after updating content
            lucide.createIcons();
        }
    }

    function updateAssistantPrompts(businessType, dateRange) {
        console.log('updateAssistantPrompts called with:', businessType, dateRange);
        
        // Add default values if parameters are missing
        businessType = businessType || 'growth';
        dateRange = dateRange || 'Last 90 days';
        
        const prompt1 = document.getElementById('prompt-1');
        const prompt2 = document.getElementById('prompt-2');
        const prompt3 = document.getElementById('prompt-3');
        
        console.log('Prompt elements found:', {
            prompt1: !!prompt1,
            prompt2: !!prompt2,
            prompt3: !!prompt3
        });
        
        if (!prompt1 || !prompt2 || !prompt3) {
            console.error('Prompt elements not found!');
            return;
        }
        
        // Get current metrics for context - using hardcoded values for now
        let successRate, volume, payments, failedVolume;
        
        try {
            const generator = new RealisticDataGenerator(businessType, dateRange);
            const allData = generator.generateAllData();
            successRate = allData.metrics.successRate;
            volume = allData.metrics.volume;
            payments = allData.metrics.payments;
            failedVolume = allData.metrics.failedVolume || 0;
    
        } catch (error) {
            console.error('Error generating data:', error);
            // Fallback to hardcoded values with new business types
            const fallbackData = {
                startup: { successRate: 78.5, volume: 1248, payments: 156, failedVolume: 341 },
                growth: { successRate: 85.2, volume: 12848, payments: 1247, failedVolume: 2152 },
                scale: { successRate: 91.7, volume: 89432, payments: 8943, failedVolume: 8068 },
                enterprise: { successRate: 94.8, volume: 156789, payments: 15678, failedVolume: 8234 }
            };
            const data = fallbackData[businessType] || fallbackData.growth;
            successRate = data.successRate;
            volume = data.volume;
            payments = data.payments;
            failedVolume = data.failedVolume;

        }
        
        // Ensure all values are valid numbers with safe defaults
        successRate = typeof successRate === 'number' && !isNaN(successRate) ? successRate : 85.0;
        volume = typeof volume === 'number' && !isNaN(volume) ? volume : 10000;
        payments = typeof payments === 'number' && !isNaN(payments) ? payments : 1000;
        failedVolume = typeof failedVolume === 'number' && !isNaN(failedVolume) ? failedVolume : 1000;
        
        // Business-specific prompt templates with professional tone
        const promptTemplates = {
            startup: {
                prompt1: `How can I improve my ${successRate.toFixed(1)}% authorization rate for the ${(dateRange || '').toLowerCase()}?`,
                prompt2: `What's causing my $${Math.round(failedVolume)} in failed payments for the ${(dateRange || '').toLowerCase()} and how can I reduce this?`,
                prompt3: `Are my current payment methods limiting my $${volume.toFixed(0)} volume for the ${(dateRange || '').toLowerCase()}?`
            },
            growth: {
                prompt1: `My authorization rate is ${successRate.toFixed(1)}% for the ${(dateRange || '').toLowerCase()}. What should I investigate?`,
                prompt2: `How can I recover the $${failedVolume.toFixed(0)} lost to failed payments this ${(dateRange || '').toLowerCase().replace('last ', '')}?`,
                prompt3: `What fraud prevention measures should I implement for ${payments} transactions in the ${(dateRange || '').toLowerCase()}?`
            },
            scale: {
                prompt1: `How can I optimize my ${successRate.toFixed(1)}% authorization rate for $${(volume/1000).toFixed(1)}k volume in the ${(dateRange || '').toLowerCase()}?`,
                prompt2: `Which payment methods are contributing to my $${failedVolume.toFixed(0)} in failed payments for the ${(dateRange || '').toLowerCase()}?`,
                prompt3: `What enterprise solutions can maximize conversion for ${payments.toLocaleString()} payments in the ${(dateRange || '').toLowerCase()}?`
            },
            enterprise: {
                prompt1: `How can I optimize my ${successRate.toFixed(1)}% authorization rate for $${(volume/1000).toFixed(1)}k volume in the ${(dateRange || '').toLowerCase()}?`,
                prompt2: `Which payment methods are contributing to my $${failedVolume.toFixed(0)} in failed payments for the ${(dateRange || '').toLowerCase()}?`,
                prompt3: `What enterprise solutions can maximize conversion for ${payments.toLocaleString()} payments in the ${(dateRange || '').toLowerCase()}?`
            }
        };
        
        const templates = promptTemplates[businessType] || promptTemplates.growth;
        
        // Update prompt text
        prompt1.textContent = templates.prompt1;
        prompt2.textContent = templates.prompt2;
        prompt3.textContent = templates.prompt3;
        
        console.log('Prompt text updated:', {
            prompt1: prompt1.textContent,
            prompt2: prompt2.textContent,
            prompt3: prompt3.textContent
        });
        
        // Add click handlers for AI panel
        prompt1.onclick = () => {
            openAIPanel(templates.prompt1, businessType, 'success-rate', successRate, dateRange, payments);
        };
        prompt2.onclick = () => {
            openAIPanel(templates.prompt2, businessType, 'failure-analysis', failedVolume, dateRange, payments);
        };
        prompt3.onclick = () => {
            openAIPanel(templates.prompt3, businessType, 'optimization', successRate, dateRange, payments);
        };
        
        console.log('Click handlers attached to prompts');
        
        // Enhanced debugging - log to console and add visual indicators
        console.log('=== PROMPT UPDATE COMPLETE ===');
        console.log('Business Type:', businessType);
        console.log('Date Range:', dateRange);
        console.log('Final Prompt 1:', prompt1.textContent);
        console.log('Final Prompt 2:', prompt2.textContent);
        console.log('Final Prompt 3:', prompt3.textContent);
        console.log('Prompt elements found:', !!prompt1, !!prompt2, !!prompt3);
        console.log('================================');
        
        // Force a DOM update by triggering a reflow
        prompt1.offsetHeight;
        prompt2.offsetHeight;
        prompt3.offsetHeight;
        

    }
    


    // Function to show professional assistant responses with business-specific advice
    function showAssistantResponse(businessType, topic, metric, dateRange, payments = null) {
        const responses = {
            'success-rate': {
                small: `Your ${metric.toFixed(1)}% authorization rate is within the expected range for businesses of your scale. To optimize further, consider expanding your payment method offerings to include digital wallets and local payment options. Additionally, ensure your checkout flow clearly communicates all fees and total amounts to reduce cart abandonment.`,
                medium: `The decline in your authorization rate to ${metric.toFixed(1)}% warrants investigation. Review your Radar fraud detection settings and 3D Secure configuration. For transactions exceeding $100, consider implementing step-up authentication. Analyze your decline codes to identify whether issues stem from fraud prevention or insufficient funds.`,
                large: `With your current volume, a ${metric.toFixed(1)}% authorization rate indicates strong performance, though there's room for optimization. Consider implementing regional payment methods for your primary markets and upgrading to machine learning-based fraud detection systems, as manual rules may not scale effectively with ${payments ? payments.toLocaleString() : 'large volume'} monthly transactions.`
            },
            'failure-analysis': {
                small: `Your failed payment volume of $${metric.toFixed(0)} represents a significant impact on revenue. Primary causes typically include insufficient funds, expired payment methods, and unclear pricing. Implement automatic retry logic with exponential backoff and consider pre-authorization for transactions over $50. Additionally, enable our Card Updater service to automatically refresh expired payment methods.`,
                medium: `The $${metric.toFixed(0)} in failed payments requires immediate attention. Implement intelligent retry logic with 24-hour intervals and review your decline code patterns. If you're experiencing high "do_not_honor" rates, your acquiring bank may have overly conservative risk parameters. Consider implementing 3D Secure for high-risk transactions and review your fraud detection thresholds.`,
                large: `Your failed payment volume of $${metric.toFixed(0)} necessitates a data-driven approach to optimization. Leverage your analytics to identify patterns across card types, geographic regions, and transaction amounts. Implement regional payment methods for your top markets and consider experiments with different fraud rule configurations. At your scale, even marginal improvements can yield significant revenue gains.`
            },
            'optimization': {
                small: `To improve your ${metric.toFixed(1)}% authorization rate, focus on foundational optimizations: diversify your payment method portfolio, ensure transparent pricing throughout the checkout process, and maintain excellent customer service. Consider implementing basic address verification while prioritizing user experience over complex fraud prevention measures.`,
                medium: `Your business has reached the scale where advanced optimization tools become valuable. Implement 3D Secure for transactions over $100, enable address verification, and deploy intelligent retry logic. Monitor fraud patterns weekly and consider implementing Radar rules for suspicious transaction patterns. Your ${payments} monthly payments provide sufficient data for meaningful trend analysis.`,
                large: `With ${payments.toLocaleString()} monthly payments, enterprise-grade solutions are essential. Implement machine learning-based fraud detection systems, as manual rules cannot effectively scale to your volume. Add regional payment methods for your top five markets and consider establishing a dedicated fraud management team. Utilize experiments to optimize conversion rateseven incremental improvements can generate substantial revenue increases.`
            }
        };
        
        const response = responses[topic][businessType];
        
        // Create a more sophisticated response display
        const responseDiv = document.createElement('div');
        responseDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;
        
        responseDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="width: 32px; height: 32px; background: var(--color-purple-500); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="sparkles" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--color-gray-900);">Assistant Response</h3>
            </div>
            <p style="margin: 0; line-height: 1.6; color: var(--color-gray-700); font-size: 13px;">${response}</p>
            <button onclick="this.parentElement.remove()" style="
                margin-top: 16px;
                padding: 8px 16px;
                background: var(--color-purple-500);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
            ">Got it</button>
        `;
        
        document.body.appendChild(responseDiv);
        lucide.createIcons();
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        `;
        backdrop.onclick = () => {
            backdrop.remove();
            responseDiv.remove();
        };
        document.body.appendChild(backdrop);
    }

    // AI Assistant Panel Functions - Optimized for Performance
    // Make openAIPanel globally available
    window.openAIPanel = function(question, businessType, topic, metric, dateRange, payments = null) {
        // Fast path - immediately show panel and add basic response
        const panel = document.getElementById('aiAssistantPanel');
        const mainContent = document.querySelector('.main-content');
        const topBar = document.querySelector('.top-bar');
        
        if (!panel || !mainContent || !topBar) {
            console.error('Required elements not found for AI panel');
            return;
        }
        
        // Hide any active tooltip
        hideTooltip();
        
        // Clear previous chat
        const chatContainer = document.getElementById('aiChatContainer');
        if (chatContainer) {
            chatContainer.innerHTML = '';
        }
        
        // Add user's question immediately
        addAIMessage('user', question);
        
        // Generate contextually appropriate responses based on the actual question and business type
        let responseMessage = '';
        let responsePills = [];
        
        console.log('openAIPanel called with topic:', topic, 'businessType:', businessType, 'metric:', metric);
        
        if (topic === 'success-rate') {
            // Response for authorization rate improvement questions
            responseMessage = `**AI Insight Analysis:** Your ${metric.toFixed(1)}% authorization rate shows ${metric < 85 ? 'room for improvement' : 'strong performance'} for the ${dateRange.toLowerCase()}.\n\n**Key Findings:**\n Industry benchmark for your business type: ${businessType === 'startup' ? '82-88%' : businessType === 'growth' ? '85-92%' : '88-95%'}\n Current performance: ${metric.toFixed(1)}%\n Gap to benchmark: ${Math.max(0, (businessType === 'startup' ? 85 : businessType === 'growth' ? 88 : 90) - metric).toFixed(1)}%\n\n**Optimization Opportunities:**\n **Smart Retries** could improve rates by **1.5-2.5%**\n **3D Secure optimization** could add another **0.8-1.2%**\n **Payment method diversification** could contribute **1.0-1.8%**\n\n**Immediate Actions:**\n Review decline code patterns for the ${dateRange.toLowerCase()}\n Enable automatic retry logic for failed payments\n Implement basic address verification\n Add multiple payment method options`;
            responsePills = [
                { text: "Review decline codes", icon: "bar-chart-2", type: "primary", action: "view-decline-codes" },
                { text: "Enable smart retries", icon: "refresh-cw", type: "secondary", action: "enable-retries" },
                { text: "Add payment methods", icon: "credit-card", type: "secondary", action: "add-payment-methods" }
            ];
        } else if (topic === 'failure-analysis') {
            // Response for failed payment recovery questions
            responseMessage = `**AI Insight Analysis:** Your $${metric.toFixed(0)} in failed payments for the ${dateRange.toLowerCase()} represents a significant revenue opportunity.\n\n**Recovery Potential:**\n **Smart retry logic** can recover **15-25%** of failed payments\n **Payment method expansion** can reduce failures by **8-15%**\n **Checkout optimization** can prevent **5-12%** of failures\n\n**Expected Revenue Recovery:**\n Conservative estimate: $${(metric * 0.15).toFixed(0)} - $${(metric * 0.25).toFixed(0)}\n Optimistic estimate: $${(metric * 0.28).toFixed(0)} - $${(metric * 0.40).toFixed(0)}\n\n**Immediate Actions:**\n Implement intelligent retry logic with 24-hour intervals\n Review decline code patterns to identify root causes\n Add alternative payment methods for your top markets\n Enable Card Updater service for expired payment methods`;
            responsePills = [
                { text: "Enable smart retries", icon: "refresh-cw", type: "primary", action: "enable-retries" },
                { text: "Review decline codes", icon: "bar-chart-2", type: "secondary", action: "view-decline-codes" },
                { text: "Add payment methods", icon: "credit-card", type: "secondary", action: "add-payment-methods" }
            ];
        } else if (topic === 'german-card-diagnosis') {
            // Response for German card auth rate drop diagnosis
            console.log('German card diagnosis case triggered');
            responseMessage = `**AI Insight Analysis:** Your auth rate for German cards dropped 3.8% in the last 24 hours. This appears to be due to a specific issuing bank (Commerzbank) declining transactions with error code 'insufficient_funds' at 2.5x normal rate.\n\n**Root Cause Analysis:**\n **Bank-specific issue:** Commerzbank is declining 15.2% of transactions vs. 6.1% normally\n **Error pattern:** 78% of declines show 'insufficient_funds' error code\n **Geographic scope:** Affects 23% of your German transaction volume\n **Revenue impact:** Estimated $2,400 in declined transactions\n\n**Recommended Solution:**\nImplementing **Adaptive Acceptance** would likely improve auth rates by **1.2%** by dynamically routing these transactions through alternate networks.\n\n**Expected Outcome:**\n Recover $1,680 of declined transactions\n Improve overall German market auth rate to 89.1%\n Reduce dependency on single bank network`;
            responsePills = [
                { text: "Adaptive Acceptance", icon: "settings", type: "primary", action: "enable-adaptive-acceptance" },
                { text: "View decline details", icon: "bar-chart-2", type: "secondary", action: "view-decline-details" },
                { text: "Contact Commerzbank", icon: "message-circle", type: "secondary", action: "contact-bank" }
            ];
        } else if (topic === 'optimization') {
            // Response for fraud prevention and optimization questions
            responseMessage = `**AI Insight Analysis:** For ${payments.toLocaleString()} transactions in the ${dateRange.toLowerCase()}, implementing fraud prevention measures can significantly improve your bottom line.\n\n**Current Risk Assessment:**\n Transaction volume: ${payments.toLocaleString()} payments\n Recommended fraud prevention level: ${businessType === 'startup' ? 'Basic' : businessType === 'growth' ? 'Enhanced' : 'Advanced'}\n Expected fraud rate reduction: **40-60%**\n\n**Recommended Measures:**\n **3D Secure 2.0** for transactions over $${businessType === 'startup' ? '50' : businessType === 'growth' ? '100' : '75'}\n **Address verification** for all transactions\n **IP geolocation** for high-risk regions\n **Device fingerprinting** for suspicious patterns\n\n**Implementation Priority:**\n Phase 1: Basic fraud rules and 3D Secure\n Phase 2: Advanced analytics and machine learning\n Phase 3: Regional payment methods and compliance`;
            responsePills = [
                { text: "Configure 3D Secure", icon: "shield-check", type: "primary", action: "configure-3ds" },
                { text: "Set fraud rules", icon: "shield-alert", type: "secondary", action: "set-fraud-rules" },
                { text: "View analytics", icon: "bar-chart-3", type: "secondary", action: "view-analytics" }
            ];
        } else {
            // Fallback response for other topics
            responseMessage = `**AI Insight Analysis:** Based on your ${businessType} business profile and ${dateRange.toLowerCase()} data, I can help optimize your payment performance.\n\n**Current Metrics:**\n Authorization rate: ${metric.toFixed(1)}%\n Failed payment volume: $${metric.toFixed(0)}\n Transaction count: ${payments ? payments.toLocaleString() : 'N/A'}\n\n**How I Can Help:**\n Analyze decline patterns and identify optimization opportunities\n Recommend fraud prevention strategies tailored to your business\n Suggest payment method improvements for better conversion\n Provide actionable insights for immediate implementation`;
            responsePills = [
                { text: "Analyze performance", icon: "bar-chart-2", type: "primary", action: "analyze-performance" },
                { text: "View recommendations", icon: "lightbulb", type: "secondary", action: "view-recommendations" },
                { text: "Schedule consultation", icon: "calendar", type: "secondary", action: "schedule-consultation" }
            ];
        }
        
        // Add AI response immediately
        addAIMessage('assistant', responseMessage, responsePills);
        
        // Store context for follow-up questions
        panel.dataset.businessType = businessType;
        panel.dataset.topic = topic;
        panel.dataset.metric = metric;
        panel.dataset.dateRange = dateRange;
        panel.dataset.payments = payments;
        
        // Open panel immediately
        panel.classList.add('open');
        mainContent.classList.add('ai-panel-open');
        topBar.classList.add('ai-panel-open');
        
        // Focus on input with minimal delay
        setTimeout(() => {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.focus();
            }
        }, 100);
    }

    // Make closeAIPanel globally available
    window.closeAIPanel = function() {
        const panel = document.getElementById('aiAssistantPanel');
        const mainContent = document.querySelector('.main-content');
        const topBar = document.querySelector('.top-bar');
        
        // Close panel and restore layout
        panel.classList.remove('open');
        mainContent.classList.remove('ai-panel-open');
        topBar.classList.remove('ai-panel-open');
    }

    // Lo-fi Mode Toggle Function
    function toggleLofiMode() {
        const toggle = document.querySelector('.toggle-switch');
        const isActive = toggle.classList.contains('active');
        
        if (isActive) {
            // Disable lo-fi mode
            toggle.classList.remove('active');
            document.body.classList.remove('lofi-mode');
            restoreOriginalContent();
        } else {
            // Enable lo-fi mode
            toggle.classList.add('active');
            document.body.classList.add('lofi-mode');
            convertToSkeletonMode();
        }
    }

    function convertToSkeletonMode() {
        // Performance stats at the top
        const performanceStats = document.querySelector('.performance-stats');
        if (performanceStats) {
            const originalContent = performanceStats.innerHTML;
            performanceStats.dataset.originalContent = originalContent;
            performanceStats.innerHTML = `
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-block skeleton-stat-card">
                    <div class="skeleton-stat-value"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
            `;
        }

        // Payment lifecycle waterfall chart
        const waterfallChart = document.querySelector('.waterfall-chart');
        if (waterfallChart) {
            const originalContent = waterfallChart.innerHTML;
            waterfallChart.dataset.originalContent = originalContent;
            waterfallChart.innerHTML = `
                <div class="skeleton-block skeleton-waterfall">
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                    <div class="skeleton-waterfall-item">
                        <div class="skeleton-waterfall-bar"></div>
                        <div class="skeleton-waterfall-label"></div>
                        <div class="skeleton-waterfall-details">
                            <div class="skeleton-detail-value"></div>
                            <div class="skeleton-detail-rate"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Key metrics - preserve header, skeleton only the content
        const metricsSection = document.querySelector('.performance-snapshot');
        if (metricsSection) {
            const originalContent = metricsSection.innerHTML;
            metricsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = metricsSection.querySelector('.snapshot-title');
            const headerHTML = header ? header.outerHTML : '';
            
            metricsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-metrics-grid">
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-metric-card">
                        <div class="skeleton-metric-header">
                            <div class="skeleton-metric-title"></div>
                            <div class="skeleton-metric-value"></div>
                        </div>
                        <div class="skeleton-metric-chart">
                            <div class="skeleton-chart-y-axis">
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                                <div class="skeleton-axis-label"></div>
                            </div>
                            <div class="skeleton-chart-area">
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                                <div class="skeleton-chart-line"></div>
                            </div>
                            <div class="skeleton-chart-legend">
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                                <div class="skeleton-legend-item"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Recommendations - preserve header, skeleton only the content
        const recommendationsSection = document.querySelector('.optimization-opportunities');
        if (recommendationsSection) {
            const originalContent = recommendationsSection.innerHTML;
            recommendationsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = recommendationsSection.querySelector('.opportunities-header');
            const headerHTML = header ? header.outerHTML : '';
            
            recommendationsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-opportunity-title"></div>
                            <div class="skeleton-opportunity-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-revenue"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-effort-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Experiments - preserve header, skeleton only the content
        const experimentsSection = document.querySelector('.ab-testing-section');
        if (experimentsSection) {
            const originalContent = experimentsSection.innerHTML;
            experimentsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = experimentsSection.querySelector('.ab-header');
            const headerHTML = header ? header.outerHTML : '';
            
            experimentsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                        <div class="skeleton-table-th"></div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-test-title"></div>
                            <div class="skeleton-test-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-status-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-progress-bar"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-improvement"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                    <div class="skeleton-table-row">
                        <div class="skeleton-table-td">
                            <div class="skeleton-test-title"></div>
                            <div class="skeleton-test-desc"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-status-badge"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-progress-bar"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-rate-value"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-improvement"></div>
                        </div>
                        <div class="skeleton-table-td">
                            <div class="skeleton-action-btn"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Optimization journey - preserve header, skeleton only the content
        const timelineSection = document.querySelector('.progress-timeline');
        if (timelineSection) {
            const originalContent = timelineSection.innerHTML;
            timelineSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = timelineSection.querySelector('.timeline-header');
            const headerHTML = header ? header.outerHTML : '';
            
            timelineSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-timeline">
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-timeline-dot"></div>
                        <div class="skeleton-timeline-content">
                            <div class="skeleton-timeline-title"></div>
                            <div class="skeleton-timeline-subtitle"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Performance insights - preserve header, skeleton only the content
        const insightsSection = document.querySelector('.performance-insights');
        if (insightsSection) {
            const originalContent = insightsSection.innerHTML;
            insightsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = insightsSection.querySelector('.insights-header');
            const headerHTML = header ? header.outerHTML : '';
            
            insightsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-insights">
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                    <div class="skeleton-insight-item">
                        <div class="skeleton-insight-icon"></div>
                        <div class="skeleton-insight-text"></div>
                    </div>
                </div>
            `;
        }

        // Quick actions - preserve header, skeleton only the content
        const actionsSection = document.querySelector('.quick-actions');
        if (actionsSection) {
            const originalContent = actionsSection.innerHTML;
            actionsSection.dataset.originalContent = originalContent;
            
            // Find and preserve the header
            const header = actionsSection.querySelector('.actions-header');
            const headerHTML = header ? header.outerHTML : '';
            
            actionsSection.innerHTML = `
                ${headerHTML}
                <div class="skeleton-block skeleton-actions">
                    <div class="skeleton-action-button"></div>
                    <div class="skeleton-action-button"></div>
                    <div class="skeleton-action-button"></div>
                </div>
            `;
        }

        // Acceptance page sections - exclude key metrics, ask assistant, and line chart UI
        // Only apply to acceptance page elements when on acceptance tab
        const isAcceptancePage = document.querySelector('.nav-tab.active')?.textContent === 'Acceptance';
        
        if (isAcceptancePage) {
            // Page filters - convert to skeleton mode
            const filterRows = document.querySelectorAll('.filter-row');
            filterRows.forEach((filterRow, index) => {
                const originalContent = filterRow.innerHTML;
                filterRow.dataset.originalContent = originalContent;
                
                if (index === 0) {
                    // First filter row (date range, deduplicated, etc.)
                    filterRow.innerHTML = `
                        <div class="skeleton-block skeleton-filter-row">
                            <div class="skeleton-filter-btn"></div>
                            <div class="skeleton-filter-btn"></div>
                            <div class="skeleton-filter-btn"></div>
                            <div class="skeleton-filter-btn"></div>
                        </div>
                    `;
                } else {
                    // Second filter row (processor, card type, etc.)
                    filterRow.innerHTML = `
                        <div class="skeleton-block skeleton-filter-chips">
                            <div class="skeleton-filter-chip"></div>
                            <div class="skeleton-filter-chip"></div>
                            <div class="skeleton-filter-chip"></div>
                            <div class="skeleton-filter-chip"></div>
                            <div class="skeleton-filter-chip"></div>
                            <div class="skeleton-filter-chip"></div>
                        </div>
                    `;
                }
            });

            // Chart container (main performance chart) - EXCLUDED from lo-fi mode
            // Left intentionally unchanged to preserve line chart UI

            // Card payments breakdown section - preserve header, skeleton content
            const breakdownSections = document.querySelectorAll('.breakdown-section');
            breakdownSections.forEach((breakdownSection, index) => {
                const originalContent = breakdownSection.innerHTML;
                breakdownSection.dataset.originalContent = originalContent;
                
                // Find and preserve the header title and subtitle, but skeleton the controls
                const header = breakdownSection.querySelector('.breakdown-header');
                const titleSection = header?.querySelector('.breakdown-title-section');
                const titleHTML = titleSection ? titleSection.outerHTML : '';
                
                breakdownSection.innerHTML = `
                    <div class="breakdown-header">
                        ${titleHTML}
                        <div class="breakdown-controls">
                            <div class="skeleton-block skeleton-breakdown-filters">
                                <div class="skeleton-filter-btn"></div>
                                <div class="skeleton-filter-btn"></div>
                                <div class="skeleton-filter-btn"></div>
                                <div class="skeleton-filter-btn"></div>
                            </div>
                            <div class="skeleton-block skeleton-breakdown-dropdowns">
                                <div class="skeleton-dropdown-btn"></div>
                                <div class="skeleton-download-btn"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-block skeleton-breakdown-total">
                        <div class="skeleton-total-label"></div>
                        <div class="skeleton-total-value"></div>
                    </div>
                    <div class="skeleton-block skeleton-bar-chart">
                        <div class="skeleton-bar-chart-y-axis">
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                        </div>
                        <div class="skeleton-bar-chart-area">
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                            <div class="skeleton-bar"></div>
                        </div>
                        <div class="skeleton-bar-chart-x-axis">
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                            <div class="skeleton-axis-label"></div>
                        </div>
                    </div>
                    <div class="skeleton-block skeleton-data-table">
                        <div class="skeleton-table-header">
                            <div class="skeleton-table-th"></div>
                            <div class="skeleton-table-th"></div>
                            <div class="skeleton-table-th"></div>
                            <div class="skeleton-table-th"></div>
                            <div class="skeleton-table-th"></div>
                            <div class="skeleton-table-th"></div>
                        </div>
                        <div class="skeleton-table-row">
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                        </div>
                        <div class="skeleton-table-row">
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                        </div>
                        <div class="skeleton-table-row">
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                            <div class="skeleton-table-td"></div>
                        </div>
                    </div>
                `;
            });

            // Resources section - preserve header, skeleton content (only in right column)
            const rightColumn = document.querySelector('.right-column');
            if (rightColumn) {
                const resourcesSection = rightColumn.querySelector('.resources-section');
                if (resourcesSection) {
                    const originalContent = resourcesSection.innerHTML;
                    resourcesSection.dataset.originalContent = originalContent;
                    
                    // Find and preserve the header
                    const header = resourcesSection.querySelector('.resources-title');
                    const headerHTML = header ? header.outerHTML : '';
                    
                    resourcesSection.innerHTML = `
                        ${headerHTML}
                        <div class="skeleton-block skeleton-resource-item">
                            <div class="skeleton-resource-icon"></div>
                            <div class="skeleton-resource-content">
                                <div class="skeleton-resource-name"></div>
                                <div class="skeleton-resource-description"></div>
                            </div>
                        </div>
                        <div class="skeleton-block skeleton-resource-subsection">
                            <div class="skeleton-subsection-title"></div>
                            <div class="skeleton-resource-link">
                                <div class="skeleton-arrow-icon"></div>
                                <div class="skeleton-link-text"></div>
                            </div>
                            <div class="skeleton-resource-link">
                                <div class="skeleton-arrow-icon"></div>
                                <div class="skeleton-link-text"></div>
                            </div>
                        </div>
                    `;
                }
            }
        }
    }

    function restoreOriginalContent() {
        // Restore all sections to their original content
        const sections = [
            '.performance-stats',
            '.waterfall-chart',
            '.performance-snapshot',
            '.optimization-opportunities',
            '.ab-testing-section',
            '.progress-timeline',
            '.performance-insights',
            '.quick-actions'
        ];

        sections.forEach(selector => {
            const section = document.querySelector(selector);
            if (section && section.dataset.originalContent) {
                section.innerHTML = section.dataset.originalContent;
                delete section.dataset.originalContent;
            }
        });

        // Handle acceptance page sections specifically
        const isAcceptancePage = document.querySelector('.nav-tab.active')?.textContent === 'Acceptance';
        if (isAcceptancePage) {
            // Chart container is excluded from lo-fi mode, so no restoration needed

            // Restore page filters
            const filterRows = document.querySelectorAll('.filter-row');
            filterRows.forEach(section => {
                if (section && section.dataset.originalContent) {
                    section.innerHTML = section.dataset.originalContent;
                    delete section.dataset.originalContent;
                }
            });

            // Restore breakdown sections
            const breakdownSections = document.querySelectorAll('.breakdown-section');
            breakdownSections.forEach(section => {
                if (section && section.dataset.originalContent) {
                    section.innerHTML = section.dataset.originalContent;
                    delete section.dataset.originalContent;
                }
            });

            // Restore resources section in right column
            const rightColumn = document.querySelector('.right-column');
            if (rightColumn) {
                const resourcesSection = rightColumn.querySelector('.resources-section');
                if (resourcesSection && resourcesSection.dataset.originalContent) {
                    resourcesSection.innerHTML = resourcesSection.dataset.originalContent;
                    delete resourcesSection.dataset.originalContent;
                }
            }
        }
    }

    function parseMarkdown(text) {
        // Clean up extra whitespace and normalize line breaks
        text = text.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // Parse section headers (like "**Current Situation:**")
        text = text.replace(/\*\*(.*?):\*\*/g, '<h4 style="margin: 12px 0 8px 0; font-size: 13px; font-weight: 600; color: var(--color-gray-900);">$1:</h4>');
        
        // Parse bold text (**text**) - but not headers
        text = text.replace(/\*\*(?!.*:)(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Parse bullet points ( text) - handle multiple lines
        const lines = text.split('\n');
        let inList = false;
        let processedLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.startsWith('')) {
                if (!inList) {
                    processedLines.push('<ul style="margin: 8px 0; padding-left: 16px;">');
                    inList = true;
                }
                const listItem = line.replace(/^\s*/, '');
                processedLines.push(`<li style="margin: 4px 0; line-height: 1.4; font-size: 13px; position: relative; padding-left: 8px;">${listItem}</li>`);
            } else if (line === '') {
                if (inList) {
                    processedLines.push('</ul>');
                    inList = false;
                }
                // Don't add extra breaks for empty lines
            } else {
                if (inList) {
                    processedLines.push('</ul>');
                    inList = false;
                }
                if (line) {
                    processedLines.push(`<p style="margin: 0 0 10px 0; line-height: 1.5; font-size: 13px;">${line}</p>`);
                }
            }
        }
        
        // Close any open list
        if (inList) {
            processedLines.push('</ul>');
        }
        
        text = processedLines.join('');
        
        // Clean up empty paragraphs and extra spacing
        text = text.replace(/<p[^>]*>\s*<\/p>/g, '');
        text = text.replace(/(<\/p>)\s*(<p[^>]*>)/g, '$1$2');
        
        return text;
    }

    function addAIMessage(sender, content, followUpPills = []) {
        const chatContainer = document.getElementById('aiChatContainer');
        if (!chatContainer) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = `ai-message-avatar ${sender}`;
        avatar.innerHTML = sender === 'assistant' ? '<i data-lucide="sparkles" style="width: 14px; height: 14px;"></i>' : '<i data-lucide="user"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'ai-message-content';
        
        const bubble = document.createElement('div');
        bubble.className = `ai-message-bubble ${sender}`;
        
        // Parse markdown for assistant messages
        if (sender === 'assistant') {
            bubble.innerHTML = parseMarkdown(content);
        } else {
            bubble.innerHTML = content;
        }
        
        contentDiv.appendChild(bubble);
        
        // Add follow-up pills if provided
        if (followUpPills && followUpPills.length > 0) {
            const pillsContainer = document.createElement('div');
            pillsContainer.className = 'ai-prompt-pills';
            
            followUpPills.forEach(pill => {
                const pillElement = document.createElement('button');
                pillElement.className = `ai-prompt-pill ${pill.type || 'secondary'}`;
                pillElement.innerHTML = `
                    ${pill.icon ? `<i data-lucide="${pill.icon}"></i>` : ''}
                    ${pill.text}
                `;
                pillElement.onclick = () => {
                    console.log('Pill clicked:', pill);
                    
                    // Special handling for enable-retry action to open experiment drawer
                    if (pill.action === 'enable-retry') {
                        console.log('Smart Retries clicked, opening experiment drawer...');
                        
                        // Close AI panel first to avoid conflicts
                        closeAIPanel();
                        
                        const experimentData = {
                            id: 'smart-retries',
                            title: 'Smart Retries',
                            description: 'Enable intelligent retry logic for declined payments to recover lost revenue.',
                            uplift: 1.5,
                            revenue: '+$18,900/year',
                            effort: 'Easy (30 minute setup)'
                        };
                        
                        console.log('Smart Retries experiment data:', experimentData);
                        
                        // Add a small delay to ensure AI panel is closed
                        setTimeout(() => {
                            openExperimentDrawer(experimentData);
                        }, 100);
                        
                        return;
                    }
                    
                    // Special handling for smart-retries action to open experiment drawer
                    if (pill.action === 'smart-retries') {
                        console.log('Smart retries action detected, opening experiment drawer...');
                        // Close AI panel first to avoid conflicts
                        closeAIPanel();
                        
                        const experimentData = {
                            id: 'smart-retries',
                            title: 'Smart Retries',
                            description: 'Automatically retry failed payments with intelligent timing and bank-specific strategies to recover lost revenue.',
                            impact: 'High',
                            effort: 'Medium',
                            category: 'Payment Optimization',
                            status: 'recommended',
                            metrics: {
                                successRate: 85.2,
                                revenueIncrease: 15,
                                timeToImplement: '2-3 days'
                            }
                        };
                        console.log('Experiment data:', experimentData);
                        
                        // Add a small delay to ensure AI panel is closed
                        setTimeout(() => {
                            openExperimentDrawer(experimentData);
                        }, 100);
                    } else if (pill.action === 'enable-adaptive-acceptance') {
                        // Handle Adaptive Acceptance action
                        console.log('Adaptive Acceptance clicked, enabling feature...');
                        handleAIAction(pill.action);
                    } else if (pill.action === 'ask-follow-up') {
                        addAIMessage('user', pill.text);
                        sendAIMessage(pill.text);
                    } else if (pill.action === 'contact-support') {
                        // Handle contact support action
                        console.log('Contact support clicked');
                    } else {
                        // Default action handling
                        console.log('Default pill action:', pill.action);
                        addAIMessage('user', pill.text);
                        sendAIMessage(pill.text);
                    }
                };
                pillsContainer.appendChild(pillElement);
            });
            
            contentDiv.appendChild(pillsContainer);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);
        
        // Reset animation for the new message
        messageDiv.style.animation = 'none';
        messageDiv.offsetHeight; // Trigger reflow
        messageDiv.style.animation = 'messageSlideIn 0.4s ease-out forwards';
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Reinitialize lucide icons
        lucide.createIcons();
    }

    // Function to handle AI action responses
    function handleAIAction(action) {
        console.log('handleAIAction called with action:', action);
        
        // Generate contextual response based on action
        const actionResponses = {
            'enable-adaptive-acceptance': {
                message: "Adaptive Acceptance was successfully enabled! This feature will now dynamically route transactions through alternate networks when primary networks decline them, helping to improve your authorization rates.",
                pills: [
                    { text: "View performance", icon: "bar-chart-2", type: "primary", action: "view-performance" },
                    { text: "Configure settings", icon: "settings", type: "secondary", action: "configure-settings" },
                    { text: "Monitor results", icon: "activity", type: "secondary", action: "monitor-results" }
                ]
            },
            'view-decline-details': {
                message: "Here's a detailed breakdown of your recent decline patterns. The data shows that Commerzbank declines are concentrated in the 50-200 range with 'insufficient_funds' errors.",
                pills: [
                    { text: "Export report", icon: "download", type: "primary", action: "export-report" },
                    { text: "Set up alerts", icon: "bell", type: "secondary", action: "setup-alerts" },
                    { text: "Contact bank", icon: "message-circle", type: "secondary", action: "contact-bank" }
                ]
            },
            'contact-bank': {
                message: "I'll help you prepare the information needed to contact Commerzbank about the increased decline rates. This includes your transaction patterns and decline analysis.",
                pills: [
                    { text: "Prepare report", icon: "file-text", type: "primary", action: "prepare-report" },
                    { text: "Schedule call", icon: "phone", type: "secondary", action: "schedule-call" },
                    { text: "View contact info", icon: "info", type: "secondary", action: "view-contact" }
                ]
            },
            'view-performance': {
                message: "Here's your current performance dashboard showing the impact of Adaptive Acceptance. You should see improvements in your German market authorization rates within the next 24-48 hours.",
                pills: [
                    { text: "View metrics", icon: "bar-chart-2", type: "primary", action: "view-metrics" },
                    { text: "Set up alerts", icon: "bell", type: "secondary", action: "setup-alerts" },
                    { text: "Export report", icon: "download", type: "secondary", action: "export-report" }
                ]
            },
            'configure-settings': {
                message: "Let's configure your Adaptive Acceptance settings to optimize for your specific decline patterns. I'll help you set the right thresholds and routing rules.",
                pills: [
                    { text: "Configure rules", icon: "settings", type: "primary", action: "configure-rules" },
                    { text: "Test settings", icon: "test-tube", type: "secondary", action: "test-settings" },
                    { text: "View defaults", icon: "info", type: "secondary", action: "view-defaults" }
                ]
            },
            'monitor-results': {
                message: "I'll help you set up monitoring for your Adaptive Acceptance implementation. This will track performance improvements and alert you to any issues.",
                pills: [
                    { text: "Set up monitoring", icon: "activity", type: "primary", action: "setup-monitoring" },
                    { text: "View alerts", icon: "bell", type: "secondary", action: "view-alerts" },
                    { text: "Schedule review", icon: "calendar", type: "secondary", action: "schedule-review" }
                ]
            }
        };
        
        const response = actionResponses[action] || {
            message: "I understand you're interested in this feature. Let me provide you with the next steps to get started.",
            pills: [
                { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" },
                { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" }
            ]
        };
        
        setTimeout(() => {
            addAIMessage('assistant', response.message, response.pills);
        }, 500);
    }

    function handlePillAction(action, pillText) {
        const panel = document.getElementById('aiAssistantPanel');
        const businessType = panel.dataset.businessType;
        
        // Add user's pill selection as a message
        addAIMessage('user', `I'd like to ${pillText.toLowerCase()}`);
        
        // Generate contextual response based on action
        const actionResponses = {
            'enable-3ds': {
                message: "Great choice! 3D Secure adds an extra layer of security and can improve your authorization rates. Let me guide you through the setup process.",
                pills: [
                    { text: "View setup guide", icon: "file-text", type: "primary", action: "view-setup-guide" },
                    { text: "Enable now", icon: "play", type: "secondary", action: "enable-feature" },
                    { text: "Learn more", icon: "info", type: "secondary", action: "learn-more" }
                ]
            },
            'configure-radar': {
                message: "Radar is our machine learning fraud detection system. I'll help you configure it for optimal performance with your transaction volume.",
                pills: [
                    { text: "Configure rules", icon: "settings", type: "primary", action: "configure-rules" },
                    { text: "View dashboard", icon: "bar-chart", type: "secondary", action: "view-dashboard" },
                    { text: "Best practices", icon: "file-text", type: "secondary", action: "best-practices" }
                ]
            },
            'enable-ml-fraud': {
                message: "Perfect! At your scale, machine learning fraud detection will significantly improve your fraud prevention while reducing false positives.",
                pills: [
                    { text: "Start setup", icon: "play", type: "primary", action: "start-setup" },
                    { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" },
                    { text: "Enterprise pricing", icon: "dollar-sign", type: "secondary", action: "pricing" }
                ]
            },
            'enable-retry': {
                message: "Smart retry logic can recover up to 15% of failed payments. Let's configure it based on your decline patterns.",
                pills: [
                    { text: "Configure retry", icon: "settings", type: "primary", action: "configure-retry" },
                    { text: "View patterns", icon: "bar-chart", type: "secondary", action: "view-patterns" },
                    { text: "Test settings", icon: "test-tube", type: "secondary", action: "test-retry" }
                ]
            },
            'smart-retry': {
                message: "Intelligent retry logic uses machine learning to determine the optimal retry timing and frequency for each transaction.",
                pills: [
                    { text: "Enable smart retry", icon: "play", type: "primary", action: "enable-smart-retry" },
                    { text: "Configure rules", icon: "settings", type: "secondary", action: "configure-rules" },
                    { text: "Monitor results", icon: "bar-chart", type: "secondary", action: "monitor-results" }
                ]
            },
            'data-analysis': {
                message: "Let's analyze your failed payment patterns to identify optimization opportunities. I'll help you set up comprehensive reporting.",
                pills: [
                    { text: "Run analysis", icon: "bar-chart", type: "primary", action: "run-analysis" },
                    { text: "Export data", icon: "download", type: "secondary", action: "export-data" },
                    { text: "Schedule review", icon: "calendar", type: "secondary", action: "schedule-review" }
                ]
            },
            'add-payment-methods': {
                message: "Adding more payment methods can increase your conversion rates by 15-20%. Let's explore options for your business.",
                pills: [
                    { text: "Browse methods", icon: "credit-card", type: "primary", action: "browse-methods" },
                    { text: "Integration guide", icon: "file-text", type: "secondary", action: "integration-guide" },
                    { text: "Compare costs", icon: "dollar-sign", type: "secondary", action: "compare-costs" }
                ]
            },
            'advanced-3ds': {
                message: "Advanced 3D Secure configuration allows you to customize authentication flows based on transaction risk and amount.",
                pills: [
                    { text: "Configure flows", icon: "settings", type: "primary", action: "configure-flows" },
                    { text: "Risk assessment", icon: "shield", type: "secondary", action: "risk-assessment" },
                    { text: "Test scenarios", icon: "test-tube", type: "secondary", action: "test-scenarios" }
                ]
            },
            'ml-fraud': {
                message: "Machine learning fraud detection adapts to your business patterns and provides real-time protection with minimal false positives.",
                pills: [
                    { text: "Start trial", icon: "play", type: "primary", action: "start-trial" },
                    { text: "Technical demo", icon: "monitor", type: "secondary", action: "technical-demo" },
                    { text: "ROI calculator", icon: "calculator", type: "secondary", action: "roi-calculator" }
                ]
            },
            'contact-support': {
                message: "I'll connect you with our support team who can provide personalized assistance for your specific needs.",
                pills: [
                    { text: "Chat with support", icon: "message-circle", type: "primary", action: "chat-support" },
                    { text: "Schedule call", icon: "phone", type: "secondary", action: "schedule-call" },
                    { text: "Email support", icon: "mail", type: "secondary", action: "email-support" }
                ]
            },
            'view-docs': {
                message: "Here are the most relevant documentation resources for your current situation. I've curated them based on your business type and metrics.",
                pills: [
                    { text: "Best practices", icon: "file-text", type: "primary", action: "best-practices" },
                    { text: "API reference", icon: "code", type: "secondary", action: "api-reference" },
                    { text: "Case studies", icon: "book-open", type: "secondary", action: "case-studies" }
                ]
            },
            'ab-test': {
                message: "Experiments can help you optimize your payment flows. Let's set up an experiment to compare different configurations.",
                pills: [
                    { text: "Create test", icon: "test-tube", type: "primary", action: "create-test" },
                    { text: "View templates", icon: "file-text", type: "secondary", action: "view-templates" },
                    { text: "Analyze results", icon: "bar-chart", type: "secondary", action: "analyze-results" }
                ]
            },
            'enable-adaptive-acceptance': {
                message: "Adaptive Acceptance was successfully enabled! This feature will now dynamically route transactions through alternate networks when primary networks decline them, helping to improve your authorization rates.",
                pills: [
                    { text: "View performance", icon: "bar-chart-2", type: "primary", action: "view-performance" },
                    { text: "Configure settings", icon: "settings", type: "secondary", action: "configure-settings" },
                    { text: "Monitor results", icon: "activity", type: "secondary", action: "monitor-results" }
                ]
            },
            'view-fraud-rules': {
                message: "Here are your current fraud rules and recent updates. I can help you review and adjust them to optimize for your primary markets.",
                pills: [
                    { text: "Review rules", icon: "shield", type: "primary", action: "review-rules" },
                    { text: "Adjust settings", icon: "settings", type: "secondary", action: "adjust-settings" },
                    { text: "Test rules", icon: "test-tube", type: "secondary", action: "test-rules" }
                ]
            },
            'view-3ds': {
                message: "Here's your current 3D Secure configuration and recent authentication data. I can help you review the SCA requirements and optimize your 3DS flows for your primary markets.",
                pills: [
                    { text: "Review config", icon: "settings", type: "primary", action: "review-config" },
                    { text: "Check SCA status", icon: "shield-check", type: "secondary", action: "check-sca" },
                    { text: "Test flows", icon: "test-tube", type: "secondary", action: "test-flows" }
                ]
            },
            'view-decline-details': {
                message: "Here's a detailed breakdown of your recent decline patterns. The data shows that Commerzbank declines are concentrated in the 50-200 range with 'insufficient_funds' errors.",
                pills: [
                    { text: "Export report", icon: "download", type: "primary", action: "export-report" },
                    { text: "Set up alerts", icon: "bell", type: "secondary", action: "setup-alerts" },
                    { text: "Contact bank", icon: "message-circle", type: "secondary", action: "contact-bank" }
                ]
            },
            'contact-bank': {
                message: "I'll help you prepare the information needed to contact Commerzbank about the increased decline rates. This includes your transaction patterns and decline analysis.",
                pills: [
                    { text: "Prepare report", icon: "file-text", type: "primary", action: "prepare-report" },
                    { text: "Schedule call", icon: "phone", type: "secondary", action: "schedule-call" },
                    { text: "View contact info", icon: "info", type: "secondary", action: "view-contact" }
                ]
            },
            'view-performance': {
                message: "Here's your current performance dashboard showing the impact of Adaptive Acceptance. You should see improvements in your German market authorization rates within the next 24-48 hours.",
                pills: [
                    { text: "View metrics", icon: "bar-chart-2", type: "primary", action: "view-metrics" },
                    { text: "Set up alerts", icon: "bell", type: "secondary", action: "setup-alerts" },
                    { text: "Export report", icon: "download", type: "secondary", action: "export-report" }
                ]
            },
            'configure-settings': {
                message: "Let's configure your Adaptive Acceptance settings to optimize for your specific decline patterns. I'll help you set the right thresholds and routing rules.",
                pills: [
                    { text: "Configure rules", icon: "settings", type: "primary", action: "configure-rules" },
                    { text: "Test settings", icon: "test-tube", type: "secondary", action: "test-settings" },
                    { text: "View defaults", icon: "info", type: "secondary", action: "view-defaults" }
                ]
            },
            'monitor-results': {
                message: "I'll help you set up monitoring for your Adaptive Acceptance implementation. This will track performance improvements and alert you to any issues.",
                pills: [
                    { text: "Set up monitoring", icon: "activity", type: "primary", action: "setup-monitoring" },
                    { text: "View alerts", icon: "bell", type: "secondary", action: "view-alerts" },
                    { text: "Schedule review", icon: "calendar", type: "secondary", action: "schedule-review" }
                ]
            },
            'export-report': {
                message: "I'll generate a comprehensive report of your decline patterns and the impact of Adaptive Acceptance. This will include transaction data, decline analysis, and optimization recommendations.",
                pills: [
                    { text: "Download PDF", icon: "download", type: "primary", action: "download-pdf" },
                    { text: "Schedule delivery", icon: "calendar", type: "secondary", action: "schedule-delivery" },
                    { text: "Customize report", icon: "settings", type: "secondary", action: "customize-report" }
                ]
            },
            'setup-alerts': {
                message: "Let's configure alerts for your payment performance metrics. I'll help you set up notifications for significant changes in authorization rates, decline patterns, and revenue impact.",
                pills: [
                    { text: "Configure alerts", icon: "bell", type: "primary", action: "configure-alerts" },
                    { text: "Test notifications", icon: "test-tube", type: "secondary", action: "test-notifications" },
                    { text: "View alert history", icon: "clock", type: "secondary", action: "view-alert-history" }
                ]
            },
            'prepare-report': {
                message: "I'll help you prepare a comprehensive report for Commerzbank including your transaction patterns, decline analysis, and the impact on your business. This will help facilitate productive discussions.",
                pills: [
                    { text: "Generate report", icon: "file-text", type: "primary", action: "generate-report" },
                    { text: "Review data", icon: "bar-chart-2", type: "secondary", action: "review-data" },
                    { text: "Export findings", icon: "download", type: "secondary", action: "export-findings" }
                ]
            }
        };
        
        const response = actionResponses[action] || {
            message: "I understand you're interested in this feature. Let me provide you with the next steps to get started.",
            pills: [
                { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" },
                { text: "Schedule demo", icon: "calendar", type: "secondary", action: "schedule-demo" }
            ]
        };
        
        setTimeout(() => {
            addAIMessage('assistant', response.message, response.pills);
        }, 500);
    }

    function sendAIMessage() {
        const input = document.getElementById('aiInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        addAIMessage('user', message);
        
        // Clear input
        input.value = '';
        
        // Generate contextual AI response with follow-up pills
        setTimeout(() => {
            const panel = document.getElementById('aiAssistantPanel');
            const businessType = panel.dataset.businessType;
            const topic = panel.dataset.topic;
            
            let response = "I understand your question. Let me provide some additional insights based on your business context. ";
            
            if (businessType === 'startup') {
                response += "For startups like yours, it's important to focus on the fundamentals first. ";
            } else if (businessType === 'growth') {
                response += "At your growth stage, you have enough data to make informed decisions. ";
            } else if (businessType === 'scale') {
                response += "With your scale, advanced optimization and data-driven approaches are key. ";
            } else {
                response += "With your enterprise volume, sophisticated solutions and data-driven approaches are essential. ";
            }
            
            response += "Would you like me to dive deeper into any specific aspect of this topic?";
            
            const followUpPills = [
                { text: "View documentation", icon: "file-text", type: "primary", action: "view-docs" },
                { text: "Enable features", icon: "settings", type: "secondary", action: "enable-features" },
                { text: "Contact support", icon: "message-circle", type: "secondary", action: "contact-support" }
            ];
            
            addAIMessage('assistant', response, followUpPills);
        }, 1000);
    }

    // Auto-resize textarea
    document.addEventListener('DOMContentLoaded', function() {
        const aiInput = document.getElementById('aiInput');
        if (aiInput) {
            aiInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Handle Enter key
            aiInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
        }

        // Close AI panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('aiAssistantPanel');
            // Guard: If click is on a prompt-btn or inside the panel, do not close
            if ((e.target.classList && e.target.classList.contains('prompt-btn')) || (panel && panel.contains(e.target))) {
                console.log('Click inside panel or on prompt-btn, not closing panel.');
                return;
            }
            if (panel && panel.classList.contains('open')) {
                // Check if click is outside the panel
                closeAIPanel();
            }
        });


    });

    // Function to add invisible hover areas for bar charts
    function addBarHoverAreas(svg, xPoints, barsData) {
        // Remove existing hover areas and AI indicators
        const existingAreas = svg.querySelectorAll('.hover-area, .ai-insight-indicator, .ai-insight-sparkle');
        existingAreas.forEach(area => area.remove());
        
        // Calculate dynamic hover area positions based on chart width
        const svgWidth = 800; // SVG viewBox width
        const numDataPoints = xPoints.length;
        const dataPointSpacing = svgWidth / (numDataPoints - 1);
        
        // Find the data point with the highest rate of change for AI insights
        const insightIndex = findHighestChangePointForBars(barsData);
        
        // Add large invisible hover areas for each bar group covering the full chart height
        for (let i = 0; i < numDataPoints; i++) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            const dataPointX = (i * dataPointSpacing) + (dataPointSpacing / 2);
            const hoverWidth = 200; // Much larger hover area for easier interaction
            
            rect.setAttribute('x', dataPointX - (hoverWidth / 2));
            rect.setAttribute('y', '0');
            rect.setAttribute('width', hoverWidth.toString());
            rect.setAttribute('height', '200'); // Full chart height
            rect.setAttribute('fill', 'transparent');
            rect.setAttribute('stroke', 'none');
            rect.classList.add('hover-area');
            rect.dataset.index = i;
            svg.appendChild(rect);
            
            // Add AI insight indicator for the point with highest change
            if (i === insightIndex) {
                addAIInsightIndicatorForBars(svg, dataPointX, barsData, i);
            }
        }
    }

    // Function to find the data point with the highest rate of change for bar charts
    function findHighestChangePointForBars(barsData) {
        let maxChange = 0;
        let maxChangeIndex = 1; // Start from index 1 to avoid first point
        
        for (let i = 1; i < barsData.length; i++) {
            let currentValue, previousValue;
            
            // Handle different data structures
            if (typeof barsData[i] === 'number') {
                // Simple array of numbers (failed charts)
                currentValue = barsData[i];
                previousValue = barsData[i-1];
            } else if (barsData[i] && typeof barsData[i] === 'object') {
                // Array of objects with credit/debit properties (breakdown charts)
                currentValue = barsData[i].credit + barsData[i].debit;
                previousValue = barsData[i-1].credit + barsData[i-1].debit;
            } else {
                continue; // Skip invalid data
            }
            
            const change = Math.abs(currentValue - previousValue);
            
            if (change > maxChange) {
                maxChange = change;
                maxChangeIndex = i;
            }
        }
        
        return maxChangeIndex;
    }
    
    // Function to add AI insight indicator for bar charts
    function addAIInsightIndicatorForBars(svg, x, barsData, index) {
        // Validate inputs to prevent undefined values
        if (typeof x === 'undefined' || typeof barsData === 'undefined' || typeof index === 'undefined') {
            console.error('addAIInsightIndicatorForBars: Invalid parameters', { x, barsData, index });
            return;
        }
        
        // Get the actual y-coordinate for this data point (bar height)
        let barHeight = 0; // Default fallback
        
        // Validate that barsData[index] exists
        if (barsData && barsData[index] !== undefined && barsData[index] !== null) {
            // Handle different data structures
            if (typeof barsData[index] === 'number') {
                // Simple array of numbers (failed charts)
                barHeight = barsData[index];
            } else if (barsData[index] && typeof barsData[index] === 'object') {
                // Array of objects with credit/debit properties (breakdown charts)
                const credit = barsData[index].credit || 0;
                const debit = barsData[index].debit || 0;
                barHeight = credit + debit;
            }
        }
        
        // Validate barHeight is a valid number
        if (isNaN(barHeight) || barHeight < 0) {
            console.error('addAIInsightIndicatorForBars: Invalid barHeight', { barHeight, barsData, index });
            barHeight = 0; // Use safe fallback
        }
        
        // Normalize barHeight to fit within chart coordinates (0-200 range)
        // Find the maximum bar height to scale appropriately
        let maxBarHeight = 0;
        if (barsData && barsData.length > 0) {
            for (let i = 0; i < barsData.length; i++) {
                let currentHeight = 0;
                if (typeof barsData[i] === 'number') {
                    currentHeight = barsData[i];
                } else if (barsData[i] && typeof barsData[i] === 'object') {
                    const credit = barsData[i].credit || 0;
                    const debit = barsData[i].debit || 0;
                    currentHeight = credit + debit;
                }
                if (!isNaN(currentHeight) && currentHeight > maxBarHeight) {
                    maxBarHeight = currentHeight;
                }
            }
        }
        
        // Scale barHeight to fit within chart coordinates (max 180 to leave space for indicator)
        let normalizedBarHeight = barHeight;
        if (maxBarHeight > 180) {
            normalizedBarHeight = (barHeight / maxBarHeight) * 180;
        }
        
        const y = 200 - normalizedBarHeight; // Position above the bar
        const indicatorY = y - 20; // Position 20px above the bar
        
        // Validate calculated coordinates
        if (isNaN(indicatorY) || indicatorY < 0 || indicatorY > 200) {
            console.error('addAIInsightIndicatorForBars: Invalid indicatorY coordinate', { indicatorY, barHeight, y, barsData, index });
            return;
        }
        
        // Create AI insight indicator group
        const aiIndicator = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        aiIndicator.setAttribute('class', 'ai-insight-indicator');
        aiIndicator.setAttribute('data-index', index);
        aiIndicator.style.cursor = 'pointer';

        // Create purple circle background (40% larger)
        const sparkle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        sparkle.setAttribute('cx', x);
        sparkle.setAttribute('cy', indicatorY);
        sparkle.setAttribute('r', '11.2'); // Increased from 8 to 11.2 (40% larger)
        sparkle.setAttribute('fill', '#533AFD');
        sparkle.setAttribute('stroke', 'white');
        sparkle.setAttribute('stroke-width', '2');
        sparkle.style.filter = 'drop-shadow(0 2px 4px rgba(83, 58, 253, 0.3))';

        // Create white star icon using SVG lines for clean design
        const starIcon = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        starIcon.setAttribute('transform', `translate(${x}, ${indicatorY})`);
        
        // Create main star using SVG lines
        const mainStar = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        
        // Create 4-pointed star using lines
        const starLines = [
            { x1: 0, y1: -3, x2: 0, y2: 3 },     // vertical line
            { x1: -3, y1: 0, x2: 3, y2: 0 },     // horizontal line
            { x1: -2, y1: -2, x2: 2, y2: 2 },    // diagonal line 1
            { x1: -2, y1: 2, x2: 2, y2: -2 }     // diagonal line 2
        ];
        
        starLines.forEach(line => {
            const lineElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            lineElement.setAttribute('x1', line.x1);
            lineElement.setAttribute('y1', line.y1);
            lineElement.setAttribute('x2', line.x2);
            lineElement.setAttribute('y2', line.y2);
            lineElement.setAttribute('stroke', 'white');
            lineElement.setAttribute('stroke-width', '2');
            lineElement.setAttribute('stroke-linecap', 'round');
            mainStar.appendChild(lineElement);
        });
        
        // Create small star in upper right using lines
        const smallStar = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        smallStar.setAttribute('transform', 'translate(5, -5)');
        
        const smallStarLines = [
            { x1: 0, y1: -1.5, x2: 0, y2: 1.5 },     // vertical line
            { x1: -1.5, y1: 0, x2: 1.5, y2: 0 },     // horizontal line
            { x1: -1, y1: -1, x2: 1, y2: 1 },        // diagonal line 1
            { x1: -1, y1: 1, x2: 1, y2: -1 }         // diagonal line 2
        ];
        
        smallStarLines.forEach(line => {
            const lineElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            lineElement.setAttribute('x1', line.x1);
            lineElement.setAttribute('y1', line.y1);
            lineElement.setAttribute('x2', line.x2);
            lineElement.setAttribute('y2', line.y2);
            lineElement.setAttribute('stroke', 'white');
            lineElement.setAttribute('stroke-width', '1.5');
            lineElement.setAttribute('stroke-linecap', 'round');
            smallStar.appendChild(lineElement);
        });
        
        starIcon.appendChild(mainStar);
        starIcon.appendChild(smallStar);

        aiIndicator.appendChild(sparkle);
        aiIndicator.appendChild(starIcon);

        // Add hover area for better interaction (also 40% larger)
        const hoverArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        hoverArea.setAttribute('cx', x);
        hoverArea.setAttribute('cy', indicatorY);
        hoverArea.setAttribute('r', '28'); // Increased from 20 to 28 (40% larger)
        hoverArea.setAttribute('fill', 'transparent');
        hoverArea.setAttribute('stroke', 'none');

        aiIndicator.appendChild(hoverArea);
        
        svg.appendChild(aiIndicator);
    }

    function handleDataPointHover(event, dataIndex) {
        const dateLabels = getDateLabels(document.getElementById('dateRangeDropdown').textContent.trim());
        const generator = new RealisticDataGenerator(currentBusinessType, document.getElementById('dateRangeDropdown').textContent.trim());
        
        // Check if this is the AI insight indicator or acceptance alert indicator
        const isAIInsight = event.target.classList.contains('ai-insight-indicator');
        const isAcceptanceAlert = event.target.classList.contains('acceptance-alert-indicator');
        
        // Determine which chart we're hovering over
        const isMainChart = event.target.closest('.chart-area');
        const isBarChart = event.target.closest('.bar-chart-area');
        const isFailedChart = event.target.closest('.breakdown-section:last-child .bar-chart-area');
        
        // Handle acceptance alert indicator specifically
        if (isAcceptanceAlert) {
            console.log('Acceptance alert indicator hovered - showing acceptance alert tooltip');
            const cx = parseFloat(event.target.getAttribute('cx'));
            const cy = parseFloat(event.target.getAttribute('cy'));
            showAcceptanceAlertTooltip(cx, cy);
            return;
        }
        
        if (isMainChart) {
            const chartData = generator.generateMainChartData();
            const yToPercent = y => ((200-y)/2).toFixed(1) + '%';
            
            // Calculate rate of change for AI insights
            let rateOfChange = '';
            let insight = '';
            let recommendedAction = '';
            
            if (isAIInsight && dataIndex > 0) {
                const currentChange = chartData.current[dataIndex] - chartData.current[dataIndex - 1];
                const baselineChange = chartData.baseline[dataIndex] - chartData.baseline[dataIndex - 1];
                const changePercent = ((currentChange / chartData.current[dataIndex - 1]) * 100).toFixed(1);
                
                rateOfChange = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
                
                if (currentChange > 0 && currentChange > baselineChange) {
                    insight = 'Strong positive performance trend detected';
                    recommendedAction = 'Consider scaling successful strategies';
                } else if (currentChange < 0) {
                    insight = 'Performance decline identified';
                    recommendedAction = 'Review recent changes and optimize';
                } else {
                    insight = 'Stable performance with room for improvement';
                    recommendedAction = 'Explore optimization opportunities';
                }
            }
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                current: yToPercent(chartData.current[dataIndex]),
                baseline: yToPercent(chartData.baseline[dataIndex]),
                optimized: yToPercent(chartData.industryBenchmark[dataIndex]),
                metric: 'Authorization rate',
                value: yToPercent(chartData.current[dataIndex]),
                payments: generator.getBusinessMetrics().dailyTransactions * generator.getTimeframeMultipliers().days,
                dataIndex: dataIndex,
                isAIInsight: isAIInsight,
                rateOfChange: rateOfChange,
                insight: insight,
                recommendedAction: recommendedAction
            };
            
            showTooltip(event, tooltipData);
        } else if (isBarChart) {
            const breakdownData = generator.generateBreakdownData();
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                creditVolume: formatUSD(breakdownData.bars[dataIndex].credit),
                debitVolume: formatUSD(breakdownData.bars[dataIndex].debit),
                creditPayments: breakdownData.bars[dataIndex].payments.credit,
                debitPayments: breakdownData.bars[dataIndex].payments.debit,
                metric: 'Payment volume',
                value: formatUSD(breakdownData.bars[dataIndex].credit + breakdownData.bars[dataIndex].debit),
                payments: breakdownData.bars[dataIndex].payments.credit + breakdownData.bars[dataIndex].payments.debit,
                dataIndex: dataIndex
            };
            
            showTooltip(event, tooltipData);
        } else if (isFailedChart) {
            const failedData = generator.generateFailedData();
            
            const tooltipData = {
                date: dateLabels[dataIndex],
                dateRange: document.getElementById('dateRangeDropdown').textContent.trim(),
                failedVolume: `$${failedData.volume[dataIndex].toFixed(2)}`,
                failedPayments: Math.round(failedData.payments[dataIndex]),
                failureRate: `${failedData.failureRate.toFixed(1)}%`,
                metric: 'Failed payments',
                value: `$${failedData.volume[dataIndex].toFixed(2)}`,
                payments: Math.round(failedData.payments[dataIndex]),
                dataIndex: dataIndex
            };
            
            showTooltip(event, tooltipData);
        }
    }

            // Initialize chart tooltips
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            initializeChartTooltips();
            lucide.createIcons();
        
        // Initialize business type switching
        // initializeBusinessTypeSwitching();
        
        // Initialize date range switching
        // initializeDateRangeSwitching();
        
        // Initialize metric card interactions
        // initializeMetricCardInteractions();
        
        // Initialize breakdown filter interactions
        // initializeBreakdownFilterInteractions();
        
        // Initialize failed payments filter interactions
        // initializeFailedPaymentsFilterInteractions();
        
        // Initialize assistant prompts
        updateAssistantPrompts('medium', 'Last 90 days');
        
        // Initialize optimization insights cards with top 3 recommendations
        updateOptimizationInsightsCards('medium');
        
        // Initialize navigation tabs
        initializeNavigationTabs();
        
        // Set initial tab to overview first
        setTimeout(() => {
            console.log('Switching to overview tab...');
            switchTabView('overview');
            
            // Ensure overview page is populated with data
            setTimeout(() => {
                const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
                const currentDateRange = document.getElementById('dateRangeDropdown')?.textContent.trim() || 'Last 90 days';
                console.log('Initializing overview page with:', currentBusinessType, currentDateRange);
                updateOverviewPage(currentBusinessType, currentDateRange);
            }, 200);
        }, 100);
        
        // Set up automatic blue dots after tab is set
        setTimeout(() => {
            setupAutoBlueDots();
            // Test: Try to add blue dots immediately
            setTimeout(() => {
                console.log('Testing blue dot addition...');
                autoAddBlueDotsOnAcceptance();
                
                // Additional test: Check if chart exists and add dots manually
                setTimeout(() => {
                    console.log('Manual blue dot test...');
                    const chartSvg = document.querySelector('.chart-area .chart-svg');
                    if (chartSvg) {
                        console.log('Chart SVG found, attempting to add blue dots manually');
                        forceAddBlueDots();
                    } else {
                        console.log('Chart SVG not found');
                    }
                }, 500);
            }, 200);
        }, 150);
        
        // Enhance sparkle icons after page loads
        setTimeout(() => {
            enhanceSparkleIcons();
        }, 1000);
        
        // Trigger initial graph animations after a short delay
        setTimeout(() => resetGraphAnimations(), 200);
        // Ensure icons are properly initialized
        setTimeout(() => {
            if (typeof lucide !== "undefined") {
                lucide.createIcons();
                console.log("Icons initialized");
            } else {
                console.error("Lucide library not loaded");
            }
        }, 500);
        

        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    const insightsSection = document.getElementById('insightsSection');
                    if (insightsSection && !insightsInitialized) {
                        console.log('Insights section detected by mutation observer, initializing...');
                        insightsInitialized = initializeInsights();
                        observer.disconnect(); // Stop observing once found
                    }
                }
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });

    // Function to reset graph animations when charts are updated
    function resetGraphAnimations() {
        const chartSvgs = document.querySelectorAll('.chart-svg, .bar-chart-svg');
        const chartPaths = document.querySelectorAll('.chart-lines path');
        const chartBars = document.querySelectorAll('.bar-chart-bars rect');
        const dataPoints = document.querySelectorAll('.data-point, .hover-area');
        
        // Reset SVG animations
        chartSvgs.forEach(svg => {
            svg.style.animation = 'none';
            svg.offsetHeight; // Trigger reflow
            svg.style.animation = 'graphLoadIn 0.4s ease-out 0.1s forwards';
        });
        
        // Reset path animations
        chartPaths.forEach(path => {
            path.style.animation = 'none';
            path.offsetHeight; // Trigger reflow
        });
        
        // Reset bar animations
        chartBars.forEach(bar => {
            bar.style.animation = 'none';
            bar.offsetHeight; // Trigger reflow
            bar.style.animation = 'growBar 0.6s ease-out 0.3s forwards';
        });
        
        // Reset data point animations
        dataPoints.forEach(point => {
            point.style.animation = 'none';
            point.offsetHeight; // Trigger reflow
            point.style.animation = 'fadeInDataPoints 0.3s ease-out 0.6s forwards';
        });
    }

    // Navigation Tab Functionality
    function initializeNavigationTabs() {
        const navTabs = document.querySelectorAll('.nav-tab');
        console.log('Initializing navigation tabs, found:', navTabs.length);
        
        navTabs.forEach((tab, index) => {
            console.log(`Setting up tab ${index}:`, tab.textContent.trim());
            tab.addEventListener('click', function(e) {
                console.log('Tab clicked:', this.textContent.trim());
                e.preventDefault();
                e.stopPropagation();
                
                // Remove active class from all tabs
                navTabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Get the tab text to determine which view to show
                const tabText = this.textContent.trim();
                console.log('Switching to tab:', tabText);
                switchTabView(tabText);
            });
        });
    }

    function switchTabView(tabName) {
        console.log('switchTabView called with:', tabName);
        
        // Update active tab
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.textContent.trim().toLowerCase() === tabName.toLowerCase()) {
                tab.classList.add('active');
            }
        });
        
        const mainContent = document.querySelector('.two-column-layout');
        console.log('Main content found:', !!mainContent);
        
        // Hide all tab content
        const allTabContent = document.querySelectorAll('.tab-content');
        console.log('Found tab content elements:', allTabContent.length);
        allTabContent.forEach(content => {
            content.style.display = 'none';
            console.log('Hiding:', content.id);
        });
        
        // Handle page title - always set to "Payments performance"
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
            pageTitle.textContent = 'Payments performance';
        }
        
        // Show the appropriate content based on tab name
        switch(tabName.toLowerCase()) {
            case 'acceptance':
                console.log('Showing acceptance view');
                showAcceptanceView();
                // Keep the default "Payment success rate" metric card for acceptance tab
                setTimeout(() => {
                    const allCards = document.querySelectorAll('.metric-card');
                    let paymentSuccessCard = null;
                    
                    // Find the Payment success rate card (default)
                    allCards.forEach(card => {
                        const label = card.querySelector('.metric-label');
                        if (label && label.textContent === 'Payment success rate') {
                            paymentSuccessCard = card;
                        }
                    });
                    
                    if (paymentSuccessCard) {
                        // Ensure the Payment success rate card is selected
                        allCards.forEach(card => card.classList.remove('selected'));
                        paymentSuccessCard.classList.add('selected');
                    }
                }, 100);
                break;
            case 'cost':
                console.log('Showing cost view');
                showCostView();
                break;
            case 'authentication':
                console.log('Showing authentication view');
                showAuthenticationView();
                break;
            case 'disputes':
                console.log('Showing disputes view');
                showDisputesView();
                break;
            case 'payment methods':
                console.log('Showing payment methods view');
                showPaymentMethodsView();
                break;
            case 'optimization':
                console.log('Showing optimization view');
                showOptimizationView();
                break;
            case 'overview':
                console.log('Showing overview view');
                showOverviewView();
                break;
            default:
                console.log('Showing default acceptance view');
                showAcceptanceView();
        }
        

    }
    
    // Insights data for different tabs
    const insightsData = {
        cost: [],
        authentication: [],
        disputes: [],
        'payment methods': [],
        optimization: []
    };
    


    function showAcceptanceView() {
        // This is the default view - show the current content
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'grid';
            mainContent.style.gridTemplateColumns = '70% 30%';
            mainContent.style.gap = '24px';
            mainContent.style.marginTop = '24px';
            mainContent.style.width = '100%';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Show the filter sections when switching back from optimization
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'flex';
        });
        
        // Show the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'block';
        }
        
        // Hide the overview view if it exists
        const overviewView = document.getElementById('overview-view');
        if (overviewView) {
            overviewView.style.display = 'none';
        }
        
        // Update optimization insights to ensure fresh content
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        updateOptimizationInsightsCards(currentBusinessType);
        
        // Ensure chart hover system is initialized for acceptance page
        setTimeout(() => {
            console.log('Ensuring chart hover system is initialized for acceptance page...');
            const chartSvg = document.querySelector('.chart-area .chart-svg');
            if (chartSvg) {
                console.log('Chart SVG found, checking for hover areas...');
                const hoverAreas = chartSvg.querySelectorAll('.simple-hover-area');
                console.log('Hover areas found:', hoverAreas.length);
                
                if (hoverAreas.length === 0) {
                    console.log('No hover areas found, reinitializing chart...');
                    // Force chart reinitialization
                    const selectedMetricCard = document.querySelector('.metric-card.selected');
                    if (selectedMetricCard) {
                        selectedMetricCard.click();
                    }
                }
            }
            
            // Ensure blue dots are added for the acceptance tab
            setTimeout(() => {
                console.log('Adding blue dots for acceptance tab...');
                autoAddBlueDotsOnAcceptance();
            }, 100);
        }, 500);
    }

    function showCostView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Hide the filter sections for coming soon pages
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Create or show cost view
        let costView = document.getElementById('cost-view');
        if (!costView) {
            costView = createCostView();
        }
        costView.style.display = 'block';
        
        // No optimization insights needed for coming soon pages
    }

    function showAuthenticationView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Hide the filter sections for coming soon pages
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Create or show authentication view
        let authView = document.getElementById('authentication-view');
        if (!authView) {
            authView = createAuthenticationView();
        }
        authView.style.display = 'block';
        
        // No optimization insights needed for coming soon pages
    }

    function showDisputesView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Hide the filter sections for coming soon pages
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Create or show disputes view
        let disputesView = document.getElementById('disputes-view');
        if (!disputesView) {
            disputesView = createDisputesView();
        }
        disputesView.style.display = 'block';
        
        // No optimization insights needed for coming soon pages
    }

    function showPaymentMethodsView() {
        const mainContent = document.querySelector('.two-column-layout');
        if (mainContent) {
            mainContent.style.display = 'none';
        }
        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Hide the filter sections for coming soon pages
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Create or show payment methods view
        let paymentMethodsView = document.getElementById('payment-methods-view');
        if (!paymentMethodsView) {
            paymentMethodsView = createPaymentMethodsView();
        }
        paymentMethodsView.style.display = 'block';
        
        // No optimization insights needed for coming soon pages
    }

    function showOptimizationView() {
        console.log('showOptimizationView called');
        
        // Hide the filter sections when optimization tab is active
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Hide the two-column layout
        const twoColumnLayout = document.querySelector('.two-column-layout');
        if (twoColumnLayout) {
            twoColumnLayout.style.display = 'none';
        }
        
        // Hide the overview view if it exists
        const overviewView = document.getElementById('overview-view');
        if (overviewView) {
            overviewView.style.display = 'none';
        }
        

        
        // Create or show optimization view
        let optimizationView = document.getElementById('optimization-view');
        console.log('Existing optimization view:', !!optimizationView);
        if (!optimizationView) {
            console.log('Creating new optimization view');
            optimizationView = createOptimizationViewNew();
        }
        
        // Make sure the optimization view is visible and properly positioned
        optimizationView.style.display = 'block';
        optimizationView.style.width = '100%';
        optimizationView.style.maxWidth = 'none';
        optimizationView.style.margin = '0';
        optimizationView.style.padding = '0';
        
        // Update the optimization page with current business type data
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateOptimizationPage(currentBusinessType, currentDateRange);
        
        // Initialize optimization date range dropdown
        const optimizationDateRangeDropdown = document.getElementById('optimizationDateRangeDropdown');
        if (optimizationDateRangeDropdown) {
            // Set the dropdown to match the main date range dropdown
            optimizationDateRangeDropdown.textContent = currentDateRange;
            optimizationDateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
            optimizationDateRangeDropdown.querySelector('i').classList.add('filter-icon');
            
            // Reinitialize lucide icons
            lucide.createIcons();
        }
        
        console.log('Optimization view should now be visible and updated');
    }

    function showOverviewView() {
        console.log('showOverviewView called');
        
        // Hide the filter sections for overview tab (showing the full dashboard)
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Hide the separator line after filters
        const separator = document.querySelector('.separator');
        if (separator) {
            separator.style.display = 'none';
        }
        
        // Hide the two-column layout (we'll show the overview view instead)
        const twoColumnLayout = document.querySelector('.two-column-layout');
        if (twoColumnLayout) {
            twoColumnLayout.style.display = 'none';
        }
        

        
        // Hide the optimization view if it exists
        const optimizationView = document.getElementById('optimization-view');
        if (optimizationView) {
            optimizationView.style.display = 'none';
        }
        
        // Create or show overview view (this contains the Performance, Payment lifecycle, Key metrics)
        let overviewView = document.getElementById('overview-view');
        if (!overviewView) {
            overviewView = createOverviewView();
        }
        overviewView.style.display = 'block';
        
        // Update optimization insights to ensure fresh content
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        updateOptimizationInsightsCards(currentBusinessType);
        
        // Initialize the overview date range dropdown
        setTimeout(() => {
            initializeOverviewDateRangeDropdown();
            
            // Set the correct active state based on current date range
            const currentDateRange = document.getElementById('dateRangeDropdown')?.textContent.trim() || 'Last 90 days';
            const overviewDropdownItems = document.querySelectorAll('#overviewDateRangeMenu .dropdown-item');
            overviewDropdownItems.forEach(item => {
                item.classList.remove('active');
                if (item.textContent === currentDateRange) {
                    item.classList.add('active');
                }
            });
            
            // Update the overview page with data
            updateOverviewPage(currentBusinessType, currentDateRange);
        }, 100);
    }



    function createOptimizationViewNew() {
        const optimizationView = document.createElement('div');
        optimizationView.id = 'optimization-view';
        optimizationView.className = 'tab-content optimization-tab-content';
        optimizationView.style.cssText = `
            width: 100%;
            background: white;
            min-height: 100vh;
            display: block;
            padding: 24px;
        `;

        const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        const generator = new RealisticDataGenerator(currentBusinessType, dateRange);
        const metrics = generator.getBusinessMetrics();

        optimizationView.innerHTML = `
            <!-- Optimization Content -->
            <div style="margin-top: 24px; width: 100%;">


                <!-- Recommendations Section -->
                <div class="optimization-opportunities" style="margin-bottom: 48px;">
                    <div class="opportunities-header">
                        <div class="opportunities-title-section">
                            <h2 class="opportunities-title">Recommendations</h2>
            
                        </div>
                        <a href="#" class="view-all-link" onclick="navigateToOptimizationTab()">
                            View all
                            <i data-lucide="arrow-right" style="width: 14px; height: 14px;"></i>
                        </a>
                    </div>
                    
                    <div class="opportunities-table-container">
                        <table class="opportunities-table">
                            <thead>
                                <tr>
                                    <th>Recommendation</th>
                                    <th>Potential impact</th>
                                    <th>Effort/Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="high-priority">
                                    <td>
                                        <div class="opportunity-cell">
                                            <div class="opportunity-info">
                                                <div class="opportunity-title">Payment Intents</div>
                                                <div class="opportunity-description">Implement Payment Intents for better authorization rates</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="revenue-impact">+$63,000/year</span>
                                    </td>
                                    <td>
                                        <span class="effort-badge medium">Medium</span>
                                        <div class="effort-detail">1-2 dev days</div>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="table-btn secondary" onclick="console.log('Payment Intents button clicked'); openExperimentDrawer({
                                                id: 'payment-intents',
                                                title: 'Payment Intents',
                                                description: 'Implement Payment Intents for better authorization rates and improved payment success.',
                                                uplift: 12,
                                                revenue: '+$63,000/year',
                                                effort: 'Medium (1-2 dev days)'
                                            })">
                                                <i data-lucide="shield-check" style="width: 14px; height: 14px;"></i>
                                                Experiment
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="high-priority">
                                    <td>
                                        <div class="opportunity-cell">
                                            <div class="opportunity-info">
                                                <div class="opportunity-title">Smart Retries</div>
                                                <div class="opportunity-description">Enable intelligent retry logic for declined payments</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="revenue-impact">+$53,200/year</span>
                                    </td>
                                    <td>
                                        <span class="effort-badge easy">Easy</span>
                                        <div class="effort-detail">30 minute setup</div>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="table-btn secondary" onclick="console.log('Smart Retries button clicked'); openExperimentDrawer({
                                                id: 'smart-retries',
                                                title: 'Smart Retries',
                                                description: 'Enable intelligent retry logic for declined payments to recover lost revenue.',
                                                uplift: 8,
                                                revenue: '+$53,200/year',
                                                effort: 'Easy (30 minute setup)'
                                            })">
                                                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                                                Experiment
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="medium-priority">
                                    <td>
                                        <div class="opportunity-cell">
                                            <div class="opportunity-info">
                                                <div class="opportunity-title">Connect marketplace</div>
                                                <div class="opportunity-description">Set up Connect for multi-party payment flows</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="revenue-impact">+$44,800/year</span>
                                    </td>
                                    <td>
                                        <span class="effort-badge hard">Hard</span>
                                        <div class="effort-detail">1-2 weeks</div>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="table-btn secondary" onclick="console.log('Connect marketplace button clicked'); openExperimentDrawer({
                                                id: 'connect-marketplace',
                                                title: 'Connect Marketplace',
                                                description: 'Set up Connect for multi-party payment flows to enable marketplace functionality.',
                                                uplift: 15,
                                                revenue: '+$44,800/year',
                                                effort: 'Hard (1-2 weeks)'
                                            })">
                                                <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                                                Experiment
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Experiments Section -->
                <div class="ab-testing-section" style="margin-bottom: 48px;">
                    <div class="ab-header">
                        <h2 class="ab-title">Experiments</h2>
                        <button class="new-test-btn" onclick="openNewExperimentDrawer()">
                            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                            New experiment
                        </button>
                    </div>
                    
                    <div class="ab-tests-table-container">
                        <table class="ab-tests-table">
                            <thead>
                                <tr>
                                    <th>Test name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Control</th>
                                    <th>Variant</th>
                                    <th>Improvement</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="active">
                                    <td>
                                        <div class="test-cell">
                                            <div class="test-title">3D Secure optimization</div>
                                            <div class="test-description">Testing automatic vs. challenge-based 3D Secure authentication</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="status-cell active">
                                            <span class="status-dot"></span>
                                            <span class="status-text">Active</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="progress-cell">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: 67%"></div>
                                            </div>
                                            <span class="progress-text">67% Complete</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="rate-value">89.2%</span>
                                    </td>
                                    <td>
                                        <span class="rate-value">91.8%</span>
                                    </td>
                                    <td>
                                        <span class="improvement">+2.6%</span>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="table-btn secondary">
                                                <i data-lucide="bar-chart" style="width: 14px; height: 14px;"></i>
                                                Details
                                            </button>
                                            <button class="table-btn secondary">
                                                <i data-lucide="pause" style="width: 14px; height: 14px;"></i>
                                                Pause
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="completed">
                                    <td>
                                        <div class="test-cell">
                                            <div class="test-title">Smart Retries configuration</div>
                                            <div class="test-description">Testing different retry strategies for declined payments</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="status-cell completed">
                                            <span class="status-dot"></span>
                                            <span class="status-text">Completed</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="progress-cell">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: 100%"></div>
                                            </div>
                                            <span class="progress-text">100% Complete</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="rate-value">85.1%</span>
                                    </td>
                                    <td>
                                        <span class="rate-value winner">87.3%</span>
                                    </td>
                                    <td>
                                        <span class="improvement">+2.2%</span>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="table-btn secondary">
                                                <i data-lucide="bar-chart" style="width: 14px; height: 14px;"></i>
                                                Details
                                            </button>
                                            <button class="table-btn primary">
                                                <i data-lucide="check" style="width: 14px; height: 14px;"></i>
                                                Deploy
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Past Optimizations Section -->
                <div class="ab-testing-section">
                    <div class="ab-header">
                        <h2 class="ab-title">Past optimizations</h2>
                    </div>
                    
                    <div class="timeline-container">
                        <!-- Table will be dynamically populated by updateTimeline function -->
                    </div>
                </div>
            </div>
        `;

        // Add the view to the main content area
        const mainContentInner = document.querySelector('.main-content-inner');
        if (mainContentInner) {
            // Check if optimization view already exists in the main content
            let existingView = mainContentInner.querySelector('#optimization-view');
            if (existingView) {
                existingView.remove();
            }
            mainContentInner.appendChild(optimizationView);
        } else {
            document.body.appendChild(optimizationView);
        }
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Update dynamic content after creating the view
        setTimeout(() => {
            const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
            
            // Update recommendations table (will show filtered recommendations)
            updateRecommendationsTable(currentBusinessType);
            
            // Update experiments table (will show active experiments)
            updateExperimentsTable();
            
            // Update optimization insights cards
            updateOptimizationInsightsCards(currentBusinessType);
            
            console.log('Optimization view dynamic content updated');
        }, 100);
        
        return optimizationView;
    }

    function createOverviewView() {
        console.log('createOverviewView called');
        const overviewView = document.createElement('div');
        overviewView.id = 'overview-view';
        overviewView.className = 'tab-content optimization-tab-content';
        overviewView.style.cssText = `
            width: 100%;
            background: white;
            min-height: 100vh;
            display: block;
        `;

        const dateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        console.log('Creating overview view with business type:', currentBusinessType, 'and date range:', dateRange);
        
        try {
            const generator = new RealisticDataGenerator(currentBusinessType, dateRange);
        const allData = generator.generateAllData();
        const metrics = generator.getBusinessMetrics();
        const timeframeMultipliers = generator.getTimeframeMultipliers();
        
        // Calculate realistic values based on business type and timeframe
        const totalRevenue = allData.metrics.volume;
        const recoveredRevenue = totalRevenue * 0.15; // Assume 15% of total revenue is recovered
        const recoveredPayments = Math.round(allData.metrics.payments * 0.12); // Assume 12% of payments are recovered
        const successRate = metrics.successRate;

        overviewView.innerHTML = `
                <!-- Simple Two Column Layout -->
                <div class="overview-page" style="display: flex; gap: 24px; margin-top: 48px; width: 100%; min-height: 100vh; align-items: flex-start;">
                    <!-- Left Column -->
                    <div style="flex: 0 0 70%; min-width: 0;">
                    <!-- Performance Header and Time Filter -->
                    <div class="performance-header-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--color-gray-900); line-height: 28px;">Performance</h2>
                        
                        <!-- Time Filter for Overview Page -->
                        <div class="date-range-dropdown">
                            <button class="filter-btn dropdown-trigger" id="overviewDateRangeDropdown">
                                ${dateRange}
                                <i data-lucide="chevron-down" class="filter-icon"></i>
                            </button>
                            <div class="dropdown-menu" id="overviewDateRangeMenu">
                                <div class="dropdown-item" data-range="7">Last 7 days</div>
                                <div class="dropdown-item" data-range="30">Last 30 days</div>
                                <div class="dropdown-item" data-range="60">Last 60 days</div>
                                <div class="dropdown-item active" data-range="90">Last 90 days</div>
                                <div class="dropdown-item" data-range="180">Last 6 months</div>
                                <div class="dropdown-item" data-range="365">Last 12 months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Stats -->
                    <div class="sparkline-charts-container" style="margin-bottom: 48px;">
                        <div class="sparkline-row">
                            <!-- Total Processing Volume -->
                            <div class="sparkline-card" onclick="switchTabView('authentication')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Total processing volume</h3>
                                    <div>
                                        <span class="sparkline-value">$45.2K</span>
                                        <span class="sparkline-trend positive">+3.8K</span>
                                    </div>
                                    <div class="sparkline-rate">Benchmark: $54.2K</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,18 L20,16 L40,14 L60,12 L80,10 L100,8 L120,10 L140,8 L160,6 L180,8 L200,6" 
                                              stroke="#3B82F6" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="6" r="2" fill="#3B82F6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Net Revenue -->
                            <div class="sparkline-card" onclick="switchTabView('authentication')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Net revenue</h3>
                                    <div>
                                        <span class="sparkline-value">$43.8K</span>
                                        <span class="sparkline-trend positive">+2.1K</span>
                                    </div>
                                    <div class="sparkline-rate">Benchmark: $50.4K</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,8 L20,10 L40,12 L60,10 L80,8 L100,6 L120,8 L140,6 L160,4 L180,6 L200,4" 
                                              stroke="#EF4444" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="4" r="2" fill="#EF4444"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Lost Revenue -->
                            <div class="sparkline-card" onclick="switchTabView('cost')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Lost revenue</h3>
                                    <div>
                                        <span class="sparkline-value">$1.4K</span>
                                        <span class="sparkline-trend negative">+0.3K</span>
                                    </div>
                                    <div class="sparkline-rate">Benchmark: $1.1K</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,12 L20,14 L40,16 L60,18 L80,20 L100,22 L120,20 L140,18 L160,16 L180,14 L200,16" 
                                              stroke="#8B5CF6" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="16" r="2" fill="#8B5CF6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Lifecycle Header -->
                    <div class="lifecycle-header" style="margin-bottom: 16px;">
                        <div class="lifecycle-header-top">
                            <div class="lifecycle-title-section">
                                <h1 class="lifecycle-title">Payment lifecycle</h1>
                            </div>
                            <div class="chart-style-dropdown">
                                <button id="chartStyleDropdown" class="chart-style-btn">
                                    <span id="chartStyleText">Sparkline</span>
                                    <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                                </button>
                                <div id="chartStyleMenu" class="chart-style-menu">
                                    <div class="chart-style-item active" data-style="sparkline">
                                        <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
                                        <span>Sparkline</span>
                                    </div>
                                    <div class="chart-style-item" data-style="bar">
                                        <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i>
                                        <span>Bar</span>
                                    </div>
                                    <div class="chart-style-item" data-style="waterfall">
                                        <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
                                        <span>Waterfall</span>
                                    </div>
                                    <div class="chart-style-item" data-style="sankey">
                                        <i data-lucide="git-branch" style="width: 16px; height: 16px;"></i>
                                        <span>Sankey</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Lifecycle Sparkline Charts -->
                    <div class="sparkline-charts-container">
                        <!-- Row 1 -->
                        <div class="sparkline-row">
                            <!-- Payment Success Rate Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('acceptance')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Payment success rate</h3>
                                    <div>
                                        <span class="sparkline-value" id="overview-payment-success-rate">85.23%</span>
                                        <span class="sparkline-trend positive" id="overview-payment-success-change">+3.45%</span>
                                    </div>
                                    <div class="sparkline-rate">Top success rate</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,20 L20,18 L40,15 L60,18 L80,12 L100,8 L120,12 L140,6 L160,10 L180,6 L200,8" 
                                              stroke="#10B981" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="8" r="2" fill="#10B981"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Authentication Success Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('authentication')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Authorization success</h3>
                                    <div>
                                        <span class="sparkline-value">98.7%</span>
                                        <span class="sparkline-trend positive">+1.5%</span>
                                    </div>
                                    <div class="sparkline-rate">Top authentication</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,25 L20,22 L40,18 L60,20 L80,15 L100,10 L120,15 L140,8 L160,12 L180,8 L200,10" 
                                              stroke="#3B82F6" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="10" r="2" fill="#3B82F6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Dispute Rate Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('disputes')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Dispute rate</h3>
                                    <div>
                                        <span class="sparkline-value">0.8%</span>
                                        <span class="sparkline-trend negative">-0.3%</span>
                                    </div>
                                    <div class="sparkline-rate">Top disputes</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,8 L20,12 L40,15 L60,18 L80,22 L100,25 L120,22 L140,18 L160,15 L180,12 L200,15" 
                                              stroke="#F97316" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="15" r="2" fill="#F97316"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="sparkline-row">
                            <!-- Processing Cost Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('cost')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Processing cost</h3>
                                    <div>
                                        <span class="sparkline-value">2.4%</span>
                                        <span class="sparkline-trend negative">-0.2%</span>
                                    </div>
                                    <div class="sparkline-rate">Top cost</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,15 L20,18 L40,20 L60,18 L80,15 L100,12 L120,15 L140,12 L160,10 L180,8 L200,10" 
                                              stroke="#8B5CF6" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="10" r="2" fill="#8B5CF6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Payment Methods Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('payment-methods')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Payment methods</h3>
                                    <div>
                                        <span class="sparkline-value">87.6%</span>
                                        <span class="sparkline-trend positive">+3.2%</span>
                                    </div>
                                    <div class="sparkline-rate">Top payment methods</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,22 L20,20 L40,18 L60,20 L80,15 L100,12 L120,15 L140,10 L160,12 L180,8 L200,10" 
                                              stroke="#06B6D4" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="10" r="2" fill="#06B6D4"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Optimizations Sparkline -->
                            <div class="sparkline-card" onclick="switchTabView('optimization')">
                                <div class="sparkline-content">
                                    <h3 class="sparkline-title">Optimizations</h3>
                                    <div>
                                        <span class="sparkline-value">12</span>
                                        <span class="sparkline-trend positive">+4</span>
                                    </div>
                                    <div class="sparkline-rate">Active optimizations</div>
                                </div>
                                <div class="sparkline-chart">
                                    <svg width="100%" height="30" viewBox="0 0 200 30">
                                        <path d="M0,25 L20,22 L40,18 L60,20 L80,15 L100,10 L120,8 L140,5 L160,8 L180,5 L200,3" 
                                              stroke="#059669" stroke-width="4" fill="none"/>
                                        <circle cx="200" cy="3" r="2" fill="#059669"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Chart Containers (Hidden by default) -->
                    <div class="chart-container-wrapper" style="display: none;">
                        <!-- Bar Chart -->
                        <div class="waterfall-chart bar-chart">
                            <div class="waterfall-container">
                            <!-- Acceptance -->
                            <div class="waterfall-item starting" onclick="switchTabView('acceptance')">
                                <div class="waterfall-bar" style="height: 100px; background: #3B82F6;"></div>
                                <div class="waterfall-label">Acceptance</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${totalRevenue.toFixed(0)}</span>
                                    <span class="detail-rate">${allData.metrics.payments} transactions</span>
                                </div>
                            </div>

                            <!-- Authorization Losses -->
                            <div class="waterfall-item negative" onclick="switchTabView('acceptance')">
                                <div class="waterfall-bar" style="height: 20px; background: #EF4444;"></div>
                                <div class="waterfall-label">Declines</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</span>
                                    <span class="detail-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</span>
                                </div>
                            </div>

                            <!-- Dispute Losses -->
                            <div class="waterfall-item negative" onclick="switchTabView('disputes')">
                                <div class="waterfall-bar" style="height: 10px; background: #F97316;"></div>
                                <div class="waterfall-label">Disputes</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</span>
                                    <span class="detail-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</span>
                                </div>
                            </div>

                            <!-- Fraud -->
                            <div class="waterfall-item positive" onclick="switchTabView('authentication')">
                                <div class="waterfall-bar" style="height: 50px; background: #10B981;"></div>
                                <div class="waterfall-label">Fraud</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * 0.02).toFixed(0)}</span>
                                    <span class="detail-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</span>
                                </div>
                            </div>

                            <!-- Costs -->
                            <div class="waterfall-item negative" onclick="switchTabView('cost')">
                                <div class="waterfall-bar" style="height: 15px; background: #8B5CF6;"></div>
                                <div class="waterfall-label">Costs</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * 0.029).toFixed(0)}</span>
                                    <span class="detail-rate">Processing fees</span>
                                </div>
                            </div>

                            <!-- Final Total -->
                            <div class="waterfall-item total" onclick="switchTabView('overview')">
                                <div class="waterfall-bar" style="height: 65px; background: #533AFD;"></div>
                                <div class="waterfall-label">Total revenue</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * successRate/100).toFixed(0)}</span>
                                    <span class="detail-rate">${successRate.toFixed(1)}% success rate</span>
                                </div>
                            </div>
                        </div>

                        <!-- Waterfall Chart Style -->
                        <div class="waterfall-chart waterfall-chart-style">
                            <div class="waterfall-container">
                                <!-- Acceptance -->
                                <div class="waterfall-item starting" onclick="switchTabView('acceptance')">
                                    <div class="waterfall-bar" style="height: 100px; background: #3B82F6;"></div>
                                    <div class="waterfall-label">Acceptance</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${totalRevenue.toFixed(0)}</span>
                                        <span class="detail-rate">${allData.metrics.payments} transactions</span>
                                    </div>
                                </div>

                                <!-- Authorization Losses -->
                                <div class="waterfall-item negative" onclick="switchTabView('acceptance')">
                                    <div class="waterfall-bar" style="height: 20px; background: #EF4444;"></div>
                                    <div class="waterfall-label">Declines</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</span>
                                        <span class="detail-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</span>
                                    </div>
                                </div>

                                <!-- Dispute Losses -->
                                <div class="waterfall-item negative" onclick="switchTabView('disputes')">
                                    <div class="waterfall-bar" style="height: 10px; background: #F97316;"></div>
                                    <div class="waterfall-label">Disputes</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</span>
                                        <span class="detail-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</span>
                                    </div>
                                </div>

                                <!-- Fraud -->
                                <div class="waterfall-item positive" onclick="switchTabView('authentication')">
                                    <div class="waterfall-bar" style="height: 50px; background: #10B981;"></div>
                                    <div class="waterfall-label">Fraud</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * 0.02).toFixed(0)}</span>
                                        <span class="detail-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</span>
                                    </div>
                                </div>

                                <!-- Costs -->
                                <div class="waterfall-item negative" onclick="switchTabView('cost')">
                                    <div class="waterfall-bar" style="height: 15px; background: #8B5CF6;"></div>
                                    <div class="waterfall-label">Costs</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * 0.029).toFixed(0)}</span>
                                        <span class="detail-rate">Processing fees</span>
                                    </div>
                                </div>

                                <!-- Final Total -->
                                <div class="waterfall-item total" onclick="switchTabView('overview')">
                                    <div class="waterfall-bar" style="height: 65px; background: #533AFD;"></div>
                                    <div class="waterfall-label">Total revenue</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * successRate/100).toFixed(0)}</span>
                                        <span class="detail-rate">${successRate.toFixed(1)}% success rate</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sankey Chart -->
                        <div class="sankey-chart">
                            <div class="sankey-container">
                                <!-- Stage 1: Acceptance -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #3B82F6;">
                                            <div class="sankey-label">Acceptance</div>
                                            <div class="sankey-value">$${totalRevenue.toFixed(0)}</div>
                                            <div class="sankey-rate">${allData.metrics.payments} transactions</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stage 2: Processing -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #EF4444;">
                                            <div class="sankey-label">Declines</div>
                                            <div class="sankey-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</div>
                                            <div class="sankey-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</div>
                                        </div>
                                    </div>
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #F97316;">
                                            <div class="sankey-label">Disputes</div>
                                            <div class="sankey-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</div>
                                            <div class="sankey-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</div>
                                        </div>
                                    </div>
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #10B981;">
                                            <div class="sankey-label">Fraud</div>
                                            <div class="sankey-value">$${(totalRevenue * 0.02).toFixed(0)}</div>
                                            <div class="sankey-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stage 3: Final -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #533AFD;">
                                            <div class="sankey-label">Total revenue</div>
                                            <div class="sankey-value">$${(totalRevenue * successRate/100).toFixed(0)}</div>
                                            <div class="sankey-rate">${successRate.toFixed(1)}% success rate</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <h2 class="snapshot-title">Key metrics</h2>
                        <div class="snapshot-grid">
                            <!-- Total Revenue Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Total revenue</h3>
                                        <div class="snapshot-card-value">
                                            $12.4K
                                            <span class="snapshot-card-change positive">+8.5%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>$15K</span>
                                            <span>$10K</span>
                                            <span>$5K</span>
                                            <span>$0</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,140 Q50,135 100,125 Q150,120 200,115" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,130 Q50,125 100,115 Q150,110 200,105" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Authorization Rate Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Authorization rate</h3>
                                        <div class="snapshot-card-value">
                                            92.3%
                                            <span class="snapshot-card-change positive">+1.8%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>100%</span>
                                            <span>95%</span>
                                            <span>90%</span>
                                            <span>85%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,180 Q50,178 100,172 Q150,168 200,165" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,175 Q50,173 100,167 Q150,163 200,160" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transaction Volume Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Transaction volume</h3>
                                        <div class="snapshot-card-value">
                                            1,247
                                            <span class="snapshot-card-change positive">+12.3%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>1.5K</span>
                                            <span>1K</span>
                                            <span>500</span>
                                            <span>0</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,160 Q50,155 100,145 Q150,140 200,135" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,150 Q50,145 100,135 Q150,130 200,125" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Average Order Value Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Average order value</h3>
                                        <div class="snapshot-card-value">
                                            $99.50
                                            <span class="snapshot-card-change positive">+5.2%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>$120</span>
                                            <span>$100</span>
                                            <span>$80</span>
                                            <span>$60</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,170 Q50,168 100,162 Q150,158 200,155" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,165 Q50,163 100,157 Q150,153 200,150" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Decline Rate Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Decline rate</h3>
                                        <div class="snapshot-card-value">
                                            7.7%
                                            <span class="snapshot-card-change negative">-1.8%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>15%</span>
                                            <span>10%</span>
                                            <span>5%</span>
                                            <span>0%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,190 Q50,188 100,182 Q150,178 200,175" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,185 Q50,183 100,177 Q150,173 200,170" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dispute Rate Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Dispute rate</h3>
                                        <div class="snapshot-card-value">
                                            0.8%
                                            <span class="snapshot-card-change negative">+0.1%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>2%</span>
                                            <span>1.5%</span>
                                            <span>1%</span>
                                            <span>0.5%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,195 Q50,193 100,187 Q150,183 200,180" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,190 Q50,188 100,182 Q150,178 200,175" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="performance-snapshot" style="display: none;">
                        <h2 class="snapshot-title">Key metrics</h2>
                        <div class="snapshot-grid">
                            <!-- Total Revenue Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Total revenue</h3>
                                        <div class="snapshot-card-value">
                                            $12.4K
                                            <span class="snapshot-card-change positive">+8.5%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>$15K</span>
                                            <span>$10K</span>
                                            <span>$5K</span>
                                            <span>$0</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,140 Q50,135 100,125 Q150,120 200,115" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,130 Q50,125 100,115 Q150,110 200,105" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Authorization Rate Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Authorization rate</h3>
                                        <div class="snapshot-card-value">
                                            92.3%
                                            <span class="snapshot-card-change positive">+1.8%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>100%</span>
                                            <span>95%</span>
                                            <span>90%</span>
                                            <span>85%</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,180 Q50,178 100,172 Q150,168 200,165" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,175 Q50,173 100,167 Q150,163 200,160" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transaction Volume Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Transaction volume</h3>
                                        <div class="snapshot-card-value">
                                            49
                                            <span class="snapshot-card-change positive">+12.3%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>60</span>
                                            <span>45</span>
                                            <span>30</span>
                                            <span>15</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,160 Q50,155 100,150 Q150,145 200,140" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,150 Q50,145 100,140 Q150,135 200,130" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Customer Count Card -->
                            <div class="snapshot-card">
                                <div class="snapshot-card-header">
                                    <div class="snapshot-card-title-section">
                                        <h3 class="snapshot-card-title">Customer count</h3>
                                        <div class="snapshot-card-value">
                                            23
                                            <span class="snapshot-card-change positive">+4.2%</span>
                                        </div>
                                    </div>
                                    <a href="#" class="explore-link">
                                        Explore
                                        <i data-lucide="arrow-up-right" style="width: 14px; height: 14px;"></i>
                                    </a>
                                </div>
                                <div class="snapshot-chart-container">
                                    <div class="snapshot-chart-content">
                                        <div class="snapshot-chart-y-axis">
                                            <span>30</span>
                                            <span>22</span>
                                            <span>15</span>
                                            <span>8</span>
                                        </div>
                                        <div class="snapshot-chart-area">
                                            <div class="snapshot-chart-grid"></div>
                                            <div class="snapshot-chart-bars">
                                                <svg class="snapshot-chart-svg" viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                                    <!-- Baseline line (dashed gray) -->
                                                    <path d="M0,170 Q50,168 100,165 Q150,162 200,160" stroke="#E4E7EC" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
                                                    <!-- Current line (solid blue) -->
                                                    <path d="M0,165 Q50,163 100,160 Q150,157 200,155" stroke="#3B82F6" stroke-width="2" fill="none"/>
                                                </svg>
                                            </div>
                                            <div class="snapshot-chart-x-axis">
                                                <span>Jul 18</span>
                                                <span>Jul 29</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Optimization Impact Tracking Chart -->
                    <div class="breakdown-section" style="margin-top: 24px;">
                        <div class="breakdown-header">
                            <div class="breakdown-title-section">
                                <h3 class="breakdown-title">Optimization impact summary</h3>
                            </div>
                            <div class="breakdown-controls">
                                <div class="breakdown-filters">
                                    <button class="breakdown-filter-btn active" data-metric="volume">Payment volume</button>
                                    <button class="breakdown-filter-btn" data-metric="payments">Payments</button>
                                    <button class="breakdown-filter-btn" data-metric="share">Share of payments</button>
                                    <button class="breakdown-filter-btn" data-metric="success">Success rate</button>
                                </div>
                                <div class="breakdown-dropdowns">
                                    <button class="dropdown-btn">
                                        Feature type
                                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                                    </button>
                                    <button class="download-btn">
                                        <i data-lucide="download" class="download-icon"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="breakdown-total">
                            <div class="total-label">
                                <span id="optimization-metric-label">Payment volume</span>
                                <i data-lucide="info" class="info-icon" style="width: 14px; height: 14px; color: var(--color-gray-400);"></i>
                            </div>
                            <span class="total-value" id="optimization-metric-value">$1.00</span>
                        </div>
                        
                        <!-- Bar Chart Container -->
                        <div class="bar-chart-container">
                            <div class="bar-chart-content">
                                <div class="bar-chart-y-axis">
                                    <span>$1.20</span>
                                    <span>$0.90</span>
                                    <span>$0.60</span>
                                    <span>$0.30</span>
                                    <span>$0</span>
                                </div>
                                <div class="bar-chart-area">
                                    <div class="bar-chart-grid"></div>
                                    <div class="bar-chart-bars">
                                        <svg class="bar-chart-svg" viewBox="0 0 800 200">
                                            <!-- Optimization impact bars -->
                                            <g class="bar-group" transform="translate(100, 0)">
                                                <rect x="0" y="20" width="40" height="160" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(200, 0)">
                                                <rect x="0" y="40" width="40" height="140" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(300, 0)">
                                                <rect x="0" y="60" width="40" height="120" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(400, 0)">
                                                <rect x="0" y="80" width="40" height="100" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(500, 0)">
                                                <rect x="0" y="100" width="40" height="80" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(600, 0)">
                                                <rect x="0" y="120" width="40" height="60" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                            <g class="bar-group" transform="translate(700, 0)">
                                                <rect x="0" y="140" width="40" height="40" fill="#3B82F6" opacity="0.8"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="bar-chart-x-axis">
                                        <span>Jul 2024</span>
                                        <span>Aug 2024</span>
                                        <span>Sep 2024</span>
                                        <span>Oct 2024</span>
                                        <span>Nov 2024</span>
                                        <span>Dec 2024</span>
                                        <span>Jan 2025</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bar-chart-footer">
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-header">
                                            <input type="checkbox" checked>
                                        </th>
                                        <th>Feature</th>
                                        <th>Recovered volume</th>
                                        <th>Recovered payments</th>
                                        <th>Success rate increase</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input type="checkbox" checked>
                                        </td>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check-circle" class="reason-icon"></i>
                                                <span>Adaptive Acceptance</span>
                                            </div>
                                        </td>
                                        <td id="adaptive-volume">+$0.00</td>
                                        <td id="adaptive-payments">+0</td>
                                        <td id="adaptive-success">+0.00%</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" checked>
                                        </td>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check-circle" class="reason-icon"></i>
                                                <span>Network Tokens</span>
                                            </div>
                                        </td>
                                        <td id="network-volume">+$0.00</td>
                                        <td id="network-payments">+0</td>
                                        <td id="network-success">+0.00%</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="checkbox" checked>
                                        </td>
                                        <td>
                                            <div class="reason-cell">
                                                <i data-lucide="check-circle" class="reason-icon"></i>
                                                <span>Card account updater</span>
                                            </div>
                                        </td>
                                        <td id="updater-volume">+$0.00</td>
                                        <td id="updater-payments">+0</td>
                                        <td id="updater-success">+0.00%</td>
                                    </tr>
                                    <tr class="total-row">
                                        <td></td>
                                        <td><strong>Total increase</strong></td>
                                        <td id="total-volume"><strong>+$0.00</strong></td>
                                        <td id="total-payments"><strong>+0</strong></td>
                                        <td id="total-success"><strong>+0.00%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Legacy Chart Containers (Hidden by default) -->
                    <div class="chart-container-wrapper" style="display: none;">
                        <!-- Bar Chart -->
                        <div class="waterfall-chart bar-chart">
                            <div class="waterfall-container">
                            <!-- Acceptance -->
                            <div class="waterfall-item starting" onclick="switchTabView('acceptance')">
                                <div class="waterfall-bar" style="height: 100px; background: #3B82F6;"></div>
                                <div class="waterfall-label">Acceptance</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${totalRevenue.toFixed(0)}</span>
                                    <span class="detail-rate">${allData.metrics.payments} transactions</span>
                                </div>
                            </div>

                            <!-- Authorization Losses -->
                            <div class="waterfall-item negative" onclick="switchTabView('acceptance')">
                                <div class="waterfall-bar" style="height: 20px; background: #EF4444;"></div>
                                <div class="waterfall-label">Declines</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</span>
                                    <span class="detail-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</span>
                                </div>
                            </div>

                            <!-- Dispute Losses -->
                            <div class="waterfall-item negative" onclick="switchTabView('disputes')">
                                <div class="waterfall-bar" style="height: 10px; background: #F97316;"></div>
                                <div class="waterfall-label">Disputes</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</span>
                                    <span class="detail-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</span>
                                </div>
                            </div>

                            <!-- Fraud -->
                            <div class="waterfall-item positive" onclick="switchTabView('authentication')">
                                <div class="waterfall-bar" style="height: 50px; background: #10B981;"></div>
                                <div class="waterfall-label">Fraud</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * 0.02).toFixed(0)}</span>
                                    <span class="detail-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</span>
                                </div>
                            </div>

                            <!-- Costs -->
                            <div class="waterfall-item negative" onclick="switchTabView('cost')">
                                <div class="waterfall-bar" style="height: 15px; background: #8B5CF6;"></div>
                                <div class="waterfall-label">Costs</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * 0.029).toFixed(0)}</span>
                                    <span class="detail-rate">Processing fees</span>
                                </div>
                            </div>

                            <!-- Final Total -->
                            <div class="waterfall-item total" onclick="switchTabView('overview')">
                                <div class="waterfall-bar" style="height: 65px; background: #533AFD;"></div>
                                <div class="waterfall-label">Total revenue</div>
                                <div class="waterfall-details">
                                    <span class="detail-value">$${(totalRevenue * successRate/100).toFixed(0)}</span>
                                    <span class="detail-rate">${successRate.toFixed(1)}% success rate</span>
                                </div>
                            </div>
                        </div>

                        <!-- Waterfall Chart Style -->
                        <div class="waterfall-chart waterfall-chart-style">
                            <div class="waterfall-container">
                                <!-- Acceptance -->
                                <div class="waterfall-item starting" onclick="switchTabView('acceptance')">
                                    <div class="waterfall-bar" style="height: 100px; background: #3B82F6;"></div>
                                    <div class="waterfall-label">Acceptance</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${totalRevenue.toFixed(0)}</span>
                                        <span class="detail-rate">${allData.metrics.payments} transactions</span>
                                    </div>
                                </div>

                                <!-- Authorization Losses -->
                                <div class="waterfall-item negative" onclick="switchTabView('acceptance')">
                                    <div class="waterfall-bar" style="height: 20px; background: #EF4444;"></div>
                                    <div class="waterfall-label">Declines</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</span>
                                        <span class="detail-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</span>
                                    </div>
                                </div>

                                <!-- Dispute Losses -->
                                <div class="waterfall-item negative" onclick="switchTabView('disputes')">
                                    <div class="waterfall-bar" style="height: 10px; background: #F97316;"></div>
                                    <div class="waterfall-label">Disputes</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</span>
                                        <span class="detail-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</span>
                                    </div>
                                </div>

                                <!-- Fraud -->
                                <div class="waterfall-item positive" onclick="switchTabView('authentication')">
                                    <div class="waterfall-bar" style="height: 50px; background: #10B981;"></div>
                                    <div class="waterfall-label">Fraud</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * 0.02).toFixed(0)}</span>
                                        <span class="detail-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</span>
                                    </div>
                                </div>

                                <!-- Costs -->
                                <div class="waterfall-item negative" onclick="switchTabView('cost')">
                                    <div class="waterfall-bar" style="height: 15px; background: #8B5CF6;"></div>
                                    <div class="waterfall-label">Costs</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * 0.029).toFixed(0)}</span>
                                        <span class="detail-rate">Processing fees</span>
                                    </div>
                                </div>

                                <!-- Final Total -->
                                <div class="waterfall-item total" onclick="switchTabView('overview')">
                                    <div class="waterfall-bar" style="height: 65px; background: #533AFD;"></div>
                                    <div class="waterfall-label">Total revenue</div>
                                    <div class="waterfall-details">
                                        <span class="detail-value">$${(totalRevenue * successRate/100).toFixed(0)}</span>
                                        <span class="detail-rate">${successRate.toFixed(1)}% success rate</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sankey Chart -->
                        <div class="sankey-chart">
                            <div class="sankey-container">
                                <!-- Stage 1: Acceptance -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #3B82F6;">
                                            <div class="sankey-label">Acceptance</div>
                                            <div class="sankey-value">$${totalRevenue.toFixed(0)}</div>
                                            <div class="sankey-rate">${allData.metrics.payments} transactions</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stage 2: Processing -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #EF4444;">
                                            <div class="sankey-label">Declines</div>
                                            <div class="sankey-value">$${(totalRevenue * (1 - successRate/100)).toFixed(0)}</div>
                                            <div class="sankey-rate">${Math.round(allData.metrics.payments * (1 - successRate/100))} declined</div>
                                        </div>
                                    </div>
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #F97316;">
                                            <div class="sankey-label">Disputes</div>
                                            <div class="sankey-value">$${(totalRevenue * metrics.disputeRate / 100).toFixed(0)}</div>
                                            <div class="sankey-rate">${Math.round(allData.metrics.payments * metrics.disputeRate / 100)} disputes</div>
                                        </div>
                                    </div>
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #10B981;">
                                            <div class="sankey-label">Fraud</div>
                                            <div class="sankey-value">$${(totalRevenue * 0.02).toFixed(0)}</div>
                                            <div class="sankey-rate">-$${(totalRevenue * 0.02).toFixed(0)} fraud losses</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stage 3: Final -->
                                <div class="sankey-stage">
                                    <div class="sankey-node">
                                        <div class="sankey-bar" style="background: #533AFD;">
                                            <div class="sankey-label">Total revenue</div>
                                            <div class="sankey-value">$${(totalRevenue * successRate/100).toFixed(0)}</div>
                                            <div class="sankey-rate">${successRate.toFixed(1)}% success rate</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                    
                    <!-- Right Column -->
                    <div style="flex: 0 0 30%; background: white; padding: 20px; border-radius: 8px; min-width: 0;">
                            <!-- Ask Assistant Section -->
                            <div class="assistant-section">
                                <div class="assistant-header">
                                    <div class="assistant-title-section">
                                        <i data-lucide="sparkles" class="sparkles-icon"></i>
                                        <h3 class="assistant-title">Ask Assistant</h3>
                                    </div>
                                </div>
                                <div class="suggested-prompts">
                                    <button class="prompt-btn" id="prompt-1" onclick="openAIPanel('How can I improve my ${successRate}% authorization rate for the ${dateRange.toLowerCase()}?', '${currentBusinessType}', 'success-rate', ${successRate}, '${dateRange}', ${allData.metrics.payments})">
                                        How can I improve my ${successRate}% authorization rate for the ${dateRange.toLowerCase()}?
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Optimization Insights Section -->
                            <div class="optimization-insights-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                                <h2 class="optimization-insights-title" style="margin: 0; font-size: 20px; font-weight: 600; color: var(--color-gray-900);">Optimization insights</h2>
                                <a href="#" class="view-all-link" onclick="navigateToOptimizationTab()">
                                    View all
                                    <i data-lucide="arrow-right" style="width: 14px; height: 14px;"></i>
                                </a>
                            </div>
                            
                            <div class="optimization-insights">
                                <div class="insight-card" onclick="openExperimentDrawer({
                                    id: 'enable-network-tokens',
                                    title: 'Enable Network Tokens',
                                    description: 'Increase your authorization rate by replacing card numbers with secure tokens',
                                    uplift: 6720,
                                    revenue: '+$6,720,000/year',
                                    effort: 'Easy'
                                })">
                                    <div class="insight-header">
                                        <div class="insight-content">
                                            <h4 class="insight-title">Enable Network Tokens</h4>
                                            <p class="insight-description">Increase your authorization rate</p>
                                        </div>
                                    </div>
                                    <div class="insight-impact">
                                        <span class="impact-value">Up to $6.72M</span>
                                        <div class="impact-label">Est. impact</div>
                                    </div>
                                </div>
                                
                                <div class="insight-card" onclick="openExperimentDrawer({
                                    id: 'enable-card-account-updater',
                                    title: 'Enable Card Account Updater',
                                    description: 'Raise your authorization rate by refreshing outdated customer payment details',
                                    uplift: 650,
                                    revenue: '+$650,000/year',
                                    effort: 'Easy'
                                })">
                                    <div class="insight-header">
                                        <div class="insight-content">
                                            <h4 class="insight-title">Enable Card Account Updater</h4>
                                            <p class="insight-description">Raise your authorization rate</p>
                                        </div>
                                    </div>
                                    <div class="insight-impact">
                                        <span class="impact-value">Up to $650K</span>
                                        <div class="impact-label">Est. impact</div>
                                    </div>
                                </div>
                                
                                <div class="insight-card" onclick="openExperimentDrawer({
                                    id: 'use-stored-credentials-api',
                                    title: 'Use Stored Credentials API',
                                    description: 'Send authorization messages in required formats',
                                    uplift: 650,
                                    revenue: '+$650,000/year',
                                    effort: 'Medium'
                                })">
                                    <div class="insight-header">
                                        <div class="insight-content">
                                            <h4 class="insight-title">Use Stored Credentials API</h4>
                                            <p class="insight-description">Send authorization messages in required formats</p>
                                        </div>
                                    </div>
                                    <div class="insight-impact">
                                        <span class="impact-value">Up to $650K</span>
                                        <div class="impact-label">Est. impact</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                        <div class="quick-actions" style="margin-bottom: 36px;">
                            <h3 class="actions-title">Quick actions</h3>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I set up a new experiment?', '${currentBusinessType}', 'setup-ab-test', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                Create experiment
                            </button>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I implement Payment Intents?', '${currentBusinessType}', 'implement-payment-intents', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="shield-check" style="width: 16px; height: 16px;"></i>
                                Implement Payment Intents
                            </button>
                            <button class="quick-action-btn" onclick="openAIPanel('How do I configure Smart Retries?', '${currentBusinessType}', 'configure-retries', 85.2, '${dateRange}', ${metrics.dailyTransactions * 30})">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                Configure Smart Retries
                            </button>
                        </div>
                        
                        <!-- Resources Section -->
                        <div class="resources-section" style="margin-bottom: 24px;">
                            <h3 class="resources-title">Resources</h3>
                            <div class="resource-item">
                                <i data-lucide="file-text" class="resource-icon"></i>
                                <div class="resource-content">
                                    <span class="resource-name">Payment optimization guide</span>
                                    <span class="resource-description">Learn how to optimize your payment performance and increase revenue.</span>
                                </div>
                            </div>
                            <div class="resource-item">
                                <i data-lucide="bar-chart" class="resource-icon"></i>
                                <div class="resource-content">
                                    <span class="resource-name">Experiments best practices</span>
                                    <span class="resource-description">Learn how to design and run effective payment optimization tests.</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    

                </div>
                </div>
        `;

        // Add the view to the main content area
        const mainContentInner = document.querySelector('.main-content-inner');
        if (mainContentInner) {
            // Check if overview view already exists in the main content
            let existingView = mainContentInner.querySelector('#overview-view');
            if (existingView) {
                existingView.remove();
            }
            mainContentInner.appendChild(overviewView);
        } else {
            document.body.appendChild(overviewView);
        }
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Initialize chart style dropdown functionality
        initializeChartStyleDropdown();
        
        // Update the page with current business type data
        const currentDateRange = document.getElementById('dateRangeDropdown').textContent.trim();
        updateOptimizationPage(currentBusinessType, currentDateRange);
        
        } catch (error) {
            console.error('Error creating overview view:', error);
        }
        
        return overviewView;
    }

    function createAuthenticationView() {
        const authView = document.createElement('div');
        authView.id = 'authentication-view';
        authView.className = 'tab-content';
        authView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-100);
            min-height: 100vh;
        `;

        authView.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center;">
                <h1 style="font-size: 32px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 16px;">Coming Soon</h1>
                <p style="font-size: 18px; color: var(--color-gray-600); margin: 0;">Authentication & Security features are under development</p>
            </div>
        `;

        document.body.appendChild(authView);
        return authView;
    }

    function createCostView() {
        const costView = document.createElement('div');
        costView.id = 'cost-view';
        costView.className = 'tab-content';
        costView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-100);
            min-height: 100vh;
        `;

        costView.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center;">
                <h1 style="font-size: 32px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 16px;">Coming Soon</h1>
                <p style="font-size: 18px; color: var(--color-gray-600); margin: 0;">Cost & Pricing Performance features are under development</p>
            </div>
        `;

        document.body.appendChild(costView);
        return costView;
    }

    function createDisputesView() {
        const disputesView = document.createElement('div');
        disputesView.id = 'disputes-view';
        disputesView.className = 'tab-content';
        disputesView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-100);
            min-height: 100vh;
        `;

        disputesView.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center;">
                <h1 style="font-size: 32px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 16px;">Coming Soon</h1>
                <p style="font-size: 18px; color: var(--color-gray-600); margin: 0;">Disputes & Chargebacks features are under development</p>
            </div>
        `;

        document.body.appendChild(disputesView);
        return disputesView;
    }

    function createPaymentMethodsView() {
        const paymentMethodsView = document.createElement('div');
        paymentMethodsView.id = 'payment-methods-view';
        paymentMethodsView.className = 'tab-content';
        paymentMethodsView.style.cssText = `
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background: var(--color-gray-100);
            min-height: 100vh;
        `;

        paymentMethodsView.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center;">
                <h1 style="font-size: 32px; font-weight: 600; color: var(--color-gray-900); margin-bottom: 16px;">Coming Soon</h1>
                <p style="font-size: 18px; color: var(--color-gray-600); margin: 0;">Payment Methods features are under development</p>
            </div>
        `;

        document.body.appendChild(paymentMethodsView);
        return paymentMethodsView;
    }

    // Performance stat cards click functionality
    function initializePerformanceStatCards() {
        const performanceCards = document.querySelectorAll('.performance-stat-card');
        performanceCards.forEach(card => {
            card.addEventListener('click', function() {
                const metric = this.getAttribute('data-metric');
                openMetricDetailsModal(metric);
            });
        });
    }

    // Open metric details modal
    function openMetricDetailsModal(metric) {
        const modal = document.getElementById('metricDetailsModal');
        const title = document.querySelector('.metric-modal-title');
        const subtitle = document.querySelector('.metric-modal-subtitle');
        
        // Set title based on metric
        const metricLabels = {
            'total-revenue': 'Total Revenue',
            'revenue-recovered': 'Total Revenue Recovered',
            'recovered-payments': 'Recovered Payments',
            'success-rate': 'Success Rate'
        };
        
        title.textContent = metricLabels[metric] || 'Metric Details';
        subtitle.textContent = 'Time series data and trends';
        
        // Generate and display chart data
        generateMetricChart(metric);
        
        // Update AI insights based on metric
        updateAIInsights(metric);
        
        // Show modal
        modal.style.display = 'block';
        
        // Reinitialize Lucide icons for the modal
        lucide.createIcons();
    }

    // Close metric details modal
    function closeMetricDetailsModal() {
        const modal = document.getElementById('metricDetailsModal');
        modal.style.display = 'none';
    }

    // Generate chart data for the metric
    function generateMetricChart(metric) {
        const svg = document.getElementById('metricChartSvg');
        const xAxis = document.getElementById('metricChartXAxis');
        const yAxisMax = document.getElementById('metricYAxisMax');
        const yAxisMin = document.getElementById('metricYAxisMin');
        
        // Get current date range
        const currentDateRange = document.getElementById('optimizationDateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        const dateLabels = getDateLabels(currentDateRange);
        
        // Set Y-axis labels based on metric type
        if (metric === 'success-rate') {
            yAxisMax.textContent = '100%';
            yAxisMin.textContent = '0%';
        } else if (metric === 'recovered-payments') {
            yAxisMax.textContent = '12';
            yAxisMin.textContent = '0';
        } else {
            yAxisMax.textContent = '$12K';
            yAxisMin.textContent = '$0';
        }
        
        // Generate data based on metric
        const generator = new RealisticDataGenerator(currentBusinessType, currentDateRange);
        let currentData, previousData, optimizedData;
        
        if (metric === 'total-revenue') {
            currentData = generator.generateTimeSeriesData(50, 0.2, 0.05);
            previousData = currentData.map(v => v * 0.8);
            optimizedData = currentData.map(v => v * 1.25);
        } else if (metric === 'revenue-recovered') {
            currentData = generator.generateTimeSeriesData(15, 0.3, 0.08);
            previousData = currentData.map(v => v * 0.9);
            optimizedData = currentData.map(v => v * 0.7);
        } else if (metric === 'recovered-payments') {
            currentData = generator.generateTimeSeriesData(8, 0.4, 0.1);
            previousData = currentData.map(v => v * 0.7);
            optimizedData = currentData.map(v => v * 1.4);
        } else if (metric === 'success-rate') {
            currentData = generator.generateTimeSeriesData(85, 0.1, 0.02);
            previousData = currentData.map(v => v * 0.95);
            optimizedData = currentData.map(v => Math.min(v * 1.08, 100));
        }
        
        // Convert to Y coordinates
        const xPoints = [60, 140, 220, 300, 380, 460, 540, 620];
        const maxValue = Math.max(...currentData, ...previousData, ...optimizedData);
        let scale;
        if (metric === 'success-rate') {
            scale = 300 / 100;
        } else if (metric === 'recovered-payments') {
            scale = 300 / 12; // Use count-based scale for recovered payments
        } else {
            scale = 300 / maxValue;
        }
        
        const currentY = currentData.map(v => 300 - (v * scale));
        const previousY = previousData.map(v => 300 - (v * scale));
        const optimizedY = optimizedData.map(v => 300 - (v * scale));
        
        // Build SVG paths
        let currentLine = '';
        let previousLine = '';
        let optimizedLine = '';
        
        for (let i = 0; i < xPoints.length; i++) {
            if (i === 0) {
                currentLine = `M${xPoints[i]},${currentY[i]}`;
                previousLine = `M${xPoints[i]},${previousY[i]}`;
                optimizedLine = `M${xPoints[i]},${optimizedY[i]}`;
            } else {
                currentLine += ` L${xPoints[i]},${currentY[i]}`;
                previousLine += ` L${xPoints[i]},${previousY[i]}`;
                optimizedLine += ` L${xPoints[i]},${optimizedY[i]}`;
            }
        }
        
        // Update SVG content
        svg.innerHTML = `
            <!-- Baseline performance line (gray) -->
            <path d="${previousLine}" stroke="#E4E7EC" stroke-width="2" fill="none"/>
            <!-- Current performance line (purple) -->
            <path d="${currentLine}" stroke="#533AFD" stroke-width="3" fill="none"/>
            <!-- Industry benchmark line (green) -->
            <path d="${optimizedLine}" stroke="#22C55E" stroke-width="3" fill="none" stroke-dasharray="5,5"/>
        `;
        
        // Update X-axis labels
        xAxis.innerHTML = dateLabels.map(label => `<span>${label}</span>`).join('');
    }

    // Update AI insights based on metric
    function updateAIInsights(metric) {
        const insightMetricName = document.getElementById('insight-metric-name');
        const insightTrend = document.getElementById('insight-trend');
        const insightImprovement = document.getElementById('insight-improvement');
        const aiRecommendationText = document.getElementById('ai-recommendation-text');
        
        const insights = {
            'total-revenue': {
                metricName: 'total revenue',
                trend: 'strong upward trend',
                improvement: '18% increase',
                recommendation: 'Consider expanding payment methods and implementing dynamic pricing to capture an additional 15-20% in revenue potential.'
            },
            'revenue-recovered': {
                metricName: 'revenue recovery',
                trend: 'stable recovery pattern',
                improvement: '8% improvement',
                recommendation: 'Implement smart retry logic and fraud detection systems to potentially recover an additional 25-30% of declined transactions.'
            },
            'recovered-payments': {
                metricName: 'payment recovery',
                trend: 'positive recovery trend',
                improvement: '14% increase',
                recommendation: 'Optimize retry strategies and add alternative payment methods to potentially recover 40-50% more failed transactions.'
            },
            'success-rate': {
                metricName: 'success rate',
                trend: 'positive trend',
                improvement: '12% improvement',
                recommendation: 'Consider implementing smart retry logic to recover declined transactions and potentially improve your success rate by an additional 3-5%.'
            }
        };
        
        const insight = insights[metric] || insights['success-rate'];
        
        if (insightMetricName) insightMetricName.textContent = insight.metricName;
        if (insightTrend) insightTrend.textContent = insight.trend;
        if (insightImprovement) insightImprovement.textContent = insight.improvement;
        if (aiRecommendationText) aiRecommendationText.textContent = insight.recommendation;
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('metricDetailsModal');
        if (e.target === modal) {
            closeMetricDetailsModal();
        }
    });

    // Initialize performance stat cards when optimization view is created
    
    // Notification Panel Functionality
    function toggleNotificationPanel() {
        console.log("Notification panel toggle called");
        const panel = document.getElementById("notificationPanel");
        if (panel.style.display === "none" || !panel.style.display) {
            panel.style.display = "flex";
            lucide.createIcons();
        } else {
            panel.style.display = "none";
        }
    }
    
    function hideNotificationPanel() {
        console.log("Notification panel hide called");
        const panel = document.getElementById("notificationPanel");
        if (panel) {
            panel.style.display = "none";
        }
    }
    
    // AI Integration Functions
    function askAIAboutAcceptanceDrop() {
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        const dateRange = document.getElementById('dateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        const question = "I noticed a significant change in my accepted volume on this date. What insights can you provide about this trend and how can I optimize my payment processing to maintain consistent volume growth?";
        
        try {
            openAIPanel(question, currentBusinessType, "german-card-diagnosis", 85.2, dateRange, 94);
            toggleNotificationPanel();
        } catch (error) {
            console.error('Error calling openAIAboutAcceptanceDrop:', error);
        }
    }
    
    function askAIAboutFraudPattern() {
        const question = "What should I do about the new fraud pattern detected in Asia?";
        openAIPanel(question, "medium", "fraud-pattern", 63.27, "Last 90 days", 31);
        toggleNotificationPanel();
    }
    
    function askAIAboutApplePay() {
        const question = "How can I expand Apple Pay to other regions given the 15% improvement?";
        openAIPanel(question, "medium", "apple-pay-expansion", 63.27, "Last 90 days", 31);
        toggleNotificationPanel();
    }
    
    function viewAcceptanceDetails() {
        console.log('viewAcceptanceDetails called - starting acceptance alert flow');
        
        // Change time frame to "Last 30 days"
        const dateRangeDropdown = document.getElementById('dateRangeDropdown');
        if (dateRangeDropdown) {
            dateRangeDropdown.textContent = 'Last 30 days';
            // Update the active state in the dropdown menu
            const dropdownMenu = document.getElementById('dateRangeMenu');
            if (dropdownMenu) {
                const items = dropdownMenu.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent === 'Last 30 days') {
                        item.classList.add('active');
                    }
                });
            }
        }
        
        // Set card country filter to Germany
        const cardCountryFilter = document.querySelector('.filter-chip[data-filter="card-country"]');
        if (cardCountryFilter) {
            cardCountryFilter.textContent = 'Germany';
            cardCountryFilter.classList.add('active');
        }
        
        // Switch to acceptance tab
        switchTabView("acceptance");
        hideNotificationPanel();
        hideAcceptanceAlertTooltip();
        
        // Automatically select the "Accepted volume" metric card and show the drop
        setTimeout(() => {
            console.log('Looking for Accepted volume card...');
            const allCards = document.querySelectorAll('.metric-card');
            let acceptedVolumeCard = null;
            
            // Find the Accepted volume card
            allCards.forEach(card => {
                const label = card.querySelector('.metric-label');
                if (label && label.textContent === 'Accepted volume') {
                    acceptedVolumeCard = card;
                    console.log('Found Accepted volume card:', card);
                }
            });
            
            if (acceptedVolumeCard) {
                console.log('Clicking Accepted volume card to trigger chart creation');
                // Trigger the metric card click event to create the proper Accepted volume chart
                acceptedVolumeCard.click();
                
                // Verify red dot was added after chart is created
                setTimeout(() => {
                    console.log('Checking if red dot was added...');
                    const redDot = document.querySelector('.acceptance-alert-indicator');
                    if (redDot) {
                        console.log('Red dot found in DOM:', redDot);
                        console.log('Red dot position:', redDot.getAttribute('cx'), redDot.getAttribute('cy'));
                    } else {
                        console.log('Red dot not found in DOM');
                    }
                }, 500);
            } else {
                console.log('Accepted volume card not found');
            }
        }, 100);
    }
    
    function showAcceptanceAlertDetails() {
        switchTabView("acceptance");
        hideNotificationPanel();
        hideAcceptanceAlertTooltip();
        
        // Set filters for the specific alert context
        setTimeout(() => {
            // Set date range to "Last 30 days" to show the July 17th drop
            setDateRangeFilter('Last 30 days');
            
            // Automatically select the "Accepted volume" metric card
            const allCards = document.querySelectorAll('.metric-card');
            let acceptedVolumeCard = null;
            
            // Find the Accepted volume card
            allCards.forEach(card => {
                const label = card.querySelector('.metric-label');
                if (label && label.textContent === 'Accepted volume') {
                    acceptedVolumeCard = card;
                }
            });
            
            if (acceptedVolumeCard) {
                // Trigger the metric card click event to create the proper Accepted volume chart
                acceptedVolumeCard.click();
                
                // The static red dots on the chart should now be functional
                // No need to add a floating red dot
                console.log('Accepted volume chart created with static red dots');
            }
        }, 100);
    }

    // Helper function to set date range filter
    function setDateRangeFilter(dateRange) {
        console.log('Setting date range filter to:', dateRange);
        
        const dateRangeDropdown = document.getElementById('dateRangeDropdown');
        const dateRangeMenu = document.getElementById('dateRangeMenu');
        
        if (dateRangeDropdown && dateRangeMenu) {
            // Update dropdown trigger text
            dateRangeDropdown.textContent = dateRange;
            dateRangeDropdown.appendChild(document.createElement('i')).setAttribute('data-lucide', 'chevron-down');
            dateRangeDropdown.querySelector('i').classList.add('filter-icon');
            
            // Update active state in dropdown menu
            const dropdownItems = dateRangeMenu.querySelectorAll('.dropdown-item');
            dropdownItems.forEach(item => {
                item.classList.remove('active');
                if (item.textContent === dateRange) {
                    item.classList.add('active');
                }
            });
            
            // Update charts with new date range
            const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            updateChartDateRanges(dateRange, currentBusinessType);
            
            // Update AI assistant prompts
            updateAssistantPrompts(currentBusinessType, dateRange);
            
            // Reinitialize lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            console.log('Date range filter set successfully to:', dateRange);
        } else {
            console.error('Date range dropdown elements not found');
        }
    }

    // Helper function to set card country filter
    function setCardCountryFilter(countryCode) {
        console.log('Setting card country filter to:', countryCode);
        
        // Find the card country filter chip
        const filterChips = document.querySelectorAll('.filter-chip');
        let cardCountryChip = null;
        
        filterChips.forEach(chip => {
            if (chip.textContent.includes('Card country')) {
                cardCountryChip = chip;
            }
        });
        
        if (cardCountryChip) {
            // Convert country code to display name
            const countryNames = {
                'GE': 'Germany',
                'US': 'United States',
                'GB': 'United Kingdom',
                'FR': 'France',
                'IT': 'Italy',
                'ES': 'Spain',
                'NL': 'Netherlands',
                'CA': 'Canada',
                'AU': 'Australia',
                'JP': 'Japan'
            };
            
            const countryName = countryNames[countryCode] || countryCode;
            
            // Update the chip to show the selected country
            cardCountryChip.innerHTML = `
                <i data-lucide="x" class="chip-icon" style="cursor: pointer;" onclick="clearCardCountryFilter(event)"></i>
                Card country: ${countryName}
            `;
            cardCountryChip.classList.add('active');
            cardCountryChip.dataset.selectedCountry = countryCode;
            
            // Reinitialize lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            console.log('Card country filter set successfully to:', countryName);
        } else {
            console.error('Card country filter chip not found');
        }
    }

    // Helper function to clear card country filter
    function clearCardCountryFilter(event) {
        event.stopPropagation();
        
        const cardCountryChip = event.target.closest('.filter-chip');
        if (cardCountryChip) {
                    // Reset to default state
        cardCountryChip.innerHTML = `
            <i data-lucide="plus" class="chip-icon"></i>
            Card country
        `;
        cardCountryChip.classList.remove('active');
        delete cardCountryChip.dataset.selectedCountry;
            
            // Reinitialize lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            console.log('Card country filter cleared');
        }
    }
    
    function viewFraudDetails() {
        switchTabView("disputes");
        hideNotificationPanel();
    }
    
    function viewOpportunityDetails() {
        switchTabView("payment methods");
        hideNotificationPanel();
    };
    
    // Experiment Drawer Functions
    let currentRecommendation = null;
    
    // Test function to verify JavaScript is working
    function testExperimentButton() {
        console.log('Test function called - JavaScript is working!');
        alert('JavaScript is working!');
    }
    
    // Test function for Ask Assistant button
    function testAskAssistant() {
        console.log('testAskAssistant function called');
        alert('Ask Assistant button is working!');
        
        // Now call the actual function
        askAIAboutAcceptanceDrop();
    }
    
    // Test function for experiment drawer
    function testExperimentDrawer() {
        console.log('Testing experiment drawer...');
        const testRecommendation = {
            id: 'test-experiment',
            title: 'Test Payment Optimization',
            description: 'This is a test recommendation to verify the drawer is working correctly.',
            uplift: 15,
            revenue: '+$50,000/year',
            effort: 'Test (1 day)'
        };
        
        console.log('Calling openExperimentDrawer with test data:', testRecommendation);
        openExperimentDrawer(testRecommendation);
    }
    
    // Test function specifically for Smart Retries button
    function testSmartRetriesButton() {
        console.log('Testing Smart Retries button functionality...');
        // Simulate the exact same action as the AI panel button
        const action = {
            action: 'smart-retries',
            text: 'Smart retries',
            icon: 'refresh-cw'
        };
        
        console.log('Action button clicked:', action);
        console.log('Smart retries action detected, opening experiment drawer...');
        // Close AI panel first to avoid conflicts
        closeAIPanel();
        
        const experimentData = {
            id: 'smart-retries',
            title: 'Smart Retries',
            description: 'Automatically retry failed payments with intelligent timing and bank-specific strategies to recover lost revenue.',
            impact: 'High',
            effort: 'Medium',
            category: 'Payment Optimization',
            status: 'recommended',
            metrics: {
                successRate: 85.2,
                revenueIncrease: 15,
                timeToImplement: '2-3 days'
            }
        };
        console.log('Experiment data:', experimentData);
        
        // Add a small delay to ensure AI panel is closed
        setTimeout(() => {
            openExperimentDrawer(experimentData);
        }, 100);
    }
    
    // Test function to simulate clicking the Smart Retries pill in AI panel
    function testSmartRetriesPill() {
        console.log('Testing Smart Retries pill functionality...');
        // Simulate the exact same pill data as in the AI panel
        const pill = {
            action: 'smart-retries',
            text: 'Smart retries',
            icon: 'refresh-cw',
            type: 'primary'
        };
        
        console.log('Pill clicked:', pill);
        
        // Special handling for smart-retries action to open experiment drawer
        if (pill.action === 'smart-retries') {
            console.log('Smart retries action detected, opening experiment drawer...');
            // Close AI panel first to avoid conflicts
            closeAIPanel();
            
            const experimentData = {
                id: 'smart-retries',
                title: 'Smart Retries',
                description: 'Automatically retry failed payments with intelligent timing and bank-specific strategies to recover lost revenue.',
                impact: 'High',
                effort: 'Medium',
                category: 'Payment Optimization',
                status: 'recommended',
                metrics: {
                    successRate: 85.2,
                    revenueIncrease: 15,
                    timeToImplement: '2-3 days'
                }
            };
            console.log('Experiment data:', experimentData);
            
            // Add a small delay to ensure AI panel is closed
            setTimeout(() => {
                openExperimentDrawer(experimentData);
            }, 100);
        }
    }
    
    // Test function for Payment success rate blue dots
    function testPaymentSuccessRateBlueDots() {
        console.log('Testing Payment success rate blue dots...');
        
        // Find the Payment success rate metric card and click it
        const metricCards = document.querySelectorAll('.metric-card');
        let paymentSuccessCard = null;
        
        metricCards.forEach(card => {
            const label = card.querySelector('.metric-label');
            if (label && label.textContent === 'Payment success rate') {
                paymentSuccessCard = card;
            }
        });
        
        if (paymentSuccessCard) {
            console.log('Found Payment success rate card, clicking it...');
            paymentSuccessCard.click();
            
            // Wait a moment for the chart to update, then check for blue dots
            setTimeout(() => {
                const chartSvg = document.querySelector('.chart-area .chart-svg');
                if (chartSvg) {
                    const blueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                    console.log(`Found ${blueDots.length} blue dots on Payment success rate chart`);
                    
                    blueDots.forEach((dot, index) => {
                        const circle = dot.querySelector('.blue-dot');
                        if (circle) {
                            const cx = circle.getAttribute('cx');
                            const cy = circle.getAttribute('cy');
                            console.log(`Blue dot ${index + 1} position:`, cx, cy);
                        }
                    });
                } else {
                    console.log('Chart SVG not found');
                }
            }, 1000);
        } else {
            console.log('Payment success rate card not found');
        }
    }
    
    // Force add blue dots to current chart
    function forceAddBlueDots() {
        console.log('forceAddBlueDots called');
        
        const chartSvg = document.querySelector('.chart-area .chart-svg');
        if (!chartSvg) {
            console.log('Chart SVG not found, retrying...');
            setTimeout(() => forceAddBlueDots(), 100);
            return;
        }
        
        console.log('Chart SVG found, proceeding with blue dot addition');
        
        // Remove any existing blue dots first
        const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
        existingBlueDots.forEach(dot => dot.remove());
        
        // Get the actual chart data to position dots correctly
        const generator = new RealisticDataGenerator(
            document.querySelector('.business-type-tab.active')?.dataset.type || 'medium',
            document.getElementById('dateRangeDropdown')?.textContent?.trim() || 'Last 90 days'
        );
        const chartData = generator.generateMainChartData();
        
        console.log('Chart data generated:', chartData);
        
        // Use exact x-coordinates that match the chart
        const xPoints = [80, 200, 320, 440, 560, 680, 720];
        
        // Use actual Y coordinates from the chart data
        const currentY = chartData.current;
        
        console.log('Current Y values:', currentY);
        
        // June 1st (index 3) - key insight point
        const june1X = xPoints[3];
        const june1Y = currentY[3];
        console.log('Adding blue dot at June 1st:', june1X, june1Y);
        addBlueDotIndicator(chartSvg, june1X, june1Y, 3, 'payment-success-rate');
        
        // June 15th (index 4) - another key data point
        const june15X = xPoints[4];
        const june15Y = currentY[4];
        console.log('Adding blue dot at June 15th:', june15X, june15Y);
        addBlueDotIndicator(chartSvg, june15X, june15Y, 4, 'payment-success-rate');
        
        console.log('Blue dots added to Payment success rate chart');
    }
    
    // Auto-add blue dots when on Acceptance tab
    function autoAddBlueDotsOnAcceptance() {
        // Check if we're on the Acceptance tab with Payment success rate selected
        const activeTab = document.querySelector('.nav-tab.active');
        const isOnAcceptanceTab = activeTab?.textContent?.includes('Acceptance');
        const selectedMetricCard = document.querySelector('.metric-card.selected');
        const isPaymentSuccessRateSelected = selectedMetricCard?.querySelector('.metric-label')?.textContent === 'Payment success rate';
        
        console.log('Tab detection:', {
            activeTab: activeTab?.textContent,
            isOnAcceptanceTab: isOnAcceptanceTab,
            selectedMetric: selectedMetricCard?.querySelector('.metric-label')?.textContent,
            isPaymentSuccessRateSelected: isPaymentSuccessRateSelected
        });
        
        if (isOnAcceptanceTab && isPaymentSuccessRateSelected) {
            console.log('Adding blue dots for Payment success rate chart');
            forceAddBlueDots();
        } else {
            console.log('Not adding blue dots - conditions not met');
            // Remove any existing blue dots if we're not on the right chart
            const chartSvg = document.querySelector('.chart-area .chart-svg');
            if (chartSvg) {
                const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                existingBlueDots.forEach(dot => dot.remove());
            }
        }
    }
    
    // Set up automatic blue dot addition
    function setupAutoBlueDots() {
        console.log('Setting up automatic blue dots...');
        
        // Add blue dots when page loads - reduced delay for faster appearance
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(autoAddBlueDotsOnAcceptance, 200);
        });
        
        // Add blue dots when switching tabs
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Wait for tab content to load, then add blue dots
                setTimeout(() => {
                    console.log('Tab clicked, checking for blue dots...');
                    autoAddBlueDotsOnAcceptance();
                }, 300);
            });
        });
        
        // Add blue dots when chart updates
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.target.classList.contains('chart-area')) {
                    // Remove any existing blue dots
                    const chartSvg = document.querySelector('.chart-area .chart-svg');
                    if (chartSvg) {
                        const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                        existingBlueDots.forEach(dot => dot.remove());
                    }
                    
                    // Then check if we should add blue dots back
                    setTimeout(autoAddBlueDotsOnAcceptance, 100);
                }
            });
        });
        
        // Also run a periodic check to ensure blue dots are always present when they should be
        setInterval(() => {
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab?.textContent?.includes('Acceptance')) {
                const chartSvg = document.querySelector('.chart-area .chart-svg');
                if (chartSvg && chartSvg.querySelectorAll('.blue-dot-indicator').length === 0) {
                    console.log('Periodic check: No blue dots found, adding them...');
                    autoAddBlueDotsOnAcceptance();
                }
            }
        }, 2000); // Check every 2 seconds
        
        const chartArea = document.querySelector('.chart-area');
        if (chartArea) {
            observer.observe(chartArea, { childList: true, subtree: true });
        }
        
        // Add blue dots when metric cards are clicked
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach(card => {
            card.addEventListener('click', () => {
                // Remove any existing blue dots when any metric card is clicked
                const chartSvg = document.querySelector('.chart-area .chart-svg');
                if (chartSvg) {
                    const existingBlueDots = chartSvg.querySelectorAll('.blue-dot-indicator');
                    existingBlueDots.forEach(dot => dot.remove());
                }
                
                // Then check if we should add blue dots back
                setTimeout(autoAddBlueDotsOnAcceptance, 100);
            });
        });
    }
    

    
    // Function to open new experiment drawer with dropdown selection
    function openNewExperimentDrawer() {
        console.log('Opening new experiment drawer...');
        console.log('Function called successfully');
        
        // Get available recommendations from the opportunities data
        const availableExperiments = [
            {
                id: 'payment-intents',
                title: 'Payment Intents',
                description: 'Implement Payment Intents for better authorization rates and improved payment success.',
                uplift: 12,
                revenue: '+$45,000/year',
                effort: 'Medium (1-2 dev days)'
            },
            {
                id: 'smart-retries',
                title: 'Smart Retries',
                description: 'Enable intelligent retry logic for declined payments to recover lost revenue.',
                uplift: 8,
                revenue: '+$38,000/year',
                effort: 'Easy (30 minute setup)'
            },
            {
                id: 'connect-marketplace',
                title: 'Connect Marketplace',
                description: 'Set up Connect for multi-party payment flows to enable marketplace functionality.',
                uplift: 15,
                revenue: '+$32,000/year',
                effort: 'Medium (3-5 dev days)'
            },
            {
                id: 'digital-wallets',
                title: 'Digital Wallets',
                description: 'Integrate Apple Pay and Google Pay for improved mobile conversion rates.',
                uplift: 6,
                revenue: '+$28,000/year',
                effort: 'Easy (1 day setup)'
            },
            {
                id: '3d-secure-optimization',
                title: '3D Secure Optimization',
                description: 'Optimize 3D Secure authentication flow to reduce abandonment rates.',
                uplift: 10,
                revenue: '+$35,000/year',
                effort: 'Medium (2-3 dev days)'
            },
            {
                id: 'custom-experiment',
                title: 'Custom Experiment',
                description: 'Create a custom experiment with your own parameters.',
                uplift: 0,
                revenue: 'Variable',
                effort: 'Variable'
            }
        ];
        
        // Create and show experiment selection modal
        const modal = document.createElement('div');
        modal.className = 'experiment-selection-modal';
        modal.innerHTML = `
            <div class="experiment-selection-content">
                <div class="experiment-selection-header">
                    <h3>Select Experiment</h3>
                    <button class="close-btn" onclick="closeExperimentSelection()">
                        <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                    </button>
                </div>
                <div class="experiment-selection-body">
                    <p class="selection-description">Choose from available recommendations or create a custom experiment:</p>
                    <div class="experiment-options">
                        ${availableExperiments.map(exp => `
                            <div class="experiment-option" onclick="selectExperiment('${exp.id}')">
                                <div class="experiment-option-header">
                                    <h4>${exp.title}</h4>
                                    <span class="uplift-badge">+${exp.uplift}%</span>
                                </div>
                                <p class="experiment-option-description">${exp.description}</p>
                                <div class="experiment-option-meta">
                                    <span class="revenue">${exp.revenue}</span>
                                    <span class="effort">${exp.effort}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Store available experiments for selection
        window.availableExperiments = availableExperiments;
    }
    
    // Function to select an experiment from the dropdown
    function selectExperiment(experimentId) {
        console.log('selectExperiment called with:', experimentId);
        // Define available experiments locally to avoid dependency on window.availableExperiments
        const availableExperiments = [
            {
                id: 'payment-intents',
                title: 'Payment Intents',
                description: 'Implement Payment Intents for better authorization rates and improved payment success.',
                uplift: 12,
                revenue: '+$45,000/year',
                effort: 'Medium (1-2 dev days)'
            },
            {
                id: 'smart-retries',
                title: 'Smart Retries',
                description: 'Enable intelligent retry logic for declined payments to recover lost revenue.',
                uplift: 8,
                revenue: '+$38,000/year',
                effort: 'Easy (30 minute setup)'
            },
            {
                id: 'connect-marketplace',
                title: 'Connect Marketplace',
                description: 'Set up Connect for multi-party payment flows to enable marketplace functionality.',
                uplift: 15,
                revenue: '+$32,000/year',
                effort: 'Medium (3-5 dev days)'
            },
            {
                id: 'digital-wallets',
                title: 'Digital Wallets',
                description: 'Integrate Apple Pay and Google Pay for improved mobile conversion rates.',
                uplift: 6,
                revenue: '+$28,000/year',
                effort: 'Easy (1 day setup)'
            },
            {
                id: '3d-secure-optimization',
                title: '3D Secure Optimization',
                description: 'Optimize 3D Secure authentication flow to reduce abandonment rates.',
                uplift: 10,
                revenue: '+$35,000/year',
                effort: 'Medium (2-3 dev days)'
            },
            {
                id: 'custom-experiment',
                title: 'Custom Experiment',
                description: 'Create a custom experiment with your own parameters.',
                uplift: 0,
                revenue: 'Variable',
                effort: 'Variable'
            }
        ];
        
        const selectedExperiment = availableExperiments.find(exp => exp.id === experimentId);
        
        if (selectedExperiment) {
            // Close the selection modal
            closeExperimentSelection();
            
            // Open the experiment drawer with the selected experiment
            openExperimentDrawer(selectedExperiment);
        } else {
            console.error('Experiment not found:', experimentId);
        }
    }
    
    // Function to close experiment selection modal
    function closeExperimentSelection() {
        const modal = document.querySelector('.experiment-selection-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    function openExperimentDrawer(recommendation) {
        console.log('openExperimentDrawer called with:', recommendation);
        console.log('Type of recommendation:', typeof recommendation);
        console.log('Recommendation stringified:', JSON.stringify(recommendation));
        
        // Handle both string and object parameters for backward compatibility
        if (typeof recommendation === 'string') {
            console.log('Converting string to object for:', recommendation);
            recommendation = {
                id: recommendation.toLowerCase().replace(/\s+/g, '-'),
                title: recommendation,
                description: 'No description available',
                uplift: 0,
                revenue: 'Variable',
                effort: 'Variable'
            };
        }
        
        // Validate recommendation object
        if (!recommendation || typeof recommendation !== 'object') {
            console.error('Invalid recommendation object:', recommendation);
            console.error('Expected object but got:', typeof recommendation);
            return;
        }
        
        currentRecommendation = recommendation;
        const drawer = document.getElementById('experimentDrawer');
        const recommendationDiv = document.getElementById('experimentRecommendation');
        
        console.log('Drawer element found:', !!drawer);
        console.log('Recommendation div found:', !!recommendationDiv);
        
        if (!drawer || !recommendationDiv) {
            console.error('Required elements not found');
            return;
        }
        
        // Populate recommendation content
        console.log('Recommendation data:', {
            title: recommendation.title,
            description: recommendation.description,
            uplift: recommendation.uplift
        });
        
        // Calculate appropriate impact percentage based on recommendation
        let impactPercentage = 0;
        let impactText = '';
        
        if (recommendation.id === 'enable-network-tokens') {
            impactPercentage = 8;
            impactText = 'Expected increase in authorization rate';
        } else if (recommendation.id === 'enable-card-account-updater') {
            impactPercentage = 6;
            impactText = 'Expected increase in authorization rate';
        } else if (recommendation.id === 'use-stored-credentials-api') {
            impactPercentage = 5;
            impactText = 'Expected increase in authorization rate';
        } else if (recommendation.id === 'payment-intents') {
            impactPercentage = 12;
            impactText = 'Expected increase in success rate';
        } else if (recommendation.id === 'smart-retries') {
            impactPercentage = 8;
            impactText = 'Expected recovery of declined payments';
        } else if (recommendation.id === 'connect-marketplace') {
            impactPercentage = 15;
            impactText = 'Expected increase in conversion rate';
        } else {
            impactPercentage = 5;
            impactText = 'Expected improvement in performance';
        }
        
        recommendationDiv.innerHTML = `
            <div class="recommendation-title">${recommendation.title || 'Recommendation'}</div>
            <div class="recommendation-description">${recommendation.description || 'No description available'}</div>
            <div class="recommendation-uplift">
                <span class="uplift-badge">+${impactPercentage}%</span>
                <span class="uplift-text">${impactText}</span>
            </div>
        `;
        
        console.log('Updated recommendation div HTML:', recommendationDiv.innerHTML);
        
        // Set minimum date to today and pre-select 30 days from now
        const today = new Date();
        const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('endDate').min = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = thirtyDaysFromNow.toISOString().split('T')[0];
        
        // Reset form
        document.getElementById('rolloutSlider').value = 10;
        document.getElementById('rolloutValue').textContent = '10%';
        document.getElementById('experimentName').value = '';
        
        // Open drawer
        drawer.classList.add('open');
        
        // Initialize slider
        initializeSlider();
    }
    
    function closeExperimentDrawer() {
        const drawer = document.getElementById('experimentDrawer');
        drawer.classList.remove('open');
        currentRecommendation = null;
    }
    
    function initializeSlider() {
        const slider = document.getElementById('rolloutSlider');
        const value = document.getElementById('rolloutValue');
        
        // Remove existing event listeners to prevent duplicates
        slider.removeEventListener('input', slider._inputHandler);
        
        // Create new handler and store reference
        slider._inputHandler = function() {
            value.textContent = this.value + '%';
        };
        
        slider.addEventListener('input', slider._inputHandler);
    }
    
    function startExperiment() {
        if (!currentRecommendation) return;
        
        const rolloutPercentage = document.getElementById('rolloutSlider').value;
        const endDate = document.getElementById('endDate').value;
        const experimentName = document.getElementById('experimentName').value || currentRecommendation.title;
        
        if (!endDate) {
            alert('Please select an end date for the experiment.');
            return;
        }
        
        // Create experiment object
        const experiment = {
            id: Date.now(),
            name: experimentName,
            recommendation: currentRecommendation,
            rolloutPercentage: parseInt(rolloutPercentage),
            endDate: endDate,
            startDate: new Date().toISOString().split('T')[0],
            status: 'active',
            results: null
        };
        
        // Add to experiments list (this will make it appear in the Experiments table)
        addExperimentToList(experiment);
        
        // Update all views to reflect the change
        updateAllViewsAfterExperimentStart(experiment);
        
        // Close drawer
        closeExperimentDrawer();
        
        // Show success message
        showExperimentStartedMessage(experiment);
    }
    
    // Global storage for experiments
    window.activeExperiments = [];
    
    // Unified data management functions
    function getRecommendations(businessType = 'medium') {
        // Ensure opportunitiesData exists and has the requested business type
        if (!window.opportunitiesData || !window.opportunitiesData[businessType]) {
            console.warn(`Business type '${businessType}' not found in opportunitiesData, falling back to 'medium'`);
            businessType = 'medium';
        }
        
        const opportunities = window.opportunitiesData[businessType] || [];
        
        // Ensure activeExperiments exists and is an array
        if (!window.activeExperiments || !Array.isArray(window.activeExperiments)) {
            console.warn('activeExperiments is not properly initialized, using empty array');
            window.activeExperiments = [];
        }
        
        const activeExperimentIds = window.activeExperiments.map(exp => exp.recommendation.id);
        const availableRecommendations = opportunities.filter(opp => !activeExperimentIds.includes(opp.id));
        
        console.log('Available recommendations:', availableRecommendations.length, 'out of', opportunities.length, 'total');
        console.log('Active experiments:', window.activeExperiments.length);
        
        return availableRecommendations;
    }
    
    function getTopRecommendations(businessType = 'growth', count = 3) {
        const recommendations = getRecommendations(businessType);
        const topRecommendations = recommendations.slice(0, count);
        
        console.log('Top recommendations for', businessType, ':', topRecommendations.length);
        
        return topRecommendations;
    }
    
    function isRecommendationActive(recommendationId) {
        if (!window.activeExperiments || !Array.isArray(window.activeExperiments)) {
            return false;
        }
        return window.activeExperiments.some(exp => exp.recommendation.id === recommendationId);
    }
    
    // Function to get active experiments for display
    function getActiveExperiments() {
        if (!window.activeExperiments || !Array.isArray(window.activeExperiments)) {
            return [];
        }
        return window.activeExperiments.filter(exp => exp.status === 'active');
    }
    
    // Function to get completed experiments for display
    function getCompletedExperiments() {
        if (!window.activeExperiments || !Array.isArray(window.activeExperiments)) {
            return [];
        }
        return window.activeExperiments.filter(exp => exp.status === 'completed');
    }
    
    // Unified opportunities data source
    window.opportunitiesData = {
        small: [
            {
                id: 'enable-network-tokens',
                title: 'Enable Network Tokens',
                description: 'Increase your authorization rate',
                impact: 'Up to $67K',
                impactLabel: 'Est. impact',
                revenue: '+$67,000/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'enable-card-account-updater',
                title: 'Enable Card Account Updater',
                description: 'Raise your authorization rate',
                impact: 'Up to $6.5K',
                impactLabel: 'Est. impact',
                revenue: '+$6,500/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'use-stored-credentials-api',
                title: 'Use Stored Credentials API',
                description: 'Send authorization messages in required formats',
                impact: 'Up to $6.5K',
                impactLabel: 'Est. impact',
                revenue: '+$6,500/year',
                effort: 'Medium',
                effortDetail: 'Requires code',
                timeline: '1-2 weeks',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'Requires code'
            }
        ],
        medium: [
            {
                id: 'enable-network-tokens',
                title: 'Enable Network Tokens',
                description: 'Increase your authorization rate',
                impact: 'Up to $6.72M',
                impactLabel: 'Est. impact',
                revenue: '+$6,720,000/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'enable-card-account-updater',
                title: 'Enable Card Account Updater',
                description: 'Raise your authorization rate',
                impact: 'Up to $650K',
                impactLabel: 'Est. impact',
                revenue: '+$650,000/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'use-stored-credentials-api',
                title: 'Use Stored Credentials API',
                description: 'Send authorization messages in required formats',
                impact: 'Up to $650K',
                impactLabel: 'Est. impact',
                revenue: '+$650,000/year',
                effort: 'Medium',
                effortDetail: 'Requires code',
                timeline: '1-2 weeks',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'Requires code'
            }
        ],
        large: [
            {
                id: 'enable-network-tokens',
                title: 'Enable Network Tokens',
                description: 'Increase your authorization rate',
                impact: 'Up to $67M',
                impactLabel: 'Est. impact',
                revenue: '+$67,000,000/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'enable-card-account-updater',
                title: 'Enable Card Account Updater',
                description: 'Raise your authorization rate',
                impact: 'Up to $6.5M',
                impactLabel: 'Est. impact',
                revenue: '+$6,500,000/year',
                effort: 'Easy',
                effortDetail: 'No code required',
                timeline: 'Same day',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'No code required',
                appearsOn: '/acceptance'
            },
            {
                id: 'use-stored-credentials-api',
                title: 'Use Stored Credentials API',
                description: 'Send authorization messages in required formats',
                impact: 'Up to $6.5M',
                impactLabel: 'Est. impact',
                revenue: '+$6,500,000/year',
                effort: 'Medium',
                effortDetail: 'Requires code',
                timeline: '1-2 weeks',
                category: 'Acceptance',
                cta: 'Experiment',
                implementation: 'Requires code'
            }
        ]
    };

    function addExperimentToList(experiment) {
        // Add to global experiments array
        window.activeExperiments.push(experiment);
        
        console.log('Experiment added to list:', experiment);
        console.log('Total active experiments:', window.activeExperiments.length);
        
        // Update the experiments table
        updateExperimentsTable();
    }
    
    // Function to update all views after an experiment is started
    function updateAllViewsAfterExperimentStart(experiment) {
        console.log('Updating all views after experiment start:', experiment);
        
        // Update recommendations table (will automatically filter out active experiments)
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        updateRecommendationsTable(currentBusinessType);
        
        // Update optimization insights cards (will show next available recommendations)
        updateOptimizationInsightsCards(currentBusinessType);
        
        // Update experiments table (will show the new experiment)
        updateExperimentsTable();
        
        // Update overview page optimization insights if visible
        const overviewView = document.getElementById('overview-view');
        if (overviewView && overviewView.style.display !== 'none') {
            updateOptimizationInsightsCards(currentBusinessType);
        }
        
        // Note: Toast notification is handled by showExperimentStartedMessage in startExperiment()
    }
    

    
    function removeRecommendationFromList(recommendationId) {
        // Recommendations are now managed through the unified system
        // The filtering happens automatically in getRecommendations()
        
        // Update the recommendations table
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        updateRecommendationsTable(currentBusinessType);
        
        console.log('Recommendation removed from list:', recommendationId);
    }
    
    function removeOptimizationInsightCard(recommendationId) {
        // Find and remove the insight card that matches the recommendation ID
        const insightCards = document.querySelectorAll('.insight-card');
        insightCards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(`id: '${recommendationId}'`)) {
                card.remove();
                console.log('Optimization insight card removed:', recommendationId);
            }
        });
        
        // Update the optimization page to reflect the change
        const optimizationView = document.querySelector('.optimization-view');
        if (optimizationView) {
            const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
            updateOptimizationOpportunities(optimizationView, currentBusinessType, {}, 'Last 90 days');
        }
        
        // Also update the optimization insights on the overview page
        updateOptimizationInsightsCards('medium');
    }
    
    function updateExperimentsTable() {
        // Find the Experiments table specifically (not Past optimizations)
        const experimentsSections = document.querySelectorAll('.ab-testing-section');
        let tableBody = null;
        
        for (const section of experimentsSections) {
            const title = section.querySelector('.ab-title');
            if (title && title.textContent === 'Experiments') {
                tableBody = section.querySelector('.ab-tests-table tbody');
                break;
            }
        }
        
        if (!tableBody) return;
        
        // Clear existing rows except the first two (which are static examples)
        const existingRows = tableBody.querySelectorAll('tr');
        for (let i = 2; i < existingRows.length; i++) {
            existingRows[i].remove();
        }
        
        const activeExperiments = getActiveExperiments();
        console.log('Adding experiments to table:', activeExperiments.length, 'active experiments');
        
        // Add new experiments
        activeExperiments.forEach(experiment => {
            const row = document.createElement('tr');
            row.className = 'active';
            row.innerHTML = `
                <td>
                    <div class="test-cell">
                        <div class="test-title">${experiment.name}</div>
                        <div class="test-description">${experiment.recommendation.description}</div>
                    </div>
                </td>
                <td>
                    <div class="status-cell active">
                        <span class="status-dot"></span>
                        <span class="status-text">Active</span>
                    </div>
                </td>
                <td>
                    <div class="progress-cell">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 10%"></div>
                        </div>
                        <span class="progress-text">10% Complete</span>
                    </div>
                </td>
                <td>
                    <span class="rate-value">--</span>
                </td>
                <td>
                    <span class="rate-value">--</span>
                </td>
                <td>
                    <span class="improvement">--</span>
                </td>
                <td>
                    <div class="table-actions">
                        <button class="table-btn secondary">
                            <i data-lucide="bar-chart" style="width: 14px; height: 14px;"></i>
                            Details
                        </button>
                        <button class="table-btn secondary">
                            <i data-lucide="pause" style="width: 14px; height: 14px;"></i>
                            Pause
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Reinitialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function updateRecommendationsTable(businessType = 'medium') {
        const tableBody = document.querySelector('.opportunities-table tbody');
        if (!tableBody) return;
        
        // Clear existing rows
        tableBody.innerHTML = '';
        
        // Get recommendations using unified data source
        const recommendations = getRecommendations(businessType);
        
        // Add remaining recommendations
        recommendations.forEach(rec => {
            const row = document.createElement('tr');
            row.className = rec.priority + '-priority';
            row.innerHTML = `
                <td>
                    <div class="opportunity-cell">
                        <div class="opportunity-info">
                            <div class="opportunity-title">${rec.title}</div>
                            <div class="opportunity-description">${rec.description}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="revenue-impact">${rec.revenue}</span>
                </td>
                <td>
                    <span class="effort-badge ${rec.effort.toLowerCase()}">${rec.effort}</span>
                    <div class="effort-detail">${rec.effortDetail}</div>
                </td>
                <td>
                    <div class="table-actions">
                        <button class="table-btn secondary" onclick="openExperimentDrawer({
                            id: '${rec.id}',
                            title: '${rec.title}',
                            description: '${rec.description}',
                            uplift: ${rec.id === 'payment-intents' ? 12 : rec.id === 'smart-retries' ? 8 : 15},
                            revenue: '${rec.revenue}',
                            effort: '${rec.effort} (${rec.effortDetail})'
                        })">
                            <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                            Experiment
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Initialize tables when page loads
    function initializeTables() {
        const currentBusinessType = document.querySelector('.business-type-tab.active')?.dataset.type || 'medium';
        updateRecommendationsTable(currentBusinessType);
        updateExperimentsTable();
    }
    
    // Call initialization when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeTables();
    });
    
    function showExperimentStartedMessage(experiment) {
        // Create and show toast notification
        const toast = document.createElement('div');
        toast.className = 'experiment-toast';
        toast.innerHTML = `
            <span>${experiment.name} enabled</span>
            <a href="#" onclick="viewExperiments()" style="color: var(--color-purple-500); text-decoration: none; margin-left: 8px; font-weight: 500;">View experiments</a>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in from bottom
        setTimeout(() => {
            toast.style.transform = 'translateX(-50%) translateY(0)';
        }, 100);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.style.transform = 'translateX(-50%) translateY(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }
    
    function viewExperiments() {
        // Switch to the optimization tab
        switchTabView('optimization');
        
        // Close the toast
        const toast = document.querySelector('.experiment-toast');
        if (toast && toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }
    
    // Initialize the page on load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, initializing overview view...');
        
        // Initialize the overview view by default
        createOverviewView();
        
        // Set the overview tab as active
        const overviewTab = document.querySelector('.nav-tab[onclick*="overview"]');
        if (overviewTab) {
            overviewTab.classList.add('active');
        }
        
        // Initialize chart tooltips
        initializeChartTooltips();
        
        // Initialize the main chart for hover functionality
        const currentDateRange = document.getElementById('dateRangeDropdown')?.textContent.trim() || 'Last 90 days';
        updateMainChart(currentDateRange, currentBusinessType);
        
        console.log('Page initialization complete');
    });


</script>

<!-- Business Type Tabs -->
<div class="business-type-tabs">
                    <button class="business-type-tab" data-type="startup" onclick="switchBusinessType('startup')">Startup</button>
                <button class="business-type-tab active" data-type="growth" onclick="switchBusinessType('growth')">Growth</button>
                <button class="business-type-tab" data-type="scale" onclick="switchBusinessType('scale')">Scale</button>
                <button class="business-type-tab" data-type="enterprise" onclick="switchBusinessType('enterprise')">Enterprise</button>
    </div>

    <!-- Lo-fi Mode Toggle -->
    <div id="lofiToggle" class="lofi-toggle">
        <div class="toggle-switch" onclick="toggleLofiMode()">
            <div class="toggle-slider"></div>
        </div>
        <span class="toggle-label">Lo-fi mode</span>
    </div>

    <!-- Experiment Drawer -->
<div class="experiment-drawer" id="experimentDrawer">
    <div class="experiment-drawer-header">
        <div class="experiment-drawer-title">
            <i data-lucide="flask-conical" style="width: 18px; height: 18px; color: var(--color-purple-500);"></i>
                                <h3>Start experiment</h3>
        </div>
        <button class="ai-panel-control-btn" onclick="closeExperimentDrawer()">
            <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </button>
    </div>
    
    <div class="experiment-drawer-content">
        <div class="experiment-form" id="experimentForm">
            <div class="experiment-section">
                <h4 class="experiment-section-title">Recommendation</h4>
                <div class="experiment-recommendation" id="experimentRecommendation">
                    <!-- Recommendation content will be populated dynamically -->
                </div>
            </div>
            
            <div class="experiment-section">
                <h4 class="experiment-section-title">Experiment Settings</h4>
                
                <div class="form-group">
                    <label class="form-label">Rollout Percentage</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="rolloutSlider" min="1" max="100" value="10">
                        <div class="slider-value" id="rolloutValue">10%</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" id="endDate" min="">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Experiment Name (Optional)</label>
                    <input type="text" class="form-input" id="experimentName" placeholder="e.g., 3D Secure Optimization Test">
                </div>
            </div>
            
            <div class="experiment-actions">
                <button class="experiment-btn secondary" onclick="closeExperimentDrawer()">Cancel</button>
                <button class="experiment-btn primary" onclick="startExperiment()">Start experiment</button>
            </div>
        </div>
    </div>
</div>

    <!-- AI Assistant Panel -->
<div class="ai-assistant-panel" id="aiAssistantPanel">
    <div class="ai-panel-header">
        <div class="ai-panel-title">
            <i data-lucide="sparkles" style="width: 18px; height: 18px; color: var(--color-purple-500);"></i>
            <h3>Assistant</h3>
        </div>
        <div class="ai-panel-controls">
            <button class="ai-panel-control-btn">
                <i data-lucide="more-horizontal" style="width: 18px; height: 18px;"></i>
            </button>
            <button class="ai-panel-control-btn">
                <i data-lucide="settings" style="width: 18px; height: 18px;"></i>
            </button>
            <button class="ai-panel-control-btn" onclick="closeAIPanel()">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
    </div>
    
    <div class="ai-panel-content">
        <div class="ai-chat-container" id="aiChatContainer">
            <!-- Chat messages will be dynamically added here -->
        </div>
        
        <div class="ai-input-container">
            <div class="ai-input-wrapper">
                <textarea 
                    class="ai-input" 
                    id="aiInput" 
                    placeholder="Ask a question"
                    rows="1"
                ></textarea>
                <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">
                    <i data-lucide="send" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Metric Details Popup Modal -->
<div class="metric-details-modal" id="metricDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; backdrop-filter: blur(4px);">
    <div class="metric-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 32px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div class="metric-modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
            <div>
                <h2 class="metric-modal-title" style="font-size: 24px; font-weight: 600; color: var(--color-gray-900); margin: 0 0 8px 0;">Metric Details</h2>
                <p class="metric-modal-subtitle" style="font-size: 13px; color: var(--color-gray-600); margin: 0;">Time series data and trends</p>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="view-in-studio-btn" style="background: var(--color-purple-500); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                    View in studio
                </button>
                <button class="metric-modal-close" onclick="closeMetricDetailsModal()" style="background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.15s;">
                    <i data-lucide="x" style="width: 20px; height: 20px; color: var(--color-gray-500);"></i>
                </button>
            </div>
        </div>
        
        <div class="metric-modal-body">
            <div class="metric-chart-container" style="margin-bottom: 24px;">
                <div class="metric-chart-content" style="position: relative; height: 300px; width: 100%;">
                    <div class="metric-chart-y-axis" style="position: absolute; left: 0; top: 0; bottom: 0; width: 40px; display: flex; flex-direction: column; justify-content: space-between; font-size: 12px; color: var(--color-gray-500); font-weight: 500; padding-right: 12px;">
                        <span id="metricYAxisMax">$12K</span>
                        <span>$8K</span>
                        <span>$4K</span>
                        <span id="metricYAxisMin">$0</span>
                    </div>
                    <div class="metric-chart-area" style="position: absolute; top: 0; left: 40px; right: 0; bottom: 40px; background: white;">
                        <div class="metric-chart-grid" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(to bottom, var(--color-gray-200) 1px, transparent 1px); background-size: 100% 25%; opacity: 0.3;"></div>
                        <div class="metric-chart-lines" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%;">
                            <svg class="metric-chart-svg" id="metricChartSvg" viewBox="0 0 700 300" style="width: 100%; height: 100%;">
                                <!-- Chart lines will be dynamically added here -->
                            </svg>
                        </div>
                        <div class="metric-chart-x-axis" id="metricChartXAxis" style="position: absolute; left: 0; right: 0; bottom: -40px; display: flex; justify-content: space-between; font-size: 12px; color: var(--color-gray-500); font-weight: 500; padding-left: 40px; padding-right: 40px;">
                            <!-- X-axis labels will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div class="metric-chart-footer" style="margin-top: 48px;">
                    <div class="metric-chart-legend" style="display: flex; gap: 24px; margin-bottom: 16px;">
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color current" style="width: 12px; height: 3px; background: #533AFD; border-radius: 2px;"></div>
                            <span style="font-size: 13px; color: var(--color-gray-700);">Current performance</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color previous" style="width: 12px; height: 3px; background: #E4E7EC; border-radius: 2px;"></div>
                            <span style="font-size: 13px; color: var(--color-gray-700);">Baseline performance</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                            <div class="legend-color optimized" style="width: 12px; height: 3px; background: #22C55E; border-radius: 2px; border-top: 2px dashed #22C55E;"></div>
                            <span style="font-size: 13px; color: var(--color-gray-700);">Industry benchmark</span>
                        </div>
                    </div>
                    <span class="update-status" style="font-size: 12px; color: var(--color-gray-500);">Updated yesterday</span>
                </div>
            </div>
            
            <!-- AI Insights Section -->
            <div class="ai-insights-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--color-gray-200);">
                <div class="ai-insights-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px; color: var(--color-purple-500);"></i>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--color-gray-900); margin: 0;">AI Insights</h3>
                </div>
                <div class="ai-insight-content" style="background: var(--color-gray-100); border-radius: 8px; padding: 16px;">
                    <p style="font-size: 13px; color: var(--color-gray-700); margin: 0 0 12px 0; line-height: 1.5;">
                        <strong>Performance analysis:</strong> Your <span id="insight-metric-name">success rate</span> shows a <span id="insight-trend">positive trend</span> over the last 90 days, with a <span id="insight-improvement">12% improvement</span> compared to baseline performance.
                    </p>
                    <div class="ai-recommendation" style="background: white; border-radius: 6px; padding: 12px; margin-top: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="lightbulb" style="width: 14px; height: 14px; color: var(--color-yellow-500);"></i>
                            <span style="font-size: 13px; font-weight: 600; color: var(--color-gray-900);">Recommendation</span>
                        </div>
                        <p style="font-size: 13px; color: var(--color-gray-700); margin: 0; line-height: 1.4;">
                            <span id="ai-recommendation-text">Consider implementing smart retry logic to recover declined transactions and potentially improve your success rate by an additional 3-5%.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Panel -->
<div id="notificationPanel" class="notification-panel" style="display:none;">
    <div class="notification-panel-header">
        <span>Notifications</span>
        <button onclick="toggleNotificationPanel()" class="close-btn">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="notification-list" id="notificationList">
        <div class="notification-item">
            <div class="notification-dot-indicator"></div>
            <div class="notification-content">
                <div class="notification-header">
                    <span class="notification-type">Acceptance Alert</span>
                    <span class="notification-timestamp">Jul 17</span>
                </div>
                <div class="notification-message">
                    Acceptance rate dropped significantly in your primary market on July 17th. This represents a potential revenue loss of $1,200.
                </div>
                <div class="notification-actions">
                    <button class="notification-btn" onclick="testAskAssistant()">Ask Assistant</button>
                    <button class="notification-btn primary" onclick="showAcceptanceAlertDetails()">View details</button>
                </div>
            </div>
        </div>
    </div>
</div>

    </script>
    
    <!-- Load JavaScript modules -->
    <script src="src/js/modules/DataGenerator.js?v=3"></script>
    <script src="src/js/modules/EventManager.js"></script>
    <script src="src/js/modules/ChartManager.js"></script>
    <script src="src/js/modules/AppManager.js"></script>
    <script src="src/js/modules/SimpleChartHover.js"></script>
    <script src="src/js/app.js"></script>
    
    <!-- Force populate optimization data immediately -->
    <script>
        // Run immediately when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, forcing optimization data population...');
            
            // Wait a bit for everything to load
            setTimeout(function() {
                // Update main metric
                const metricValue = document.getElementById('optimization-metric-value');
                if (metricValue) {
                    metricValue.textContent = '$56,800.00';
                    console.log('Updated main metric');
                }
                
                // Update table cells
                const cells = {
                    'adaptive-volume': '+$12,500.00',
                    'adaptive-payments': '+45',
                    'adaptive-success': '+2.80%',
                    'network-volume': '+$8,200.00',
                    'network-payments': '+28',
                    'network-success': '+1.50%',
                    'updater-volume': '+$6,800.00',
                    'updater-payments': '+22',
                    'updater-success': '+1.20%',
                    'total-volume': '<strong>+$27,500.00</strong>',
                    'total-payments': '<strong>+95</strong>',
                    'total-success': '<strong>+5.50%</strong>'
                };
                
                Object.keys(cells).forEach(function(id) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = cells[id];
                        console.log('Updated', id);
                    }
                });
                
                console.log('Optimization data population complete');
            }, 500);
            
            // Also run after a longer delay to catch any late updates
            setTimeout(function() {
                console.log('Running delayed optimization data population...');
                
                // Update main metric
                const metricValue = document.getElementById('optimization-metric-value');
                if (metricValue && metricValue.textContent === '$1.00') {
                    metricValue.textContent = '$56,800.00';
                    console.log('Updated main metric (delayed)');
                }
                
                // Update table cells if they're still showing zeros
                const cells = {
                    'adaptive-volume': '+$12,500.00',
                    'adaptive-payments': '+45',
                    'adaptive-success': '+2.80%',
                    'network-volume': '+$8,200.00',
                    'network-payments': '+28',
                    'network-success': '+1.50%',
                    'updater-volume': '+$6,800.00',
                    'updater-payments': '+22',
                    'updater-success': '+1.20%',
                    'total-volume': '<strong>+$27,500.00</strong>',
                    'total-payments': '<strong>+95</strong>',
                    'total-success': '<strong>+5.50%</strong>'
                };
                
                Object.keys(cells).forEach(function(id) {
                    const element = document.getElementById(id);
                    if (element && (element.textContent.includes('$0.00') || element.textContent.includes('+0'))) {
                        element.innerHTML = cells[id];
                        console.log('Updated', id, '(delayed)');
                    }
                });
                
                console.log('Delayed optimization data population complete');
            }, 2000);
        });
    </script>
    
    <!-- Debug script for testing hover functionality -->
    <script>
        // Debug function removed to prevent console errors
        
        // Add manual tooltip test
        window.testTooltip = function() {
            console.log('Manual tooltip test...');
            
            // Test if tooltip function works
            if (typeof showSimpleTooltip === 'function') {
                console.log('Testing showSimpleTooltip...');
                
                // Create test data
                const testData = {
                    current: [85, 82, 88, 85, 80, 87, 89],
                    baseline: [82, 80, 85, 82, 78, 84, 86],
                    optimized: [93, 91, 95, 93, 89, 94, 96]
                };
                
                // Create a test element
                const testElement = document.createElement('div');
                testElement.style.position = 'absolute';
                testElement.style.left = '100px';
                testElement.style.top = '100px';
                testElement.style.width = '50px';
                testElement.style.height = '50px';
                testElement.style.background = 'red';
                document.body.appendChild(testElement);
                
                // Call tooltip function
                showSimpleTooltip(testElement, 0, testData);
                
                // Remove test element after 3 seconds
                setTimeout(() => {
                    if (testElement.parentNode) {
                        testElement.parentNode.removeChild(testElement);
                    }
                    hideSimpleTooltip();
                }, 3000);
                
                console.log('Tooltip test completed');
            } else {
                console.error('showSimpleTooltip function not found');
            }
        };
        
        // Add ChartManager hover test
        window.testChartManagerHover = function() {
            console.log('Manual ChartManager hover test...');
            
            if (window.app && window.app.appManager && window.app.appManager.chartManager) {
                console.log('Testing ChartManager hover functionality...');
                window.app.appManager.chartManager.triggerHoverTest('mainChart');
            } else {
                console.error('ChartManager not available');
            }
        };
        
        // Add direct tooltip test on existing data points
        window.testDirectTooltip = function() {
            console.log('Testing direct tooltip on existing data points...');
            
            const dataPoints = document.querySelectorAll('.data-point');
            console.log('Found data points:', dataPoints.length);
            
            if (dataPoints.length > 0) {
                const firstPoint = dataPoints[0];
                const index = parseInt(firstPoint.dataset.index) || 0;
                
                console.log('Testing tooltip on data point with index:', index);
                
                // Create test data
                const testData = {
                    current: [85, 82, 88, 85, 80, 87, 89],
                    baseline: [82, 80, 85, 82, 78, 84, 86],
                    optimized: [93, 91, 95, 93, 89, 94, 96]
                };
                
                // Call tooltip function directly
                if (typeof showSimpleTooltip === 'function') {
                    showSimpleTooltip(firstPoint, index, testData);
                    console.log('Tooltip should now be visible');
                    
                    // Hide tooltip after 3 seconds
                    setTimeout(() => {
                        if (typeof hideSimpleTooltip === 'function') {
                            hideSimpleTooltip();
                            console.log('Tooltip hidden');
                        }
                    }, 3000);
                } else {
                    console.error('showSimpleTooltip function not found');
                }
            } else {
                console.error('No data points found');
            }
        };
        
        // Manual hover event test (removed to prevent console flooding)
        
        // ChartManager status check (removed to prevent console flooding)
        
        // Manual hover enhancement test (removed to prevent console flooding)
    </script>
</body>
</html> 